<HTML><HEAD><META CONTENT="text/html; charset=ISO-8859-1" HTTP-EQUIV="Content-Type"/><TITLE>EMMA Coverage Report</TITLE><STYLE TYPE="text/css"> TABLE,TD,TH {border-style:solid; border-color:black;} TD,TH {background:white;margin:0;line-height:100%;padding-left:0.5em;padding-right:0.5em;} TD {border-width:0 1px 0 0;} TH {border-width:1px 1px 1px 0;} TR TD.h {color:red;} TABLE {border-spacing:0; border-collapse:collapse;border-width:0 0 1px 1px;} P,H1,H2,H3,TH {font-family:verdana,arial,sans-serif;font-size:10pt;} TD {font-family:courier,monospace;font-size:10pt;} TABLE.hdft {border-spacing:0;border-collapse:collapse;border-style:none;} TABLE.hdft TH,TABLE.hdft TD {border-style:none;line-height:normal;} TABLE.hdft TH.tl,TABLE.hdft TD.tl {background:#6699CC;color:white;} TABLE.hdft TD.nv {background:#6633DD;color:white;} .nv A:link {color:white;} .nv A:visited {color:white;} .nv A:active {color:yellow;} TABLE.hdft A:link {color:white;} TABLE.hdft A:visited {color:white;} TABLE.hdft A:active {color:yellow;} .in {color:#356085;} TABLE.s TD {padding-left:0.25em;padding-right:0.25em;} TABLE.s TD.l {padding-left:0.25em;padding-right:0.25em;text-align:right;background:#F0F0F0;} TABLE.s TR.z TD {background:#FF9999;} TABLE.s TR.p TD {background:#FFFF88;} TABLE.s TR.c TD {background:#CCFFCC;} A:link {color:#0000EE;text-decoration:none;} A:visited {color:#0000EE;text-decoration:none;} A:hover {color:#0000EE;text-decoration:underline;} TABLE.cn {border-width:0 0 1px 0;} TABLE.s {border-width:1px 0 1px 1px;} TD.h {color:red;border-width:0 1px 0 0;} TD.f {border-width:0 1px 0 1px;} TD.hf {color:red;border-width:0 1px 0 1px;} TH.f {border-width:1px 1px 1px 1px;} TR.cis TD {background:#F0F0F0;} TR.cis TD {border-width:1px 1px 1px 0;} TR.cis TD.h {color:red;border-width:1px 1px 1px 0;} TR.cis TD.f {border-width:1px 1px 1px 1px;} TR.cis TD.hf {color:red;border-width:1px 1px 1px 1px;} TD.b {border-style:none;background:transparent;line-height:50%;}  TD.bt {border-width:1px 0 0 0;background:transparent;line-height:50%;} TR.o TD {background:#F0F0F0;}TABLE.it {border-style:none;}TABLE.it TD,TABLE.it TH {border-style:none;}</STYLE></HEAD><BODY><TABLE CLASS="hdft" WIDTH="100%" CELLSPACING="0"><TR><TH CLASS="tl"><A HREF="http://emma.sourceforge.net/">EMMA</A> Coverage Report (generated Fri May 26 15:35:26 CDT 2006)</TH></TR><TR><TD CLASS="nv">[<A HREF="../index.html">all classes</A>][<A HREF="6.html">com.mysql.jdbc</A>]</TD></TR></TABLE><H2>COVERAGE SUMMARY FOR SOURCE FILE [<SPAN CLASS="in">MysqlIO.java</SPAN>]</H2><TABLE WIDTH="100%" CELLSPACING="0"><TR><TH>name</TH><TH>class, %</TH><TH>method, %</TH><TH>block, %</TH><TH>line, %</TH></TR><TR><TD>MysqlIO.java</TD><TD>100% (1/1)</TD><TD>85%  (62/73)</TD><TD CLASS="h">62%  (4737/7697)</TD><TD CLASS="h">65%  (1100.3/1696)</TD></TR></TABLE><H3>COVERAGE BREAKDOWN BY CLASS AND METHOD</H3><TABLE CLASS="cn" WIDTH="100%" CELLSPACING="0"><TR><TH CLASS="f">name</TH><TH>class, %</TH><TH>method, %</TH><TH>block, %</TH><TH>line, %</TH></TR><TR><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#0">MysqlIO</A></TD><TD>100% (1/1)</TD><TD>85%  (62/73)</TD><TD CLASS="h">62%  (4737/7697)</TD><TD CLASS="h">65%  (1100.3/1696)</TD></TR><TR><TD CLASS="f"><A HREF="#1">changeDatabaseTo (String): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/54)</TD><TD CLASS="h">0%   (0/10)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2">checkPacketSequencing (byte): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/91)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR><TD CLASS="f"><A HREF="#3">compressPacket (Buffer, int, int, int): Buffer</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/100)</TD><TD CLASS="h">0%   (0/32)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#4">dumpPacketRingBuffer (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/55)</TD><TD CLASS="h">0%   (0/10)</TD></TR><TR><TD CLASS="f"><A HREF="#5">enqueuePacketForDebugging (boolean, boolean, int, byte [], Buffer): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/172)</TD><TD CLASS="h">0%   (0/34)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#6">getCalendarInstanceForSessionOrNew (): Calendar</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/9)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR><TD CLASS="f"><A HREF="#7">getLastPacketSentTimeMs (): long</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#8">isDataAvailable (): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/23)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR><TD CLASS="f"><A HREF="#9">negotiateSSLConnection (String, String, String, int): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/150)</TD><TD CLASS="h">0%   (0/31)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#a">resetReadPacketSequence (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#b">secureAuth (Buffer, int, String, String, String, boolean): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/253)</TD><TD CLASS="h">0%   (0/56)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#c">createSocketFactory (): SocketFactory</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">19%  (9/47)</TD><TD CLASS="h">40%  (2/5)</TD></TR><TR><TD CLASS="f"><A HREF="#d">getPacketDumpToLog (Buffer, int): String</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">20%  (7/35)</TD><TD CLASS="h">25%  (2/8)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#e">isSetNeededForAutoCommitMode (boolean): boolean</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">22%  (9/41)</TD><TD CLASS="h">29%  (2/7)</TD></TR><TR><TD CLASS="f"><A HREF="#f">closeStreamer (RowData): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">22%  (11/49)</TD><TD CLASS="h">67%  (4/6)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#10">reuseAndReadViaChannel (Buffer): Buffer</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">24%  (89/371)</TD><TD CLASS="h">24%  (23/95)</TD></TR><TR><TD CLASS="f"><A HREF="#11">unpackNativeEncodedColumn (Buffer, Field [], int, Object []): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">40%  (281/700)</TD><TD CLASS="h">39%  (58.3/151)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#12">adjustStartForFieldLength (int, int): int</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">52%  (15/29)</TD><TD CLASS="h">57%  (4/7)</TD></TR><TR><TD CLASS="f"><A HREF="#13">secureAuth411 (Buffer, int, String, String, String, boolean): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">54%  (76/141)</TD><TD CLASS="h">62%  (21/34)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#14">clearInputStream (): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">56%  (50/90)</TD><TD CLASS="h">68%  (15.7/23)</TD></TR><TR><TD CLASS="f"><A HREF="#15">checkErrorPacket (int): Buffer</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">56%  (118/212)</TD><TD CLASS="h">66%  (31/47)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#16">forceClose (): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">65%  (22/34)</TD><TD CLASS="h">62%  (10/16)</TD></TR><TR><TD CLASS="f"><A HREF="#17">send (Buffer, int): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">68%  (126/184)</TD><TD CLASS="h">73%  (30/41)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#18">sendSplitPacketsViaChannel (Buffer): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">69%  (152/220)</TD><TD CLASS="h">72%  (36.7/51)</TD></TR><TR><TD CLASS="f"><A HREF="#19">readPacket (): Buffer</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">70%  (150/215)</TD><TD CLASS="h">71%  (28.5/40)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1a">sendSplitPackets (Buffer): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">70%  (142/202)</TD><TD CLASS="h">73%  (33.7/46)</TD></TR><TR><TD CLASS="f"><A HREF="#1b">sqlQueryDirect (Statement, String, String, Buffer, int, Connection, int, int,...</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">71%  (343/484)</TD><TD CLASS="h">79%  (66/83)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1c">doHandshake (String, String, String): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">71%  (460/644)</TD><TD CLASS="h">70%  (98/139)</TD></TR><TR><TD CLASS="f"><A HREF="#1d">reuseAndReadPacket (Buffer): Buffer</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">72%  (380/529)</TD><TD CLASS="h">77%  (76/99)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1e">buildResultSetWithUpdates (Statement, Buffer): ResultSet</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">72%  (79/109)</TD><TD>83%  (21.7/26)</TD></TR><TR><TD CLASS="f"><A HREF="#1f">sendCommand (int, String, Buffer, boolean, String): Buffer</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">75%  (143/190)</TD><TD CLASS="h">79%  (37/47)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#20">checkForCharsetMismatch (): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">76%  (22/29)</TD><TD CLASS="h">75%  (6/8)</TD></TR><TR><TD CLASS="f"><A HREF="#21">extractNativeEncodedColumn (Buffer, Field [], int, Object []): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">77%  (101/131)</TD><TD>93%  (28/30)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#0">&lt;static initializer&gt;</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>84%  (26/31)</TD><TD>88%  (11.4/13)</TD></TR><TR><TD CLASS="f"><A HREF="#23">changeUser (String, String, String): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>84%  (98/116)</TD><TD>89%  (23/26)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#24">readChannelFully (ByteBuffer, int): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>85%  (22/26)</TD><TD>88%  (7/8)</TD></TR><TR><TD CLASS="f"><A HREF="#25">isVersion (int, int, int): boolean</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>88%  (14/16)</TD><TD>88%  (0.9/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#26">readFully (InputStream, byte [], int, int): int</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>88%  (30/34)</TD><TD>89%  (8/9)</TD></TR><TR><TD CLASS="f"><A HREF="#27">sendFileToServer (Statement, String): ResultSet</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>89%  (229/257)</TD><TD>93%  (51/55)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#28">explainSlowQuery (byte [], String): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>89%  (59/66)</TD><TD>88%  (14.9/17)</TD></TR><TR><TD CLASS="f"><A HREF="#29">unpackField (Buffer, boolean): Field</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>90%  (224/249)</TD><TD>89%  (51/57)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2a">MysqlIO (String, int, Properties, String, Connection, int): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>91%  (302/332)</TD><TD>92%  (77/84)</TD></TR><TR><TD CLASS="f"><A HREF="#2b">readViaChannel (): Buffer</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>91%  (81/89)</TD><TD>90%  (19/21)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2c">readAllResults (Statement, int, int, int, boolean, String, Buffer, boolean, l...</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>92%  (106/115)</TD><TD>91%  (20/22)</TD></TR><TR><TD CLASS="f"><A HREF="#2d">readServerStatusForResultSets (Buffer): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>95%  (42/44)</TD><TD>99%  (9.9/10)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2e">readResultsForQueryOrUpdate (Statement, int, int, int, boolean, String, Buffe...</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>97%  (61/63)</TD><TD>99%  (13.8/14)</TD></TR><TR><TD CLASS="f"><A HREF="#2f">versionMeetsMinimum (int, int, int): boolean</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>97%  (31/32)</TD><TD>99%  (8.9/9)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#30">alignPacketSize (int, int): int</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (12/12)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#31">buildResultSetWithRows (Statement, String, Field [], RowData, int, int, boole...</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (48/48)</TD><TD>100% (11/11)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#32">checkErrorPacket (): Buffer</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (4/4)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#33">checkForOutstandingStreamingData (): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (38/38)</TD><TD>100% (6/6)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#34">disableMultiQueries (): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (20/20)</TD><TD>100% (6/6)</TD></TR><TR><TD CLASS="f"><A HREF="#35">enableMultiQueries (): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (20/20)</TD><TD>100% (6/6)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#36">getHost (): String</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#37">getMaxBuf (): int</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (2/2)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#38">getResultSet (Statement, long, int, int, int, boolean, String, boolean, boole...</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (90/90)</TD><TD>100% (20/20)</TD></TR><TR><TD CLASS="f"><A HREF="#39">getServerMajorVersion (): int</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#3a">getServerMinorVersion (): int</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#3b">getServerSubMinorVersion (): int</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#3c">getServerVersion (): String</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#3d">getSharedSendPacket (): Buffer</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (24/24)</TD><TD>100% (5/5)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#3e">hadWarnings (): boolean</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#3f">hasLongColumnInfo (): boolean</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#40">nextRow (Field [], int, boolean, int): Object []</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (59/59)</TD><TD>100% (16/16)</TD></TR><TR><TD CLASS="f"><A HREF="#41">quit (): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (17/17)</TD><TD>100% (6/6)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#42">readSingleRowSet (long, int, int, boolean, Field []): RowData</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (53/53)</TD><TD>100% (14/14)</TD></TR><TR><TD CLASS="f"><A HREF="#43">reclaimLargeReusablePacket (): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (17/17)</TD><TD>100% (3/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#44">reclaimLargeSharedSendPacket (): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (17/17)</TD><TD>100% (3/3)</TD></TR><TR><TD CLASS="f"><A HREF="#45">resetMaxBuf (): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (6/6)</TD><TD>100% (2/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#46">scanForAndThrowDataTruncation (): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (21/21)</TD><TD>100% (3/3)</TD></TR><TR><TD CLASS="f"><A HREF="#47">send (Buffer): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (14/14)</TD><TD>100% (5/5)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#48">sendViaChannel (Buffer, int): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (66/66)</TD><TD>100% (16/16)</TD></TR><TR><TD CLASS="f"><A HREF="#49">unpackBinaryResultSetRow (Field [], Buffer, int): Object []</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (78/78)</TD><TD>100% (18/18)</TD></TR></TABLE><P></P><TABLE CLASS="s" WIDTH="100%" CELLSPACING="0"><TR><TD CLASS="l">1</TD><TD>/*</TD></TR><TR><TD CLASS="l">2</TD><TD>      Copyright (C) 2002-2004 MySQL AB</TD></TR><TR><TD CLASS="l">3</TD><TD> </TD></TR><TR><TD CLASS="l">4</TD><TD>      This program is free software; you can redistribute it and/or modify</TD></TR><TR><TD CLASS="l">5</TD><TD>      it under the terms of version 2 of the GNU General Public License as</TD></TR><TR><TD CLASS="l">6</TD><TD>      published by the Free Software Foundation.</TD></TR><TR><TD CLASS="l">7</TD><TD> </TD></TR><TR><TD CLASS="l">8</TD><TD>      There are special exceptions to the terms and conditions of the GPL</TD></TR><TR><TD CLASS="l">9</TD><TD>      as it is applied to this software. View the full text of the</TD></TR><TR><TD CLASS="l">10</TD><TD>      exception in file EXCEPTIONS-CONNECTOR-J in the directory of this</TD></TR><TR><TD CLASS="l">11</TD><TD>      software distribution.</TD></TR><TR><TD CLASS="l">12</TD><TD> </TD></TR><TR><TD CLASS="l">13</TD><TD>      This program is distributed in the hope that it will be useful,</TD></TR><TR><TD CLASS="l">14</TD><TD>      but WITHOUT ANY WARRANTY; without even the implied warranty of</TD></TR><TR><TD CLASS="l">15</TD><TD>      MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</TD></TR><TR><TD CLASS="l">16</TD><TD>      GNU General Public License for more details.</TD></TR><TR><TD CLASS="l">17</TD><TD> </TD></TR><TR><TD CLASS="l">18</TD><TD>      You should have received a copy of the GNU General Public License</TD></TR><TR><TD CLASS="l">19</TD><TD>      along with this program; if not, write to the Free Software</TD></TR><TR><TD CLASS="l">20</TD><TD>      Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</TD></TR><TR><TD CLASS="l">21</TD><TD> </TD></TR><TR><TD CLASS="l">22</TD><TD> </TD></TR><TR><TD CLASS="l">23</TD><TD> </TD></TR><TR><TD CLASS="l">24</TD><TD> */</TD></TR><TR><TD CLASS="l">25</TD><TD>package com.mysql.jdbc;</TD></TR><TR><TD CLASS="l">26</TD><TD> </TD></TR><TR><TD CLASS="l">27</TD><TD>import com.mysql.jdbc.profiler.ProfileEventSink;</TD></TR><TR><TD CLASS="l">28</TD><TD>import com.mysql.jdbc.profiler.ProfilerEvent;</TD></TR><TR><TD CLASS="l">29</TD><TD>import com.mysql.jdbc.util.ReadAheadInputStream;</TD></TR><TR><TD CLASS="l">30</TD><TD>import com.mysql.jdbc.util.ResultSetUtil;</TD></TR><TR><TD CLASS="l">31</TD><TD> </TD></TR><TR><TD CLASS="l">32</TD><TD>import java.io.BufferedInputStream;</TD></TR><TR><TD CLASS="l">33</TD><TD>import java.io.BufferedOutputStream;</TD></TR><TR><TD CLASS="l">34</TD><TD>import java.io.ByteArrayOutputStream;</TD></TR><TR><TD CLASS="l">35</TD><TD>import java.io.EOFException;</TD></TR><TR><TD CLASS="l">36</TD><TD>import java.io.FileInputStream;</TD></TR><TR><TD CLASS="l">37</TD><TD>import java.io.IOException;</TD></TR><TR><TD CLASS="l">38</TD><TD>import java.io.InputStream;</TD></TR><TR><TD CLASS="l">39</TD><TD>import java.io.OutputStreamWriter;</TD></TR><TR><TD CLASS="l">40</TD><TD> </TD></TR><TR><TD CLASS="l">41</TD><TD>import java.lang.ref.SoftReference;</TD></TR><TR><TD CLASS="l">42</TD><TD> </TD></TR><TR><TD CLASS="l">43</TD><TD>import java.math.BigInteger;</TD></TR><TR><TD CLASS="l">44</TD><TD> </TD></TR><TR><TD CLASS="l">45</TD><TD>import java.net.InetSocketAddress;</TD></TR><TR><TD CLASS="l">46</TD><TD>import java.net.MalformedURLException;</TD></TR><TR><TD CLASS="l">47</TD><TD>import java.net.Socket;</TD></TR><TR><TD CLASS="l">48</TD><TD>import java.net.URL;</TD></TR><TR><TD CLASS="l">49</TD><TD> </TD></TR><TR><TD CLASS="l">50</TD><TD>import java.nio.ByteBuffer;</TD></TR><TR><TD CLASS="l">51</TD><TD>import java.nio.channels.SocketChannel;</TD></TR><TR><TD CLASS="l">52</TD><TD> </TD></TR><TR><TD CLASS="l">53</TD><TD>import java.security.NoSuchAlgorithmException;</TD></TR><TR><TD CLASS="l">54</TD><TD> </TD></TR><TR><TD CLASS="l">55</TD><TD>import java.sql.DataTruncation;</TD></TR><TR><TD CLASS="l">56</TD><TD>import java.sql.SQLException;</TD></TR><TR><TD CLASS="l">57</TD><TD> </TD></TR><TR><TD CLASS="l">58</TD><TD>import java.util.ArrayList;</TD></TR><TR><TD CLASS="l">59</TD><TD>import java.util.Calendar;</TD></TR><TR><TD CLASS="l">60</TD><TD>import java.util.Iterator;</TD></TR><TR><TD CLASS="l">61</TD><TD>import java.util.LinkedList;</TD></TR><TR><TD CLASS="l">62</TD><TD>import java.util.Properties;</TD></TR><TR><TD CLASS="l">63</TD><TD>import java.util.zip.Deflater;</TD></TR><TR><TD CLASS="l">64</TD><TD> </TD></TR><TR><TD CLASS="l">65</TD><TD> </TD></TR><TR><TD CLASS="l">66</TD><TD>/**</TD></TR><TR><TD CLASS="l">67</TD><TD> * This class is used by Connection for communicating with the MySQL server.</TD></TR><TR><TD CLASS="l">68</TD><TD> *</TD></TR><TR><TD CLASS="l">69</TD><TD> * @author Mark Matthews</TD></TR><TR><TD CLASS="l">70</TD><TD> * @version $Id: MysqlIO.java 5184 2006-04-20 15:03:14 -0500 (Thu, 20 Apr 2006) mmatthews $</TD></TR><TR><TD CLASS="l">71</TD><TD> *</TD></TR><TR><TD CLASS="l">72</TD><TD> * @see java.sql.Connection</TD></TR><TR><TD CLASS="l">73</TD><TD> */</TD></TR><TR><TD CLASS="l">74</TD><TD>class MysqlIO {</TD></TR><TR><TD CLASS="l"><A NAME="0">75</A></TD><TD>    protected static final int NULL_LENGTH = ~0;</TD></TR><TR><TD CLASS="l">76</TD><TD>    protected static final int COMP_HEADER_LENGTH = 3;</TD></TR><TR><TD CLASS="l">77</TD><TD>    protected static final int MIN_COMPRESS_LEN = 50;</TD></TR><TR><TD CLASS="l">78</TD><TD>    protected static final int HEADER_LENGTH = 4;</TD></TR><TR CLASS="c"><TD CLASS="l">79</TD><TD>    private static int maxBufferSize = 65535;</TD></TR><TR><TD CLASS="l">80</TD><TD>    private static final int CLIENT_COMPRESS = 32; /* Can use compression</TD></TR><TR><TD CLASS="l">81</TD><TD>    protcol */</TD></TR><TR><TD CLASS="l">82</TD><TD>    protected static final int CLIENT_CONNECT_WITH_DB = 8;</TD></TR><TR><TD CLASS="l">83</TD><TD>    private static final int CLIENT_FOUND_ROWS = 2;</TD></TR><TR><TD CLASS="l">84</TD><TD>    private static final int CLIENT_LOCAL_FILES = 128; /* Can use LOAD DATA</TD></TR><TR><TD CLASS="l">85</TD><TD>    LOCAL */</TD></TR><TR><TD CLASS="l">86</TD><TD> </TD></TR><TR><TD CLASS="l">87</TD><TD>    /* Found instead of</TD></TR><TR><TD CLASS="l">88</TD><TD>       affected rows */</TD></TR><TR><TD CLASS="l">89</TD><TD>    private static final int CLIENT_LONG_FLAG = 4; /* Get all column flags */</TD></TR><TR><TD CLASS="l">90</TD><TD>    private static final int CLIENT_LONG_PASSWORD = 1; /* new more secure</TD></TR><TR><TD CLASS="l">91</TD><TD>    passwords */</TD></TR><TR><TD CLASS="l">92</TD><TD>    private static final int CLIENT_PROTOCOL_41 = 512; // for &gt; 4.1.1</TD></TR><TR><TD CLASS="l">93</TD><TD>    private static final int CLIENT_INTERACTIVE = 1024;</TD></TR><TR><TD CLASS="l">94</TD><TD>    protected static final int CLIENT_SSL = 2048;</TD></TR><TR><TD CLASS="l">95</TD><TD>    private static final int CLIENT_TRANSACTIONS = 8192; // Client knows about transactions</TD></TR><TR><TD CLASS="l">96</TD><TD>    protected static final int CLIENT_RESERVED = 16384; // for 4.1.0 only</TD></TR><TR><TD CLASS="l">97</TD><TD>    protected static final int CLIENT_SECURE_CONNECTION = 32768;</TD></TR><TR><TD CLASS="l">98</TD><TD>    private static final int CLIENT_MULTI_QUERIES = 65536; // Enable/disable multiquery support</TD></TR><TR><TD CLASS="l">99</TD><TD>    private static final int CLIENT_MULTI_RESULTS = 131072; // Enable/disable multi-results</TD></TR><TR><TD CLASS="l">100</TD><TD>    private static final int SERVER_STATUS_IN_TRANS = 1;</TD></TR><TR><TD CLASS="l">101</TD><TD>    private static final int SERVER_STATUS_AUTOCOMMIT = 2; // Server in auto_commit mode</TD></TR><TR><TD CLASS="l">102</TD><TD>    private static final int SERVER_MORE_RESULTS_EXISTS = 8; // Multi query - next query exists</TD></TR><TR><TD CLASS="l">103</TD><TD>    private static final int SERVER_QUERY_NO_GOOD_INDEX_USED = 16;</TD></TR><TR><TD CLASS="l">104</TD><TD>    private static final int SERVER_QUERY_NO_INDEX_USED = 32;</TD></TR><TR><TD CLASS="l">105</TD><TD>    private static final String FALSE_SCRAMBLE = &#34;xxxxxxxx&#34;; //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">106</TD><TD>    protected static final int MAX_QUERY_SIZE_TO_LOG = 1024; // truncate logging of queries at 1K</TD></TR><TR><TD CLASS="l">107</TD><TD>    protected static final int MAX_QUERY_SIZE_TO_EXPLAIN = 1024 * 1024; // don't explain queries above 1MB</TD></TR><TR><TD CLASS="l">108</TD><TD> </TD></TR><TR><TD CLASS="l">109</TD><TD>    /**</TD></TR><TR><TD CLASS="l">110</TD><TD>     * We store the platform 'encoding' here, only used to avoid munging</TD></TR><TR><TD CLASS="l">111</TD><TD>     * filenames for LOAD DATA LOCAL INFILE...</TD></TR><TR><TD CLASS="l">112</TD><TD>     */</TD></TR><TR CLASS="c"><TD CLASS="l">113</TD><TD>    private static String jvmPlatformCharset = null;</TD></TR><TR><TD CLASS="l">114</TD><TD>    </TD></TR><TR><TD CLASS="l">115</TD><TD>    /**</TD></TR><TR><TD CLASS="l">116</TD><TD>     * Are we using packed or unpacked binary result set rows?</TD></TR><TR><TD CLASS="l">117</TD><TD>     */</TD></TR><TR CLASS="c"><TD CLASS="l">118</TD><TD>    private boolean binaryResultsAreUnpacked = true;</TD></TR><TR><TD CLASS="l">119</TD><TD> </TD></TR><TR><TD CLASS="l">120</TD><TD>    /**</TD></TR><TR><TD CLASS="l">121</TD><TD>     * We need to have a 'marker' for all-zero datetimes so that ResultSet</TD></TR><TR><TD CLASS="l">122</TD><TD>     * can decide what to do based on connection setting</TD></TR><TR><TD CLASS="l">123</TD><TD>     */</TD></TR><TR><TD CLASS="l">124</TD><TD>    protected final static String ZERO_DATE_VALUE_MARKER = &#34;0000-00-00&#34;;</TD></TR><TR><TD CLASS="l">125</TD><TD>    protected final static String ZERO_DATETIME_VALUE_MARKER = &#34;0000-00-00 00:00:00&#34;;</TD></TR><TR><TD CLASS="l">126</TD><TD> </TD></TR><TR><TD CLASS="l">127</TD><TD>    static {</TD></TR><TR CLASS="c"><TD CLASS="l">128</TD><TD>        OutputStreamWriter outWriter = null;</TD></TR><TR><TD CLASS="l">129</TD><TD> </TD></TR><TR><TD CLASS="l">130</TD><TD>        //</TD></TR><TR><TD CLASS="l">131</TD><TD>        // Use the I/O system to get the encoding (if possible), to avoid</TD></TR><TR><TD CLASS="l">132</TD><TD>        // security restrictions on System.getProperty(&#34;file.encoding&#34;) in</TD></TR><TR><TD CLASS="l">133</TD><TD>        // applets (why is that restricted?)</TD></TR><TR><TD CLASS="l">134</TD><TD>        //</TD></TR><TR><TD CLASS="l">135</TD><TD>        try {</TD></TR><TR CLASS="c"><TD CLASS="l">136</TD><TD>            outWriter = new OutputStreamWriter(new ByteArrayOutputStream());</TD></TR><TR CLASS="c"><TD CLASS="l">137</TD><TD>            jvmPlatformCharset = outWriter.getEncoding();</TD></TR><TR CLASS="c"><TD CLASS="l">138</TD><TD>        } finally {</TD></TR><TR CLASS="p"><TD TITLE="43% line coverage (3 out of 7 instructions)" CLASS="l">139</TD><TD TITLE="43% line coverage (3 out of 7 instructions)">            try {</TD></TR><TR CLASS="c"><TD CLASS="l">140</TD><TD>                if (outWriter != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">141</TD><TD>                    outWriter.close();</TD></TR><TR><TD CLASS="l">142</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">143</TD><TD>            } catch (IOException ioEx) {</TD></TR><TR><TD CLASS="l">144</TD><TD>                // ignore</TD></TR><TR CLASS="c"><TD CLASS="l">145</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">146</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">147</TD><TD>    }</TD></TR><TR><TD CLASS="l">148</TD><TD> </TD></TR><TR><TD CLASS="l">149</TD><TD>    /** Max number of bytes to dump when tracing the protocol */</TD></TR><TR><TD CLASS="l">150</TD><TD>    private final static int MAX_PACKET_DUMP_LENGTH = 1024;</TD></TR><TR CLASS="c"><TD CLASS="l">151</TD><TD>    private boolean packetSequenceReset = false;</TD></TR><TR><TD CLASS="l">152</TD><TD>    protected int serverCharsetIndex;</TD></TR><TR><TD CLASS="l">153</TD><TD> </TD></TR><TR><TD CLASS="l">154</TD><TD>    //</TD></TR><TR><TD CLASS="l">155</TD><TD>    // Use this when reading in rows to avoid thousands of new()</TD></TR><TR><TD CLASS="l">156</TD><TD>    // calls, because the byte arrays just get copied out of the</TD></TR><TR><TD CLASS="l">157</TD><TD>    // packet anyway</TD></TR><TR><TD CLASS="l">158</TD><TD>    //</TD></TR><TR CLASS="c"><TD CLASS="l">159</TD><TD>    private Buffer reusablePacket = null;</TD></TR><TR CLASS="c"><TD CLASS="l">160</TD><TD>    private Buffer sendPacket = null;</TD></TR><TR CLASS="c"><TD CLASS="l">161</TD><TD>    private Buffer sharedSendPacket = null;</TD></TR><TR><TD CLASS="l">162</TD><TD> </TD></TR><TR><TD CLASS="l">163</TD><TD>    /** Data to the server */</TD></TR><TR CLASS="c"><TD CLASS="l">164</TD><TD>    protected BufferedOutputStream mysqlOutput = null;</TD></TR><TR><TD CLASS="l">165</TD><TD>    protected com.mysql.jdbc.Connection connection;</TD></TR><TR CLASS="c"><TD CLASS="l">166</TD><TD>    private Deflater deflater = null;</TD></TR><TR CLASS="c"><TD CLASS="l">167</TD><TD>    protected InputStream mysqlInput = null;</TD></TR><TR CLASS="c"><TD CLASS="l">168</TD><TD>    private LinkedList packetDebugRingBuffer = null;</TD></TR><TR CLASS="c"><TD CLASS="l">169</TD><TD>    private RowData streamingData = null;</TD></TR><TR><TD CLASS="l">170</TD><TD> </TD></TR><TR><TD CLASS="l">171</TD><TD>    /** The connection to the server */</TD></TR><TR CLASS="c"><TD CLASS="l">172</TD><TD>    protected Socket mysqlConnection = null;</TD></TR><TR><TD CLASS="l">173</TD><TD>    private SocketChannel socketChannel;</TD></TR><TR CLASS="c"><TD CLASS="l">174</TD><TD>    private SocketFactory socketFactory = null;</TD></TR><TR><TD CLASS="l">175</TD><TD> </TD></TR><TR><TD CLASS="l">176</TD><TD>    //</TD></TR><TR><TD CLASS="l">177</TD><TD>    // Packet used for 'LOAD DATA LOCAL INFILE'</TD></TR><TR><TD CLASS="l">178</TD><TD>    //</TD></TR><TR><TD CLASS="l">179</TD><TD>    // We use a SoftReference, so that we don't penalize intermittent</TD></TR><TR><TD CLASS="l">180</TD><TD>    // use of this feature</TD></TR><TR><TD CLASS="l">181</TD><TD>    //</TD></TR><TR><TD CLASS="l">182</TD><TD>    private SoftReference loadFileBufRef;</TD></TR><TR><TD CLASS="l">183</TD><TD> </TD></TR><TR><TD CLASS="l">184</TD><TD>    //</TD></TR><TR><TD CLASS="l">185</TD><TD>    // Used to send large packets to the server versions 4+</TD></TR><TR><TD CLASS="l">186</TD><TD>    // We use a SoftReference, so that we don't penalize intermittent</TD></TR><TR><TD CLASS="l">187</TD><TD>    // use of this feature</TD></TR><TR><TD CLASS="l">188</TD><TD>    //</TD></TR><TR><TD CLASS="l">189</TD><TD>    private SoftReference splitBufRef;</TD></TR><TR CLASS="c"><TD CLASS="l">190</TD><TD>    protected String host = null;</TD></TR><TR><TD CLASS="l">191</TD><TD>    protected String seed;</TD></TR><TR CLASS="c"><TD CLASS="l">192</TD><TD>    private String serverVersion = null;</TD></TR><TR CLASS="c"><TD CLASS="l">193</TD><TD>    private String socketFactoryClassName = null;</TD></TR><TR CLASS="c"><TD CLASS="l">194</TD><TD>    private byte[] packetHeaderBuf = new byte[4];</TD></TR><TR CLASS="c"><TD CLASS="l">195</TD><TD>    private boolean colDecimalNeedsBump = false; // do we need to increment the colDecimal flag?</TD></TR><TR CLASS="c"><TD CLASS="l">196</TD><TD>    private boolean hadWarnings = false;</TD></TR><TR CLASS="c"><TD CLASS="l">197</TD><TD>    private boolean has41NewNewProt = false;</TD></TR><TR><TD CLASS="l">198</TD><TD> </TD></TR><TR><TD CLASS="l">199</TD><TD>    /** Does the server support long column info? */</TD></TR><TR CLASS="c"><TD CLASS="l">200</TD><TD>    private boolean hasLongColumnInfo = false;</TD></TR><TR CLASS="c"><TD CLASS="l">201</TD><TD>    private boolean isInteractiveClient = false;</TD></TR><TR CLASS="c"><TD CLASS="l">202</TD><TD>    private boolean logSlowQueries = false;</TD></TR><TR><TD CLASS="l">203</TD><TD> </TD></TR><TR><TD CLASS="l">204</TD><TD>    /**</TD></TR><TR><TD CLASS="l">205</TD><TD>     * Does the character set of this connection match the character set of the</TD></TR><TR><TD CLASS="l">206</TD><TD>     * platform</TD></TR><TR><TD CLASS="l">207</TD><TD>     */</TD></TR><TR CLASS="c"><TD CLASS="l">208</TD><TD>    private boolean platformDbCharsetMatches = true; // changed once we've connected.</TD></TR><TR CLASS="c"><TD CLASS="l">209</TD><TD>    private boolean profileSql = false;</TD></TR><TR CLASS="c"><TD CLASS="l">210</TD><TD>    private boolean queryBadIndexUsed = false;</TD></TR><TR CLASS="c"><TD CLASS="l">211</TD><TD>    private boolean queryNoIndexUsed = false;</TD></TR><TR><TD CLASS="l">212</TD><TD> </TD></TR><TR><TD CLASS="l">213</TD><TD>    /** Should we use 4.1 protocol extensions? */</TD></TR><TR CLASS="c"><TD CLASS="l">214</TD><TD>    private boolean use41Extensions = false;</TD></TR><TR CLASS="c"><TD CLASS="l">215</TD><TD>    private boolean useCompression = false;</TD></TR><TR CLASS="c"><TD CLASS="l">216</TD><TD>    protected boolean useNewIo = false;</TD></TR><TR CLASS="c"><TD CLASS="l">217</TD><TD>    private boolean useNewLargePackets = false;</TD></TR><TR CLASS="c"><TD CLASS="l">218</TD><TD>    private boolean useNewUpdateCounts = false; // should we use the new larger update counts?</TD></TR><TR CLASS="c"><TD CLASS="l">219</TD><TD>    private byte packetSequence = 0;</TD></TR><TR CLASS="c"><TD CLASS="l">220</TD><TD>    private byte readPacketSequence = -1;</TD></TR><TR CLASS="c"><TD CLASS="l">221</TD><TD>    private boolean checkPacketSequence = false;</TD></TR><TR CLASS="c"><TD CLASS="l">222</TD><TD>    byte protocolVersion = 0;</TD></TR><TR CLASS="c"><TD CLASS="l">223</TD><TD>    private int maxAllowedPacket = 1024 * 1024;</TD></TR><TR CLASS="c"><TD CLASS="l">224</TD><TD>    protected int maxThreeBytes = 255 * 255 * 255;</TD></TR><TR CLASS="c"><TD CLASS="l">225</TD><TD>    protected int port = 3306;</TD></TR><TR><TD CLASS="l">226</TD><TD>    protected int serverCapabilities;</TD></TR><TR CLASS="c"><TD CLASS="l">227</TD><TD>    private int serverMajorVersion = 0;</TD></TR><TR CLASS="c"><TD CLASS="l">228</TD><TD>    private int serverMinorVersion = 0;</TD></TR><TR CLASS="c"><TD CLASS="l">229</TD><TD>    private int serverStatus = 0;</TD></TR><TR CLASS="c"><TD CLASS="l">230</TD><TD>    private int serverSubMinorVersion = 0;</TD></TR><TR CLASS="c"><TD CLASS="l">231</TD><TD>    private int warningCount = 0;</TD></TR><TR CLASS="c"><TD CLASS="l">232</TD><TD>    protected long clientParam = 0;</TD></TR><TR CLASS="c"><TD CLASS="l">233</TD><TD>    protected long lastPacketSentTimeMs = 0;</TD></TR><TR CLASS="c"><TD CLASS="l">234</TD><TD>    private boolean traceProtocol = false;</TD></TR><TR CLASS="c"><TD CLASS="l">235</TD><TD>    private boolean enablePacketDebug = false;</TD></TR><TR><TD CLASS="l">236</TD><TD>    private ByteBuffer channelClearBuf;</TD></TR><TR><TD CLASS="l">237</TD><TD>    private Calendar sessionCalendar;</TD></TR><TR><TD CLASS="l">238</TD><TD>        private boolean useConnectWithDb;</TD></TR><TR><TD CLASS="l">239</TD><TD>        private boolean needToGrabQueryFromPacket;</TD></TR><TR><TD CLASS="l">240</TD><TD>        private boolean autoGenerateTestcaseScript;</TD></TR><TR><TD CLASS="l">241</TD><TD> </TD></TR><TR><TD CLASS="l">242</TD><TD>    /**</TD></TR><TR><TD CLASS="l">243</TD><TD>     * Constructor:  Connect to the MySQL server and setup a stream connection.</TD></TR><TR><TD CLASS="l">244</TD><TD>     *</TD></TR><TR><TD CLASS="l">245</TD><TD>     * @param host the hostname to connect to</TD></TR><TR><TD CLASS="l">246</TD><TD>     * @param port the port number that the server is listening on</TD></TR><TR><TD CLASS="l">247</TD><TD>     * @param props the Properties from DriverManager.getConnection()</TD></TR><TR><TD CLASS="l">248</TD><TD>     * @param socketFactoryClassName the socket factory to use</TD></TR><TR><TD CLASS="l">249</TD><TD>     * @param conn the Connection that is creating us</TD></TR><TR><TD CLASS="l">250</TD><TD>     * @param socketTimeout the timeout to set for the socket (0 means no</TD></TR><TR><TD CLASS="l">251</TD><TD>     *        timeout)</TD></TR><TR><TD CLASS="l">252</TD><TD>     *</TD></TR><TR><TD CLASS="l">253</TD><TD>     * @throws IOException if an IOException occurs during connect.</TD></TR><TR><TD CLASS="l"><A NAME="2a">254</A></TD><TD>     * @throws SQLException if a database access error occurs.</TD></TR><TR><TD CLASS="l">255</TD><TD>     */</TD></TR><TR><TD CLASS="l">256</TD><TD>    public MysqlIO(String host, int port, Properties props,</TD></TR><TR><TD CLASS="l">257</TD><TD>        String socketFactoryClassName, com.mysql.jdbc.Connection conn,</TD></TR><TR CLASS="c"><TD CLASS="l">258</TD><TD>        int socketTimeout) throws IOException, SQLException {</TD></TR><TR CLASS="c"><TD CLASS="l">259</TD><TD>        this.connection = conn;</TD></TR><TR><TD CLASS="l">260</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">261</TD><TD>        if (this.connection.getEnablePacketDebug()) {</TD></TR><TR CLASS="z"><TD CLASS="l">262</TD><TD>            this.packetDebugRingBuffer = new LinkedList();</TD></TR><TR><TD CLASS="l">263</TD><TD>        }</TD></TR><TR><TD CLASS="l">264</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">265</TD><TD>        this.logSlowQueries = this.connection.getLogSlowQueries();</TD></TR><TR><TD CLASS="l">266</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">267</TD><TD>        this.useNewIo = this.connection.getUseNewIo();</TD></TR><TR><TD CLASS="l">268</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">269</TD><TD>        if (this.useNewIo) {</TD></TR><TR CLASS="c"><TD CLASS="l">270</TD><TD>            this.reusablePacket = Buffer.allocateDirect(this.connection.getNetBufferLength(),</TD></TR><TR><TD CLASS="l">271</TD><TD>                    true);</TD></TR><TR><TD CLASS="l">272</TD><TD>        } else {</TD></TR><TR CLASS="c"><TD CLASS="l">273</TD><TD>            this.reusablePacket = Buffer.allocateNew(this.connection.getNetBufferLength(),</TD></TR><TR><TD CLASS="l">274</TD><TD>                    false);</TD></TR><TR><TD CLASS="l">275</TD><TD>        }</TD></TR><TR><TD CLASS="l">276</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">277</TD><TD>        this.port = port;</TD></TR><TR CLASS="c"><TD CLASS="l">278</TD><TD>        this.host = host;</TD></TR><TR><TD CLASS="l">279</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">280</TD><TD>        if (!this.useNewIo) {</TD></TR><TR CLASS="c"><TD CLASS="l">281</TD><TD>            this.socketFactoryClassName = socketFactoryClassName;</TD></TR><TR CLASS="c"><TD CLASS="l">282</TD><TD>            this.socketFactory = createSocketFactory();</TD></TR><TR><TD CLASS="l">283</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">284</TD><TD>            this.mysqlConnection = this.socketFactory.connect(this.host,</TD></TR><TR><TD CLASS="l">285</TD><TD>                    this.port, props);</TD></TR><TR><TD CLASS="l">286</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">287</TD><TD>            if (socketTimeout != 0) {</TD></TR><TR><TD CLASS="l">288</TD><TD>                try {</TD></TR><TR CLASS="z"><TD CLASS="l">289</TD><TD>                    this.mysqlConnection.setSoTimeout(socketTimeout);</TD></TR><TR CLASS="z"><TD CLASS="l">290</TD><TD>                } catch (Exception ex) {</TD></TR><TR><TD CLASS="l">291</TD><TD>                    /* Ignore if the platform does not support it */</TD></TR><TR><TD CLASS="l">292</TD><TD>                    ;</TD></TR><TR CLASS="z"><TD CLASS="l">293</TD><TD>                }</TD></TR><TR><TD CLASS="l">294</TD><TD>            }</TD></TR><TR><TD CLASS="l">295</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">296</TD><TD>            this.mysqlConnection = this.socketFactory.beforeHandshake();</TD></TR><TR><TD CLASS="l">297</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">298</TD><TD>            if (this.connection.getUseReadAheadInput()) {</TD></TR><TR CLASS="c"><TD CLASS="l">299</TD><TD>                this.mysqlInput = new ReadAheadInputStream(this.mysqlConnection.getInputStream(), 16384, </TD></TR><TR><TD CLASS="l">300</TD><TD>                                this.connection.getTraceProtocol(),</TD></TR><TR><TD CLASS="l">301</TD><TD>                                this.connection.getLog());        </TD></TR><TR CLASS="z"><TD CLASS="l">302</TD><TD>            } else if (this.connection.useUnbufferedInput()) {</TD></TR><TR CLASS="z"><TD CLASS="l">303</TD><TD>                this.mysqlInput = this.mysqlConnection.getInputStream();</TD></TR><TR><TD CLASS="l">304</TD><TD>            } else {</TD></TR><TR CLASS="z"><TD CLASS="l">305</TD><TD>                this.mysqlInput = new BufferedInputStream(this.mysqlConnection.getInputStream(),</TD></TR><TR><TD CLASS="l">306</TD><TD>                        16384);</TD></TR><TR><TD CLASS="l">307</TD><TD>            }</TD></TR><TR><TD CLASS="l">308</TD><TD>            </TD></TR><TR CLASS="c"><TD CLASS="l">309</TD><TD>            this.mysqlOutput = new BufferedOutputStream(this.mysqlConnection.getOutputStream(),</TD></TR><TR><TD CLASS="l">310</TD><TD>                    16384);</TD></TR><TR><TD CLASS="l">311</TD><TD>        } else {</TD></TR><TR CLASS="c"><TD CLASS="l">312</TD><TD>            this.socketChannel = SocketChannel.open();</TD></TR><TR CLASS="c"><TD CLASS="l">313</TD><TD>            this.socketChannel.configureBlocking(true);</TD></TR><TR CLASS="c"><TD CLASS="l">314</TD><TD>            this.socketChannel.connect(new InetSocketAddress(host, port));</TD></TR><TR CLASS="c"><TD CLASS="l">315</TD><TD>            this.channelClearBuf = ByteBuffer.allocate(4096);</TD></TR><TR><TD CLASS="l">316</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">317</TD><TD>            this.mysqlInput = this.socketChannel.socket().getInputStream();</TD></TR><TR><TD CLASS="l">318</TD><TD>        }</TD></TR><TR><TD CLASS="l">319</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">320</TD><TD>        this.isInteractiveClient = this.connection.getInteractiveClient();</TD></TR><TR CLASS="c"><TD CLASS="l">321</TD><TD>        this.profileSql = this.connection.getProfileSql();</TD></TR><TR CLASS="c"><TD CLASS="l">322</TD><TD>        this.sessionCalendar = Calendar.getInstance();</TD></TR><TR CLASS="c"><TD CLASS="l">323</TD><TD>        this.autoGenerateTestcaseScript = this.connection.getAutoGenerateTestcaseScript();</TD></TR><TR><TD CLASS="l">324</TD><TD>        </TD></TR><TR CLASS="c"><TD CLASS="l">325</TD><TD>        this.needToGrabQueryFromPacket = (this.profileSql || </TD></TR><TR><TD CLASS="l">326</TD><TD>                        this.logSlowQueries || </TD></TR><TR><TD CLASS="l">327</TD><TD>                        this.autoGenerateTestcaseScript);</TD></TR><TR CLASS="c"><TD CLASS="l">328</TD><TD>    }</TD></TR><TR><TD CLASS="l">329</TD><TD> </TD></TR><TR><TD CLASS="l">330</TD><TD>    /**</TD></TR><TR><TD CLASS="l">331</TD><TD>     * Does the server send back extra column info?</TD></TR><TR><TD CLASS="l"><A NAME="3f">332</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">333</TD><TD>     * @return true if so</TD></TR><TR><TD CLASS="l">334</TD><TD>     */</TD></TR><TR><TD CLASS="l">335</TD><TD>    public boolean hasLongColumnInfo() {</TD></TR><TR CLASS="c"><TD CLASS="l">336</TD><TD>        return this.hasLongColumnInfo;</TD></TR><TR><TD CLASS="l"><A NAME="8">337</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">338</TD><TD> </TD></TR><TR><TD CLASS="l">339</TD><TD>    protected boolean isDataAvailable() throws SQLException {</TD></TR><TR><TD CLASS="l">340</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">341</TD><TD>            if (!this.useNewIo) {</TD></TR><TR CLASS="z"><TD CLASS="l">342</TD><TD>                return this.mysqlInput.available() &gt; 0;</TD></TR><TR><TD CLASS="l">343</TD><TD>            }</TD></TR><TR><TD CLASS="l">344</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">345</TD><TD>            return false; // we don't know</TD></TR><TR CLASS="z"><TD CLASS="l">346</TD><TD>        } catch (IOException ioEx) {</TD></TR><TR CLASS="z"><TD CLASS="l">347</TD><TD>            throw new CommunicationsException(this.connection,</TD></TR><TR><TD CLASS="l">348</TD><TD>                this.lastPacketSentTimeMs, ioEx);</TD></TR><TR><TD CLASS="l">349</TD><TD>        }</TD></TR><TR><TD CLASS="l">350</TD><TD>    }</TD></TR><TR><TD CLASS="l">351</TD><TD> </TD></TR><TR><TD CLASS="l">352</TD><TD>    /**</TD></TR><TR><TD CLASS="l">353</TD><TD>     * DOCUMENT ME!</TD></TR><TR><TD CLASS="l"><A NAME="7">354</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">355</TD><TD>     * @return Returns the lastPacketSentTimeMs.</TD></TR><TR><TD CLASS="l">356</TD><TD>     */</TD></TR><TR><TD CLASS="l">357</TD><TD>    protected long getLastPacketSentTimeMs() {</TD></TR><TR CLASS="z"><TD CLASS="l">358</TD><TD>        return this.lastPacketSentTimeMs;</TD></TR><TR><TD CLASS="l">359</TD><TD>    }</TD></TR><TR><TD CLASS="l">360</TD><TD> </TD></TR><TR><TD CLASS="l">361</TD><TD>    /**</TD></TR><TR><TD CLASS="l">362</TD><TD>     * Build a result set. Delegates to buildResultSetWithRows() to build a</TD></TR><TR><TD CLASS="l">363</TD><TD>     * JDBC-version-specific ResultSet, given rows as byte data, and field</TD></TR><TR><TD CLASS="l">364</TD><TD>     * information.</TD></TR><TR><TD CLASS="l">365</TD><TD>     *</TD></TR><TR><TD CLASS="l">366</TD><TD>     * @param callingStatement DOCUMENT ME!</TD></TR><TR><TD CLASS="l">367</TD><TD>     * @param columnCount the number of columns in the result set</TD></TR><TR><TD CLASS="l">368</TD><TD>     * @param maxRows the maximum number of rows to read (-1 means all rows)</TD></TR><TR><TD CLASS="l">369</TD><TD>     * @param resultSetType (TYPE_FORWARD_ONLY, TYPE_SCROLL_????)</TD></TR><TR><TD CLASS="l">370</TD><TD>     * @param resultSetConcurrency the type of result set (CONCUR_UPDATABLE or</TD></TR><TR><TD CLASS="l">371</TD><TD>     *        READ_ONLY)</TD></TR><TR><TD CLASS="l">372</TD><TD>     * @param streamResults should the result set be read all at once, or</TD></TR><TR><TD CLASS="l">373</TD><TD>     *        streamed?</TD></TR><TR><TD CLASS="l">374</TD><TD>     * @param catalog the database name in use when the result set was created</TD></TR><TR><TD CLASS="l">375</TD><TD>     * @param isBinaryEncoded is this result set in native encoding?</TD></TR><TR><TD CLASS="l">376</TD><TD>     * @param unpackFieldInfo should we read MYSQL_FIELD info (if available)?</TD></TR><TR><TD CLASS="l">377</TD><TD>     *</TD></TR><TR><TD CLASS="l">378</TD><TD>     * @return a result set</TD></TR><TR><TD CLASS="l">379</TD><TD>     *</TD></TR><TR><TD CLASS="l">380</TD><TD>     * @throws SQLException if a database access error occurs</TD></TR><TR><TD CLASS="l">381</TD><TD>     */</TD></TR><TR><TD CLASS="l">382</TD><TD>    protected ResultSet getResultSet(Statement callingStatement,</TD></TR><TR><TD CLASS="l">383</TD><TD>        long columnCount, int maxRows, int resultSetType,</TD></TR><TR><TD CLASS="l"><A NAME="38">384</A></TD><TD>        int resultSetConcurrency, boolean streamResults, String catalog,</TD></TR><TR><TD CLASS="l">385</TD><TD>        boolean isBinaryEncoded, boolean unpackFieldInfo)</TD></TR><TR><TD CLASS="l">386</TD><TD>        throws SQLException {</TD></TR><TR><TD CLASS="l">387</TD><TD>        Buffer packet; // The packet from the server</TD></TR><TR CLASS="c"><TD CLASS="l">388</TD><TD>        Field[] fields = null;</TD></TR><TR><TD CLASS="l">389</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">390</TD><TD>        if (unpackFieldInfo) {</TD></TR><TR CLASS="c"><TD CLASS="l">391</TD><TD>            fields = new Field[(int) columnCount];</TD></TR><TR><TD CLASS="l">392</TD><TD>        }</TD></TR><TR><TD CLASS="l">393</TD><TD> </TD></TR><TR><TD CLASS="l">394</TD><TD>        // Read in the column information</TD></TR><TR CLASS="c"><TD CLASS="l">395</TD><TD>        for (int i = 0; i &lt; columnCount; i++) {</TD></TR><TR CLASS="c"><TD CLASS="l">396</TD><TD>            Buffer fieldPacket = null;</TD></TR><TR><TD CLASS="l">397</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">398</TD><TD>            if (this.useNewIo) {</TD></TR><TR><TD CLASS="l">399</TD><TD>                // allocations of NIO buffers are _very_, _very_</TD></TR><TR><TD CLASS="l">400</TD><TD>                // slow...(this code used to run 10x slower than </TD></TR><TR><TD CLASS="l">401</TD><TD>                // it does now) so it is actually much faster to re-use,</TD></TR><TR><TD CLASS="l">402</TD><TD>                // extract the bytes, and wrap it as a plain-old</TD></TR><TR><TD CLASS="l">403</TD><TD>                // byte array packet.</TD></TR><TR CLASS="c"><TD CLASS="l">404</TD><TD>                packet = reuseAndReadPacket(this.reusablePacket);</TD></TR><TR><TD CLASS="l">405</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">406</TD><TD>                if (unpackFieldInfo) {</TD></TR><TR CLASS="c"><TD CLASS="l">407</TD><TD>                    fieldPacket = new ByteArrayBuffer(packet.getByteBuffer());</TD></TR><TR><TD CLASS="l">408</TD><TD>                }</TD></TR><TR><TD CLASS="l">409</TD><TD>            } else {</TD></TR><TR CLASS="c"><TD CLASS="l">410</TD><TD>                fieldPacket = readPacket();</TD></TR><TR><TD CLASS="l">411</TD><TD>            }</TD></TR><TR><TD CLASS="l">412</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">413</TD><TD>            if (unpackFieldInfo) {</TD></TR><TR CLASS="c"><TD CLASS="l">414</TD><TD>                fields[i] = unpackField(fieldPacket, false);</TD></TR><TR><TD CLASS="l">415</TD><TD>            }</TD></TR><TR><TD CLASS="l">416</TD><TD>        }</TD></TR><TR><TD CLASS="l">417</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">418</TD><TD>        packet = reuseAndReadPacket(this.reusablePacket);</TD></TR><TR><TD CLASS="l">419</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">420</TD><TD>        RowData rowData = null;</TD></TR><TR><TD CLASS="l">421</TD><TD>       </TD></TR><TR CLASS="c"><TD CLASS="l">422</TD><TD>        if (!streamResults) {</TD></TR><TR CLASS="c"><TD CLASS="l">423</TD><TD>            rowData = readSingleRowSet(columnCount, maxRows,</TD></TR><TR><TD CLASS="l">424</TD><TD>                    resultSetConcurrency, isBinaryEncoded, fields);</TD></TR><TR><TD CLASS="l">425</TD><TD>        } else {</TD></TR><TR CLASS="c"><TD CLASS="l">426</TD><TD>            rowData = new RowDataDynamic(this, (int) columnCount, fields,</TD></TR><TR><TD CLASS="l">427</TD><TD>                    isBinaryEncoded);</TD></TR><TR CLASS="c"><TD CLASS="l">428</TD><TD>            this.streamingData = rowData;</TD></TR><TR><TD CLASS="l">429</TD><TD>        }</TD></TR><TR><TD CLASS="l">430</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">431</TD><TD>        ResultSet rs = buildResultSetWithRows(callingStatement, catalog, fields,</TD></TR><TR><TD CLASS="l">432</TD><TD>            rowData, resultSetType, resultSetConcurrency, isBinaryEncoded);</TD></TR><TR><TD CLASS="l">433</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">434</TD><TD>        return rs;</TD></TR><TR><TD CLASS="l">435</TD><TD>    }</TD></TR><TR><TD CLASS="l">436</TD><TD> </TD></TR><TR><TD CLASS="l">437</TD><TD>    /**</TD></TR><TR><TD CLASS="l"><A NAME="16">438</A></TD><TD>     * Forcibly closes the underlying socket to MySQL.</TD></TR><TR><TD CLASS="l">439</TD><TD>     */</TD></TR><TR><TD CLASS="l">440</TD><TD>    protected final void forceClose() {</TD></TR><TR><TD CLASS="l">441</TD><TD>        try {</TD></TR><TR CLASS="c"><TD CLASS="l">442</TD><TD>            if (this.mysqlInput != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">443</TD><TD>                this.mysqlInput.close();</TD></TR><TR><TD CLASS="l">444</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">445</TD><TD>        } catch (IOException ioEx) {</TD></TR><TR><TD CLASS="l">446</TD><TD>            // we can't do anything constructive about this</TD></TR><TR><TD CLASS="l">447</TD><TD>            // Let the JVM clean it up later</TD></TR><TR CLASS="z"><TD CLASS="l">448</TD><TD>            this.mysqlInput = null;</TD></TR><TR CLASS="c"><TD CLASS="l">449</TD><TD>        }</TD></TR><TR><TD CLASS="l">450</TD><TD> </TD></TR><TR><TD CLASS="l">451</TD><TD>        try {</TD></TR><TR CLASS="c"><TD CLASS="l">452</TD><TD>            if (this.mysqlOutput != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">453</TD><TD>                this.mysqlOutput.close();</TD></TR><TR><TD CLASS="l">454</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">455</TD><TD>        } catch (IOException ioEx) {</TD></TR><TR><TD CLASS="l">456</TD><TD>            // we can't do anything constructive about this</TD></TR><TR><TD CLASS="l">457</TD><TD>            // Let the JVM clean it up later</TD></TR><TR CLASS="z"><TD CLASS="l">458</TD><TD>            this.mysqlOutput = null;</TD></TR><TR CLASS="c"><TD CLASS="l">459</TD><TD>        }</TD></TR><TR><TD CLASS="l">460</TD><TD> </TD></TR><TR><TD CLASS="l">461</TD><TD>        try {</TD></TR><TR CLASS="c"><TD CLASS="l">462</TD><TD>            if (this.mysqlConnection != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">463</TD><TD>                this.mysqlConnection.close();</TD></TR><TR><TD CLASS="l">464</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">465</TD><TD>        } catch (IOException ioEx) {</TD></TR><TR><TD CLASS="l">466</TD><TD>            // we can't do anything constructive about this</TD></TR><TR><TD CLASS="l">467</TD><TD>            // Let the JVM clean it up later</TD></TR><TR CLASS="z"><TD CLASS="l">468</TD><TD>            this.mysqlConnection = null;</TD></TR><TR CLASS="c"><TD CLASS="l">469</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">470</TD><TD>    }</TD></TR><TR><TD CLASS="l">471</TD><TD> </TD></TR><TR><TD CLASS="l">472</TD><TD>    /**</TD></TR><TR><TD CLASS="l">473</TD><TD>     * Read one packet from the MySQL server</TD></TR><TR><TD CLASS="l">474</TD><TD>     *</TD></TR><TR><TD CLASS="l">475</TD><TD>     * @return the packet from the server.</TD></TR><TR><TD CLASS="l">476</TD><TD>     *</TD></TR><TR><TD CLASS="l">477</TD><TD>     * @throws SQLException DOCUMENT ME!</TD></TR><TR><TD CLASS="l"><A NAME="19">478</A></TD><TD>     * @throws CommunicationsException DOCUMENT ME!</TD></TR><TR><TD CLASS="l">479</TD><TD>     */</TD></TR><TR><TD CLASS="l">480</TD><TD>    protected final Buffer readPacket() throws SQLException {</TD></TR><TR><TD CLASS="l">481</TD><TD>        try {</TD></TR><TR CLASS="c"><TD CLASS="l">482</TD><TD>            if (!this.useNewIo) {</TD></TR><TR CLASS="c"><TD CLASS="l">483</TD><TD>                int lengthRead = readFully(this.mysqlInput,</TD></TR><TR><TD CLASS="l">484</TD><TD>                        this.packetHeaderBuf, 0, 4);</TD></TR><TR><TD CLASS="l">485</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">486</TD><TD>                if (lengthRead &lt; 4) {</TD></TR><TR CLASS="z"><TD CLASS="l">487</TD><TD>                    forceClose();</TD></TR><TR CLASS="z"><TD CLASS="l">488</TD><TD>                    throw new IOException(Messages.getString(&#34;MysqlIO.1&#34;)); //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">489</TD><TD>                }</TD></TR><TR><TD CLASS="l">490</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">491</TD><TD>                int packetLength = (this.packetHeaderBuf[0] &amp; 0xff) +</TD></TR><TR><TD CLASS="l">492</TD><TD>                    ((this.packetHeaderBuf[1] &amp; 0xff) &lt;&lt; 8) +</TD></TR><TR><TD CLASS="l">493</TD><TD>                    ((this.packetHeaderBuf[2] &amp; 0xff) &lt;&lt; 16);</TD></TR><TR><TD CLASS="l">494</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">495</TD><TD>                if (this.traceProtocol) {</TD></TR><TR CLASS="c"><TD CLASS="l">496</TD><TD>                    StringBuffer traceMessageBuf = new StringBuffer();</TD></TR><TR><TD CLASS="l">497</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">498</TD><TD>                    traceMessageBuf.append(Messages.getString(&#34;MysqlIO.2&#34;)); //$NON-NLS-1$</TD></TR><TR CLASS="c"><TD CLASS="l">499</TD><TD>                    traceMessageBuf.append(packetLength);</TD></TR><TR CLASS="c"><TD CLASS="l">500</TD><TD>                    traceMessageBuf.append(Messages.getString(&#34;MysqlIO.3&#34;)); //$NON-NLS-1$</TD></TR><TR CLASS="c"><TD CLASS="l">501</TD><TD>                    traceMessageBuf.append(StringUtils.dumpAsHex(</TD></TR><TR><TD CLASS="l">502</TD><TD>                            this.packetHeaderBuf, 4));</TD></TR><TR><TD CLASS="l">503</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">504</TD><TD>                    this.connection.getLog().logTrace(traceMessageBuf.toString());</TD></TR><TR><TD CLASS="l">505</TD><TD>                }</TD></TR><TR><TD CLASS="l">506</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">507</TD><TD>                byte multiPacketSeq = this.packetHeaderBuf[3];</TD></TR><TR><TD CLASS="l">508</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">509</TD><TD>                if (!this.packetSequenceReset) {</TD></TR><TR CLASS="p"><TD TITLE="50% line coverage (3 out of 6 instructions)" CLASS="l">510</TD><TD TITLE="50% line coverage (3 out of 6 instructions)">                    if (this.enablePacketDebug &amp;&amp; this.checkPacketSequence) {</TD></TR><TR CLASS="z"><TD CLASS="l">511</TD><TD>                        checkPacketSequencing(multiPacketSeq);</TD></TR><TR><TD CLASS="l">512</TD><TD>                    }</TD></TR><TR><TD CLASS="l">513</TD><TD>                } else {</TD></TR><TR CLASS="z"><TD CLASS="l">514</TD><TD>                    this.packetSequenceReset = false;</TD></TR><TR><TD CLASS="l">515</TD><TD>                }</TD></TR><TR><TD CLASS="l">516</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">517</TD><TD>                this.readPacketSequence = multiPacketSeq;</TD></TR><TR><TD CLASS="l">518</TD><TD> </TD></TR><TR><TD CLASS="l">519</TD><TD>                // Read data</TD></TR><TR CLASS="c"><TD CLASS="l">520</TD><TD>                byte[] buffer = new byte[packetLength + 1];</TD></TR><TR CLASS="c"><TD CLASS="l">521</TD><TD>                int numBytesRead = readFully(this.mysqlInput, buffer, 0,</TD></TR><TR><TD CLASS="l">522</TD><TD>                        packetLength);</TD></TR><TR><TD CLASS="l">523</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">524</TD><TD>                if (numBytesRead != packetLength) {</TD></TR><TR CLASS="z"><TD CLASS="l">525</TD><TD>                    throw new IOException(&#34;Short read, expected &#34; +</TD></TR><TR><TD CLASS="l">526</TD><TD>                        packetLength + &#34; bytes, only read &#34; + numBytesRead);</TD></TR><TR><TD CLASS="l">527</TD><TD>                }</TD></TR><TR><TD CLASS="l">528</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">529</TD><TD>                buffer[packetLength] = 0;</TD></TR><TR><TD CLASS="l">530</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">531</TD><TD>                Buffer packet = Buffer.allocateNew(buffer, this.useNewIo);</TD></TR><TR CLASS="c"><TD CLASS="l">532</TD><TD>                packet.setBufLength(packetLength + 1);</TD></TR><TR><TD CLASS="l">533</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">534</TD><TD>                if (this.traceProtocol) {</TD></TR><TR CLASS="c"><TD CLASS="l">535</TD><TD>                    StringBuffer traceMessageBuf = new StringBuffer();</TD></TR><TR><TD CLASS="l">536</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">537</TD><TD>                    traceMessageBuf.append(Messages.getString(&#34;MysqlIO.4&#34;)); //$NON-NLS-1$</TD></TR><TR CLASS="c"><TD CLASS="l">538</TD><TD>                    traceMessageBuf.append(getPacketDumpToLog(packet,</TD></TR><TR><TD CLASS="l">539</TD><TD>                            packetLength));</TD></TR><TR><TD CLASS="l">540</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">541</TD><TD>                    this.connection.getLog().logTrace(traceMessageBuf.toString());</TD></TR><TR><TD CLASS="l">542</TD><TD>                }</TD></TR><TR><TD CLASS="l">543</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">544</TD><TD>                if (this.enablePacketDebug) {</TD></TR><TR CLASS="z"><TD CLASS="l">545</TD><TD>                    enqueuePacketForDebugging(false, false, 0,</TD></TR><TR><TD CLASS="l">546</TD><TD>                        this.packetHeaderBuf, packet);</TD></TR><TR><TD CLASS="l">547</TD><TD>                }</TD></TR><TR><TD CLASS="l">548</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">549</TD><TD>                return packet;</TD></TR><TR><TD CLASS="l">550</TD><TD>            }</TD></TR><TR><TD CLASS="l">551</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">552</TD><TD>            return readViaChannel();</TD></TR><TR CLASS="z"><TD CLASS="l">553</TD><TD>        } catch (IOException ioEx) {</TD></TR><TR CLASS="z"><TD CLASS="l">554</TD><TD>            throw new CommunicationsException(this.connection,</TD></TR><TR><TD CLASS="l">555</TD><TD>                this.lastPacketSentTimeMs, ioEx);</TD></TR><TR CLASS="z"><TD CLASS="l">556</TD><TD>        } catch (OutOfMemoryError oom) {</TD></TR><TR><TD CLASS="l">557</TD><TD>                try {</TD></TR><TR CLASS="z"><TD CLASS="l">558</TD><TD>                            this.connection.realClose(false, false, true, oom);</TD></TR><TR><TD CLASS="l">559</TD><TD>                    } finally {</TD></TR><TR CLASS="z"><TD CLASS="l">560</TD><TD>                            throw oom;</TD></TR><TR><TD CLASS="l">561</TD><TD>                    }</TD></TR><TR><TD CLASS="l">562</TD><TD>        }</TD></TR><TR><TD CLASS="l">563</TD><TD>    }</TD></TR><TR><TD CLASS="l">564</TD><TD> </TD></TR><TR><TD CLASS="l">565</TD><TD>    /**</TD></TR><TR><TD CLASS="l">566</TD><TD>     * Unpacks the Field information from the given packet. Understands pre 4.1</TD></TR><TR><TD CLASS="l">567</TD><TD>     * and post 4.1 server version field packet structures.</TD></TR><TR><TD CLASS="l">568</TD><TD>     *</TD></TR><TR><TD CLASS="l">569</TD><TD>     * @param packet the packet containing the field information</TD></TR><TR><TD CLASS="l">570</TD><TD>     * @param extractDefaultValues should default values be extracted?</TD></TR><TR><TD CLASS="l">571</TD><TD>     *</TD></TR><TR><TD CLASS="l">572</TD><TD>     * @return the unpacked field</TD></TR><TR><TD CLASS="l">573</TD><TD>     *</TD></TR><TR><TD CLASS="l"><A NAME="29">574</A></TD><TD>     * @throws SQLException DOCUMENT ME!</TD></TR><TR><TD CLASS="l">575</TD><TD>     */</TD></TR><TR><TD CLASS="l">576</TD><TD>    protected final Field unpackField(Buffer packet,</TD></TR><TR><TD CLASS="l">577</TD><TD>        boolean extractDefaultValues) throws SQLException {</TD></TR><TR CLASS="c"><TD CLASS="l">578</TD><TD>        if (this.use41Extensions) {</TD></TR><TR><TD CLASS="l">579</TD><TD>            // we only store the position of the string and</TD></TR><TR><TD CLASS="l">580</TD><TD>            // materialize only if needed...</TD></TR><TR CLASS="c"><TD CLASS="l">581</TD><TD>            if (this.has41NewNewProt) {</TD></TR><TR><TD CLASS="l">582</TD><TD>                // Not used yet, 5.0?</TD></TR><TR CLASS="c"><TD CLASS="l">583</TD><TD>                int catalogNameStart = packet.getPosition() + 1;</TD></TR><TR CLASS="c"><TD CLASS="l">584</TD><TD>                int catalogNameLength = packet.fastSkipLenString();</TD></TR><TR CLASS="c"><TD CLASS="l">585</TD><TD>                catalogNameStart = adjustStartForFieldLength(catalogNameStart, catalogNameLength);</TD></TR><TR><TD CLASS="l">586</TD><TD>            }</TD></TR><TR><TD CLASS="l">587</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">588</TD><TD>            int databaseNameStart = packet.getPosition() + 1;</TD></TR><TR CLASS="c"><TD CLASS="l">589</TD><TD>            int databaseNameLength = packet.fastSkipLenString();</TD></TR><TR CLASS="c"><TD CLASS="l">590</TD><TD>            databaseNameStart = adjustStartForFieldLength(databaseNameStart, databaseNameLength);</TD></TR><TR><TD CLASS="l">591</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">592</TD><TD>            int tableNameStart = packet.getPosition() + 1;</TD></TR><TR CLASS="c"><TD CLASS="l">593</TD><TD>            int tableNameLength = packet.fastSkipLenString();</TD></TR><TR CLASS="c"><TD CLASS="l">594</TD><TD>            tableNameStart = adjustStartForFieldLength(tableNameStart, tableNameLength);</TD></TR><TR><TD CLASS="l">595</TD><TD>            </TD></TR><TR><TD CLASS="l">596</TD><TD>            // orgTableName is never used so skip</TD></TR><TR CLASS="c"><TD CLASS="l">597</TD><TD>            int originalTableNameStart = packet.getPosition() + 1;</TD></TR><TR CLASS="c"><TD CLASS="l">598</TD><TD>            int originalTableNameLength = packet.fastSkipLenString();</TD></TR><TR CLASS="c"><TD CLASS="l">599</TD><TD>            originalTableNameStart = adjustStartForFieldLength(originalTableNameStart, originalTableNameLength);</TD></TR><TR><TD CLASS="l">600</TD><TD> </TD></TR><TR><TD CLASS="l">601</TD><TD>            // we only store the position again...</TD></TR><TR CLASS="c"><TD CLASS="l">602</TD><TD>            int nameStart = packet.getPosition() + 1;</TD></TR><TR CLASS="c"><TD CLASS="l">603</TD><TD>            int nameLength = packet.fastSkipLenString();</TD></TR><TR><TD CLASS="l">604</TD><TD>            </TD></TR><TR CLASS="c"><TD CLASS="l">605</TD><TD>            nameStart = adjustStartForFieldLength(nameStart, nameLength);</TD></TR><TR><TD CLASS="l">606</TD><TD> </TD></TR><TR><TD CLASS="l">607</TD><TD>            // orgColName is not required so skip...</TD></TR><TR CLASS="c"><TD CLASS="l">608</TD><TD>            int originalColumnNameStart = packet.getPosition() + 1;</TD></TR><TR CLASS="c"><TD CLASS="l">609</TD><TD>            int originalColumnNameLength = packet.fastSkipLenString();</TD></TR><TR CLASS="c"><TD CLASS="l">610</TD><TD>            originalColumnNameStart = adjustStartForFieldLength(originalColumnNameStart, originalColumnNameLength);</TD></TR><TR><TD CLASS="l">611</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">612</TD><TD>            packet.readByte();</TD></TR><TR><TD CLASS="l">613</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">614</TD><TD>            short charSetNumber = (short) packet.readInt();</TD></TR><TR><TD CLASS="l">615</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">616</TD><TD>            long colLength = 0;</TD></TR><TR><TD CLASS="l">617</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">618</TD><TD>            if (this.has41NewNewProt) {</TD></TR><TR CLASS="c"><TD CLASS="l">619</TD><TD>                colLength = packet.readLong();</TD></TR><TR><TD CLASS="l">620</TD><TD>            } else {</TD></TR><TR CLASS="z"><TD CLASS="l">621</TD><TD>                colLength = packet.readLongInt();</TD></TR><TR><TD CLASS="l">622</TD><TD>            }</TD></TR><TR><TD CLASS="l">623</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">624</TD><TD>            int colType = packet.readByte() &amp; 0xff;</TD></TR><TR><TD CLASS="l">625</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">626</TD><TD>            short colFlag = 0;</TD></TR><TR><TD CLASS="l">627</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">628</TD><TD>            if (this.hasLongColumnInfo) {</TD></TR><TR CLASS="c"><TD CLASS="l">629</TD><TD>                colFlag = (short) packet.readInt();</TD></TR><TR><TD CLASS="l">630</TD><TD>            } else {</TD></TR><TR CLASS="z"><TD CLASS="l">631</TD><TD>                colFlag = (short) (packet.readByte() &amp; 0xff);</TD></TR><TR><TD CLASS="l">632</TD><TD>            }</TD></TR><TR><TD CLASS="l">633</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">634</TD><TD>            int colDecimals = packet.readByte() &amp; 0xff;</TD></TR><TR><TD CLASS="l">635</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">636</TD><TD>            int defaultValueStart = -1;</TD></TR><TR CLASS="c"><TD CLASS="l">637</TD><TD>            int defaultValueLength = -1;</TD></TR><TR><TD CLASS="l">638</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">639</TD><TD>            if (extractDefaultValues) {</TD></TR><TR CLASS="z"><TD CLASS="l">640</TD><TD>                defaultValueStart = packet.getPosition() + 1;</TD></TR><TR CLASS="z"><TD CLASS="l">641</TD><TD>                defaultValueLength = packet.fastSkipLenString();</TD></TR><TR><TD CLASS="l">642</TD><TD>            }</TD></TR><TR><TD CLASS="l">643</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">644</TD><TD>            Field field = new Field(this.connection, packet.getByteBuffer(),</TD></TR><TR><TD CLASS="l">645</TD><TD>                    databaseNameStart, databaseNameLength, tableNameStart,</TD></TR><TR><TD CLASS="l">646</TD><TD>                    tableNameLength, originalTableNameStart,</TD></TR><TR><TD CLASS="l">647</TD><TD>                    originalTableNameLength, nameStart, nameLength,</TD></TR><TR><TD CLASS="l">648</TD><TD>                    originalColumnNameStart, originalColumnNameLength,</TD></TR><TR><TD CLASS="l">649</TD><TD>                    colLength, colType, colFlag, colDecimals,</TD></TR><TR><TD CLASS="l">650</TD><TD>                    defaultValueStart, defaultValueLength, charSetNumber);</TD></TR><TR><TD CLASS="l">651</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">652</TD><TD>            return field;</TD></TR><TR><TD CLASS="l">653</TD><TD>        }</TD></TR><TR><TD CLASS="l">654</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">655</TD><TD>        int tableNameStart = packet.getPosition() + 1;</TD></TR><TR CLASS="c"><TD CLASS="l">656</TD><TD>        int tableNameLength = packet.fastSkipLenString();</TD></TR><TR CLASS="c"><TD CLASS="l">657</TD><TD>        tableNameStart = adjustStartForFieldLength(tableNameStart, tableNameLength);</TD></TR><TR><TD CLASS="l">658</TD><TD>        </TD></TR><TR CLASS="c"><TD CLASS="l">659</TD><TD>        int nameStart = packet.getPosition() + 1;</TD></TR><TR CLASS="c"><TD CLASS="l">660</TD><TD>        int nameLength = packet.fastSkipLenString();</TD></TR><TR CLASS="c"><TD CLASS="l">661</TD><TD>        nameStart = adjustStartForFieldLength(nameStart, nameLength);</TD></TR><TR><TD CLASS="l">662</TD><TD>        </TD></TR><TR CLASS="c"><TD CLASS="l">663</TD><TD>        int colLength = packet.readnBytes();</TD></TR><TR CLASS="c"><TD CLASS="l">664</TD><TD>        int colType = packet.readnBytes();</TD></TR><TR CLASS="c"><TD CLASS="l">665</TD><TD>        packet.readByte(); // We know it's currently 2</TD></TR><TR><TD CLASS="l">666</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">667</TD><TD>        short colFlag = 0;</TD></TR><TR><TD CLASS="l">668</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">669</TD><TD>        if (this.hasLongColumnInfo) {</TD></TR><TR CLASS="c"><TD CLASS="l">670</TD><TD>            colFlag = (short) (packet.readInt());</TD></TR><TR><TD CLASS="l">671</TD><TD>        } else {</TD></TR><TR CLASS="z"><TD CLASS="l">672</TD><TD>            colFlag = (short) (packet.readByte() &amp; 0xff);</TD></TR><TR><TD CLASS="l">673</TD><TD>        }</TD></TR><TR><TD CLASS="l">674</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">675</TD><TD>        int colDecimals = (packet.readByte() &amp; 0xff);</TD></TR><TR><TD CLASS="l">676</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">677</TD><TD>        if (this.colDecimalNeedsBump) {</TD></TR><TR CLASS="z"><TD CLASS="l">678</TD><TD>            colDecimals++;</TD></TR><TR><TD CLASS="l">679</TD><TD>        }</TD></TR><TR><TD CLASS="l">680</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">681</TD><TD>        Field field = new Field(this.connection, packet.getByteBuffer(),</TD></TR><TR><TD CLASS="l">682</TD><TD>                nameStart, nameLength, tableNameStart, tableNameLength,</TD></TR><TR><TD CLASS="l">683</TD><TD>                colLength, colType, colFlag, colDecimals);</TD></TR><TR><TD CLASS="l">684</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="12">685</A></TD><TD>        return field;</TD></TR><TR><TD CLASS="l">686</TD><TD>    }</TD></TR><TR><TD CLASS="l">687</TD><TD> </TD></TR><TR><TD CLASS="l">688</TD><TD>    private int adjustStartForFieldLength(int nameStart, int nameLength) {</TD></TR><TR CLASS="c"><TD CLASS="l">689</TD><TD>            if (nameLength &lt; 251) {</TD></TR><TR CLASS="c"><TD CLASS="l">690</TD><TD>                    return nameStart;</TD></TR><TR><TD CLASS="l">691</TD><TD>            }</TD></TR><TR><TD CLASS="l">692</TD><TD>            </TD></TR><TR CLASS="c"><TD CLASS="l">693</TD><TD>                if (nameLength &gt;= 251 &amp;&amp; nameLength &lt; 65536) {</TD></TR><TR CLASS="c"><TD CLASS="l">694</TD><TD>                        return nameStart + 2;</TD></TR><TR><TD CLASS="l">695</TD><TD>                }</TD></TR><TR><TD CLASS="l">696</TD><TD>                </TD></TR><TR CLASS="z"><TD CLASS="l">697</TD><TD>                if (nameLength &gt;= 65536 &amp;&amp; nameLength &lt; 16777216) {</TD></TR><TR CLASS="z"><TD CLASS="l">698</TD><TD>                        return nameStart + 3;</TD></TR><TR><TD CLASS="l">699</TD><TD>                }</TD></TR><TR><TD CLASS="l">700</TD><TD>                </TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="e">701</A></TD><TD>                return nameStart + 8;</TD></TR><TR><TD CLASS="l">702</TD><TD>        }</TD></TR><TR><TD CLASS="l">703</TD><TD> </TD></TR><TR><TD CLASS="l">704</TD><TD>        protected boolean isSetNeededForAutoCommitMode(boolean autoCommitFlag) {</TD></TR><TR CLASS="c"><TD CLASS="l">705</TD><TD>        if (this.use41Extensions &amp;&amp; this.connection.getElideSetAutoCommits()) {</TD></TR><TR CLASS="z"><TD CLASS="l">706</TD><TD>            boolean autoCommitModeOnServer = ((this.serverStatus &amp;</TD></TR><TR><TD CLASS="l">707</TD><TD>                SERVER_STATUS_AUTOCOMMIT) != 0);</TD></TR><TR><TD CLASS="l">708</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">709</TD><TD>            if (!autoCommitFlag) {</TD></TR><TR><TD CLASS="l">710</TD><TD>                // Just to be safe, check if a transaction is in progress on the server....</TD></TR><TR><TD CLASS="l">711</TD><TD>                // if so, then we must be in autoCommit == false</TD></TR><TR><TD CLASS="l">712</TD><TD>                // therefore return the opposite of transaction status</TD></TR><TR CLASS="z"><TD CLASS="l">713</TD><TD>                boolean inTransactionOnServer = ((this.serverStatus &amp;</TD></TR><TR><TD CLASS="l">714</TD><TD>                    SERVER_STATUS_IN_TRANS) != 0);</TD></TR><TR><TD CLASS="l">715</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">716</TD><TD>                return !inTransactionOnServer;</TD></TR><TR><TD CLASS="l">717</TD><TD>            }</TD></TR><TR><TD CLASS="l">718</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">719</TD><TD>            return !autoCommitModeOnServer;</TD></TR><TR><TD CLASS="l">720</TD><TD>        }</TD></TR><TR><TD CLASS="l">721</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">722</TD><TD>        return true;</TD></TR><TR><TD CLASS="l">723</TD><TD>    }</TD></TR><TR><TD CLASS="l">724</TD><TD> </TD></TR><TR><TD CLASS="l">725</TD><TD>    /**</TD></TR><TR><TD CLASS="l">726</TD><TD>     * Re-authenticates as the given user and password</TD></TR><TR><TD CLASS="l">727</TD><TD>     *</TD></TR><TR><TD CLASS="l">728</TD><TD>     * @param userName DOCUMENT ME!</TD></TR><TR><TD CLASS="l">729</TD><TD>     * @param password DOCUMENT ME!</TD></TR><TR><TD CLASS="l">730</TD><TD>     * @param database DOCUMENT ME!</TD></TR><TR><TD CLASS="l">731</TD><TD>     *</TD></TR><TR><TD CLASS="l"><A NAME="23">732</A></TD><TD>     * @throws SQLException DOCUMENT ME!</TD></TR><TR><TD CLASS="l">733</TD><TD>     */</TD></TR><TR><TD CLASS="l">734</TD><TD>    protected void changeUser(String userName, String password, String database)</TD></TR><TR><TD CLASS="l">735</TD><TD>        throws SQLException {</TD></TR><TR CLASS="c"><TD CLASS="l">736</TD><TD>        this.packetSequence = -1;</TD></TR><TR><TD CLASS="l">737</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">738</TD><TD>        int passwordLength = 16;</TD></TR><TR CLASS="c"><TD CLASS="l">739</TD><TD>        int userLength = 0;</TD></TR><TR><TD CLASS="l">740</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">741</TD><TD>        if (userName != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">742</TD><TD>            userLength = userName.length();</TD></TR><TR><TD CLASS="l">743</TD><TD>        }</TD></TR><TR><TD CLASS="l">744</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">745</TD><TD>        int packLength = (userLength + passwordLength) + 7 + HEADER_LENGTH;</TD></TR><TR><TD CLASS="l">746</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">747</TD><TD>        if ((this.serverCapabilities &amp; CLIENT_SECURE_CONNECTION) != 0) {</TD></TR><TR CLASS="c"><TD CLASS="l">748</TD><TD>            Buffer changeUserPacket = Buffer.allocateNew(packLength + 1,</TD></TR><TR><TD CLASS="l">749</TD><TD>                    this.useNewIo);</TD></TR><TR CLASS="c"><TD CLASS="l">750</TD><TD>            changeUserPacket.writeByte((byte) MysqlDefs.COM_CHANGE_USER);</TD></TR><TR><TD CLASS="l">751</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">752</TD><TD>            if (versionMeetsMinimum(4, 1, 1)) {</TD></TR><TR CLASS="c"><TD CLASS="l">753</TD><TD>                secureAuth411(changeUserPacket, packLength, userName, password,</TD></TR><TR><TD CLASS="l">754</TD><TD>                    database, false);</TD></TR><TR><TD CLASS="l">755</TD><TD>            } else {</TD></TR><TR CLASS="p"><TD TITLE="11% line coverage (1 out of 9 instructions)" CLASS="l">756</TD><TD TITLE="11% line coverage (1 out of 9 instructions)">                secureAuth(changeUserPacket, packLength, userName, password,</TD></TR><TR><TD CLASS="l">757</TD><TD>                    database, false);</TD></TR><TR><TD CLASS="l">758</TD><TD>            }</TD></TR><TR><TD CLASS="l">759</TD><TD>        } else {</TD></TR><TR><TD CLASS="l">760</TD><TD>            // Passwords can be 16 chars long</TD></TR><TR CLASS="c"><TD CLASS="l">761</TD><TD>            Buffer packet = Buffer.allocateNew(packLength, this.useNewIo);</TD></TR><TR CLASS="c"><TD CLASS="l">762</TD><TD>            packet.writeByte((byte) MysqlDefs.COM_CHANGE_USER);</TD></TR><TR><TD CLASS="l">763</TD><TD> </TD></TR><TR><TD CLASS="l">764</TD><TD>            // User/Password data</TD></TR><TR CLASS="c"><TD CLASS="l">765</TD><TD>            packet.writeString(userName);</TD></TR><TR><TD CLASS="l">766</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">767</TD><TD>            if (this.protocolVersion &gt; 9) {</TD></TR><TR CLASS="c"><TD CLASS="l">768</TD><TD>                packet.writeString(Util.newCrypt(password, this.seed));</TD></TR><TR><TD CLASS="l">769</TD><TD>            } else {</TD></TR><TR CLASS="z"><TD CLASS="l">770</TD><TD>                packet.writeString(Util.oldCrypt(password, this.seed));</TD></TR><TR><TD CLASS="l">771</TD><TD>            }</TD></TR><TR><TD CLASS="l">772</TD><TD> </TD></TR><TR CLASS="p"><TD TITLE="93% line coverage (13 out of 14 instructions)" CLASS="l">773</TD><TD TITLE="93% line coverage (13 out of 14 instructions)">                        boolean localUseConnectWithDb = this.useConnectWithDb &amp;&amp; </TD></TR><TR><TD CLASS="l">774</TD><TD>                                (database != null &amp;&amp; database.length() &gt; 0);</TD></TR><TR><TD CLASS="l">775</TD><TD>                        </TD></TR><TR CLASS="c"><TD CLASS="l">776</TD><TD>            if (localUseConnectWithDb) {</TD></TR><TR CLASS="c"><TD CLASS="l">777</TD><TD>                packet.writeString(database);</TD></TR><TR><TD CLASS="l">778</TD><TD>            }</TD></TR><TR><TD CLASS="l">779</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">780</TD><TD>            send(packet);</TD></TR><TR CLASS="c"><TD CLASS="l">781</TD><TD>            checkErrorPacket();</TD></TR><TR><TD CLASS="l">782</TD><TD>                        </TD></TR><TR CLASS="c"><TD CLASS="l">783</TD><TD>                        if (!localUseConnectWithDb) {</TD></TR><TR CLASS="z"><TD CLASS="l">784</TD><TD>                                changeDatabaseTo(database);</TD></TR><TR><TD CLASS="l">785</TD><TD>                        }</TD></TR><TR><TD CLASS="l">786</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">787</TD><TD>    }</TD></TR><TR><TD CLASS="l">788</TD><TD> </TD></TR><TR><TD CLASS="l">789</TD><TD>    /**</TD></TR><TR><TD CLASS="l">790</TD><TD>     * Checks for errors in the reply packet, and if none, returns the reply</TD></TR><TR><TD CLASS="l">791</TD><TD>     * packet, ready for reading</TD></TR><TR><TD CLASS="l">792</TD><TD>     *</TD></TR><TR><TD CLASS="l">793</TD><TD>     * @return a packet ready for reading.</TD></TR><TR><TD CLASS="l"><A NAME="32">794</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">795</TD><TD>     * @throws SQLException is the packet is an error packet</TD></TR><TR><TD CLASS="l">796</TD><TD>     */</TD></TR><TR><TD CLASS="l">797</TD><TD>    protected Buffer checkErrorPacket() throws SQLException {</TD></TR><TR CLASS="c"><TD CLASS="l">798</TD><TD>        return checkErrorPacket(-1);</TD></TR><TR><TD CLASS="l">799</TD><TD>    }</TD></TR><TR><TD CLASS="l">800</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="20">801</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">802</TD><TD>     * Determines if the database charset is the same as the platform charset</TD></TR><TR><TD CLASS="l">803</TD><TD>     */</TD></TR><TR><TD CLASS="l">804</TD><TD>    protected void checkForCharsetMismatch() {</TD></TR><TR CLASS="c"><TD CLASS="l">805</TD><TD>        if (this.connection.getUseUnicode() &amp;&amp;</TD></TR><TR><TD CLASS="l">806</TD><TD>                (this.connection.getEncoding() != null)) {</TD></TR><TR CLASS="c"><TD CLASS="l">807</TD><TD>            String encodingToCheck = jvmPlatformCharset;</TD></TR><TR><TD CLASS="l">808</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">809</TD><TD>            if (encodingToCheck == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">810</TD><TD>                encodingToCheck = System.getProperty(&#34;file.encoding&#34;); //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">811</TD><TD>            }</TD></TR><TR><TD CLASS="l">812</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">813</TD><TD>            if (encodingToCheck == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">814</TD><TD>                this.platformDbCharsetMatches = false;</TD></TR><TR><TD CLASS="l">815</TD><TD>            } else {</TD></TR><TR CLASS="c"><TD CLASS="l">816</TD><TD>                this.platformDbCharsetMatches = encodingToCheck.equals(this.connection.getEncoding());</TD></TR><TR><TD CLASS="l">817</TD><TD>            }</TD></TR><TR><TD CLASS="l"><A NAME="14">818</A></TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">819</TD><TD>    }</TD></TR><TR><TD CLASS="l">820</TD><TD> </TD></TR><TR><TD CLASS="l">821</TD><TD>    protected void clearInputStream() throws SQLException {</TD></TR><TR CLASS="c"><TD CLASS="l">822</TD><TD>        if (!this.useNewIo) {</TD></TR><TR><TD CLASS="l">823</TD><TD>            try {</TD></TR><TR CLASS="c"><TD CLASS="l">824</TD><TD>                int len = this.mysqlInput.available();</TD></TR><TR><TD CLASS="l">825</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">826</TD><TD>                while (len &gt; 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">827</TD><TD>                    this.mysqlInput.skip(len);</TD></TR><TR CLASS="z"><TD CLASS="l">828</TD><TD>                    len = this.mysqlInput.available();</TD></TR><TR><TD CLASS="l">829</TD><TD>                }</TD></TR><TR CLASS="c"><TD CLASS="l">830</TD><TD>            } catch (IOException ioEx) {</TD></TR><TR CLASS="c"><TD CLASS="l">831</TD><TD>                throw new CommunicationsException(this.connection,</TD></TR><TR><TD CLASS="l">832</TD><TD>                    this.lastPacketSentTimeMs, ioEx);</TD></TR><TR CLASS="c"><TD CLASS="l">833</TD><TD>            }</TD></TR><TR><TD CLASS="l">834</TD><TD>        } else {</TD></TR><TR><TD CLASS="l">835</TD><TD>            //try {</TD></TR><TR><TD CLASS="l">836</TD><TD>            //if (this.mysqlInput.available() != 0) {</TD></TR><TR><TD CLASS="l">837</TD><TD>            try {</TD></TR><TR CLASS="c"><TD CLASS="l">838</TD><TD>                this.socketChannel.configureBlocking(false);</TD></TR><TR><TD CLASS="l">839</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">840</TD><TD>                int len = 0;</TD></TR><TR><TD CLASS="l">841</TD><TD> </TD></TR><TR><TD CLASS="l">842</TD><TD>                while (true) {</TD></TR><TR CLASS="c"><TD CLASS="l">843</TD><TD>                    len = this.socketChannel.read(this.channelClearBuf);</TD></TR><TR><TD CLASS="l">844</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">845</TD><TD>                    if ((len == 0) || (len == -1)) {</TD></TR><TR CLASS="c"><TD CLASS="l">846</TD><TD>                        break;</TD></TR><TR><TD CLASS="l">847</TD><TD>                    }</TD></TR><TR><TD CLASS="l">848</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">849</TD><TD>                    this.channelClearBuf.clear();</TD></TR><TR><TD CLASS="l">850</TD><TD>                }</TD></TR><TR CLASS="p"><TD TITLE="9% line coverage (1 out of 11 instructions)" CLASS="l">851</TD><TD TITLE="9% line coverage (1 out of 11 instructions)">            } catch (IOException ioEx) {</TD></TR><TR CLASS="z"><TD CLASS="l">852</TD><TD>                throw new CommunicationsException(this.connection,</TD></TR><TR><TD CLASS="l">853</TD><TD>                    this.lastPacketSentTimeMs, ioEx);</TD></TR><TR><TD CLASS="l">854</TD><TD>            } finally {</TD></TR><TR CLASS="p"><TD TITLE="64% line coverage (7 out of 11 instructions)" CLASS="l">855</TD><TD TITLE="64% line coverage (7 out of 11 instructions)">                try {</TD></TR><TR CLASS="c"><TD CLASS="l">856</TD><TD>                    this.socketChannel.configureBlocking(true);</TD></TR><TR CLASS="z"><TD CLASS="l">857</TD><TD>                } catch (IOException ioEx) {</TD></TR><TR CLASS="z"><TD CLASS="l">858</TD><TD>                    throw new CommunicationsException(this.connection,</TD></TR><TR><TD CLASS="l">859</TD><TD>                        this.lastPacketSentTimeMs, ioEx);</TD></TR><TR CLASS="c"><TD CLASS="l">860</TD><TD>                }</TD></TR><TR CLASS="c"><TD CLASS="l">861</TD><TD>            }</TD></TR><TR><TD CLASS="l">862</TD><TD> </TD></TR><TR><TD CLASS="l">863</TD><TD>            //}</TD></TR><TR><TD CLASS="l">864</TD><TD>            //} catch (IOException ioEx) {</TD></TR><TR><TD CLASS="l">865</TD><TD>            //        throw new CommunicationsException(this.connection,</TD></TR><TR><TD CLASS="l">866</TD><TD>            //                        this.lastPacketSentTimeMs, ioEx);</TD></TR><TR><TD CLASS="l">867</TD><TD>            //} </TD></TR><TR><TD CLASS="l"><A NAME="a">868</A></TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">869</TD><TD>    }</TD></TR><TR><TD CLASS="l">870</TD><TD> </TD></TR><TR><TD CLASS="l">871</TD><TD>    protected void resetReadPacketSequence() {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="4">872</A></TD><TD>        this.readPacketSequence = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">873</TD><TD>    }</TD></TR><TR><TD CLASS="l">874</TD><TD> </TD></TR><TR><TD CLASS="l">875</TD><TD>    protected void dumpPacketRingBuffer() throws SQLException {</TD></TR><TR CLASS="z"><TD CLASS="l">876</TD><TD>        if ((this.packetDebugRingBuffer != null) &amp;&amp;</TD></TR><TR><TD CLASS="l">877</TD><TD>                this.connection.getEnablePacketDebug()) {</TD></TR><TR CLASS="z"><TD CLASS="l">878</TD><TD>            StringBuffer dumpBuffer = new StringBuffer();</TD></TR><TR><TD CLASS="l">879</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">880</TD><TD>            dumpBuffer.append(&#34;Last &#34; + this.packetDebugRingBuffer.size() +</TD></TR><TR><TD CLASS="l">881</TD><TD>                &#34; packets received from server, from oldest-&gt;newest:\n&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">882</TD><TD>            dumpBuffer.append(&#34;\n&#34;);</TD></TR><TR><TD CLASS="l">883</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">884</TD><TD>            for (Iterator ringBufIter = this.packetDebugRingBuffer.iterator();</TD></TR><TR CLASS="z"><TD CLASS="l">885</TD><TD>                    ringBufIter.hasNext();) {</TD></TR><TR CLASS="z"><TD CLASS="l">886</TD><TD>                dumpBuffer.append((StringBuffer) ringBufIter.next());</TD></TR><TR CLASS="z"><TD CLASS="l">887</TD><TD>                dumpBuffer.append(&#34;\n&#34;);</TD></TR><TR><TD CLASS="l">888</TD><TD>            }</TD></TR><TR><TD CLASS="l">889</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">890</TD><TD>            this.connection.getLog().logTrace(dumpBuffer.toString());</TD></TR><TR><TD CLASS="l">891</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">892</TD><TD>    }</TD></TR><TR><TD CLASS="l">893</TD><TD> </TD></TR><TR><TD CLASS="l">894</TD><TD>    /**</TD></TR><TR><TD CLASS="l">895</TD><TD>     * Runs an 'EXPLAIN' on the given query and dumps the results to  the log</TD></TR><TR><TD CLASS="l">896</TD><TD>     *</TD></TR><TR><TD CLASS="l">897</TD><TD>     * @param querySQL DOCUMENT ME!</TD></TR><TR><TD CLASS="l">898</TD><TD>     * @param truncatedQuery DOCUMENT ME!</TD></TR><TR><TD CLASS="l">899</TD><TD>     *</TD></TR><TR><TD CLASS="l"><A NAME="28">900</A></TD><TD>     * @throws SQLException DOCUMENT ME!</TD></TR><TR><TD CLASS="l">901</TD><TD>     */</TD></TR><TR><TD CLASS="l">902</TD><TD>    protected void explainSlowQuery(byte[] querySQL, String truncatedQuery)</TD></TR><TR><TD CLASS="l">903</TD><TD>        throws SQLException {</TD></TR><TR CLASS="c"><TD CLASS="l">904</TD><TD>        if (StringUtils.startsWithIgnoreCaseAndWs(truncatedQuery, &#34;SELECT&#34;)) { //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">905</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">906</TD><TD>            PreparedStatement stmt = null;</TD></TR><TR CLASS="c"><TD CLASS="l">907</TD><TD>            java.sql.ResultSet rs = null;</TD></TR><TR><TD CLASS="l">908</TD><TD> </TD></TR><TR><TD CLASS="l">909</TD><TD>            try {</TD></TR><TR CLASS="c"><TD CLASS="l">910</TD><TD>                stmt = this.connection.clientPrepareStatement(&#34;EXPLAIN ?&#34;); //$NON-NLS-1$</TD></TR><TR CLASS="c"><TD CLASS="l">911</TD><TD>                stmt.setBytesNoEscapeNoQuotes(1, querySQL);</TD></TR><TR CLASS="c"><TD CLASS="l">912</TD><TD>                rs = stmt.executeQuery();</TD></TR><TR><TD CLASS="l">913</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">914</TD><TD>                StringBuffer explainResults = new StringBuffer(Messages.getString(</TD></TR><TR><TD CLASS="l">915</TD><TD>                            &#34;MysqlIO.8&#34;) + truncatedQuery //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">916</TD><TD>                         +Messages.getString(&#34;MysqlIO.9&#34;)); //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">917</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">918</TD><TD>                ResultSetUtil.appendResultSetSlashGStyle(explainResults, rs);</TD></TR><TR><TD CLASS="l">919</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">920</TD><TD>                this.connection.getLog().logWarn(explainResults.toString());</TD></TR><TR CLASS="p"><TD TITLE="96% line coverage (43 out of 45 instructions)" CLASS="l">921</TD><TD TITLE="96% line coverage (43 out of 45 instructions)">            } catch (SQLException sqlEx) {</TD></TR><TR CLASS="z"><TD CLASS="l">922</TD><TD>            } finally {</TD></TR><TR CLASS="p"><TD TITLE="43% line coverage (3 out of 7 instructions)" CLASS="l">923</TD><TD TITLE="43% line coverage (3 out of 7 instructions)">                if (rs != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">924</TD><TD>                    rs.close();</TD></TR><TR><TD CLASS="l">925</TD><TD>                }</TD></TR><TR><TD CLASS="l">926</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">927</TD><TD>                if (stmt != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">928</TD><TD>                    stmt.close();</TD></TR><TR><TD CLASS="l">929</TD><TD>                }</TD></TR><TR CLASS="p"><TD TITLE="50% line coverage (1 out of 2 instructions)" CLASS="l">930</TD><TD TITLE="50% line coverage (1 out of 2 instructions)">            }</TD></TR><TR><TD CLASS="l">931</TD><TD>        } else {</TD></TR><TR><TD CLASS="l"><A NAME="37">932</A></TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">933</TD><TD>    }</TD></TR><TR><TD CLASS="l">934</TD><TD> </TD></TR><TR><TD CLASS="l">935</TD><TD>    static int getMaxBuf() {</TD></TR><TR CLASS="c"><TD CLASS="l">936</TD><TD>        return maxBufferSize;</TD></TR><TR><TD CLASS="l">937</TD><TD>    }</TD></TR><TR><TD CLASS="l">938</TD><TD> </TD></TR><TR><TD CLASS="l">939</TD><TD>    /**</TD></TR><TR><TD CLASS="l">940</TD><TD>     * Get the major version of the MySQL server we are talking to.</TD></TR><TR><TD CLASS="l"><A NAME="39">941</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">942</TD><TD>     * @return DOCUMENT ME!</TD></TR><TR><TD CLASS="l">943</TD><TD>     */</TD></TR><TR><TD CLASS="l">944</TD><TD>    final int getServerMajorVersion() {</TD></TR><TR CLASS="c"><TD CLASS="l">945</TD><TD>        return this.serverMajorVersion;</TD></TR><TR><TD CLASS="l">946</TD><TD>    }</TD></TR><TR><TD CLASS="l">947</TD><TD> </TD></TR><TR><TD CLASS="l">948</TD><TD>    /**</TD></TR><TR><TD CLASS="l">949</TD><TD>     * Get the minor version of the MySQL server we are talking to.</TD></TR><TR><TD CLASS="l"><A NAME="3a">950</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">951</TD><TD>     * @return DOCUMENT ME!</TD></TR><TR><TD CLASS="l">952</TD><TD>     */</TD></TR><TR><TD CLASS="l">953</TD><TD>    final int getServerMinorVersion() {</TD></TR><TR CLASS="c"><TD CLASS="l">954</TD><TD>        return this.serverMinorVersion;</TD></TR><TR><TD CLASS="l">955</TD><TD>    }</TD></TR><TR><TD CLASS="l">956</TD><TD> </TD></TR><TR><TD CLASS="l">957</TD><TD>    /**</TD></TR><TR><TD CLASS="l">958</TD><TD>     * Get the sub-minor version of the MySQL server we are talking to.</TD></TR><TR><TD CLASS="l"><A NAME="3b">959</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">960</TD><TD>     * @return DOCUMENT ME!</TD></TR><TR><TD CLASS="l">961</TD><TD>     */</TD></TR><TR><TD CLASS="l">962</TD><TD>    final int getServerSubMinorVersion() {</TD></TR><TR CLASS="c"><TD CLASS="l">963</TD><TD>        return this.serverSubMinorVersion;</TD></TR><TR><TD CLASS="l">964</TD><TD>    }</TD></TR><TR><TD CLASS="l">965</TD><TD> </TD></TR><TR><TD CLASS="l">966</TD><TD>    /**</TD></TR><TR><TD CLASS="l">967</TD><TD>     * Get the version string of the server we are talking to</TD></TR><TR><TD CLASS="l"><A NAME="3c">968</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">969</TD><TD>     * @return DOCUMENT ME!</TD></TR><TR><TD CLASS="l">970</TD><TD>     */</TD></TR><TR><TD CLASS="l">971</TD><TD>    String getServerVersion() {</TD></TR><TR CLASS="c"><TD CLASS="l">972</TD><TD>        return this.serverVersion;</TD></TR><TR><TD CLASS="l">973</TD><TD>    }</TD></TR><TR><TD CLASS="l">974</TD><TD> </TD></TR><TR><TD CLASS="l">975</TD><TD>    /**</TD></TR><TR><TD CLASS="l">976</TD><TD>     * Initialize communications with the MySQL server. Handles logging on, and</TD></TR><TR><TD CLASS="l">977</TD><TD>     * handling initial connection errors.</TD></TR><TR><TD CLASS="l">978</TD><TD>     *</TD></TR><TR><TD CLASS="l">979</TD><TD>     * @param user DOCUMENT ME!</TD></TR><TR><TD CLASS="l">980</TD><TD>     * @param password DOCUMENT ME!</TD></TR><TR><TD CLASS="l">981</TD><TD>     * @param database DOCUMENT ME!</TD></TR><TR><TD CLASS="l">982</TD><TD>     *</TD></TR><TR><TD CLASS="l">983</TD><TD>     * @throws SQLException DOCUMENT ME!</TD></TR><TR><TD CLASS="l">984</TD><TD>     * @throws CommunicationsException DOCUMENT ME!</TD></TR><TR><TD CLASS="l"><A NAME="1c">985</A></TD><TD>     */</TD></TR><TR><TD CLASS="l">986</TD><TD>    void doHandshake(String user, String password, String database)</TD></TR><TR><TD CLASS="l">987</TD><TD>        throws SQLException {</TD></TR><TR><TD CLASS="l">988</TD><TD>        // Read the first packet</TD></TR><TR CLASS="c"><TD CLASS="l">989</TD><TD>        this.checkPacketSequence = false;</TD></TR><TR CLASS="c"><TD CLASS="l">990</TD><TD>        this.readPacketSequence = 0;</TD></TR><TR><TD CLASS="l">991</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">992</TD><TD>        Buffer buf = readPacket();</TD></TR><TR><TD CLASS="l">993</TD><TD> </TD></TR><TR><TD CLASS="l">994</TD><TD>        // Get the protocol version</TD></TR><TR CLASS="c"><TD CLASS="l">995</TD><TD>        this.protocolVersion = buf.readByte();</TD></TR><TR><TD CLASS="l">996</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">997</TD><TD>        if (this.protocolVersion == -1) {</TD></TR><TR><TD CLASS="l">998</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">999</TD><TD>                this.mysqlConnection.close();</TD></TR><TR CLASS="z"><TD CLASS="l">1000</TD><TD>            } catch (Exception e) {</TD></TR><TR><TD CLASS="l">1001</TD><TD>                ; // ignore</TD></TR><TR CLASS="z"><TD CLASS="l">1002</TD><TD>            }</TD></TR><TR><TD CLASS="l">1003</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1004</TD><TD>            int errno = 2000;</TD></TR><TR><TD CLASS="l">1005</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1006</TD><TD>            errno = buf.readInt();</TD></TR><TR><TD CLASS="l">1007</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1008</TD><TD>            String serverErrorMessage = buf.readString();</TD></TR><TR><TD CLASS="l">1009</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1010</TD><TD>            StringBuffer errorBuf = new StringBuffer(Messages.getString(</TD></TR><TR><TD CLASS="l">1011</TD><TD>                        &#34;MysqlIO.10&#34;)); //$NON-NLS-1$</TD></TR><TR CLASS="z"><TD CLASS="l">1012</TD><TD>            errorBuf.append(serverErrorMessage);</TD></TR><TR CLASS="z"><TD CLASS="l">1013</TD><TD>            errorBuf.append(&#34;\&#34;&#34;); //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">1014</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1015</TD><TD>            String xOpen = SQLError.mysqlToSqlState(errno,</TD></TR><TR><TD CLASS="l">1016</TD><TD>                    this.connection.getUseSqlStateCodes());</TD></TR><TR><TD CLASS="l">1017</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1018</TD><TD>            throw new SQLException(SQLError.get(xOpen) + &#34;, &#34; //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">1019</TD><TD>                 +errorBuf.toString(), xOpen, errno);</TD></TR><TR><TD CLASS="l">1020</TD><TD>        }</TD></TR><TR><TD CLASS="l">1021</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1022</TD><TD>        this.serverVersion = buf.readString();</TD></TR><TR><TD CLASS="l">1023</TD><TD> </TD></TR><TR><TD CLASS="l">1024</TD><TD>        // Parse the server version into major/minor/subminor</TD></TR><TR CLASS="c"><TD CLASS="l">1025</TD><TD>        int point = this.serverVersion.indexOf(&#34;.&#34;); //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">1026</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1027</TD><TD>        if (point != -1) {</TD></TR><TR><TD CLASS="l">1028</TD><TD>            try {</TD></TR><TR CLASS="c"><TD CLASS="l">1029</TD><TD>                int n = Integer.parseInt(this.serverVersion.substring(0, point));</TD></TR><TR CLASS="c"><TD CLASS="l">1030</TD><TD>                this.serverMajorVersion = n;</TD></TR><TR CLASS="z"><TD CLASS="l">1031</TD><TD>            } catch (NumberFormatException NFE1) {</TD></TR><TR><TD CLASS="l">1032</TD><TD>                ;</TD></TR><TR CLASS="c"><TD CLASS="l">1033</TD><TD>            }</TD></TR><TR><TD CLASS="l">1034</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1035</TD><TD>            String remaining = this.serverVersion.substring(point + 1,</TD></TR><TR><TD CLASS="l">1036</TD><TD>                    this.serverVersion.length());</TD></TR><TR CLASS="c"><TD CLASS="l">1037</TD><TD>            point = remaining.indexOf(&#34;.&#34;); //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">1038</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1039</TD><TD>            if (point != -1) {</TD></TR><TR><TD CLASS="l">1040</TD><TD>                try {</TD></TR><TR CLASS="c"><TD CLASS="l">1041</TD><TD>                    int n = Integer.parseInt(remaining.substring(0, point));</TD></TR><TR CLASS="c"><TD CLASS="l">1042</TD><TD>                    this.serverMinorVersion = n;</TD></TR><TR CLASS="z"><TD CLASS="l">1043</TD><TD>                } catch (NumberFormatException nfe) {</TD></TR><TR><TD CLASS="l">1044</TD><TD>                    ;</TD></TR><TR CLASS="c"><TD CLASS="l">1045</TD><TD>                }</TD></TR><TR><TD CLASS="l">1046</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1047</TD><TD>                remaining = remaining.substring(point + 1, remaining.length());</TD></TR><TR><TD CLASS="l">1048</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1049</TD><TD>                int pos = 0;</TD></TR><TR><TD CLASS="l">1050</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1051</TD><TD>                while (pos &lt; remaining.length()) {</TD></TR><TR CLASS="c"><TD CLASS="l">1052</TD><TD>                    if ((remaining.charAt(pos) &lt; '0') ||</TD></TR><TR><TD CLASS="l">1053</TD><TD>                            (remaining.charAt(pos) &gt; '9')) {</TD></TR><TR CLASS="z"><TD CLASS="l">1054</TD><TD>                        break;</TD></TR><TR><TD CLASS="l">1055</TD><TD>                    }</TD></TR><TR><TD CLASS="l">1056</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1057</TD><TD>                    pos++;</TD></TR><TR><TD CLASS="l">1058</TD><TD>                }</TD></TR><TR><TD CLASS="l">1059</TD><TD> </TD></TR><TR><TD CLASS="l">1060</TD><TD>                try {</TD></TR><TR CLASS="c"><TD CLASS="l">1061</TD><TD>                    int n = Integer.parseInt(remaining.substring(0, pos));</TD></TR><TR CLASS="c"><TD CLASS="l">1062</TD><TD>                    this.serverSubMinorVersion = n;</TD></TR><TR CLASS="z"><TD CLASS="l">1063</TD><TD>                } catch (NumberFormatException nfe) {</TD></TR><TR><TD CLASS="l">1064</TD><TD>                    ;</TD></TR><TR CLASS="c"><TD CLASS="l">1065</TD><TD>                }</TD></TR><TR><TD CLASS="l">1066</TD><TD>            }</TD></TR><TR><TD CLASS="l">1067</TD><TD>        }</TD></TR><TR><TD CLASS="l">1068</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1069</TD><TD>        if (versionMeetsMinimum(4, 0, 8)) {</TD></TR><TR CLASS="c"><TD CLASS="l">1070</TD><TD>            this.maxThreeBytes = (256 * 256 * 256) - 1;</TD></TR><TR CLASS="c"><TD CLASS="l">1071</TD><TD>            this.useNewLargePackets = true;</TD></TR><TR><TD CLASS="l">1072</TD><TD>        } else {</TD></TR><TR CLASS="z"><TD CLASS="l">1073</TD><TD>            this.maxThreeBytes = 255 * 255 * 255;</TD></TR><TR CLASS="z"><TD CLASS="l">1074</TD><TD>            this.useNewLargePackets = false;</TD></TR><TR><TD CLASS="l">1075</TD><TD>        }</TD></TR><TR><TD CLASS="l">1076</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1077</TD><TD>        this.colDecimalNeedsBump = versionMeetsMinimum(3, 23, 0);</TD></TR><TR CLASS="p"><TD TITLE="95% line coverage (38 out of 40 instructions)" CLASS="l">1078</TD><TD TITLE="95% line coverage (38 out of 40 instructions)">        this.colDecimalNeedsBump = !versionMeetsMinimum(3, 23, 15); // guess? Not noted in changelog</TD></TR><TR CLASS="c"><TD CLASS="l">1079</TD><TD>        this.useNewUpdateCounts = versionMeetsMinimum(3, 22, 5);</TD></TR><TR><TD CLASS="l">1080</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1081</TD><TD>        buf.readLong(); // thread id -- we don't use it</TD></TR><TR CLASS="c"><TD CLASS="l">1082</TD><TD>        this.seed = buf.readString();</TD></TR><TR><TD CLASS="l">1083</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1084</TD><TD>        this.serverCapabilities = 0;</TD></TR><TR><TD CLASS="l">1085</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1086</TD><TD>        if (buf.getPosition() &lt; buf.getBufLength()) {</TD></TR><TR CLASS="c"><TD CLASS="l">1087</TD><TD>            this.serverCapabilities = buf.readInt();</TD></TR><TR><TD CLASS="l">1088</TD><TD>        }</TD></TR><TR><TD CLASS="l">1089</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1090</TD><TD>        if (versionMeetsMinimum(4, 1, 1)) {</TD></TR><TR CLASS="c"><TD CLASS="l">1091</TD><TD>            int position = buf.getPosition();</TD></TR><TR><TD CLASS="l">1092</TD><TD> </TD></TR><TR><TD CLASS="l">1093</TD><TD>            /* New protocol with 16 bytes to describe server characteristics */</TD></TR><TR CLASS="c"><TD CLASS="l">1094</TD><TD>            this.serverCharsetIndex = buf.readByte() &amp; 0xff;</TD></TR><TR CLASS="c"><TD CLASS="l">1095</TD><TD>            this.serverStatus = buf.readInt();</TD></TR><TR CLASS="c"><TD CLASS="l">1096</TD><TD>            buf.setPosition(position + 16);</TD></TR><TR><TD CLASS="l">1097</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1098</TD><TD>            String seedPart2 = buf.readString();</TD></TR><TR CLASS="c"><TD CLASS="l">1099</TD><TD>            StringBuffer newSeed = new StringBuffer(20);</TD></TR><TR CLASS="c"><TD CLASS="l">1100</TD><TD>            newSeed.append(this.seed);</TD></TR><TR CLASS="c"><TD CLASS="l">1101</TD><TD>            newSeed.append(seedPart2);</TD></TR><TR CLASS="c"><TD CLASS="l">1102</TD><TD>            this.seed = newSeed.toString();</TD></TR><TR><TD CLASS="l">1103</TD><TD>        }</TD></TR><TR><TD CLASS="l">1104</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1105</TD><TD>        if (((this.serverCapabilities &amp; CLIENT_COMPRESS) != 0) &amp;&amp;</TD></TR><TR><TD CLASS="l">1106</TD><TD>                this.connection.getUseCompression()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1107</TD><TD>            this.clientParam |= CLIENT_COMPRESS;</TD></TR><TR><TD CLASS="l">1108</TD><TD>        }</TD></TR><TR><TD CLASS="l">1109</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1110</TD><TD>                this.useConnectWithDb = (database != null) &amp;&amp; </TD></TR><TR><TD CLASS="l">1111</TD><TD>                        (database.length() &gt; 0) &amp;&amp;</TD></TR><TR><TD CLASS="l">1112</TD><TD>                        !this.connection.getCreateDatabaseIfNotExist();</TD></TR><TR><TD CLASS="l">1113</TD><TD>                </TD></TR><TR CLASS="c"><TD CLASS="l">1114</TD><TD>        if (this.useConnectWithDb) {</TD></TR><TR CLASS="c"><TD CLASS="l">1115</TD><TD>            this.clientParam |= CLIENT_CONNECT_WITH_DB;</TD></TR><TR><TD CLASS="l">1116</TD><TD>        }</TD></TR><TR><TD CLASS="l">1117</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1118</TD><TD>        if (((this.serverCapabilities &amp; CLIENT_SSL) == 0) &amp;&amp;</TD></TR><TR><TD CLASS="l">1119</TD><TD>                this.connection.getUseSSL()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1120</TD><TD>            if (this.connection.getRequireSSL()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1121</TD><TD>                this.connection.close();</TD></TR><TR CLASS="z"><TD CLASS="l">1122</TD><TD>                forceClose();</TD></TR><TR CLASS="z"><TD CLASS="l">1123</TD><TD>                throw new SQLException(Messages.getString(&#34;MysqlIO.15&#34;), //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">1124</TD><TD>                    SQLError.SQL_STATE_UNABLE_TO_CONNECT_TO_DATASOURCE);</TD></TR><TR><TD CLASS="l">1125</TD><TD>            }</TD></TR><TR><TD CLASS="l">1126</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1127</TD><TD>            this.connection.setUseSSL(false);</TD></TR><TR><TD CLASS="l">1128</TD><TD>        }</TD></TR><TR><TD CLASS="l">1129</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1130</TD><TD>        if ((this.serverCapabilities &amp; CLIENT_LONG_FLAG) != 0) {</TD></TR><TR><TD CLASS="l">1131</TD><TD>            // We understand other column flags, as well</TD></TR><TR CLASS="c"><TD CLASS="l">1132</TD><TD>            this.clientParam |= CLIENT_LONG_FLAG;</TD></TR><TR CLASS="c"><TD CLASS="l">1133</TD><TD>            this.hasLongColumnInfo = true;</TD></TR><TR><TD CLASS="l">1134</TD><TD>        }</TD></TR><TR><TD CLASS="l">1135</TD><TD> </TD></TR><TR><TD CLASS="l">1136</TD><TD>        // return FOUND rows</TD></TR><TR CLASS="c"><TD CLASS="l">1137</TD><TD>        this.clientParam |= CLIENT_FOUND_ROWS;</TD></TR><TR><TD CLASS="l">1138</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1139</TD><TD>        if (this.connection.getAllowLoadLocalInfile()) {</TD></TR><TR CLASS="c"><TD CLASS="l">1140</TD><TD>            this.clientParam |= CLIENT_LOCAL_FILES;</TD></TR><TR><TD CLASS="l">1141</TD><TD>        }</TD></TR><TR><TD CLASS="l">1142</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1143</TD><TD>        if (this.isInteractiveClient) {</TD></TR><TR CLASS="z"><TD CLASS="l">1144</TD><TD>            this.clientParam |= CLIENT_INTERACTIVE;</TD></TR><TR><TD CLASS="l">1145</TD><TD>        }</TD></TR><TR><TD CLASS="l">1146</TD><TD> </TD></TR><TR><TD CLASS="l">1147</TD><TD>        // Authenticate</TD></TR><TR CLASS="c"><TD CLASS="l">1148</TD><TD>        if (this.protocolVersion &gt; 9) {</TD></TR><TR CLASS="c"><TD CLASS="l">1149</TD><TD>            this.clientParam |= CLIENT_LONG_PASSWORD; // for long passwords</TD></TR><TR><TD CLASS="l">1150</TD><TD>        } else {</TD></TR><TR CLASS="z"><TD CLASS="l">1151</TD><TD>            this.clientParam &amp;= ~CLIENT_LONG_PASSWORD;</TD></TR><TR><TD CLASS="l">1152</TD><TD>        }</TD></TR><TR><TD CLASS="l">1153</TD><TD> </TD></TR><TR><TD CLASS="l">1154</TD><TD>        //</TD></TR><TR><TD CLASS="l">1155</TD><TD>        // 4.1 has some differences in the protocol</TD></TR><TR><TD CLASS="l">1156</TD><TD>        //</TD></TR><TR CLASS="c"><TD CLASS="l">1157</TD><TD>        if (versionMeetsMinimum(4, 1, 0)) {</TD></TR><TR CLASS="c"><TD CLASS="l">1158</TD><TD>            if (versionMeetsMinimum(4, 1, 1)) {</TD></TR><TR CLASS="c"><TD CLASS="l">1159</TD><TD>                this.clientParam |= CLIENT_PROTOCOL_41;</TD></TR><TR CLASS="c"><TD CLASS="l">1160</TD><TD>                this.has41NewNewProt = true;</TD></TR><TR><TD CLASS="l">1161</TD><TD> </TD></TR><TR><TD CLASS="l">1162</TD><TD>                // Need this to get server status values</TD></TR><TR CLASS="c"><TD CLASS="l">1163</TD><TD>                this.clientParam |= CLIENT_TRANSACTIONS;</TD></TR><TR><TD CLASS="l">1164</TD><TD> </TD></TR><TR><TD CLASS="l">1165</TD><TD>                // We always allow multiple result sets</TD></TR><TR CLASS="c"><TD CLASS="l">1166</TD><TD>                this.clientParam |= CLIENT_MULTI_RESULTS;</TD></TR><TR><TD CLASS="l">1167</TD><TD> </TD></TR><TR><TD CLASS="l">1168</TD><TD>                // We allow the user to configure whether</TD></TR><TR><TD CLASS="l">1169</TD><TD>                // or not they want to support multiple queries</TD></TR><TR><TD CLASS="l">1170</TD><TD>                // (by default, this is disabled).</TD></TR><TR CLASS="c"><TD CLASS="l">1171</TD><TD>                if (this.connection.getAllowMultiQueries()) {</TD></TR><TR CLASS="c"><TD CLASS="l">1172</TD><TD>                    this.clientParam |= CLIENT_MULTI_QUERIES;</TD></TR><TR><TD CLASS="l">1173</TD><TD>                }</TD></TR><TR><TD CLASS="l">1174</TD><TD>            } else {</TD></TR><TR CLASS="z"><TD CLASS="l">1175</TD><TD>                this.clientParam |= CLIENT_RESERVED;</TD></TR><TR CLASS="z"><TD CLASS="l">1176</TD><TD>                this.has41NewNewProt = false;</TD></TR><TR><TD CLASS="l">1177</TD><TD>            }</TD></TR><TR><TD CLASS="l">1178</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1179</TD><TD>            this.use41Extensions = true;</TD></TR><TR><TD CLASS="l">1180</TD><TD>        }</TD></TR><TR><TD CLASS="l">1181</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1182</TD><TD>        int passwordLength = 16;</TD></TR><TR CLASS="c"><TD CLASS="l">1183</TD><TD>        int userLength = 0;</TD></TR><TR CLASS="c"><TD CLASS="l">1184</TD><TD>        int databaseLength = 0;</TD></TR><TR><TD CLASS="l">1185</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1186</TD><TD>        if (user != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">1187</TD><TD>            userLength = user.length();</TD></TR><TR><TD CLASS="l">1188</TD><TD>        }</TD></TR><TR><TD CLASS="l">1189</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1190</TD><TD>        if (database != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">1191</TD><TD>            databaseLength = database.length();</TD></TR><TR><TD CLASS="l">1192</TD><TD>        }</TD></TR><TR><TD CLASS="l">1193</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1194</TD><TD>        int packLength = (userLength + passwordLength + databaseLength) + 7 +</TD></TR><TR><TD CLASS="l">1195</TD><TD>            HEADER_LENGTH;</TD></TR><TR CLASS="c"><TD CLASS="l">1196</TD><TD>        Buffer packet = null;</TD></TR><TR><TD CLASS="l">1197</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1198</TD><TD>        if (!this.connection.getUseSSL()) {</TD></TR><TR CLASS="c"><TD CLASS="l">1199</TD><TD>            if ((this.serverCapabilities &amp; CLIENT_SECURE_CONNECTION) != 0) {</TD></TR><TR CLASS="c"><TD CLASS="l">1200</TD><TD>                this.clientParam |= CLIENT_SECURE_CONNECTION;</TD></TR><TR><TD CLASS="l">1201</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1202</TD><TD>                if (versionMeetsMinimum(4, 1, 1)) {</TD></TR><TR CLASS="c"><TD CLASS="l">1203</TD><TD>                    secureAuth411(null, packLength, user, password, database,</TD></TR><TR><TD CLASS="l">1204</TD><TD>                        true);</TD></TR><TR><TD CLASS="l">1205</TD><TD>                } else {</TD></TR><TR CLASS="z"><TD CLASS="l">1206</TD><TD>                    secureAuth(null, packLength, user, password, database, true);</TD></TR><TR><TD CLASS="l">1207</TD><TD>                }</TD></TR><TR><TD CLASS="l">1208</TD><TD>            } else {</TD></TR><TR><TD CLASS="l">1209</TD><TD>                // Passwords can be 16 chars long</TD></TR><TR CLASS="c"><TD CLASS="l">1210</TD><TD>                packet = Buffer.allocateNew(packLength, this.useNewIo);</TD></TR><TR><TD CLASS="l">1211</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1212</TD><TD>                if ((this.clientParam &amp; CLIENT_RESERVED) != 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">1213</TD><TD>                    if (versionMeetsMinimum(4, 1, 1)) {</TD></TR><TR CLASS="z"><TD CLASS="l">1214</TD><TD>                        packet.writeLong(this.clientParam);</TD></TR><TR CLASS="z"><TD CLASS="l">1215</TD><TD>                        packet.writeLong(this.maxThreeBytes);</TD></TR><TR><TD CLASS="l">1216</TD><TD> </TD></TR><TR><TD CLASS="l">1217</TD><TD>                        // charset, JDBC will connect as 'latin1',</TD></TR><TR><TD CLASS="l">1218</TD><TD>                        // and use 'SET NAMES' to change to the desired</TD></TR><TR><TD CLASS="l">1219</TD><TD>                        // charset after the connection is established.</TD></TR><TR CLASS="z"><TD CLASS="l">1220</TD><TD>                        packet.writeByte((byte) 8);</TD></TR><TR><TD CLASS="l">1221</TD><TD> </TD></TR><TR><TD CLASS="l">1222</TD><TD>                        // Set of bytes reserved for future use.</TD></TR><TR CLASS="z"><TD CLASS="l">1223</TD><TD>                        packet.writeBytesNoNull(new byte[23]);</TD></TR><TR><TD CLASS="l">1224</TD><TD>                    } else {</TD></TR><TR CLASS="z"><TD CLASS="l">1225</TD><TD>                        packet.writeLong(this.clientParam);</TD></TR><TR CLASS="z"><TD CLASS="l">1226</TD><TD>                        packet.writeLong(this.maxThreeBytes);</TD></TR><TR><TD CLASS="l">1227</TD><TD>                    }</TD></TR><TR><TD CLASS="l">1228</TD><TD>                } else {</TD></TR><TR CLASS="c"><TD CLASS="l">1229</TD><TD>                    packet.writeInt((int) this.clientParam);</TD></TR><TR CLASS="c"><TD CLASS="l">1230</TD><TD>                    packet.writeLongInt(this.maxThreeBytes);</TD></TR><TR><TD CLASS="l">1231</TD><TD>                }</TD></TR><TR><TD CLASS="l">1232</TD><TD> </TD></TR><TR><TD CLASS="l">1233</TD><TD>                // User/Password data</TD></TR><TR CLASS="c"><TD CLASS="l">1234</TD><TD>                packet.writeString(user);</TD></TR><TR><TD CLASS="l">1235</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1236</TD><TD>                if (this.protocolVersion &gt; 9) {</TD></TR><TR CLASS="c"><TD CLASS="l">1237</TD><TD>                    packet.writeString(Util.newCrypt(password, this.seed));</TD></TR><TR><TD CLASS="l">1238</TD><TD>                } else {</TD></TR><TR CLASS="z"><TD CLASS="l">1239</TD><TD>                    packet.writeString(Util.oldCrypt(password, this.seed));</TD></TR><TR><TD CLASS="l">1240</TD><TD>                }</TD></TR><TR><TD CLASS="l">1241</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1242</TD><TD>                if (this.useConnectWithDb) {</TD></TR><TR CLASS="c"><TD CLASS="l">1243</TD><TD>                    packet.writeString(database);</TD></TR><TR><TD CLASS="l">1244</TD><TD>                }</TD></TR><TR><TD CLASS="l">1245</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1246</TD><TD>                send(packet);</TD></TR><TR><TD CLASS="l">1247</TD><TD>            }</TD></TR><TR><TD CLASS="l">1248</TD><TD>        } else {</TD></TR><TR CLASS="z"><TD CLASS="l">1249</TD><TD>            negotiateSSLConnection(user, password, database, packLength);</TD></TR><TR><TD CLASS="l">1250</TD><TD>        }</TD></TR><TR><TD CLASS="l">1251</TD><TD> </TD></TR><TR><TD CLASS="l">1252</TD><TD>        // Check for errors, not for 4.1.1 or newer,</TD></TR><TR><TD CLASS="l">1253</TD><TD>        // as the new auth protocol doesn't work that way</TD></TR><TR><TD CLASS="l">1254</TD><TD>        // (see secureAuth411() for more details...)</TD></TR><TR CLASS="c"><TD CLASS="l">1255</TD><TD>        if (!versionMeetsMinimum(4, 1, 1)) {</TD></TR><TR CLASS="c"><TD CLASS="l">1256</TD><TD>            checkErrorPacket();</TD></TR><TR><TD CLASS="l">1257</TD><TD>        }</TD></TR><TR><TD CLASS="l">1258</TD><TD> </TD></TR><TR><TD CLASS="l">1259</TD><TD>        //</TD></TR><TR><TD CLASS="l">1260</TD><TD>        // Can't enable compression until after handshake</TD></TR><TR><TD CLASS="l">1261</TD><TD>        //</TD></TR><TR CLASS="c"><TD CLASS="l">1262</TD><TD>        if (((this.serverCapabilities &amp; CLIENT_COMPRESS) != 0) &amp;&amp;</TD></TR><TR><TD CLASS="l">1263</TD><TD>                this.connection.getUseCompression()) {</TD></TR><TR><TD CLASS="l">1264</TD><TD>            // The following matches with ZLIB's</TD></TR><TR><TD CLASS="l">1265</TD><TD>            // compress()</TD></TR><TR CLASS="z"><TD CLASS="l">1266</TD><TD>            this.deflater = new Deflater();</TD></TR><TR CLASS="z"><TD CLASS="l">1267</TD><TD>            this.useCompression = true;</TD></TR><TR CLASS="z"><TD CLASS="l">1268</TD><TD>            this.mysqlInput = new CompressedInputStream(this.connection,</TD></TR><TR><TD CLASS="l">1269</TD><TD>                    this.mysqlInput);</TD></TR><TR><TD CLASS="l">1270</TD><TD>        }</TD></TR><TR><TD CLASS="l">1271</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1272</TD><TD>        if (!this.useConnectWithDb) {</TD></TR><TR CLASS="z"><TD CLASS="l">1273</TD><TD>            changeDatabaseTo(database);</TD></TR><TR><TD CLASS="l"><A NAME="1">1274</A></TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">1275</TD><TD>    }</TD></TR><TR><TD CLASS="l">1276</TD><TD> </TD></TR><TR><TD CLASS="l">1277</TD><TD>        private void changeDatabaseTo(String database) throws SQLException, CommunicationsException {</TD></TR><TR CLASS="z"><TD CLASS="l">1278</TD><TD>                if (database == null || database.length() == 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">1279</TD><TD>                        return;</TD></TR><TR><TD CLASS="l">1280</TD><TD>                }</TD></TR><TR><TD CLASS="l">1281</TD><TD>                </TD></TR><TR><TD CLASS="l">1282</TD><TD>                try {</TD></TR><TR CLASS="z"><TD CLASS="l">1283</TD><TD>                    sendCommand(MysqlDefs.INIT_DB, database, null, false, null);</TD></TR><TR CLASS="z"><TD CLASS="l">1284</TD><TD>                } catch (Exception ex) {</TD></TR><TR CLASS="z"><TD CLASS="l">1285</TD><TD>                        if (this.connection.getCreateDatabaseIfNotExist()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1286</TD><TD>                                sendCommand(MysqlDefs.QUERY, &#34;CREATE DATABASE IF NOT EXISTS &#34; +</TD></TR><TR><TD CLASS="l">1287</TD><TD>                                        database,</TD></TR><TR><TD CLASS="l">1288</TD><TD>                                        null, false, null);</TD></TR><TR CLASS="z"><TD CLASS="l">1289</TD><TD>                                sendCommand(MysqlDefs.INIT_DB, database, null, false, null);</TD></TR><TR><TD CLASS="l">1290</TD><TD>                        } else {</TD></TR><TR CLASS="z"><TD CLASS="l">1291</TD><TD>                                throw new CommunicationsException(this.connection,</TD></TR><TR><TD CLASS="l">1292</TD><TD>                                                this.lastPacketSentTimeMs, ex);</TD></TR><TR><TD CLASS="l">1293</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">1294</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1295</TD><TD>        }</TD></TR><TR><TD CLASS="l">1296</TD><TD> </TD></TR><TR><TD CLASS="l">1297</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1298</TD><TD>    * Retrieve one row from the MySQL server. Note: this method is not</TD></TR><TR><TD CLASS="l">1299</TD><TD>    * thread-safe, but it is only called from methods that are guarded by</TD></TR><TR><TD CLASS="l">1300</TD><TD>    * synchronizing on this object.</TD></TR><TR><TD CLASS="l">1301</TD><TD>    *</TD></TR><TR><TD CLASS="l">1302</TD><TD>    * @param fields DOCUMENT ME!</TD></TR><TR><TD CLASS="l">1303</TD><TD>    * @param columnCount DOCUMENT ME!</TD></TR><TR><TD CLASS="l">1304</TD><TD>    * @param isBinaryEncoded DOCUMENT ME!</TD></TR><TR><TD CLASS="l">1305</TD><TD>    * @param resultSetConcurrency DOCUMENT ME!</TD></TR><TR><TD CLASS="l">1306</TD><TD>    *</TD></TR><TR><TD CLASS="l">1307</TD><TD>    * @return DOCUMENT ME!</TD></TR><TR><TD CLASS="l">1308</TD><TD>    *</TD></TR><TR><TD CLASS="l">1309</TD><TD>    * @throws SQLException DOCUMENT ME!</TD></TR><TR><TD CLASS="l">1310</TD><TD>    */</TD></TR><TR><TD CLASS="l">1311</TD><TD>    final Object[] nextRow(Field[] fields, int columnCount,</TD></TR><TR><TD CLASS="l"><A NAME="40">1312</A></TD><TD>        boolean isBinaryEncoded, int resultSetConcurrency)</TD></TR><TR><TD CLASS="l">1313</TD><TD>        throws SQLException {</TD></TR><TR><TD CLASS="l">1314</TD><TD>        // Get the next incoming packet, re-using the packet because</TD></TR><TR><TD CLASS="l">1315</TD><TD>        // all the data we need gets copied out of it.</TD></TR><TR CLASS="c"><TD CLASS="l">1316</TD><TD>        Buffer rowPacket = checkErrorPacket();</TD></TR><TR><TD CLASS="l">1317</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1318</TD><TD>        if (!isBinaryEncoded) {</TD></TR><TR><TD CLASS="l">1319</TD><TD>            //</TD></TR><TR><TD CLASS="l">1320</TD><TD>            // Didn't read an error, so re-position to beginning</TD></TR><TR><TD CLASS="l">1321</TD><TD>            // of packet in order to read result set data</TD></TR><TR><TD CLASS="l">1322</TD><TD>            //</TD></TR><TR CLASS="c"><TD CLASS="l">1323</TD><TD>            rowPacket.setPosition(rowPacket.getPosition() - 1);</TD></TR><TR><TD CLASS="l">1324</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1325</TD><TD>            if (!rowPacket.isLastDataPacket()) {</TD></TR><TR CLASS="c"><TD CLASS="l">1326</TD><TD>                byte[][] rowData = new byte[columnCount][];</TD></TR><TR><TD CLASS="l">1327</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1328</TD><TD>                int offset = 0;</TD></TR><TR><TD CLASS="l">1329</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1330</TD><TD>                for (int i = 0; i &lt; columnCount; i++) {</TD></TR><TR CLASS="c"><TD CLASS="l">1331</TD><TD>                    rowData[i] = rowPacket.readLenByteArray(offset);</TD></TR><TR><TD CLASS="l">1332</TD><TD>                }</TD></TR><TR><TD CLASS="l">1333</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1334</TD><TD>                return rowData;</TD></TR><TR><TD CLASS="l">1335</TD><TD>            }</TD></TR><TR><TD CLASS="l">1336</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1337</TD><TD>            readServerStatusForResultSets(rowPacket);</TD></TR><TR><TD CLASS="l">1338</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1339</TD><TD>            return null;</TD></TR><TR><TD CLASS="l">1340</TD><TD>        }</TD></TR><TR><TD CLASS="l">1341</TD><TD> </TD></TR><TR><TD CLASS="l">1342</TD><TD>        // </TD></TR><TR><TD CLASS="l">1343</TD><TD>        // Handle binary-encoded data for server-side   </TD></TR><TR><TD CLASS="l">1344</TD><TD>        // PreparedStatements...</TD></TR><TR><TD CLASS="l">1345</TD><TD>        //</TD></TR><TR CLASS="c"><TD CLASS="l">1346</TD><TD>        if (!rowPacket.isLastDataPacket()) {</TD></TR><TR CLASS="c"><TD CLASS="l">1347</TD><TD>            return unpackBinaryResultSetRow(fields, rowPacket,</TD></TR><TR><TD CLASS="l">1348</TD><TD>                resultSetConcurrency);</TD></TR><TR><TD CLASS="l">1349</TD><TD>        }</TD></TR><TR><TD CLASS="l">1350</TD><TD>        </TD></TR><TR CLASS="c"><TD CLASS="l">1351</TD><TD>        rowPacket.setPosition(rowPacket.getPosition() - 1);</TD></TR><TR CLASS="c"><TD CLASS="l">1352</TD><TD>        readServerStatusForResultSets(rowPacket);</TD></TR><TR><TD CLASS="l">1353</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1354</TD><TD>        return null;</TD></TR><TR><TD CLASS="l">1355</TD><TD>    }</TD></TR><TR><TD CLASS="l">1356</TD><TD> </TD></TR><TR><TD CLASS="l">1357</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1358</TD><TD>     * Log-off of the MySQL server and close the socket.</TD></TR><TR><TD CLASS="l"><A NAME="41">1359</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">1360</TD><TD>     * @throws SQLException DOCUMENT ME!</TD></TR><TR><TD CLASS="l">1361</TD><TD>     */</TD></TR><TR><TD CLASS="l">1362</TD><TD>    final void quit() throws SQLException {</TD></TR><TR CLASS="c"><TD CLASS="l">1363</TD><TD>        Buffer packet = Buffer.allocateNew(6, this.useNewIo);</TD></TR><TR CLASS="c"><TD CLASS="l">1364</TD><TD>        this.packetSequence = -1;</TD></TR><TR CLASS="c"><TD CLASS="l">1365</TD><TD>        packet.writeByte((byte) MysqlDefs.QUIT);</TD></TR><TR CLASS="c"><TD CLASS="l">1366</TD><TD>        send(packet);</TD></TR><TR CLASS="c"><TD CLASS="l">1367</TD><TD>        forceClose();</TD></TR><TR CLASS="c"><TD CLASS="l">1368</TD><TD>    }</TD></TR><TR><TD CLASS="l">1369</TD><TD> </TD></TR><TR><TD CLASS="l">1370</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1371</TD><TD>     * Returns the packet used for sending data (used by PreparedStatement)</TD></TR><TR><TD CLASS="l">1372</TD><TD>     * Guarded by external synchronization on a mutex.</TD></TR><TR><TD CLASS="l"><A NAME="3d">1373</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">1374</TD><TD>     * @return A packet to send data with</TD></TR><TR><TD CLASS="l">1375</TD><TD>     */</TD></TR><TR><TD CLASS="l">1376</TD><TD>    Buffer getSharedSendPacket() {</TD></TR><TR CLASS="c"><TD CLASS="l">1377</TD><TD>        if (this.sharedSendPacket == null) {</TD></TR><TR CLASS="c"><TD CLASS="l">1378</TD><TD>            if (this.useNewIo) {</TD></TR><TR CLASS="c"><TD CLASS="l">1379</TD><TD>                this.sharedSendPacket = Buffer.allocateDirect(this.connection.getNetBufferLength(),</TD></TR><TR><TD CLASS="l">1380</TD><TD>                        true);</TD></TR><TR><TD CLASS="l">1381</TD><TD>            } else {</TD></TR><TR CLASS="c"><TD CLASS="l">1382</TD><TD>                this.sharedSendPacket = Buffer.allocateNew(this.connection.getNetBufferLength(),</TD></TR><TR><TD CLASS="l">1383</TD><TD>                        false);</TD></TR><TR><TD CLASS="l">1384</TD><TD>            }</TD></TR><TR><TD CLASS="l">1385</TD><TD>        }</TD></TR><TR><TD CLASS="l">1386</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="f">1387</A></TD><TD>        return this.sharedSendPacket;</TD></TR><TR><TD CLASS="l">1388</TD><TD>    }</TD></TR><TR><TD CLASS="l">1389</TD><TD> </TD></TR><TR><TD CLASS="l">1390</TD><TD>    void closeStreamer(RowData streamer) throws SQLException {</TD></TR><TR CLASS="c"><TD CLASS="l">1391</TD><TD>        if (this.streamingData == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">1392</TD><TD>            throw new SQLException(Messages.getString(&#34;MysqlIO.17&#34;) //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">1393</TD><TD>                 +streamer + Messages.getString(&#34;MysqlIO.18&#34;)); //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">1394</TD><TD>        }</TD></TR><TR><TD CLASS="l">1395</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1396</TD><TD>        if (streamer != this.streamingData) {</TD></TR><TR CLASS="z"><TD CLASS="l">1397</TD><TD>            throw new SQLException(Messages.getString(&#34;MysqlIO.19&#34;) //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">1398</TD><TD>                 +streamer + Messages.getString(&#34;MysqlIO.20&#34;) //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">1399</TD><TD>                 +Messages.getString(&#34;MysqlIO.21&#34;) //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">1400</TD><TD>                 +Messages.getString(&#34;MysqlIO.22&#34;)); //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">1401</TD><TD>        }</TD></TR><TR><TD CLASS="l">1402</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1403</TD><TD>        this.streamingData = null;</TD></TR><TR CLASS="c"><TD CLASS="l">1404</TD><TD>    }</TD></TR><TR><TD CLASS="l">1405</TD><TD> </TD></TR><TR><TD CLASS="l">1406</TD><TD>    ResultSet readAllResults(Statement callingStatement, int maxRows,</TD></TR><TR><TD CLASS="l"><A NAME="2c">1407</A></TD><TD>        int resultSetType, int resultSetConcurrency, boolean streamResults,</TD></TR><TR><TD CLASS="l">1408</TD><TD>        String catalog, Buffer resultPacket, boolean isBinaryEncoded,</TD></TR><TR><TD CLASS="l">1409</TD><TD>        long preSentColumnCount, boolean unpackFieldInfo)</TD></TR><TR><TD CLASS="l">1410</TD><TD>        throws SQLException {</TD></TR><TR CLASS="c"><TD CLASS="l">1411</TD><TD>        resultPacket.setPosition(resultPacket.getPosition() - 1);</TD></TR><TR><TD CLASS="l">1412</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1413</TD><TD>        ResultSet topLevelResultSet = readResultsForQueryOrUpdate(callingStatement,</TD></TR><TR><TD CLASS="l">1414</TD><TD>                maxRows, resultSetType, resultSetConcurrency, streamResults,</TD></TR><TR><TD CLASS="l">1415</TD><TD>                catalog, resultPacket, isBinaryEncoded, preSentColumnCount,</TD></TR><TR><TD CLASS="l">1416</TD><TD>                unpackFieldInfo);</TD></TR><TR><TD CLASS="l">1417</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1418</TD><TD>        ResultSet currentResultSet = topLevelResultSet;</TD></TR><TR><TD CLASS="l">1419</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1420</TD><TD>        boolean checkForMoreResults = ((this.clientParam &amp;</TD></TR><TR><TD CLASS="l">1421</TD><TD>            CLIENT_MULTI_RESULTS) != 0);</TD></TR><TR><TD CLASS="l">1422</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1423</TD><TD>        boolean serverHasMoreResults = (this.serverStatus &amp;</TD></TR><TR><TD CLASS="l">1424</TD><TD>            SERVER_MORE_RESULTS_EXISTS) != 0;</TD></TR><TR><TD CLASS="l">1425</TD><TD> </TD></TR><TR><TD CLASS="l">1426</TD><TD>        //</TD></TR><TR><TD CLASS="l">1427</TD><TD>        // TODO: We need to support streaming of multiple result sets</TD></TR><TR><TD CLASS="l">1428</TD><TD>        //</TD></TR><TR CLASS="c"><TD CLASS="l">1429</TD><TD>        if (serverHasMoreResults &amp;&amp; streamResults) {</TD></TR><TR CLASS="z"><TD CLASS="l">1430</TD><TD>            clearInputStream();</TD></TR><TR><TD CLASS="l">1431</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1432</TD><TD>            throw new SQLException(Messages.getString(&#34;MysqlIO.23&#34;), //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">1433</TD><TD>                SQLError.SQL_STATE_DRIVER_NOT_CAPABLE);</TD></TR><TR><TD CLASS="l">1434</TD><TD>        }</TD></TR><TR><TD CLASS="l">1435</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1436</TD><TD>        boolean moreRowSetsExist = checkForMoreResults &amp; serverHasMoreResults;</TD></TR><TR><TD CLASS="l">1437</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1438</TD><TD>        while (moreRowSetsExist) {</TD></TR><TR CLASS="c"><TD CLASS="l">1439</TD><TD>            Buffer fieldPacket = checkErrorPacket();</TD></TR><TR CLASS="c"><TD CLASS="l">1440</TD><TD>            fieldPacket.setPosition(0);</TD></TR><TR><TD CLASS="l">1441</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1442</TD><TD>            if ((fieldPacket.readByte(0) == 0) &amp;&amp;</TD></TR><TR><TD CLASS="l">1443</TD><TD>                    (fieldPacket.readByte(1) == 0) &amp;&amp;</TD></TR><TR><TD CLASS="l">1444</TD><TD>                    (fieldPacket.readByte(2) == 0)) {</TD></TR><TR CLASS="c"><TD CLASS="l">1445</TD><TD>                break;</TD></TR><TR><TD CLASS="l">1446</TD><TD>            }</TD></TR><TR><TD CLASS="l">1447</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1448</TD><TD>            ResultSet newResultSet = readResultsForQueryOrUpdate(callingStatement,</TD></TR><TR><TD CLASS="l">1449</TD><TD>                    maxRows, resultSetType, resultSetConcurrency,</TD></TR><TR><TD CLASS="l">1450</TD><TD>                    streamResults, catalog, fieldPacket, isBinaryEncoded,</TD></TR><TR><TD CLASS="l">1451</TD><TD>                    preSentColumnCount, unpackFieldInfo);</TD></TR><TR><TD CLASS="l">1452</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1453</TD><TD>            currentResultSet.setNextResultSet(newResultSet);</TD></TR><TR><TD CLASS="l">1454</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1455</TD><TD>            currentResultSet = newResultSet;</TD></TR><TR><TD CLASS="l">1456</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1457</TD><TD>            moreRowSetsExist = (this.serverStatus &amp; SERVER_MORE_RESULTS_EXISTS) != 0;</TD></TR><TR><TD CLASS="l">1458</TD><TD>        }</TD></TR><TR><TD CLASS="l">1459</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1460</TD><TD>        if (!streamResults) {</TD></TR><TR CLASS="c"><TD CLASS="l">1461</TD><TD>            clearInputStream();</TD></TR><TR><TD CLASS="l">1462</TD><TD>        }</TD></TR><TR><TD CLASS="l">1463</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1464</TD><TD>        reclaimLargeReusablePacket();</TD></TR><TR><TD CLASS="l">1465</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1466</TD><TD>        return topLevelResultSet;</TD></TR><TR><TD CLASS="l">1467</TD><TD>    }</TD></TR><TR><TD CLASS="l">1468</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="45">1469</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">1470</TD><TD>     * Sets the buffer size to max-buf</TD></TR><TR><TD CLASS="l">1471</TD><TD>     */</TD></TR><TR><TD CLASS="l">1472</TD><TD>    void resetMaxBuf() {</TD></TR><TR CLASS="c"><TD CLASS="l">1473</TD><TD>        this.maxAllowedPacket = this.connection.getMaxAllowedPacket();</TD></TR><TR CLASS="c"><TD CLASS="l">1474</TD><TD>    }</TD></TR><TR><TD CLASS="l">1475</TD><TD> </TD></TR><TR><TD CLASS="l">1476</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1477</TD><TD>     * Send a command to the MySQL server If data is to be sent with command,</TD></TR><TR><TD CLASS="l">1478</TD><TD>     * it should be put in extraData.</TD></TR><TR><TD CLASS="l">1479</TD><TD>     *</TD></TR><TR><TD CLASS="l">1480</TD><TD>     * Raw packets can be sent by setting queryPacket to something other</TD></TR><TR><TD CLASS="l">1481</TD><TD>     * than null.</TD></TR><TR><TD CLASS="l">1482</TD><TD>     *</TD></TR><TR><TD CLASS="l">1483</TD><TD>     * @param command the MySQL protocol 'command' from MysqlDefs</TD></TR><TR><TD CLASS="l">1484</TD><TD>     * @param extraData any 'string' data for the command</TD></TR><TR><TD CLASS="l">1485</TD><TD>     * @param queryPacket a packet pre-loaded with data for the protocol (i.e.</TD></TR><TR><TD CLASS="l">1486</TD><TD>     * from a client-side prepared statement).</TD></TR><TR><TD CLASS="l">1487</TD><TD>     * @param skipCheck do not call checkErrorPacket() if true</TD></TR><TR><TD CLASS="l">1488</TD><TD>     * @param extraDataCharEncoding the character encoding of the extraData</TD></TR><TR><TD CLASS="l">1489</TD><TD>     * parameter.</TD></TR><TR><TD CLASS="l">1490</TD><TD>     *</TD></TR><TR><TD CLASS="l">1491</TD><TD>     * @return the response packet from the server</TD></TR><TR><TD CLASS="l">1492</TD><TD>     *</TD></TR><TR><TD CLASS="l">1493</TD><TD>     * @throws SQLException if an I/O error or SQL error occurs</TD></TR><TR><TD CLASS="l">1494</TD><TD>     */</TD></TR><TR><TD CLASS="l">1495</TD><TD>   </TD></TR><TR><TD CLASS="l">1496</TD><TD>    final Buffer sendCommand(int command, String extraData, Buffer queryPacket,</TD></TR><TR><TD CLASS="l">1497</TD><TD>        boolean skipCheck, String extraDataCharEncoding)</TD></TR><TR><TD CLASS="l">1498</TD><TD>        throws SQLException {</TD></TR><TR><TD CLASS="l">1499</TD><TD>        //</TD></TR><TR><TD CLASS="l"><A NAME="1f">1500</A></TD><TD>        // We cache these locally, per-command, as the checks</TD></TR><TR><TD CLASS="l">1501</TD><TD>        // for them are in very 'hot' sections of the I/O code</TD></TR><TR><TD CLASS="l">1502</TD><TD>        // and we save 10-15% in overall performance by doing this...</TD></TR><TR><TD CLASS="l">1503</TD><TD>        //</TD></TR><TR CLASS="c"><TD CLASS="l">1504</TD><TD>        this.enablePacketDebug = this.connection.getEnablePacketDebug();</TD></TR><TR CLASS="c"><TD CLASS="l">1505</TD><TD>        this.traceProtocol = this.connection.getTraceProtocol();</TD></TR><TR CLASS="c"><TD CLASS="l">1506</TD><TD>        this.readPacketSequence = 0;</TD></TR><TR><TD CLASS="l">1507</TD><TD> </TD></TR><TR><TD CLASS="l">1508</TD><TD>        try {</TD></TR><TR><TD CLASS="l">1509</TD><TD>                </TD></TR><TR CLASS="c"><TD CLASS="l">1510</TD><TD>            checkForOutstandingStreamingData();</TD></TR><TR><TD CLASS="l">1511</TD><TD>           </TD></TR><TR><TD CLASS="l">1512</TD><TD>            // Clear serverStatus...this value is guarded by an</TD></TR><TR><TD CLASS="l">1513</TD><TD>            // external mutex, as you can only ever be processing </TD></TR><TR><TD CLASS="l">1514</TD><TD>            // one command at a time</TD></TR><TR CLASS="c"><TD CLASS="l">1515</TD><TD>            this.serverStatus = 0;</TD></TR><TR CLASS="c"><TD CLASS="l">1516</TD><TD>            this.hadWarnings = false;</TD></TR><TR CLASS="c"><TD CLASS="l">1517</TD><TD>            this.warningCount = 0;</TD></TR><TR><TD CLASS="l">1518</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1519</TD><TD>            this.queryNoIndexUsed = false;</TD></TR><TR CLASS="c"><TD CLASS="l">1520</TD><TD>            this.queryBadIndexUsed = false;</TD></TR><TR><TD CLASS="l">1521</TD><TD> </TD></TR><TR><TD CLASS="l">1522</TD><TD>            //</TD></TR><TR><TD CLASS="l">1523</TD><TD>            // Compressed input stream needs cleared at beginning</TD></TR><TR><TD CLASS="l">1524</TD><TD>            // of each command execution...</TD></TR><TR><TD CLASS="l">1525</TD><TD>            //</TD></TR><TR CLASS="c"><TD CLASS="l">1526</TD><TD>            if (this.useCompression) {</TD></TR><TR CLASS="z"><TD CLASS="l">1527</TD><TD>                int bytesLeft = this.mysqlInput.available();</TD></TR><TR><TD CLASS="l">1528</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1529</TD><TD>                if (bytesLeft &gt; 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">1530</TD><TD>                    this.mysqlInput.skip(bytesLeft);</TD></TR><TR><TD CLASS="l">1531</TD><TD>                }</TD></TR><TR><TD CLASS="l">1532</TD><TD>            }</TD></TR><TR><TD CLASS="l">1533</TD><TD> </TD></TR><TR><TD CLASS="l">1534</TD><TD>            try {</TD></TR><TR CLASS="c"><TD CLASS="l">1535</TD><TD>                clearInputStream();</TD></TR><TR><TD CLASS="l">1536</TD><TD> </TD></TR><TR><TD CLASS="l">1537</TD><TD>                //</TD></TR><TR><TD CLASS="l">1538</TD><TD>                // PreparedStatements construct their own packets,</TD></TR><TR><TD CLASS="l">1539</TD><TD>                // for efficiency's sake.</TD></TR><TR><TD CLASS="l">1540</TD><TD>                //</TD></TR><TR><TD CLASS="l">1541</TD><TD>                // If this is a generic query, we need to re-use</TD></TR><TR><TD CLASS="l">1542</TD><TD>                // the sending packet.</TD></TR><TR><TD CLASS="l">1543</TD><TD>                //</TD></TR><TR CLASS="c"><TD CLASS="l">1544</TD><TD>                if (queryPacket == null) {</TD></TR><TR CLASS="c"><TD CLASS="l">1545</TD><TD>                    int packLength = HEADER_LENGTH + COMP_HEADER_LENGTH + 1 +</TD></TR><TR><TD CLASS="l">1546</TD><TD>                        ((extraData != null) ? extraData.length() : 0) + 2;</TD></TR><TR><TD CLASS="l">1547</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1548</TD><TD>                    if (this.sendPacket == null) {</TD></TR><TR CLASS="c"><TD CLASS="l">1549</TD><TD>                        this.sendPacket = Buffer.allocateNew(packLength,</TD></TR><TR><TD CLASS="l">1550</TD><TD>                                this.useNewIo);</TD></TR><TR><TD CLASS="l">1551</TD><TD>                    }</TD></TR><TR><TD CLASS="l">1552</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1553</TD><TD>                    this.packetSequence = -1;</TD></TR><TR CLASS="c"><TD CLASS="l">1554</TD><TD>                    this.readPacketSequence = 0;</TD></TR><TR CLASS="c"><TD CLASS="l">1555</TD><TD>                    this.checkPacketSequence = true;</TD></TR><TR CLASS="c"><TD CLASS="l">1556</TD><TD>                    this.sendPacket.clear();</TD></TR><TR><TD CLASS="l">1557</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1558</TD><TD>                    this.sendPacket.writeByte((byte) command);</TD></TR><TR><TD CLASS="l">1559</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1560</TD><TD>                    if ((command == MysqlDefs.INIT_DB) ||</TD></TR><TR><TD CLASS="l">1561</TD><TD>                            (command == MysqlDefs.CREATE_DB) ||</TD></TR><TR><TD CLASS="l">1562</TD><TD>                            (command == MysqlDefs.DROP_DB) ||</TD></TR><TR><TD CLASS="l">1563</TD><TD>                            (command == MysqlDefs.QUERY) ||</TD></TR><TR><TD CLASS="l">1564</TD><TD>                            (command == MysqlDefs.COM_PREPARE)) {</TD></TR><TR CLASS="c"><TD CLASS="l">1565</TD><TD>                        if (extraDataCharEncoding == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">1566</TD><TD>                            this.sendPacket.writeStringNoNull(extraData);</TD></TR><TR><TD CLASS="l">1567</TD><TD>                        } else {</TD></TR><TR CLASS="c"><TD CLASS="l">1568</TD><TD>                            this.sendPacket.writeStringNoNull(extraData,</TD></TR><TR><TD CLASS="l">1569</TD><TD>                                extraDataCharEncoding,</TD></TR><TR><TD CLASS="l">1570</TD><TD>                                this.connection.getServerCharacterEncoding(),</TD></TR><TR><TD CLASS="l">1571</TD><TD>                                this.connection.parserKnowsUnicode());</TD></TR><TR><TD CLASS="l">1572</TD><TD>                        }</TD></TR><TR CLASS="c"><TD CLASS="l">1573</TD><TD>                    } else if (command == MysqlDefs.PROCESS_KILL) {</TD></TR><TR CLASS="z"><TD CLASS="l">1574</TD><TD>                        long id = new Long(extraData).longValue();</TD></TR><TR CLASS="z"><TD CLASS="l">1575</TD><TD>                        this.sendPacket.writeLong(id);</TD></TR><TR><TD CLASS="l">1576</TD><TD>                    }</TD></TR><TR><TD CLASS="l">1577</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1578</TD><TD>                    send(this.sendPacket);</TD></TR><TR><TD CLASS="l">1579</TD><TD>                } else {</TD></TR><TR CLASS="c"><TD CLASS="l">1580</TD><TD>                    this.packetSequence = -1;</TD></TR><TR CLASS="c"><TD CLASS="l">1581</TD><TD>                    send(queryPacket); // packet passed by PreparedStatement</TD></TR><TR><TD CLASS="l">1582</TD><TD>                }</TD></TR><TR CLASS="c"><TD CLASS="l">1583</TD><TD>            } catch (SQLException sqlEx) {</TD></TR><TR><TD CLASS="l">1584</TD><TD>                // don't wrap SQLExceptions</TD></TR><TR CLASS="c"><TD CLASS="l">1585</TD><TD>                throw sqlEx;</TD></TR><TR CLASS="z"><TD CLASS="l">1586</TD><TD>            } catch (Exception ex) {</TD></TR><TR CLASS="z"><TD CLASS="l">1587</TD><TD>                throw new CommunicationsException(this.connection,</TD></TR><TR><TD CLASS="l">1588</TD><TD>                    this.lastPacketSentTimeMs, ex);</TD></TR><TR CLASS="c"><TD CLASS="l">1589</TD><TD>            }</TD></TR><TR><TD CLASS="l">1590</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1591</TD><TD>            Buffer returnPacket = null;</TD></TR><TR><TD CLASS="l">1592</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1593</TD><TD>            if (!skipCheck) {</TD></TR><TR CLASS="c"><TD CLASS="l">1594</TD><TD>                if ((command == MysqlDefs.COM_EXECUTE) ||</TD></TR><TR><TD CLASS="l">1595</TD><TD>                        (command == MysqlDefs.COM_RESET_STMT)) {</TD></TR><TR CLASS="c"><TD CLASS="l">1596</TD><TD>                    this.readPacketSequence = 0;</TD></TR><TR CLASS="c"><TD CLASS="l">1597</TD><TD>                    this.packetSequenceReset = true;</TD></TR><TR><TD CLASS="l">1598</TD><TD>                }</TD></TR><TR><TD CLASS="l">1599</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1600</TD><TD>                returnPacket = checkErrorPacket(command);</TD></TR><TR><TD CLASS="l">1601</TD><TD>            }</TD></TR><TR><TD CLASS="l">1602</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1603</TD><TD>            return returnPacket;</TD></TR><TR CLASS="z"><TD CLASS="l">1604</TD><TD>        } catch (IOException ioEx) {</TD></TR><TR CLASS="z"><TD CLASS="l">1605</TD><TD>            throw new CommunicationsException(this.connection,</TD></TR><TR><TD CLASS="l">1606</TD><TD>                this.lastPacketSentTimeMs, ioEx);</TD></TR><TR><TD CLASS="l">1607</TD><TD>        }</TD></TR><TR><TD CLASS="l">1608</TD><TD>    }</TD></TR><TR><TD CLASS="l">1609</TD><TD> </TD></TR><TR><TD CLASS="l">1610</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1611</TD><TD>     * Send a query stored in a packet directly to the server.</TD></TR><TR><TD CLASS="l">1612</TD><TD>     *</TD></TR><TR><TD CLASS="l">1613</TD><TD>     * @param callingStatement DOCUMENT ME!</TD></TR><TR><TD CLASS="l">1614</TD><TD>     * @param resultSetConcurrency DOCUMENT ME!</TD></TR><TR><TD CLASS="l">1615</TD><TD>     * @param characterEncoding DOCUMENT ME!</TD></TR><TR><TD CLASS="l">1616</TD><TD>     * @param queryPacket DOCUMENT ME!</TD></TR><TR><TD CLASS="l">1617</TD><TD>     * @param maxRows DOCUMENT ME!</TD></TR><TR><TD CLASS="l">1618</TD><TD>     * @param conn DOCUMENT ME!</TD></TR><TR><TD CLASS="l">1619</TD><TD>     * @param resultSetType DOCUMENT ME!</TD></TR><TR><TD CLASS="l">1620</TD><TD>     * @param resultSetConcurrency DOCUMENT ME!</TD></TR><TR><TD CLASS="l">1621</TD><TD>     * @param streamResults DOCUMENT ME!</TD></TR><TR><TD CLASS="l">1622</TD><TD>     * @param catalog DOCUMENT ME!</TD></TR><TR><TD CLASS="l">1623</TD><TD>     * @param unpackFieldInfo should we read MYSQL_FIELD info (if available)?</TD></TR><TR><TD CLASS="l">1624</TD><TD>     *</TD></TR><TR><TD CLASS="l">1625</TD><TD>     * @return DOCUMENT ME!</TD></TR><TR><TD CLASS="l">1626</TD><TD>     *</TD></TR><TR><TD CLASS="l">1627</TD><TD>     * @throws Exception DOCUMENT ME!</TD></TR><TR><TD CLASS="l">1628</TD><TD>     */</TD></TR><TR><TD CLASS="l">1629</TD><TD>    final ResultSet sqlQueryDirect(Statement callingStatement, String query,</TD></TR><TR><TD CLASS="l"><A NAME="1b">1630</A></TD><TD>        String characterEncoding, Buffer queryPacket, int maxRows,</TD></TR><TR><TD CLASS="l">1631</TD><TD>        Connection conn, int resultSetType, int resultSetConcurrency,</TD></TR><TR><TD CLASS="l">1632</TD><TD>        boolean streamResults, String catalog, boolean unpackFieldInfo)</TD></TR><TR><TD CLASS="l">1633</TD><TD>        throws Exception {</TD></TR><TR CLASS="c"><TD CLASS="l">1634</TD><TD>        long queryStartTime = 0;</TD></TR><TR CLASS="c"><TD CLASS="l">1635</TD><TD>        long queryEndTime = 0;</TD></TR><TR><TD CLASS="l">1636</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1637</TD><TD>        if (query != null) {</TD></TR><TR><TD CLASS="l">1638</TD><TD>                </TD></TR><TR><TD CLASS="l">1639</TD><TD>                </TD></TR><TR><TD CLASS="l">1640</TD><TD>            // We don't know exactly how many bytes we're going to get</TD></TR><TR><TD CLASS="l">1641</TD><TD>            // from the query. Since we're dealing with Unicode, the</TD></TR><TR><TD CLASS="l">1642</TD><TD>            // max is 2, so pad it (2 * query) + space for headers</TD></TR><TR CLASS="c"><TD CLASS="l">1643</TD><TD>            int packLength = HEADER_LENGTH + 1 + (query.length() * 2) + 2;</TD></TR><TR><TD CLASS="l">1644</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1645</TD><TD>            if (this.sendPacket == null) {</TD></TR><TR CLASS="c"><TD CLASS="l">1646</TD><TD>                if (this.useNewIo) {</TD></TR><TR CLASS="c"><TD CLASS="l">1647</TD><TD>                    this.sendPacket = Buffer.allocateDirect(packLength,</TD></TR><TR><TD CLASS="l">1648</TD><TD>                            this.useNewIo);</TD></TR><TR><TD CLASS="l">1649</TD><TD>                } else {</TD></TR><TR CLASS="c"><TD CLASS="l">1650</TD><TD>                    this.sendPacket = Buffer.allocateNew(packLength, false);</TD></TR><TR><TD CLASS="l">1651</TD><TD>                }</TD></TR><TR><TD CLASS="l">1652</TD><TD>            } else {</TD></TR><TR CLASS="c"><TD CLASS="l">1653</TD><TD>                this.sendPacket.clear();</TD></TR><TR><TD CLASS="l">1654</TD><TD>            }</TD></TR><TR><TD CLASS="l">1655</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1656</TD><TD>            this.sendPacket.writeByte((byte) MysqlDefs.QUERY);</TD></TR><TR><TD CLASS="l">1657</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1658</TD><TD>            if (characterEncoding != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">1659</TD><TD>                if (this.platformDbCharsetMatches) {</TD></TR><TR CLASS="c"><TD CLASS="l">1660</TD><TD>                    this.sendPacket.writeStringNoNull(query, characterEncoding,</TD></TR><TR><TD CLASS="l">1661</TD><TD>                        this.connection.getServerCharacterEncoding(),</TD></TR><TR><TD CLASS="l">1662</TD><TD>                        this.connection.parserKnowsUnicode());</TD></TR><TR><TD CLASS="l">1663</TD><TD>                } else {</TD></TR><TR CLASS="c"><TD CLASS="l">1664</TD><TD>                    if (StringUtils.startsWithIgnoreCaseAndWs(query, &#34;LOAD DATA&#34;)) { //$NON-NLS-1$</TD></TR><TR CLASS="c"><TD CLASS="l">1665</TD><TD>                        this.sendPacket.writeBytesNoNull(query.getBytes());</TD></TR><TR><TD CLASS="l">1666</TD><TD>                    } else {</TD></TR><TR CLASS="c"><TD CLASS="l">1667</TD><TD>                        this.sendPacket.writeStringNoNull(query,</TD></TR><TR><TD CLASS="l">1668</TD><TD>                            characterEncoding,</TD></TR><TR><TD CLASS="l">1669</TD><TD>                            this.connection.getServerCharacterEncoding(),</TD></TR><TR><TD CLASS="l">1670</TD><TD>                            this.connection.parserKnowsUnicode());</TD></TR><TR><TD CLASS="l">1671</TD><TD>                    }</TD></TR><TR><TD CLASS="l">1672</TD><TD>                }</TD></TR><TR><TD CLASS="l">1673</TD><TD>            } else {</TD></TR><TR CLASS="c"><TD CLASS="l">1674</TD><TD>                this.sendPacket.writeStringNoNull(query);</TD></TR><TR><TD CLASS="l">1675</TD><TD>            }</TD></TR><TR><TD CLASS="l">1676</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1677</TD><TD>            queryPacket = this.sendPacket;</TD></TR><TR><TD CLASS="l">1678</TD><TD>        }</TD></TR><TR><TD CLASS="l">1679</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1680</TD><TD>        byte[] queryBuf = null;</TD></TR><TR CLASS="c"><TD CLASS="l">1681</TD><TD>        int oldPacketPosition = 0;</TD></TR><TR><TD CLASS="l">1682</TD><TD> </TD></TR><TR><TD CLASS="l">1683</TD><TD>        </TD></TR><TR><TD CLASS="l">1684</TD><TD>        </TD></TR><TR CLASS="c"><TD CLASS="l">1685</TD><TD>        if (needToGrabQueryFromPacket) {</TD></TR><TR CLASS="c"><TD CLASS="l">1686</TD><TD>            queryBuf = queryPacket.getByteBuffer();</TD></TR><TR><TD CLASS="l">1687</TD><TD> </TD></TR><TR><TD CLASS="l">1688</TD><TD>            // save the packet position</TD></TR><TR CLASS="c"><TD CLASS="l">1689</TD><TD>            oldPacketPosition = queryPacket.getPosition();</TD></TR><TR><TD CLASS="l">1690</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1691</TD><TD>            queryStartTime = System.currentTimeMillis();</TD></TR><TR><TD CLASS="l">1692</TD><TD>        }</TD></TR><TR><TD CLASS="l">1693</TD><TD> </TD></TR><TR><TD CLASS="l">1694</TD><TD>        // Send query command and sql query string</TD></TR><TR CLASS="c"><TD CLASS="l">1695</TD><TD>        Buffer resultPacket = sendCommand(MysqlDefs.QUERY, null, queryPacket,</TD></TR><TR><TD CLASS="l">1696</TD><TD>                false, null);</TD></TR><TR><TD CLASS="l">1697</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1698</TD><TD>        long fetchBeginTime = 0;</TD></TR><TR CLASS="c"><TD CLASS="l">1699</TD><TD>        long fetchEndTime = 0;</TD></TR><TR><TD CLASS="l">1700</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1701</TD><TD>        String profileQueryToLog = null;</TD></TR><TR><TD CLASS="l">1702</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1703</TD><TD>        boolean queryWasSlow = false;</TD></TR><TR><TD CLASS="l">1704</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1705</TD><TD>        if (this.profileSql || this.logSlowQueries) {</TD></TR><TR CLASS="c"><TD CLASS="l">1706</TD><TD>            queryEndTime = System.currentTimeMillis();</TD></TR><TR><TD CLASS="l">1707</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1708</TD><TD>            boolean shouldExtractQuery = false;</TD></TR><TR><TD CLASS="l">1709</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1710</TD><TD>            if (this.profileSql) {</TD></TR><TR CLASS="c"><TD CLASS="l">1711</TD><TD>                shouldExtractQuery = true;</TD></TR><TR CLASS="z"><TD CLASS="l">1712</TD><TD>            } else if (this.logSlowQueries &amp;&amp;</TD></TR><TR><TD CLASS="l">1713</TD><TD>                    ((queryEndTime - queryStartTime) &gt;= this.connection.getSlowQueryThresholdMillis())) {</TD></TR><TR CLASS="z"><TD CLASS="l">1714</TD><TD>                shouldExtractQuery = true;</TD></TR><TR CLASS="z"><TD CLASS="l">1715</TD><TD>                queryWasSlow = true;</TD></TR><TR><TD CLASS="l">1716</TD><TD>            }</TD></TR><TR><TD CLASS="l">1717</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1718</TD><TD>            if (shouldExtractQuery) {</TD></TR><TR><TD CLASS="l">1719</TD><TD>                // Extract the actual query from the network packet </TD></TR><TR CLASS="c"><TD CLASS="l">1720</TD><TD>                boolean truncated = false;</TD></TR><TR><TD CLASS="l">1721</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1722</TD><TD>                int extractPosition = oldPacketPosition;</TD></TR><TR><TD CLASS="l">1723</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1724</TD><TD>                if (oldPacketPosition &gt; this.connection.getMaxQuerySizeToLog()) {</TD></TR><TR CLASS="c"><TD CLASS="l">1725</TD><TD>                    extractPosition = this.connection.getMaxQuerySizeToLog() + 5;</TD></TR><TR CLASS="c"><TD CLASS="l">1726</TD><TD>                    truncated = true;</TD></TR><TR><TD CLASS="l">1727</TD><TD>                }</TD></TR><TR><TD CLASS="l">1728</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1729</TD><TD>                profileQueryToLog = new String(queryBuf, 5,</TD></TR><TR><TD CLASS="l">1730</TD><TD>                        (extractPosition - 5));</TD></TR><TR><TD CLASS="l">1731</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1732</TD><TD>                if (truncated) {</TD></TR><TR CLASS="c"><TD CLASS="l">1733</TD><TD>                    profileQueryToLog += Messages.getString(&#34;MysqlIO.25&#34;); //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">1734</TD><TD>                }</TD></TR><TR><TD CLASS="l">1735</TD><TD>            }</TD></TR><TR><TD CLASS="l">1736</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1737</TD><TD>            fetchBeginTime = queryEndTime;</TD></TR><TR><TD CLASS="l">1738</TD><TD>        }</TD></TR><TR><TD CLASS="l">1739</TD><TD>        </TD></TR><TR CLASS="c"><TD CLASS="l">1740</TD><TD>        if (this.autoGenerateTestcaseScript) {</TD></TR><TR CLASS="c"><TD CLASS="l">1741</TD><TD>                String testcaseQuery = null;</TD></TR><TR><TD CLASS="l">1742</TD><TD>                </TD></TR><TR CLASS="c"><TD CLASS="l">1743</TD><TD>                if (query != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">1744</TD><TD>                        testcaseQuery = query;</TD></TR><TR><TD CLASS="l">1745</TD><TD>                } else {</TD></TR><TR CLASS="z"><TD CLASS="l">1746</TD><TD>                        testcaseQuery = new String(queryBuf, 5,</TD></TR><TR><TD CLASS="l">1747</TD><TD>                        (oldPacketPosition - 5));</TD></TR><TR><TD CLASS="l">1748</TD><TD>                }</TD></TR><TR><TD CLASS="l">1749</TD><TD>                </TD></TR><TR CLASS="c"><TD CLASS="l">1750</TD><TD>                    StringBuffer debugBuf = new StringBuffer(testcaseQuery.length() + 32);</TD></TR><TR CLASS="c"><TD CLASS="l">1751</TD><TD>                    this.connection.generateConnectionCommentBlock(debugBuf);</TD></TR><TR CLASS="c"><TD CLASS="l">1752</TD><TD>                    debugBuf.append(testcaseQuery);</TD></TR><TR CLASS="c"><TD CLASS="l">1753</TD><TD>                    debugBuf.append(';');</TD></TR><TR CLASS="c"><TD CLASS="l">1754</TD><TD>                    this.connection.dumpTestcaseQuery(debugBuf.toString());</TD></TR><TR><TD CLASS="l">1755</TD><TD>            }</TD></TR><TR><TD CLASS="l">1756</TD><TD>        </TD></TR><TR CLASS="c"><TD CLASS="l">1757</TD><TD>        ResultSet rs = readAllResults(callingStatement, maxRows, resultSetType,</TD></TR><TR><TD CLASS="l">1758</TD><TD>                resultSetConcurrency, streamResults, catalog, resultPacket,</TD></TR><TR><TD CLASS="l">1759</TD><TD>                false, -1L, unpackFieldInfo);</TD></TR><TR><TD CLASS="l">1760</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1761</TD><TD>        if (queryWasSlow) {</TD></TR><TR CLASS="z"><TD CLASS="l">1762</TD><TD>            StringBuffer mesgBuf = new StringBuffer(48 +</TD></TR><TR><TD CLASS="l">1763</TD><TD>                    profileQueryToLog.length());</TD></TR><TR CLASS="z"><TD CLASS="l">1764</TD><TD>            mesgBuf.append(Messages.getString(&#34;MysqlIO.26&#34;)); //$NON-NLS-1$</TD></TR><TR CLASS="z"><TD CLASS="l">1765</TD><TD>            mesgBuf.append(this.connection.getSlowQueryThresholdMillis());</TD></TR><TR CLASS="z"><TD CLASS="l">1766</TD><TD>            mesgBuf.append(Messages.getString(&#34;MysqlIO.26a&#34;));</TD></TR><TR CLASS="z"><TD CLASS="l">1767</TD><TD>            mesgBuf.append((queryEndTime - queryStartTime));</TD></TR><TR CLASS="z"><TD CLASS="l">1768</TD><TD>            mesgBuf.append(Messages.getString(&#34;MysqlIO.27&#34;)); //$NON-NLS-1$</TD></TR><TR CLASS="z"><TD CLASS="l">1769</TD><TD>            mesgBuf.append(profileQueryToLog);</TD></TR><TR><TD CLASS="l">1770</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1771</TD><TD>            this.connection.getLog().logWarn(mesgBuf.toString());</TD></TR><TR><TD CLASS="l">1772</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1773</TD><TD>            if (this.connection.getExplainSlowQueries()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1774</TD><TD>                if (oldPacketPosition &lt; MAX_QUERY_SIZE_TO_EXPLAIN) {</TD></TR><TR CLASS="z"><TD CLASS="l">1775</TD><TD>                    explainSlowQuery(queryPacket.getBytes(5,</TD></TR><TR><TD CLASS="l">1776</TD><TD>                            (oldPacketPosition - 5)), profileQueryToLog);</TD></TR><TR><TD CLASS="l">1777</TD><TD>                } else {</TD></TR><TR CLASS="z"><TD CLASS="l">1778</TD><TD>                    this.connection.getLog().logWarn(Messages.getString(</TD></TR><TR><TD CLASS="l">1779</TD><TD>                            &#34;MysqlIO.28&#34;) //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">1780</TD><TD>                         +MAX_QUERY_SIZE_TO_EXPLAIN +</TD></TR><TR><TD CLASS="l">1781</TD><TD>                        Messages.getString(&#34;MysqlIO.29&#34;)); //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">1782</TD><TD>                }</TD></TR><TR><TD CLASS="l">1783</TD><TD>            }</TD></TR><TR><TD CLASS="l">1784</TD><TD>        }</TD></TR><TR><TD CLASS="l">1785</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1786</TD><TD>        if (this.profileSql) {</TD></TR><TR CLASS="c"><TD CLASS="l">1787</TD><TD>            fetchEndTime = System.currentTimeMillis();</TD></TR><TR><TD CLASS="l">1788</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1789</TD><TD>            ProfileEventSink eventSink = ProfileEventSink.getInstance(this.connection);</TD></TR><TR><TD CLASS="l">1790</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1791</TD><TD>            eventSink.consumeEvent(new ProfilerEvent(ProfilerEvent.TYPE_QUERY,</TD></TR><TR><TD CLASS="l">1792</TD><TD>                    &#34;&#34;, catalog, this.connection.getId(), //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">1793</TD><TD>                    (callingStatement != null) ? callingStatement.getId() : 999,</TD></TR><TR><TD CLASS="l">1794</TD><TD>                    rs.resultId, System.currentTimeMillis(),</TD></TR><TR><TD CLASS="l">1795</TD><TD>                    (int) (queryEndTime - queryStartTime), null,</TD></TR><TR><TD CLASS="l">1796</TD><TD>                    new Throwable(), profileQueryToLog));</TD></TR><TR><TD CLASS="l">1797</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1798</TD><TD>            eventSink.consumeEvent(new ProfilerEvent(ProfilerEvent.TYPE_FETCH,</TD></TR><TR><TD CLASS="l">1799</TD><TD>                    &#34;&#34;, catalog, this.connection.getId(), //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">1800</TD><TD>                    (callingStatement != null) ? callingStatement.getId() : 999,</TD></TR><TR><TD CLASS="l">1801</TD><TD>                    rs.resultId, System.currentTimeMillis(),</TD></TR><TR><TD CLASS="l">1802</TD><TD>                    (int) (fetchEndTime - fetchBeginTime), null,</TD></TR><TR><TD CLASS="l">1803</TD><TD>                    new Throwable(), null));</TD></TR><TR><TD CLASS="l">1804</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1805</TD><TD>            if (this.queryBadIndexUsed) {</TD></TR><TR CLASS="p"><TD TITLE="97% line coverage (36 out of 37 instructions)" CLASS="l">1806</TD><TD TITLE="97% line coverage (36 out of 37 instructions)">                eventSink.consumeEvent(new ProfilerEvent(</TD></TR><TR><TD CLASS="l">1807</TD><TD>                        ProfilerEvent.TYPE_WARN, &#34;&#34;, catalog, //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">1808</TD><TD>                        this.connection.getId(),</TD></TR><TR><TD CLASS="l">1809</TD><TD>                        (callingStatement != null) ? callingStatement.getId()</TD></TR><TR><TD CLASS="l">1810</TD><TD>                                                   : 999, rs.resultId,</TD></TR><TR><TD CLASS="l">1811</TD><TD>                        System.currentTimeMillis(),</TD></TR><TR><TD CLASS="l">1812</TD><TD>                        (int) (queryEndTime - queryStartTime), null,</TD></TR><TR><TD CLASS="l">1813</TD><TD>                        new Throwable(),</TD></TR><TR><TD CLASS="l">1814</TD><TD>                        Messages.getString(&#34;MysqlIO.33&#34;) //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">1815</TD><TD>                         +profileQueryToLog));</TD></TR><TR><TD CLASS="l">1816</TD><TD>            }</TD></TR><TR><TD CLASS="l">1817</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1818</TD><TD>            if (this.queryNoIndexUsed) {</TD></TR><TR CLASS="z"><TD CLASS="l">1819</TD><TD>                eventSink.consumeEvent(new ProfilerEvent(</TD></TR><TR><TD CLASS="l">1820</TD><TD>                        ProfilerEvent.TYPE_WARN, &#34;&#34;, catalog, //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">1821</TD><TD>                        this.connection.getId(),</TD></TR><TR><TD CLASS="l">1822</TD><TD>                        (callingStatement != null) ? callingStatement.getId()</TD></TR><TR><TD CLASS="l">1823</TD><TD>                                                   : 999, rs.resultId,</TD></TR><TR><TD CLASS="l">1824</TD><TD>                        System.currentTimeMillis(),</TD></TR><TR><TD CLASS="l">1825</TD><TD>                        (int) (queryEndTime - queryStartTime), null,</TD></TR><TR><TD CLASS="l">1826</TD><TD>                        new Throwable(),</TD></TR><TR><TD CLASS="l">1827</TD><TD>                        Messages.getString(&#34;MysqlIO.35&#34;) //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">1828</TD><TD>                         +profileQueryToLog));</TD></TR><TR><TD CLASS="l">1829</TD><TD>            }</TD></TR><TR><TD CLASS="l">1830</TD><TD>        }</TD></TR><TR><TD CLASS="l">1831</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1832</TD><TD>        if (this.hadWarnings) {</TD></TR><TR CLASS="c"><TD CLASS="l">1833</TD><TD>            scanForAndThrowDataTruncation();</TD></TR><TR><TD CLASS="l">1834</TD><TD>        }</TD></TR><TR><TD CLASS="l">1835</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1836</TD><TD>        return rs;</TD></TR><TR><TD CLASS="l">1837</TD><TD>    }</TD></TR><TR><TD CLASS="l">1838</TD><TD> </TD></TR><TR><TD CLASS="l">1839</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1840</TD><TD>     * Returns the host this IO is connected to</TD></TR><TR><TD CLASS="l"><A NAME="36">1841</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">1842</TD><TD>     * @return DOCUMENT ME!</TD></TR><TR><TD CLASS="l">1843</TD><TD>     */</TD></TR><TR><TD CLASS="l">1844</TD><TD>    String getHost() {</TD></TR><TR CLASS="c"><TD CLASS="l">1845</TD><TD>        return this.host;</TD></TR><TR><TD CLASS="l">1846</TD><TD>    }</TD></TR><TR><TD CLASS="l">1847</TD><TD> </TD></TR><TR><TD CLASS="l">1848</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1849</TD><TD>     * Is the version of the MySQL server we are connected to the given</TD></TR><TR><TD CLASS="l">1850</TD><TD>     * version?</TD></TR><TR><TD CLASS="l">1851</TD><TD>     *</TD></TR><TR><TD CLASS="l">1852</TD><TD>     * @param major the major version</TD></TR><TR><TD CLASS="l">1853</TD><TD>     * @param minor the minor version</TD></TR><TR><TD CLASS="l">1854</TD><TD>     * @param subminor the subminor version</TD></TR><TR><TD CLASS="l">1855</TD><TD>     *</TD></TR><TR><TD CLASS="l"><A NAME="25">1856</A></TD><TD>     * @return true if the version of the MySQL server we are connected  is the</TD></TR><TR><TD CLASS="l">1857</TD><TD>     *         given version</TD></TR><TR><TD CLASS="l">1858</TD><TD>     */</TD></TR><TR><TD CLASS="l">1859</TD><TD>    boolean isVersion(int major, int minor, int subminor) {</TD></TR><TR CLASS="p"><TD TITLE="88% line coverage (14 out of 16 instructions)" CLASS="l">1860</TD><TD TITLE="88% line coverage (14 out of 16 instructions)">        return ((major == getServerMajorVersion()) &amp;&amp;</TD></TR><TR><TD CLASS="l">1861</TD><TD>        (minor == getServerMinorVersion()) &amp;&amp;</TD></TR><TR><TD CLASS="l">1862</TD><TD>        (subminor == getServerSubMinorVersion()));</TD></TR><TR><TD CLASS="l">1863</TD><TD>    }</TD></TR><TR><TD CLASS="l">1864</TD><TD> </TD></TR><TR><TD CLASS="l">1865</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1866</TD><TD>     * Does the version of the MySQL server we are connected to meet the given</TD></TR><TR><TD CLASS="l">1867</TD><TD>     * minimums?</TD></TR><TR><TD CLASS="l">1868</TD><TD>     *</TD></TR><TR><TD CLASS="l">1869</TD><TD>     * @param major DOCUMENT ME!</TD></TR><TR><TD CLASS="l">1870</TD><TD>     * @param minor DOCUMENT ME!</TD></TR><TR><TD CLASS="l">1871</TD><TD>     * @param subminor DOCUMENT ME!</TD></TR><TR><TD CLASS="l"><A NAME="2f">1872</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">1873</TD><TD>     * @return DOCUMENT ME!</TD></TR><TR><TD CLASS="l">1874</TD><TD>     */</TD></TR><TR><TD CLASS="l">1875</TD><TD>    boolean versionMeetsMinimum(int major, int minor, int subminor) {</TD></TR><TR CLASS="c"><TD CLASS="l">1876</TD><TD>        if (getServerMajorVersion() &gt;= major) {</TD></TR><TR CLASS="c"><TD CLASS="l">1877</TD><TD>            if (getServerMajorVersion() == major) {</TD></TR><TR CLASS="c"><TD CLASS="l">1878</TD><TD>                if (getServerMinorVersion() &gt;= minor) {</TD></TR><TR CLASS="c"><TD CLASS="l">1879</TD><TD>                    if (getServerMinorVersion() == minor) {</TD></TR><TR CLASS="p"><TD TITLE="88% line coverage (7 out of 8 instructions)" CLASS="l">1880</TD><TD TITLE="88% line coverage (7 out of 8 instructions)">                        return (getServerSubMinorVersion() &gt;= subminor);</TD></TR><TR><TD CLASS="l">1881</TD><TD>                    }</TD></TR><TR><TD CLASS="l">1882</TD><TD> </TD></TR><TR><TD CLASS="l">1883</TD><TD>                    // newer than major.minor</TD></TR><TR CLASS="c"><TD CLASS="l">1884</TD><TD>                    return true;</TD></TR><TR><TD CLASS="l">1885</TD><TD>                }</TD></TR><TR><TD CLASS="l">1886</TD><TD> </TD></TR><TR><TD CLASS="l">1887</TD><TD>                // older than major.minor</TD></TR><TR CLASS="c"><TD CLASS="l">1888</TD><TD>                return false;</TD></TR><TR><TD CLASS="l">1889</TD><TD>            }</TD></TR><TR><TD CLASS="l">1890</TD><TD> </TD></TR><TR><TD CLASS="l">1891</TD><TD>            // newer than major  </TD></TR><TR CLASS="c"><TD CLASS="l">1892</TD><TD>            return true;</TD></TR><TR><TD CLASS="l">1893</TD><TD>        }</TD></TR><TR><TD CLASS="l">1894</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1895</TD><TD>        return false;</TD></TR><TR><TD CLASS="l">1896</TD><TD>    }</TD></TR><TR><TD CLASS="l">1897</TD><TD> </TD></TR><TR><TD CLASS="l">1898</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1899</TD><TD>     * Returns the hex dump of the given packet, truncated to</TD></TR><TR><TD CLASS="l">1900</TD><TD>     * MAX_PACKET_DUMP_LENGTH if packetLength exceeds that value.</TD></TR><TR><TD CLASS="l">1901</TD><TD>     *</TD></TR><TR><TD CLASS="l">1902</TD><TD>     * @param packetToDump the packet to dump in hex</TD></TR><TR><TD CLASS="l">1903</TD><TD>     * @param packetLength the number of bytes to dump</TD></TR><TR><TD CLASS="l">1904</TD><TD>     *</TD></TR><TR><TD CLASS="l"><A NAME="d">1905</A></TD><TD>     * @return the hex dump of the given packet</TD></TR><TR><TD CLASS="l">1906</TD><TD>     */</TD></TR><TR><TD CLASS="l">1907</TD><TD>    private final static String getPacketDumpToLog(Buffer packetToDump,</TD></TR><TR><TD CLASS="l">1908</TD><TD>        int packetLength) {</TD></TR><TR CLASS="c"><TD CLASS="l">1909</TD><TD>        if (packetLength &lt; MAX_PACKET_DUMP_LENGTH) {</TD></TR><TR CLASS="c"><TD CLASS="l">1910</TD><TD>            return packetToDump.dump(packetLength);</TD></TR><TR><TD CLASS="l">1911</TD><TD>        }</TD></TR><TR><TD CLASS="l">1912</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1913</TD><TD>        StringBuffer packetDumpBuf = new StringBuffer(MAX_PACKET_DUMP_LENGTH * 4);</TD></TR><TR CLASS="z"><TD CLASS="l">1914</TD><TD>        packetDumpBuf.append(packetToDump.dump(MAX_PACKET_DUMP_LENGTH));</TD></TR><TR CLASS="z"><TD CLASS="l">1915</TD><TD>        packetDumpBuf.append(Messages.getString(&#34;MysqlIO.36&#34;)); //$NON-NLS-1$</TD></TR><TR CLASS="z"><TD CLASS="l">1916</TD><TD>        packetDumpBuf.append(MAX_PACKET_DUMP_LENGTH);</TD></TR><TR CLASS="z"><TD CLASS="l">1917</TD><TD>        packetDumpBuf.append(Messages.getString(&#34;MysqlIO.37&#34;)); //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">1918</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1919</TD><TD>        return packetDumpBuf.toString();</TD></TR><TR><TD CLASS="l"><A NAME="26">1920</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">1921</TD><TD> </TD></TR><TR><TD CLASS="l">1922</TD><TD>    private final int readFully(InputStream in, byte[] b, int off, int len)</TD></TR><TR><TD CLASS="l">1923</TD><TD>        throws IOException {</TD></TR><TR CLASS="c"><TD CLASS="l">1924</TD><TD>        if (len &lt; 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">1925</TD><TD>            throw new IndexOutOfBoundsException();</TD></TR><TR><TD CLASS="l">1926</TD><TD>        }</TD></TR><TR><TD CLASS="l">1927</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1928</TD><TD>        int n = 0;</TD></TR><TR><TD CLASS="l">1929</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1930</TD><TD>        while (n &lt; len) {</TD></TR><TR CLASS="c"><TD CLASS="l">1931</TD><TD>            int count = in.read(b, off + n, len - n);</TD></TR><TR><TD CLASS="l">1932</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1933</TD><TD>            if (count &lt; 0) {</TD></TR><TR CLASS="c"><TD CLASS="l">1934</TD><TD>                throw new EOFException();</TD></TR><TR><TD CLASS="l">1935</TD><TD>            }</TD></TR><TR><TD CLASS="l">1936</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1937</TD><TD>            n += count;</TD></TR><TR><TD CLASS="l">1938</TD><TD>        }</TD></TR><TR><TD CLASS="l">1939</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1940</TD><TD>        return n;</TD></TR><TR><TD CLASS="l">1941</TD><TD>    }</TD></TR><TR><TD CLASS="l">1942</TD><TD> </TD></TR><TR><TD CLASS="l">1943</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1944</TD><TD>     * Reads one result set off of the wire, if the result is actually an</TD></TR><TR><TD CLASS="l">1945</TD><TD>     * update count, creates an update-count only result set.</TD></TR><TR><TD CLASS="l">1946</TD><TD>     *</TD></TR><TR><TD CLASS="l">1947</TD><TD>     * @param callingStatement DOCUMENT ME!</TD></TR><TR><TD CLASS="l">1948</TD><TD>     * @param maxRows the maximum rows to return in the result set.</TD></TR><TR><TD CLASS="l">1949</TD><TD>     * @param resultSetType scrollability</TD></TR><TR><TD CLASS="l">1950</TD><TD>     * @param resultSetConcurrency updatability</TD></TR><TR><TD CLASS="l">1951</TD><TD>     * @param streamResults should the driver leave the results on the wire,</TD></TR><TR><TD CLASS="l">1952</TD><TD>     *        and read them only when needed?</TD></TR><TR><TD CLASS="l">1953</TD><TD>     * @param catalog the catalog in use</TD></TR><TR><TD CLASS="l">1954</TD><TD>     * @param resultPacket the first packet of information in the result set</TD></TR><TR><TD CLASS="l">1955</TD><TD>     * @param isBinaryEncoded is this result set from a prepared statement?</TD></TR><TR><TD CLASS="l">1956</TD><TD>     * @param preSentColumnCount do we already know the number of columns?</TD></TR><TR><TD CLASS="l">1957</TD><TD>     * @param unpackFieldInfo should we unpack the field information?</TD></TR><TR><TD CLASS="l">1958</TD><TD>     *</TD></TR><TR><TD CLASS="l">1959</TD><TD>     * @return a result set that either represents the rows, or an update count</TD></TR><TR><TD CLASS="l">1960</TD><TD>     *</TD></TR><TR><TD CLASS="l">1961</TD><TD>     * @throws SQLException if an error occurs while reading the rows</TD></TR><TR><TD CLASS="l">1962</TD><TD>     */</TD></TR><TR><TD CLASS="l">1963</TD><TD>    private final ResultSet readResultsForQueryOrUpdate(</TD></TR><TR><TD CLASS="l"><A NAME="2e">1964</A></TD><TD>        Statement callingStatement, int maxRows, int resultSetType,</TD></TR><TR><TD CLASS="l">1965</TD><TD>        int resultSetConcurrency, boolean streamResults, String catalog,</TD></TR><TR><TD CLASS="l">1966</TD><TD>        Buffer resultPacket, boolean isBinaryEncoded, long preSentColumnCount,</TD></TR><TR><TD CLASS="l">1967</TD><TD>        boolean unpackFieldInfo) throws SQLException {</TD></TR><TR CLASS="c"><TD CLASS="l">1968</TD><TD>        long columnCount = resultPacket.readFieldLength();</TD></TR><TR><TD CLASS="l">1969</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1970</TD><TD>        if (columnCount == 0) {</TD></TR><TR CLASS="c"><TD CLASS="l">1971</TD><TD>            return buildResultSetWithUpdates(callingStatement, resultPacket);</TD></TR><TR CLASS="c"><TD CLASS="l">1972</TD><TD>        } else if (columnCount == Buffer.NULL_LENGTH) {</TD></TR><TR CLASS="c"><TD CLASS="l">1973</TD><TD>            String charEncoding = null;</TD></TR><TR><TD CLASS="l">1974</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1975</TD><TD>            if (this.connection.getUseUnicode()) {</TD></TR><TR CLASS="c"><TD CLASS="l">1976</TD><TD>                charEncoding = this.connection.getEncoding();</TD></TR><TR><TD CLASS="l">1977</TD><TD>            }</TD></TR><TR><TD CLASS="l">1978</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1979</TD><TD>            String fileName = null;</TD></TR><TR><TD CLASS="l">1980</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1981</TD><TD>            if (this.platformDbCharsetMatches) {</TD></TR><TR CLASS="p"><TD TITLE="80% line coverage (8 out of 10 instructions)" CLASS="l">1982</TD><TD TITLE="80% line coverage (8 out of 10 instructions)">                fileName = ((charEncoding != null)</TD></TR><TR><TD CLASS="l">1983</TD><TD>                    ? resultPacket.readString(charEncoding)</TD></TR><TR><TD CLASS="l">1984</TD><TD>                    : resultPacket.readString());</TD></TR><TR><TD CLASS="l">1985</TD><TD>            } else {</TD></TR><TR CLASS="c"><TD CLASS="l">1986</TD><TD>                fileName = resultPacket.readString();</TD></TR><TR><TD CLASS="l">1987</TD><TD>            }</TD></TR><TR><TD CLASS="l">1988</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1989</TD><TD>            return sendFileToServer(callingStatement, fileName);</TD></TR><TR><TD CLASS="l">1990</TD><TD>        } else {</TD></TR><TR CLASS="c"><TD CLASS="l">1991</TD><TD>            com.mysql.jdbc.ResultSet results = getResultSet(callingStatement,</TD></TR><TR><TD CLASS="l">1992</TD><TD>                    columnCount, maxRows, resultSetType, resultSetConcurrency,</TD></TR><TR><TD CLASS="l">1993</TD><TD>                    streamResults, catalog, isBinaryEncoded, unpackFieldInfo);</TD></TR><TR><TD CLASS="l">1994</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">1995</TD><TD>            return results;</TD></TR><TR><TD CLASS="l"><A NAME="30">1996</A></TD><TD>        }</TD></TR><TR><TD CLASS="l">1997</TD><TD>    }</TD></TR><TR><TD CLASS="l">1998</TD><TD> </TD></TR><TR><TD CLASS="l">1999</TD><TD>    private int alignPacketSize(int a, int l) {</TD></TR><TR CLASS="c"><TD CLASS="l">2000</TD><TD>        return ((((a) + (l)) - 1) &amp; ~((l) - 1));</TD></TR><TR><TD CLASS="l">2001</TD><TD>    }</TD></TR><TR><TD CLASS="l">2002</TD><TD> </TD></TR><TR><TD CLASS="l">2003</TD><TD>    private com.mysql.jdbc.ResultSet buildResultSetWithRows(</TD></TR><TR><TD CLASS="l"><A NAME="31">2004</A></TD><TD>        Statement callingStatement, String catalog,</TD></TR><TR><TD CLASS="l">2005</TD><TD>        com.mysql.jdbc.Field[] fields, RowData rows, int resultSetType,</TD></TR><TR><TD CLASS="l">2006</TD><TD>        int resultSetConcurrency, boolean isBinaryEncoded)</TD></TR><TR><TD CLASS="l">2007</TD><TD>        throws SQLException {</TD></TR><TR CLASS="c"><TD CLASS="l">2008</TD><TD>        ResultSet rs = null;</TD></TR><TR><TD CLASS="l">2009</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2010</TD><TD>        switch (resultSetConcurrency) {</TD></TR><TR><TD CLASS="l">2011</TD><TD>        case java.sql.ResultSet.CONCUR_READ_ONLY:</TD></TR><TR CLASS="c"><TD CLASS="l">2012</TD><TD>            rs = new com.mysql.jdbc.ResultSet(catalog, fields, rows,</TD></TR><TR><TD CLASS="l">2013</TD><TD>                    this.connection, callingStatement);</TD></TR><TR><TD CLASS="l">2014</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2015</TD><TD>            if (isBinaryEncoded) {</TD></TR><TR CLASS="c"><TD CLASS="l">2016</TD><TD>                rs.setBinaryEncoded();</TD></TR><TR><TD CLASS="l">2017</TD><TD>            }</TD></TR><TR><TD CLASS="l">2018</TD><TD> </TD></TR><TR><TD CLASS="l">2019</TD><TD>            break;</TD></TR><TR><TD CLASS="l">2020</TD><TD> </TD></TR><TR><TD CLASS="l">2021</TD><TD>        case java.sql.ResultSet.CONCUR_UPDATABLE:</TD></TR><TR CLASS="c"><TD CLASS="l">2022</TD><TD>            rs = new com.mysql.jdbc.UpdatableResultSet(catalog, fields, rows,</TD></TR><TR><TD CLASS="l">2023</TD><TD>                    this.connection, callingStatement);</TD></TR><TR><TD CLASS="l">2024</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2025</TD><TD>            break;</TD></TR><TR><TD CLASS="l">2026</TD><TD> </TD></TR><TR><TD CLASS="l">2027</TD><TD>        default:</TD></TR><TR CLASS="c"><TD CLASS="l">2028</TD><TD>            return new com.mysql.jdbc.ResultSet(catalog, fields, rows,</TD></TR><TR><TD CLASS="l">2029</TD><TD>                this.connection, callingStatement);</TD></TR><TR><TD CLASS="l">2030</TD><TD>        }</TD></TR><TR><TD CLASS="l">2031</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2032</TD><TD>        rs.setResultSetType(resultSetType);</TD></TR><TR CLASS="c"><TD CLASS="l">2033</TD><TD>        rs.setResultSetConcurrency(resultSetConcurrency);</TD></TR><TR><TD CLASS="l">2034</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2035</TD><TD>        return rs;</TD></TR><TR><TD CLASS="l">2036</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="1e">2037</A></TD><TD> </TD></TR><TR><TD CLASS="l">2038</TD><TD>    private com.mysql.jdbc.ResultSet buildResultSetWithUpdates(</TD></TR><TR><TD CLASS="l">2039</TD><TD>        Statement callingStatement, Buffer resultPacket)</TD></TR><TR><TD CLASS="l">2040</TD><TD>        throws SQLException {</TD></TR><TR CLASS="c"><TD CLASS="l">2041</TD><TD>        long updateCount = -1;</TD></TR><TR CLASS="c"><TD CLASS="l">2042</TD><TD>        long updateID = -1;</TD></TR><TR CLASS="c"><TD CLASS="l">2043</TD><TD>        String info = null;</TD></TR><TR><TD CLASS="l">2044</TD><TD> </TD></TR><TR><TD CLASS="l">2045</TD><TD>        try {</TD></TR><TR CLASS="c"><TD CLASS="l">2046</TD><TD>            if (this.useNewUpdateCounts) {</TD></TR><TR CLASS="c"><TD CLASS="l">2047</TD><TD>                updateCount = resultPacket.newReadLength();</TD></TR><TR CLASS="c"><TD CLASS="l">2048</TD><TD>                updateID = resultPacket.newReadLength();</TD></TR><TR><TD CLASS="l">2049</TD><TD>            } else {</TD></TR><TR CLASS="z"><TD CLASS="l">2050</TD><TD>                updateCount = resultPacket.readLength();</TD></TR><TR CLASS="z"><TD CLASS="l">2051</TD><TD>                updateID = resultPacket.readLength();</TD></TR><TR><TD CLASS="l">2052</TD><TD>            }</TD></TR><TR><TD CLASS="l">2053</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2054</TD><TD>            if (this.use41Extensions) {</TD></TR><TR CLASS="c"><TD CLASS="l">2055</TD><TD>                this.serverStatus = resultPacket.readInt();</TD></TR><TR><TD CLASS="l">2056</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2057</TD><TD>                this.warningCount = resultPacket.readInt();</TD></TR><TR><TD CLASS="l">2058</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2059</TD><TD>                if (this.warningCount &gt; 0) {</TD></TR><TR CLASS="c"><TD CLASS="l">2060</TD><TD>                    this.hadWarnings = true; // this is a 'latch', it's reset by sendCommand()</TD></TR><TR><TD CLASS="l">2061</TD><TD>                }</TD></TR><TR><TD CLASS="l">2062</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2063</TD><TD>                resultPacket.readByte(); // advance pointer</TD></TR><TR><TD CLASS="l">2064</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2065</TD><TD>                if (this.profileSql) {</TD></TR><TR CLASS="p"><TD TITLE="88% line coverage (14 out of 16 instructions)" CLASS="l">2066</TD><TD TITLE="88% line coverage (14 out of 16 instructions)">                    this.queryNoIndexUsed = (this.serverStatus &amp;</TD></TR><TR><TD CLASS="l">2067</TD><TD>                        SERVER_QUERY_NO_GOOD_INDEX_USED) != 0;</TD></TR><TR CLASS="p"><TD TITLE="82% line coverage (9 out of 11 instructions)" CLASS="l">2068</TD><TD TITLE="82% line coverage (9 out of 11 instructions)">                    this.queryBadIndexUsed = (this.serverStatus &amp;</TD></TR><TR><TD CLASS="l">2069</TD><TD>                        SERVER_QUERY_NO_INDEX_USED) != 0;</TD></TR><TR><TD CLASS="l">2070</TD><TD>                }</TD></TR><TR><TD CLASS="l">2071</TD><TD>            }</TD></TR><TR><TD CLASS="l">2072</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2073</TD><TD>            if (this.connection.isReadInfoMsgEnabled()) {</TD></TR><TR CLASS="c"><TD CLASS="l">2074</TD><TD>                info = resultPacket.readString();</TD></TR><TR><TD CLASS="l">2075</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2076</TD><TD>        } catch (Exception ex) {</TD></TR><TR CLASS="z"><TD CLASS="l">2077</TD><TD>            throw new SQLException(SQLError.get(</TD></TR><TR><TD CLASS="l">2078</TD><TD>                    SQLError.SQL_STATE_GENERAL_ERROR) + &#34;: &#34; //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">2079</TD><TD>                 +ex.getClass().getName(), SQLError.SQL_STATE_GENERAL_ERROR, -1);</TD></TR><TR CLASS="c"><TD CLASS="l">2080</TD><TD>        }</TD></TR><TR><TD CLASS="l">2081</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2082</TD><TD>        ResultSet updateRs = new com.mysql.jdbc.ResultSet(updateCount,</TD></TR><TR><TD CLASS="l">2083</TD><TD>                updateID, this.connection, callingStatement);</TD></TR><TR><TD CLASS="l">2084</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2085</TD><TD>        if (info != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">2086</TD><TD>            updateRs.setServerInfo(info);</TD></TR><TR><TD CLASS="l">2087</TD><TD>        }</TD></TR><TR><TD CLASS="l">2088</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="33">2089</A></TD><TD>        return updateRs;</TD></TR><TR><TD CLASS="l">2090</TD><TD>    }</TD></TR><TR><TD CLASS="l">2091</TD><TD> </TD></TR><TR><TD CLASS="l">2092</TD><TD>    private void checkForOutstandingStreamingData() throws SQLException {</TD></TR><TR CLASS="c"><TD CLASS="l">2093</TD><TD>        if (this.streamingData != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">2094</TD><TD>            if (!this.connection.getClobberStreamingResults()) {</TD></TR><TR CLASS="c"><TD CLASS="l">2095</TD><TD>                throw new SQLException(Messages.getString(&#34;MysqlIO.39&#34;) //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">2096</TD><TD>                     +this.streamingData +</TD></TR><TR><TD CLASS="l">2097</TD><TD>                    Messages.getString(&#34;MysqlIO.40&#34;) //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">2098</TD><TD>                     +Messages.getString(&#34;MysqlIO.41&#34;) //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">2099</TD><TD>                     +Messages.getString(&#34;MysqlIO.42&#34;)); //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">2100</TD><TD>            }</TD></TR><TR><TD CLASS="l">2101</TD><TD> </TD></TR><TR><TD CLASS="l">2102</TD><TD>            // Close the result set</TD></TR><TR CLASS="c"><TD CLASS="l">2103</TD><TD>            this.streamingData.getOwner().realClose(false);</TD></TR><TR><TD CLASS="l">2104</TD><TD> </TD></TR><TR><TD CLASS="l">2105</TD><TD>            // clear any pending data....</TD></TR><TR CLASS="c"><TD CLASS="l">2106</TD><TD>            clearInputStream();</TD></TR><TR><TD CLASS="l">2107</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="3">2108</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">2109</TD><TD> </TD></TR><TR><TD CLASS="l">2110</TD><TD>    private Buffer compressPacket(Buffer packet, int offset, int packetLen,</TD></TR><TR><TD CLASS="l">2111</TD><TD>        int headerLength) throws SQLException {</TD></TR><TR CLASS="z"><TD CLASS="l">2112</TD><TD>        packet.writeLongInt(packetLen - headerLength);</TD></TR><TR CLASS="z"><TD CLASS="l">2113</TD><TD>        packet.writeByte((byte) 0); // wrapped packet has 0 packet seq.</TD></TR><TR><TD CLASS="l">2114</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2115</TD><TD>        int lengthToWrite = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">2116</TD><TD>        int compressedLength = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">2117</TD><TD>        byte[] bytesToCompress = packet.getByteBuffer();</TD></TR><TR CLASS="z"><TD CLASS="l">2118</TD><TD>        byte[] compressedBytes = null;</TD></TR><TR CLASS="z"><TD CLASS="l">2119</TD><TD>        int offsetWrite = 0;</TD></TR><TR><TD CLASS="l">2120</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2121</TD><TD>        if (packetLen &lt; MIN_COMPRESS_LEN) {</TD></TR><TR CLASS="z"><TD CLASS="l">2122</TD><TD>            lengthToWrite = packetLen;</TD></TR><TR CLASS="z"><TD CLASS="l">2123</TD><TD>            compressedBytes = packet.getByteBuffer();</TD></TR><TR CLASS="z"><TD CLASS="l">2124</TD><TD>            compressedLength = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">2125</TD><TD>            offsetWrite = offset;</TD></TR><TR><TD CLASS="l">2126</TD><TD>        } else {</TD></TR><TR CLASS="z"><TD CLASS="l">2127</TD><TD>            compressedBytes = new byte[bytesToCompress.length * 2];</TD></TR><TR><TD CLASS="l">2128</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2129</TD><TD>            this.deflater.reset();</TD></TR><TR CLASS="z"><TD CLASS="l">2130</TD><TD>            this.deflater.setInput(bytesToCompress, offset, packetLen);</TD></TR><TR CLASS="z"><TD CLASS="l">2131</TD><TD>            this.deflater.finish();</TD></TR><TR><TD CLASS="l">2132</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2133</TD><TD>            int compLen = this.deflater.deflate(compressedBytes);</TD></TR><TR><TD CLASS="l">2134</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2135</TD><TD>            if (compLen &gt; packetLen) {</TD></TR><TR CLASS="z"><TD CLASS="l">2136</TD><TD>                lengthToWrite = packetLen;</TD></TR><TR CLASS="z"><TD CLASS="l">2137</TD><TD>                compressedBytes = packet.getByteBuffer();</TD></TR><TR CLASS="z"><TD CLASS="l">2138</TD><TD>                compressedLength = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">2139</TD><TD>                offsetWrite = offset;</TD></TR><TR><TD CLASS="l">2140</TD><TD>            } else {</TD></TR><TR CLASS="z"><TD CLASS="l">2141</TD><TD>                lengthToWrite = compLen;</TD></TR><TR CLASS="z"><TD CLASS="l">2142</TD><TD>                headerLength += COMP_HEADER_LENGTH;</TD></TR><TR CLASS="z"><TD CLASS="l">2143</TD><TD>                compressedLength = packetLen;</TD></TR><TR><TD CLASS="l">2144</TD><TD>            }</TD></TR><TR><TD CLASS="l">2145</TD><TD>        }</TD></TR><TR><TD CLASS="l">2146</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2147</TD><TD>        Buffer compressedPacket = Buffer.allocateNew(packetLen + headerLength,</TD></TR><TR><TD CLASS="l">2148</TD><TD>                this.useNewIo);</TD></TR><TR><TD CLASS="l">2149</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2150</TD><TD>        compressedPacket.setPosition(0);</TD></TR><TR CLASS="z"><TD CLASS="l">2151</TD><TD>        compressedPacket.writeLongInt(lengthToWrite);</TD></TR><TR CLASS="z"><TD CLASS="l">2152</TD><TD>        compressedPacket.writeByte(this.packetSequence);</TD></TR><TR CLASS="z"><TD CLASS="l">2153</TD><TD>        compressedPacket.writeLongInt(compressedLength);</TD></TR><TR CLASS="z"><TD CLASS="l">2154</TD><TD>        compressedPacket.writeBytesNoNull(compressedBytes, offsetWrite,</TD></TR><TR><TD CLASS="l">2155</TD><TD>            lengthToWrite);</TD></TR><TR><TD CLASS="l">2156</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2157</TD><TD>        return compressedPacket;</TD></TR><TR><TD CLASS="l"><A NAME="2d">2158</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">2159</TD><TD> </TD></TR><TR><TD CLASS="l">2160</TD><TD>    private final void readServerStatusForResultSets(Buffer rowPacket)</TD></TR><TR><TD CLASS="l">2161</TD><TD>        throws SQLException {</TD></TR><TR CLASS="c"><TD CLASS="l">2162</TD><TD>        if (this.use41Extensions) {</TD></TR><TR CLASS="c"><TD CLASS="l">2163</TD><TD>            rowPacket.readByte(); // skips the 'last packet' flag</TD></TR><TR><TD CLASS="l">2164</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2165</TD><TD>            this.warningCount = rowPacket.readInt();</TD></TR><TR><TD CLASS="l">2166</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2167</TD><TD>            if (this.warningCount &gt; 0) {</TD></TR><TR CLASS="c"><TD CLASS="l">2168</TD><TD>                this.hadWarnings = true; // this is a 'latch', it's reset by sendCommand()</TD></TR><TR><TD CLASS="l">2169</TD><TD>            }</TD></TR><TR><TD CLASS="l">2170</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2171</TD><TD>            this.serverStatus = rowPacket.readInt();</TD></TR><TR><TD CLASS="l">2172</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2173</TD><TD>            if (this.profileSql) {</TD></TR><TR CLASS="p"><TD TITLE="88% line coverage (14 out of 16 instructions)" CLASS="l">2174</TD><TD TITLE="88% line coverage (14 out of 16 instructions)">                this.queryNoIndexUsed = (this.serverStatus &amp;</TD></TR><TR><TD CLASS="l">2175</TD><TD>                    SERVER_QUERY_NO_GOOD_INDEX_USED) != 0;</TD></TR><TR CLASS="c"><TD CLASS="l">2176</TD><TD>                this.queryBadIndexUsed = (this.serverStatus &amp;</TD></TR><TR><TD CLASS="l">2177</TD><TD>                    SERVER_QUERY_NO_INDEX_USED) != 0;</TD></TR><TR><TD CLASS="l">2178</TD><TD>            }</TD></TR><TR><TD CLASS="l">2179</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="c">2180</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">2181</TD><TD> </TD></TR><TR><TD CLASS="l">2182</TD><TD>    private SocketFactory createSocketFactory() throws SQLException {</TD></TR><TR><TD CLASS="l">2183</TD><TD>        try {</TD></TR><TR CLASS="c"><TD CLASS="l">2184</TD><TD>            if (this.socketFactoryClassName == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">2185</TD><TD>                throw new SQLException(Messages.getString(&#34;MysqlIO.75&#34;), //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">2186</TD><TD>                    SQLError.SQL_STATE_UNABLE_TO_CONNECT_TO_DATASOURCE);</TD></TR><TR><TD CLASS="l">2187</TD><TD>            }</TD></TR><TR><TD CLASS="l">2188</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2189</TD><TD>            return (SocketFactory) (Class.forName(this.socketFactoryClassName)</TD></TR><TR><TD CLASS="l">2190</TD><TD>                                         .newInstance());</TD></TR><TR CLASS="z"><TD CLASS="l">2191</TD><TD>        } catch (Exception ex) {</TD></TR><TR CLASS="z"><TD CLASS="l">2192</TD><TD>            throw new SQLException(Messages.getString(&#34;MysqlIO.76&#34;) //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">2193</TD><TD>                 +this.socketFactoryClassName +</TD></TR><TR><TD CLASS="l">2194</TD><TD>                Messages.getString(&#34;MysqlIO.77&#34;) + ex.toString() //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">2195</TD><TD>                 +(this.connection.getParanoid() ? &#34;&#34; //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">2196</TD><TD>                                                 : Util.stackTraceToString(ex)),</TD></TR><TR><TD CLASS="l">2197</TD><TD>                SQLError.SQL_STATE_UNABLE_TO_CONNECT_TO_DATASOURCE);</TD></TR><TR><TD CLASS="l">2198</TD><TD>        }</TD></TR><TR><TD CLASS="l">2199</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="5">2200</A></TD><TD> </TD></TR><TR><TD CLASS="l">2201</TD><TD>    private void enqueuePacketForDebugging(boolean isPacketBeingSent,</TD></TR><TR><TD CLASS="l">2202</TD><TD>        boolean isPacketReused, int sendLength, byte[] header, Buffer packet)</TD></TR><TR><TD CLASS="l">2203</TD><TD>        throws SQLException {</TD></TR><TR CLASS="z"><TD CLASS="l">2204</TD><TD>        if ((this.packetDebugRingBuffer.size() + 1) &gt; this.connection.getPacketDebugBufferSize()) {</TD></TR><TR CLASS="z"><TD CLASS="l">2205</TD><TD>            this.packetDebugRingBuffer.removeFirst();</TD></TR><TR><TD CLASS="l">2206</TD><TD>        }</TD></TR><TR><TD CLASS="l">2207</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2208</TD><TD>        StringBuffer packetDump = null;</TD></TR><TR><TD CLASS="l">2209</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2210</TD><TD>        if (!isPacketBeingSent) {</TD></TR><TR CLASS="z"><TD CLASS="l">2211</TD><TD>            int bytesToDump = Math.min(MAX_PACKET_DUMP_LENGTH,</TD></TR><TR><TD CLASS="l">2212</TD><TD>                    packet.getBufLength());</TD></TR><TR><TD CLASS="l">2213</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2214</TD><TD>            Buffer packetToDump = Buffer.allocateNew(4 + bytesToDump, false);</TD></TR><TR><TD CLASS="l">2215</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2216</TD><TD>            packetToDump.setPosition(0);</TD></TR><TR CLASS="z"><TD CLASS="l">2217</TD><TD>            packetToDump.writeBytesNoNull(header);</TD></TR><TR CLASS="z"><TD CLASS="l">2218</TD><TD>            packetToDump.writeBytesNoNull(packet.getBytes(0, bytesToDump));</TD></TR><TR><TD CLASS="l">2219</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2220</TD><TD>            String packetPayload = packetToDump.dump(bytesToDump);</TD></TR><TR><TD CLASS="l">2221</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2222</TD><TD>            packetDump = new StringBuffer(96 + packetPayload.length());</TD></TR><TR><TD CLASS="l">2223</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2224</TD><TD>            packetDump.append(&#34;Server &#34;);</TD></TR><TR><TD CLASS="l">2225</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2226</TD><TD>            if (isPacketReused) {</TD></TR><TR CLASS="z"><TD CLASS="l">2227</TD><TD>                packetDump.append(&#34;(re-used)&#34;);</TD></TR><TR><TD CLASS="l">2228</TD><TD>            } else {</TD></TR><TR CLASS="z"><TD CLASS="l">2229</TD><TD>                packetDump.append(&#34;(new)&#34;);</TD></TR><TR><TD CLASS="l">2230</TD><TD>            }</TD></TR><TR><TD CLASS="l">2231</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2232</TD><TD>            packetDump.append(&#34; &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2233</TD><TD>            packetDump.append(packet.toSuperString());</TD></TR><TR CLASS="z"><TD CLASS="l">2234</TD><TD>            packetDump.append(&#34; --------------------&gt; Client\n&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2235</TD><TD>            packetDump.append(&#34;\nPacket payload:\n\n&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2236</TD><TD>            packetDump.append(packetPayload);</TD></TR><TR><TD CLASS="l">2237</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2238</TD><TD>            if (bytesToDump == MAX_PACKET_DUMP_LENGTH) {</TD></TR><TR CLASS="z"><TD CLASS="l">2239</TD><TD>                packetDump.append(&#34;\nNote: Packet of &#34; + packet.getBufLength() +</TD></TR><TR><TD CLASS="l">2240</TD><TD>                    &#34; bytes truncated to &#34; + MAX_PACKET_DUMP_LENGTH +</TD></TR><TR><TD CLASS="l">2241</TD><TD>                    &#34; bytes.\n&#34;);</TD></TR><TR><TD CLASS="l">2242</TD><TD>            }</TD></TR><TR><TD CLASS="l">2243</TD><TD>        } else {</TD></TR><TR CLASS="z"><TD CLASS="l">2244</TD><TD>            int bytesToDump = Math.min(MAX_PACKET_DUMP_LENGTH, sendLength);</TD></TR><TR><TD CLASS="l">2245</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2246</TD><TD>            String packetPayload = packet.dump(bytesToDump);</TD></TR><TR><TD CLASS="l">2247</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2248</TD><TD>            packetDump = new StringBuffer(64 + 4 + packetPayload.length());</TD></TR><TR><TD CLASS="l">2249</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2250</TD><TD>            packetDump.append(&#34;Client &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2251</TD><TD>            packetDump.append(packet.toSuperString());</TD></TR><TR CLASS="z"><TD CLASS="l">2252</TD><TD>            packetDump.append(&#34;--------------------&gt; Server\n&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2253</TD><TD>            packetDump.append(&#34;\nPacket payload:\n\n&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2254</TD><TD>            packetDump.append(packetPayload);</TD></TR><TR><TD CLASS="l">2255</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2256</TD><TD>            if (bytesToDump == MAX_PACKET_DUMP_LENGTH) {</TD></TR><TR CLASS="z"><TD CLASS="l">2257</TD><TD>                packetDump.append(&#34;\nNote: Packet of &#34; + sendLength +</TD></TR><TR><TD CLASS="l">2258</TD><TD>                    &#34; bytes truncated to &#34; + MAX_PACKET_DUMP_LENGTH +</TD></TR><TR><TD CLASS="l">2259</TD><TD>                    &#34; bytes.\n&#34;);</TD></TR><TR><TD CLASS="l">2260</TD><TD>            }</TD></TR><TR><TD CLASS="l">2261</TD><TD>        }</TD></TR><TR><TD CLASS="l">2262</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2263</TD><TD>        this.packetDebugRingBuffer.addLast(packetDump);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="24">2264</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">2265</TD><TD> </TD></TR><TR><TD CLASS="l">2266</TD><TD>    private void readChannelFully(ByteBuffer buf, int length)</TD></TR><TR><TD CLASS="l">2267</TD><TD>        throws IOException {</TD></TR><TR CLASS="c"><TD CLASS="l">2268</TD><TD>        int n = 0;</TD></TR><TR><TD CLASS="l">2269</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2270</TD><TD>        while (n &lt; length) {</TD></TR><TR CLASS="c"><TD CLASS="l">2271</TD><TD>            int count = this.socketChannel.read(buf);</TD></TR><TR><TD CLASS="l">2272</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2273</TD><TD>            if (count &lt; 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">2274</TD><TD>                throw new EOFException();</TD></TR><TR><TD CLASS="l">2275</TD><TD>            }</TD></TR><TR><TD CLASS="l">2276</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2277</TD><TD>            n += count;</TD></TR><TR><TD CLASS="l">2278</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2279</TD><TD>            buf.position(n);</TD></TR><TR><TD CLASS="l">2280</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">2281</TD><TD>    }</TD></TR><TR><TD CLASS="l">2282</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="42">2283</A></TD><TD>    private RowData readSingleRowSet(long columnCount, int maxRows,</TD></TR><TR><TD CLASS="l">2284</TD><TD>        int resultSetConcurrency, boolean isBinaryEncoded, Field[] fields)</TD></TR><TR><TD CLASS="l">2285</TD><TD>        throws SQLException {</TD></TR><TR><TD CLASS="l">2286</TD><TD>        RowData rowData;</TD></TR><TR CLASS="c"><TD CLASS="l">2287</TD><TD>        ArrayList rows = new ArrayList();</TD></TR><TR><TD CLASS="l">2288</TD><TD> </TD></TR><TR><TD CLASS="l">2289</TD><TD>        // Now read the data</TD></TR><TR CLASS="c"><TD CLASS="l">2290</TD><TD>        Object rowBytes = nextRow(fields, (int) columnCount, isBinaryEncoded,</TD></TR><TR><TD CLASS="l">2291</TD><TD>                resultSetConcurrency);</TD></TR><TR><TD CLASS="l">2292</TD><TD>        </TD></TR><TR CLASS="c"><TD CLASS="l">2293</TD><TD>        int rowCount = 0;</TD></TR><TR><TD CLASS="l">2294</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2295</TD><TD>        if (rowBytes != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">2296</TD><TD>            rows.add(rowBytes);</TD></TR><TR CLASS="c"><TD CLASS="l">2297</TD><TD>            rowCount = 1;</TD></TR><TR><TD CLASS="l">2298</TD><TD>        }</TD></TR><TR><TD CLASS="l">2299</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2300</TD><TD>        while (rowBytes != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">2301</TD><TD>            rowBytes = nextRow(fields, (int) columnCount, isBinaryEncoded,</TD></TR><TR><TD CLASS="l">2302</TD><TD>                    resultSetConcurrency);</TD></TR><TR><TD CLASS="l">2303</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2304</TD><TD>            if (rowBytes != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">2305</TD><TD>                    if ((maxRows == -1) || (rowCount &lt; maxRows)) {</TD></TR><TR CLASS="c"><TD CLASS="l">2306</TD><TD>                            rows.add(rowBytes);</TD></TR><TR CLASS="c"><TD CLASS="l">2307</TD><TD>                            rowCount++;</TD></TR><TR><TD CLASS="l">2308</TD><TD>                    }</TD></TR><TR><TD CLASS="l">2309</TD><TD>            }</TD></TR><TR><TD CLASS="l">2310</TD><TD>        }</TD></TR><TR><TD CLASS="l">2311</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2312</TD><TD>        rowData = new RowDataStatic(rows);</TD></TR><TR><TD CLASS="l">2313</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="2b">2314</A></TD><TD>        return rowData;</TD></TR><TR><TD CLASS="l">2315</TD><TD>    }</TD></TR><TR><TD CLASS="l">2316</TD><TD> </TD></TR><TR><TD CLASS="l">2317</TD><TD>    private Buffer readViaChannel() throws IOException, SQLException {</TD></TR><TR CLASS="c"><TD CLASS="l">2318</TD><TD>        Buffer packet = Buffer.allocateNew(16384, true);</TD></TR><TR CLASS="c"><TD CLASS="l">2319</TD><TD>        packet.setPosition(0);</TD></TR><TR><TD CLASS="l">2320</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2321</TD><TD>        packet.setBufLength(4);</TD></TR><TR><TD CLASS="l">2322</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2323</TD><TD>        ByteBuffer lenBuf = packet.getNioBuffer();</TD></TR><TR><TD CLASS="l">2324</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2325</TD><TD>        readChannelFully(lenBuf, 4);</TD></TR><TR><TD CLASS="l">2326</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2327</TD><TD>        byte b1 = lenBuf.get(0);</TD></TR><TR CLASS="c"><TD CLASS="l">2328</TD><TD>        byte b2 = lenBuf.get(1);</TD></TR><TR CLASS="c"><TD CLASS="l">2329</TD><TD>        byte b3 = lenBuf.get(2);</TD></TR><TR><TD CLASS="l">2330</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2331</TD><TD>        int packetLength = (b1 &amp; 0xff) + ((b2 &amp; 0xff) &lt;&lt; 8) +</TD></TR><TR><TD CLASS="l">2332</TD><TD>            ((b3 &amp; 0xff) &lt;&lt; 16);</TD></TR><TR><TD CLASS="l">2333</TD><TD> </TD></TR><TR><TD CLASS="l">2334</TD><TD>        // -1 for all values through above assembly sequence</TD></TR><TR CLASS="c"><TD CLASS="l">2335</TD><TD>        if (packetLength == -65793) {</TD></TR><TR CLASS="z"><TD CLASS="l">2336</TD><TD>            forceClose();</TD></TR><TR CLASS="z"><TD CLASS="l">2337</TD><TD>            throw new IOException(Messages.getString(&#34;MysqlIO.79&#34;)); //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">2338</TD><TD>        }</TD></TR><TR><TD CLASS="l">2339</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2340</TD><TD>        packet.ensureCapacity(packetLength + 1);</TD></TR><TR CLASS="c"><TD CLASS="l">2341</TD><TD>        packet.setBufLength(packetLength);</TD></TR><TR CLASS="c"><TD CLASS="l">2342</TD><TD>        packet.setPosition(0);</TD></TR><TR CLASS="c"><TD CLASS="l">2343</TD><TD>        this.socketChannel.read(packet.getNioBuffer());</TD></TR><TR><TD CLASS="l">2344</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2345</TD><TD>        packet.setBufLength(packetLength + 1);</TD></TR><TR CLASS="c"><TD CLASS="l">2346</TD><TD>        packet.setPosition(packetLength);</TD></TR><TR CLASS="c"><TD CLASS="l">2347</TD><TD>        packet.writeByte((byte) 0); // \0 Termination required</TD></TR><TR CLASS="c"><TD CLASS="l">2348</TD><TD>        packet.setPosition(0);</TD></TR><TR><TD CLASS="l">2349</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2350</TD><TD>        return packet;</TD></TR><TR><TD CLASS="l">2351</TD><TD>    }</TD></TR><TR><TD CLASS="l">2352</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="43">2353</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">2354</TD><TD>     * Don't hold on to overly-large packets</TD></TR><TR><TD CLASS="l">2355</TD><TD>     */</TD></TR><TR><TD CLASS="l">2356</TD><TD>    private void reclaimLargeReusablePacket() {</TD></TR><TR CLASS="c"><TD CLASS="l">2357</TD><TD>        if ((this.reusablePacket != null) &amp;&amp;</TD></TR><TR><TD CLASS="l">2358</TD><TD>                (this.reusablePacket.getCapacity() &gt; 1048576)) {</TD></TR><TR CLASS="c"><TD CLASS="l">2359</TD><TD>            this.reusablePacket = Buffer.allocateNew(this.connection.getNetBufferLength(),</TD></TR><TR><TD CLASS="l">2360</TD><TD>                    this.useNewIo);</TD></TR><TR><TD CLASS="l">2361</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">2362</TD><TD>    }</TD></TR><TR><TD CLASS="l">2363</TD><TD> </TD></TR><TR><TD CLASS="l">2364</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2365</TD><TD>     * Re-use a packet to read from the MySQL server</TD></TR><TR><TD CLASS="l">2366</TD><TD>     *</TD></TR><TR><TD CLASS="l">2367</TD><TD>     * @param reuse DOCUMENT ME!</TD></TR><TR><TD CLASS="l">2368</TD><TD>     *</TD></TR><TR><TD CLASS="l">2369</TD><TD>     * @return DOCUMENT ME!</TD></TR><TR><TD CLASS="l">2370</TD><TD>     *</TD></TR><TR><TD CLASS="l">2371</TD><TD>     * @throws SQLException DOCUMENT ME!</TD></TR><TR><TD CLASS="l"><A NAME="1d">2372</A></TD><TD>     * @throws SQLException DOCUMENT ME!</TD></TR><TR><TD CLASS="l">2373</TD><TD>     */</TD></TR><TR><TD CLASS="l">2374</TD><TD>    private final Buffer reuseAndReadPacket(Buffer reuse)</TD></TR><TR><TD CLASS="l">2375</TD><TD>        throws SQLException {</TD></TR><TR CLASS="c"><TD CLASS="l">2376</TD><TD>        if (!this.useNewIo) {</TD></TR><TR><TD CLASS="l">2377</TD><TD>            try {</TD></TR><TR CLASS="c"><TD CLASS="l">2378</TD><TD>                reuse.setWasMultiPacket(false);</TD></TR><TR><TD CLASS="l">2379</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2380</TD><TD>                int lengthRead = readFully(this.mysqlInput,</TD></TR><TR><TD CLASS="l">2381</TD><TD>                        this.packetHeaderBuf, 0, 4);</TD></TR><TR><TD CLASS="l">2382</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2383</TD><TD>                if (lengthRead &lt; 4) {</TD></TR><TR CLASS="z"><TD CLASS="l">2384</TD><TD>                    forceClose();</TD></TR><TR CLASS="z"><TD CLASS="l">2385</TD><TD>                    throw new IOException(Messages.getString(&#34;MysqlIO.43&#34;)); //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">2386</TD><TD>                }</TD></TR><TR><TD CLASS="l">2387</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2388</TD><TD>                int packetLength = (this.packetHeaderBuf[0] &amp; 0xff) +</TD></TR><TR><TD CLASS="l">2389</TD><TD>                    ((this.packetHeaderBuf[1] &amp; 0xff) &lt;&lt; 8) +</TD></TR><TR><TD CLASS="l">2390</TD><TD>                    ((this.packetHeaderBuf[2] &amp; 0xff) &lt;&lt; 16);</TD></TR><TR><TD CLASS="l">2391</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2392</TD><TD>                if (this.traceProtocol) {</TD></TR><TR CLASS="c"><TD CLASS="l">2393</TD><TD>                    StringBuffer traceMessageBuf = new StringBuffer();</TD></TR><TR><TD CLASS="l">2394</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2395</TD><TD>                    traceMessageBuf.append(Messages.getString(&#34;MysqlIO.44&#34;)); //$NON-NLS-1$</TD></TR><TR CLASS="c"><TD CLASS="l">2396</TD><TD>                    traceMessageBuf.append(packetLength);</TD></TR><TR CLASS="c"><TD CLASS="l">2397</TD><TD>                    traceMessageBuf.append(Messages.getString(&#34;MysqlIO.45&#34;)); //$NON-NLS-1$</TD></TR><TR CLASS="c"><TD CLASS="l">2398</TD><TD>                    traceMessageBuf.append(StringUtils.dumpAsHex(</TD></TR><TR><TD CLASS="l">2399</TD><TD>                            this.packetHeaderBuf, 4));</TD></TR><TR><TD CLASS="l">2400</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2401</TD><TD>                    this.connection.getLog().logTrace(traceMessageBuf.toString());</TD></TR><TR><TD CLASS="l">2402</TD><TD>                }</TD></TR><TR><TD CLASS="l">2403</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2404</TD><TD>                byte multiPacketSeq = this.packetHeaderBuf[3];</TD></TR><TR><TD CLASS="l">2405</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2406</TD><TD>                if (!this.packetSequenceReset) {</TD></TR><TR CLASS="p"><TD TITLE="50% line coverage (3 out of 6 instructions)" CLASS="l">2407</TD><TD TITLE="50% line coverage (3 out of 6 instructions)">                    if (this.enablePacketDebug &amp;&amp; this.checkPacketSequence) {</TD></TR><TR CLASS="z"><TD CLASS="l">2408</TD><TD>                        checkPacketSequencing(multiPacketSeq);</TD></TR><TR><TD CLASS="l">2409</TD><TD>                    }</TD></TR><TR><TD CLASS="l">2410</TD><TD>                } else {</TD></TR><TR CLASS="c"><TD CLASS="l">2411</TD><TD>                    this.packetSequenceReset = false;</TD></TR><TR><TD CLASS="l">2412</TD><TD>                }</TD></TR><TR><TD CLASS="l">2413</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2414</TD><TD>                this.readPacketSequence = multiPacketSeq;</TD></TR><TR><TD CLASS="l">2415</TD><TD> </TD></TR><TR><TD CLASS="l">2416</TD><TD>                // Set the Buffer to it's original state</TD></TR><TR CLASS="c"><TD CLASS="l">2417</TD><TD>                reuse.setPosition(0);</TD></TR><TR><TD CLASS="l">2418</TD><TD> </TD></TR><TR><TD CLASS="l">2419</TD><TD>                // Do we need to re-alloc the byte buffer?</TD></TR><TR><TD CLASS="l">2420</TD><TD>                //</TD></TR><TR><TD CLASS="l">2421</TD><TD>                // Note: We actually check the length of the buffer,</TD></TR><TR><TD CLASS="l">2422</TD><TD>                // rather than getBufLength(), because getBufLength() is not</TD></TR><TR><TD CLASS="l">2423</TD><TD>                // necesarily the actual length of the byte array</TD></TR><TR><TD CLASS="l">2424</TD><TD>                // used as the buffer</TD></TR><TR CLASS="c"><TD CLASS="l">2425</TD><TD>                if (reuse.getByteBuffer().length &lt;= packetLength) {</TD></TR><TR CLASS="c"><TD CLASS="l">2426</TD><TD>                    reuse.setByteBuffer(new byte[packetLength + 1]);</TD></TR><TR><TD CLASS="l">2427</TD><TD>                }</TD></TR><TR><TD CLASS="l">2428</TD><TD> </TD></TR><TR><TD CLASS="l">2429</TD><TD>                // Set the new length</TD></TR><TR CLASS="c"><TD CLASS="l">2430</TD><TD>                reuse.setBufLength(packetLength);</TD></TR><TR><TD CLASS="l">2431</TD><TD> </TD></TR><TR><TD CLASS="l">2432</TD><TD>                // Read the data from the server</TD></TR><TR CLASS="c"><TD CLASS="l">2433</TD><TD>                int numBytesRead = readFully(this.mysqlInput,</TD></TR><TR><TD CLASS="l">2434</TD><TD>                        reuse.getByteBuffer(), 0, packetLength);</TD></TR><TR><TD CLASS="l">2435</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2436</TD><TD>                if (numBytesRead != packetLength) {</TD></TR><TR CLASS="z"><TD CLASS="l">2437</TD><TD>                    throw new IOException(&#34;Short read, expected &#34; +</TD></TR><TR><TD CLASS="l">2438</TD><TD>                        packetLength + &#34; bytes, only read &#34; + numBytesRead);</TD></TR><TR><TD CLASS="l">2439</TD><TD>                }</TD></TR><TR><TD CLASS="l">2440</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2441</TD><TD>                if (this.traceProtocol) {</TD></TR><TR CLASS="c"><TD CLASS="l">2442</TD><TD>                    StringBuffer traceMessageBuf = new StringBuffer();</TD></TR><TR><TD CLASS="l">2443</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2444</TD><TD>                    traceMessageBuf.append(Messages.getString(&#34;MysqlIO.46&#34;)); //$NON-NLS-1$</TD></TR><TR CLASS="c"><TD CLASS="l">2445</TD><TD>                    traceMessageBuf.append(getPacketDumpToLog(reuse,</TD></TR><TR><TD CLASS="l">2446</TD><TD>                            packetLength));</TD></TR><TR><TD CLASS="l">2447</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2448</TD><TD>                    this.connection.getLog().logTrace(traceMessageBuf.toString());</TD></TR><TR><TD CLASS="l">2449</TD><TD>                }</TD></TR><TR><TD CLASS="l">2450</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2451</TD><TD>                if (this.enablePacketDebug) {</TD></TR><TR CLASS="z"><TD CLASS="l">2452</TD><TD>                    enqueuePacketForDebugging(false, true, 0,</TD></TR><TR><TD CLASS="l">2453</TD><TD>                        this.packetHeaderBuf, reuse);</TD></TR><TR><TD CLASS="l">2454</TD><TD>                }</TD></TR><TR><TD CLASS="l">2455</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2456</TD><TD>                boolean isMultiPacket = false;</TD></TR><TR><TD CLASS="l">2457</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2458</TD><TD>                if (packetLength == this.maxThreeBytes) {</TD></TR><TR CLASS="c"><TD CLASS="l">2459</TD><TD>                    reuse.setPosition(this.maxThreeBytes);</TD></TR><TR><TD CLASS="l">2460</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2461</TD><TD>                    int packetEndPoint = packetLength;</TD></TR><TR><TD CLASS="l">2462</TD><TD> </TD></TR><TR><TD CLASS="l">2463</TD><TD>                    // it's multi-packet</TD></TR><TR CLASS="c"><TD CLASS="l">2464</TD><TD>                    isMultiPacket = true;</TD></TR><TR><TD CLASS="l">2465</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2466</TD><TD>                    lengthRead = readFully(this.mysqlInput,</TD></TR><TR><TD CLASS="l">2467</TD><TD>                            this.packetHeaderBuf = new byte[4], 0, 4);</TD></TR><TR><TD CLASS="l">2468</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2469</TD><TD>                    if (lengthRead &lt; 4) {</TD></TR><TR CLASS="z"><TD CLASS="l">2470</TD><TD>                        forceClose();</TD></TR><TR CLASS="z"><TD CLASS="l">2471</TD><TD>                        throw new IOException(Messages.getString(&#34;MysqlIO.47&#34;)); //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">2472</TD><TD>                    }</TD></TR><TR><TD CLASS="l">2473</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2474</TD><TD>                    packetLength = (this.packetHeaderBuf[0] &amp; 0xff) +</TD></TR><TR><TD CLASS="l">2475</TD><TD>                        ((this.packetHeaderBuf[1] &amp; 0xff) &lt;&lt; 8) +</TD></TR><TR><TD CLASS="l">2476</TD><TD>                        ((this.packetHeaderBuf[2] &amp; 0xff) &lt;&lt; 16);</TD></TR><TR><TD CLASS="l">2477</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2478</TD><TD>                    Buffer multiPacket = Buffer.allocateNew(packetLength,</TD></TR><TR><TD CLASS="l">2479</TD><TD>                            this.useNewIo);</TD></TR><TR CLASS="c"><TD CLASS="l">2480</TD><TD>                    boolean firstMultiPkt = true;</TD></TR><TR><TD CLASS="l">2481</TD><TD> </TD></TR><TR><TD CLASS="l">2482</TD><TD>                    while (true) {</TD></TR><TR CLASS="c"><TD CLASS="l">2483</TD><TD>                        if (!firstMultiPkt) {</TD></TR><TR CLASS="c"><TD CLASS="l">2484</TD><TD>                            lengthRead = readFully(this.mysqlInput,</TD></TR><TR><TD CLASS="l">2485</TD><TD>                                    this.packetHeaderBuf = new byte[4], 0, 4);</TD></TR><TR><TD CLASS="l">2486</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2487</TD><TD>                            if (lengthRead &lt; 4) {</TD></TR><TR CLASS="z"><TD CLASS="l">2488</TD><TD>                                forceClose();</TD></TR><TR CLASS="z"><TD CLASS="l">2489</TD><TD>                                throw new IOException(Messages.getString(</TD></TR><TR><TD CLASS="l">2490</TD><TD>                                        &#34;MysqlIO.48&#34;)); //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">2491</TD><TD>                            }</TD></TR><TR><TD CLASS="l">2492</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2493</TD><TD>                            packetLength = (this.packetHeaderBuf[0] &amp; 0xff) +</TD></TR><TR><TD CLASS="l">2494</TD><TD>                                ((this.packetHeaderBuf[1] &amp; 0xff) &lt;&lt; 8) +</TD></TR><TR><TD CLASS="l">2495</TD><TD>                                ((this.packetHeaderBuf[2] &amp; 0xff) &lt;&lt; 16);</TD></TR><TR><TD CLASS="l">2496</TD><TD>                        } else {</TD></TR><TR CLASS="c"><TD CLASS="l">2497</TD><TD>                            firstMultiPkt = false;</TD></TR><TR><TD CLASS="l">2498</TD><TD>                        }</TD></TR><TR><TD CLASS="l">2499</TD><TD> </TD></TR><TR CLASS="p"><TD TITLE="50% line coverage (3 out of 6 instructions)" CLASS="l">2500</TD><TD TITLE="50% line coverage (3 out of 6 instructions)">                        if (!this.useNewLargePackets &amp;&amp; (packetLength == 1)) {</TD></TR><TR CLASS="z"><TD CLASS="l">2501</TD><TD>                            clearInputStream();</TD></TR><TR><TD CLASS="l">2502</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2503</TD><TD>                            break;</TD></TR><TR CLASS="c"><TD CLASS="l">2504</TD><TD>                        } else if (packetLength &lt; this.maxThreeBytes) {</TD></TR><TR CLASS="c"><TD CLASS="l">2505</TD><TD>                            byte newPacketSeq = this.packetHeaderBuf[3];</TD></TR><TR><TD CLASS="l">2506</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2507</TD><TD>                            if (newPacketSeq != (multiPacketSeq + 1)) {</TD></TR><TR CLASS="z"><TD CLASS="l">2508</TD><TD>                                throw new IOException(Messages.getString(</TD></TR><TR><TD CLASS="l">2509</TD><TD>                                        &#34;MysqlIO.49&#34;)); //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">2510</TD><TD>                            }</TD></TR><TR><TD CLASS="l">2511</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2512</TD><TD>                            multiPacketSeq = newPacketSeq;</TD></TR><TR><TD CLASS="l">2513</TD><TD> </TD></TR><TR><TD CLASS="l">2514</TD><TD>                            // Set the Buffer to it's original state</TD></TR><TR CLASS="c"><TD CLASS="l">2515</TD><TD>                            multiPacket.setPosition(0);</TD></TR><TR><TD CLASS="l">2516</TD><TD> </TD></TR><TR><TD CLASS="l">2517</TD><TD>                            // Set the new length</TD></TR><TR CLASS="c"><TD CLASS="l">2518</TD><TD>                            multiPacket.setBufLength(packetLength);</TD></TR><TR><TD CLASS="l">2519</TD><TD> </TD></TR><TR><TD CLASS="l">2520</TD><TD>                            // Read the data from the server</TD></TR><TR CLASS="c"><TD CLASS="l">2521</TD><TD>                            byte[] byteBuf = multiPacket.getByteBuffer();</TD></TR><TR CLASS="c"><TD CLASS="l">2522</TD><TD>                            int lengthToWrite = packetLength;</TD></TR><TR><TD CLASS="l">2523</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2524</TD><TD>                            int bytesRead = readFully(this.mysqlInput, byteBuf,</TD></TR><TR><TD CLASS="l">2525</TD><TD>                                    0, packetLength);</TD></TR><TR><TD CLASS="l">2526</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2527</TD><TD>                            if (bytesRead != lengthToWrite) {</TD></TR><TR CLASS="z"><TD CLASS="l">2528</TD><TD>                                throw new CommunicationsException(this.connection,</TD></TR><TR><TD CLASS="l">2529</TD><TD>                                    this.lastPacketSentTimeMs,</TD></TR><TR><TD CLASS="l">2530</TD><TD>                                    new SQLException(Messages.getString(</TD></TR><TR><TD CLASS="l">2531</TD><TD>                                            &#34;MysqlIO.50&#34;) //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">2532</TD><TD>                                         +lengthToWrite +</TD></TR><TR><TD CLASS="l">2533</TD><TD>                                        Messages.getString(&#34;MysqlIO.51&#34;) +</TD></TR><TR><TD CLASS="l">2534</TD><TD>                                        bytesRead //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">2535</TD><TD>                                         +&#34;.&#34;)); //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">2536</TD><TD>                            }</TD></TR><TR><TD CLASS="l">2537</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2538</TD><TD>                            reuse.writeBytesNoNull(byteBuf, 0, lengthToWrite);</TD></TR><TR><TD CLASS="l">2539</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2540</TD><TD>                            packetEndPoint += lengthToWrite;</TD></TR><TR><TD CLASS="l">2541</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2542</TD><TD>                            break; // end of multipacket sequence</TD></TR><TR><TD CLASS="l">2543</TD><TD>                        }</TD></TR><TR><TD CLASS="l">2544</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2545</TD><TD>                        byte newPacketSeq = this.packetHeaderBuf[3];</TD></TR><TR><TD CLASS="l">2546</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2547</TD><TD>                        if (newPacketSeq != (multiPacketSeq + 1)) {</TD></TR><TR CLASS="z"><TD CLASS="l">2548</TD><TD>                            throw new IOException(Messages.getString(</TD></TR><TR><TD CLASS="l">2549</TD><TD>                                    &#34;MysqlIO.53&#34;)); //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">2550</TD><TD>                        }</TD></TR><TR><TD CLASS="l">2551</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2552</TD><TD>                        multiPacketSeq = newPacketSeq;</TD></TR><TR><TD CLASS="l">2553</TD><TD> </TD></TR><TR><TD CLASS="l">2554</TD><TD>                        // Set the Buffer to it's original state</TD></TR><TR CLASS="c"><TD CLASS="l">2555</TD><TD>                        multiPacket.setPosition(0);</TD></TR><TR><TD CLASS="l">2556</TD><TD> </TD></TR><TR><TD CLASS="l">2557</TD><TD>                        // Set the new length</TD></TR><TR CLASS="c"><TD CLASS="l">2558</TD><TD>                        multiPacket.setBufLength(packetLength);</TD></TR><TR><TD CLASS="l">2559</TD><TD> </TD></TR><TR><TD CLASS="l">2560</TD><TD>                        // Read the data from the server</TD></TR><TR CLASS="c"><TD CLASS="l">2561</TD><TD>                        byte[] byteBuf = multiPacket.getByteBuffer();</TD></TR><TR CLASS="c"><TD CLASS="l">2562</TD><TD>                        int lengthToWrite = packetLength;</TD></TR><TR><TD CLASS="l">2563</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2564</TD><TD>                        int bytesRead = readFully(this.mysqlInput, byteBuf, 0,</TD></TR><TR><TD CLASS="l">2565</TD><TD>                                packetLength);</TD></TR><TR><TD CLASS="l">2566</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2567</TD><TD>                        if (bytesRead != lengthToWrite) {</TD></TR><TR CLASS="z"><TD CLASS="l">2568</TD><TD>                            throw new CommunicationsException(this.connection,</TD></TR><TR><TD CLASS="l">2569</TD><TD>                                this.lastPacketSentTimeMs,</TD></TR><TR><TD CLASS="l">2570</TD><TD>                                new SQLException(Messages.getString(</TD></TR><TR><TD CLASS="l">2571</TD><TD>                                        &#34;MysqlIO.54&#34;) //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">2572</TD><TD>                                     +lengthToWrite +</TD></TR><TR><TD CLASS="l">2573</TD><TD>                                    Messages.getString(&#34;MysqlIO.55&#34;) //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">2574</TD><TD>                                     +bytesRead + &#34;.&#34;)); //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">2575</TD><TD>                        }</TD></TR><TR><TD CLASS="l">2576</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2577</TD><TD>                        reuse.writeBytesNoNull(byteBuf, 0, lengthToWrite);</TD></TR><TR><TD CLASS="l">2578</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2579</TD><TD>                        packetEndPoint += lengthToWrite;</TD></TR><TR><TD CLASS="l">2580</TD><TD>                    }</TD></TR><TR><TD CLASS="l">2581</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2582</TD><TD>                    reuse.setPosition(0);</TD></TR><TR CLASS="c"><TD CLASS="l">2583</TD><TD>                    reuse.setWasMultiPacket(true);</TD></TR><TR><TD CLASS="l">2584</TD><TD>                }</TD></TR><TR><TD CLASS="l">2585</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2586</TD><TD>                if (!isMultiPacket) {</TD></TR><TR CLASS="c"><TD CLASS="l">2587</TD><TD>                    reuse.getByteBuffer()[packetLength] = 0; // Null-termination</TD></TR><TR><TD CLASS="l">2588</TD><TD>                }</TD></TR><TR><TD CLASS="l">2589</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2590</TD><TD>                return reuse;</TD></TR><TR CLASS="c"><TD CLASS="l">2591</TD><TD>            } catch (IOException ioEx) {</TD></TR><TR CLASS="c"><TD CLASS="l">2592</TD><TD>                throw new CommunicationsException(this.connection,</TD></TR><TR><TD CLASS="l">2593</TD><TD>                    this.lastPacketSentTimeMs, ioEx);</TD></TR><TR CLASS="z"><TD CLASS="l">2594</TD><TD>            } catch (OutOfMemoryError oom) {</TD></TR><TR><TD CLASS="l">2595</TD><TD>                    try {</TD></TR><TR><TD CLASS="l">2596</TD><TD>                            // _Try_ this</TD></TR><TR CLASS="z"><TD CLASS="l">2597</TD><TD>                            clearInputStream();</TD></TR><TR CLASS="z"><TD CLASS="l">2598</TD><TD>                    } finally {</TD></TR><TR CLASS="z"><TD CLASS="l">2599</TD><TD>                            try {</TD></TR><TR CLASS="z"><TD CLASS="l">2600</TD><TD>                                    this.connection.realClose(false, false, true, oom);</TD></TR><TR><TD CLASS="l">2601</TD><TD>                            } finally {</TD></TR><TR CLASS="z"><TD CLASS="l">2602</TD><TD>                                    throw oom;</TD></TR><TR><TD CLASS="l">2603</TD><TD>                            }</TD></TR><TR CLASS="z"><TD CLASS="l">2604</TD><TD>                    }</TD></TR><TR><TD CLASS="l">2605</TD><TD>            }</TD></TR><TR><TD CLASS="l">2606</TD><TD>        }</TD></TR><TR><TD CLASS="l">2607</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2608</TD><TD>        return reuseAndReadViaChannel(reuse);</TD></TR><TR><TD CLASS="l">2609</TD><TD>    }</TD></TR><TR><TD CLASS="l">2610</TD><TD> </TD></TR><TR><TD CLASS="l">2611</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2612</TD><TD>         * @param multiPacketSeq</TD></TR><TR><TD CLASS="l"><A NAME="2">2613</A></TD><TD>         * @throws CommunicationsException</TD></TR><TR><TD CLASS="l">2614</TD><TD>         */</TD></TR><TR><TD CLASS="l">2615</TD><TD>    private void checkPacketSequencing(byte multiPacketSeq)</TD></TR><TR><TD CLASS="l">2616</TD><TD>        throws CommunicationsException {</TD></TR><TR CLASS="z"><TD CLASS="l">2617</TD><TD>        if ((multiPacketSeq == -128) &amp;&amp; (this.readPacketSequence != 127)) {</TD></TR><TR CLASS="z"><TD CLASS="l">2618</TD><TD>            throw new CommunicationsException(this.connection,</TD></TR><TR><TD CLASS="l">2619</TD><TD>                this.lastPacketSentTimeMs,</TD></TR><TR><TD CLASS="l">2620</TD><TD>                new IOException(&#34;Packets out of order, expected packet # -128, but received packet # &#34; +</TD></TR><TR><TD CLASS="l">2621</TD><TD>                    multiPacketSeq));</TD></TR><TR><TD CLASS="l">2622</TD><TD>        }</TD></TR><TR><TD CLASS="l">2623</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2624</TD><TD>        if ((this.readPacketSequence == -1) &amp;&amp; (multiPacketSeq != 0)) {</TD></TR><TR CLASS="z"><TD CLASS="l">2625</TD><TD>            throw new CommunicationsException(this.connection,</TD></TR><TR><TD CLASS="l">2626</TD><TD>                this.lastPacketSentTimeMs,</TD></TR><TR><TD CLASS="l">2627</TD><TD>                new IOException(&#34;Packets out of order, expected packet # -1, but received packet # &#34; +</TD></TR><TR><TD CLASS="l">2628</TD><TD>                    multiPacketSeq));</TD></TR><TR><TD CLASS="l">2629</TD><TD>        }</TD></TR><TR><TD CLASS="l">2630</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2631</TD><TD>        if ((multiPacketSeq != -128) &amp;&amp; (this.readPacketSequence != -1) &amp;&amp;</TD></TR><TR><TD CLASS="l">2632</TD><TD>                (multiPacketSeq != (this.readPacketSequence + 1))) {</TD></TR><TR CLASS="z"><TD CLASS="l">2633</TD><TD>            throw new CommunicationsException(this.connection,</TD></TR><TR><TD CLASS="l">2634</TD><TD>                this.lastPacketSentTimeMs,</TD></TR><TR><TD CLASS="l">2635</TD><TD>                new IOException(&#34;Packets out of order, expected packet # &#34; +</TD></TR><TR><TD CLASS="l">2636</TD><TD>                    (this.readPacketSequence + 1) + &#34;, but received packet # &#34; +</TD></TR><TR><TD CLASS="l">2637</TD><TD>                    multiPacketSeq));</TD></TR><TR><TD CLASS="l">2638</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2639</TD><TD>    }</TD></TR><TR><TD CLASS="l">2640</TD><TD> </TD></TR><TR><TD CLASS="l">2641</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2642</TD><TD>    * Send a packet to the MySQL server</TD></TR><TR><TD CLASS="l">2643</TD><TD>    *</TD></TR><TR><TD CLASS="l">2644</TD><TD>    * @param packet DOCUMENT ME!</TD></TR><TR><TD CLASS="l"><A NAME="47">2645</A></TD><TD>    *</TD></TR><TR><TD CLASS="l">2646</TD><TD>    * @throws SQLException DOCUMENT ME!</TD></TR><TR><TD CLASS="l">2647</TD><TD>    */</TD></TR><TR><TD CLASS="l">2648</TD><TD>    final void send(Buffer packet) throws SQLException {</TD></TR><TR CLASS="c"><TD CLASS="l">2649</TD><TD>        int l = packet.getPosition();</TD></TR><TR CLASS="c"><TD CLASS="l">2650</TD><TD>        send(packet, l);</TD></TR><TR><TD CLASS="l">2651</TD><TD> </TD></TR><TR><TD CLASS="l">2652</TD><TD>        // </TD></TR><TR><TD CLASS="l">2653</TD><TD>        // Don't hold on to large packets</TD></TR><TR><TD CLASS="l">2654</TD><TD>        //</TD></TR><TR CLASS="c"><TD CLASS="l">2655</TD><TD>        if (packet == this.sharedSendPacket) {</TD></TR><TR CLASS="c"><TD CLASS="l">2656</TD><TD>            reclaimLargeSharedSendPacket();</TD></TR><TR><TD CLASS="l"><A NAME="35">2657</A></TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">2658</TD><TD>    }</TD></TR><TR><TD CLASS="l">2659</TD><TD>    </TD></TR><TR><TD CLASS="l">2660</TD><TD>    void enableMultiQueries() throws SQLException {</TD></TR><TR CLASS="c"><TD CLASS="l">2661</TD><TD>            Buffer buf = getSharedSendPacket();</TD></TR><TR><TD CLASS="l">2662</TD><TD>            </TD></TR><TR CLASS="c"><TD CLASS="l">2663</TD><TD>            buf.clear();</TD></TR><TR CLASS="c"><TD CLASS="l">2664</TD><TD>            buf.writeByte((byte)MysqlDefs.COM_SET_OPTION);</TD></TR><TR CLASS="c"><TD CLASS="l">2665</TD><TD>            buf.writeInt(0);</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="34">2666</A></TD><TD>            sendCommand(MysqlDefs.COM_SET_OPTION, null, buf, false, null);</TD></TR><TR CLASS="c"><TD CLASS="l">2667</TD><TD>    }</TD></TR><TR><TD CLASS="l">2668</TD><TD>    </TD></TR><TR><TD CLASS="l">2669</TD><TD>    void disableMultiQueries() throws SQLException {</TD></TR><TR CLASS="c"><TD CLASS="l">2670</TD><TD>            Buffer buf = getSharedSendPacket();</TD></TR><TR><TD CLASS="l">2671</TD><TD>            </TD></TR><TR CLASS="c"><TD CLASS="l">2672</TD><TD>            buf.clear();</TD></TR><TR CLASS="c"><TD CLASS="l">2673</TD><TD>            buf.writeByte((byte)MysqlDefs.COM_SET_OPTION);</TD></TR><TR CLASS="c"><TD CLASS="l">2674</TD><TD>            buf.writeInt(1);</TD></TR><TR CLASS="c"><TD CLASS="l">2675</TD><TD>            sendCommand(MysqlDefs.COM_SET_OPTION, null, buf, false, null);</TD></TR><TR CLASS="c"><TD CLASS="l">2676</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="17">2677</A></TD><TD> </TD></TR><TR><TD CLASS="l">2678</TD><TD>    private final void send(Buffer packet, int packetLen)</TD></TR><TR><TD CLASS="l">2679</TD><TD>        throws SQLException {</TD></TR><TR><TD CLASS="l">2680</TD><TD>        try {</TD></TR><TR CLASS="c"><TD CLASS="l">2681</TD><TD>            if (packetLen &gt; this.maxAllowedPacket) {</TD></TR><TR CLASS="c"><TD CLASS="l">2682</TD><TD>                throw new PacketTooBigException(packetLen, this.maxAllowedPacket);</TD></TR><TR><TD CLASS="l">2683</TD><TD>            }</TD></TR><TR><TD CLASS="l">2684</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2685</TD><TD>                        if (this.connection.getMaintainTimeStats()) {</TD></TR><TR CLASS="c"><TD CLASS="l">2686</TD><TD>                                this.lastPacketSentTimeMs = System.currentTimeMillis();</TD></TR><TR><TD CLASS="l">2687</TD><TD>                        }</TD></TR><TR><TD CLASS="l">2688</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2689</TD><TD>            if ((this.serverMajorVersion &gt;= 4) &amp;&amp;</TD></TR><TR><TD CLASS="l">2690</TD><TD>                    (packetLen &gt;= this.maxThreeBytes)) {</TD></TR><TR CLASS="c"><TD CLASS="l">2691</TD><TD>                if (!this.useNewIo) {</TD></TR><TR CLASS="c"><TD CLASS="l">2692</TD><TD>                    sendSplitPackets(packet);</TD></TR><TR><TD CLASS="l">2693</TD><TD>                } else {</TD></TR><TR CLASS="c"><TD CLASS="l">2694</TD><TD>                    sendSplitPacketsViaChannel(packet);</TD></TR><TR><TD CLASS="l">2695</TD><TD>                }</TD></TR><TR><TD CLASS="l">2696</TD><TD>            } else {</TD></TR><TR CLASS="c"><TD CLASS="l">2697</TD><TD>                this.packetSequence++;</TD></TR><TR><TD CLASS="l">2698</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2699</TD><TD>                Buffer packetToSend = packet;</TD></TR><TR><TD CLASS="l">2700</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2701</TD><TD>                packetToSend.setPosition(0);</TD></TR><TR><TD CLASS="l">2702</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2703</TD><TD>                if (this.useCompression) {</TD></TR><TR CLASS="z"><TD CLASS="l">2704</TD><TD>                    int originalPacketLen = packetLen;</TD></TR><TR><TD CLASS="l">2705</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2706</TD><TD>                    packetToSend = compressPacket(packet, 0, packetLen,</TD></TR><TR><TD CLASS="l">2707</TD><TD>                            HEADER_LENGTH);</TD></TR><TR CLASS="z"><TD CLASS="l">2708</TD><TD>                    packetLen = packetToSend.getPosition();</TD></TR><TR><TD CLASS="l">2709</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2710</TD><TD>                    if (this.traceProtocol) {</TD></TR><TR CLASS="z"><TD CLASS="l">2711</TD><TD>                        StringBuffer traceMessageBuf = new StringBuffer();</TD></TR><TR><TD CLASS="l">2712</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2713</TD><TD>                        traceMessageBuf.append(Messages.getString(&#34;MysqlIO.57&#34;)); //$NON-NLS-1$</TD></TR><TR CLASS="z"><TD CLASS="l">2714</TD><TD>                        traceMessageBuf.append(getPacketDumpToLog(</TD></TR><TR><TD CLASS="l">2715</TD><TD>                                packetToSend, packetLen));</TD></TR><TR CLASS="z"><TD CLASS="l">2716</TD><TD>                        traceMessageBuf.append(Messages.getString(&#34;MysqlIO.58&#34;)); //$NON-NLS-1$</TD></TR><TR CLASS="z"><TD CLASS="l">2717</TD><TD>                        traceMessageBuf.append(getPacketDumpToLog(packet,</TD></TR><TR><TD CLASS="l">2718</TD><TD>                                originalPacketLen));</TD></TR><TR><TD CLASS="l">2719</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2720</TD><TD>                        this.connection.getLog().logTrace(traceMessageBuf.toString());</TD></TR><TR><TD CLASS="l">2721</TD><TD>                    }</TD></TR><TR><TD CLASS="l">2722</TD><TD>                } else {</TD></TR><TR CLASS="c"><TD CLASS="l">2723</TD><TD>                    packetToSend.writeLongInt(packetLen - HEADER_LENGTH);</TD></TR><TR CLASS="c"><TD CLASS="l">2724</TD><TD>                    packetToSend.writeByte(this.packetSequence);</TD></TR><TR><TD CLASS="l">2725</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2726</TD><TD>                    if (this.traceProtocol) {</TD></TR><TR CLASS="c"><TD CLASS="l">2727</TD><TD>                        StringBuffer traceMessageBuf = new StringBuffer();</TD></TR><TR><TD CLASS="l">2728</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2729</TD><TD>                        traceMessageBuf.append(Messages.getString(&#34;MysqlIO.59&#34;)); //$NON-NLS-1$</TD></TR><TR CLASS="c"><TD CLASS="l">2730</TD><TD>                        traceMessageBuf.append(packetToSend.dump(packetLen));</TD></TR><TR><TD CLASS="l">2731</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2732</TD><TD>                        this.connection.getLog().logTrace(traceMessageBuf.toString());</TD></TR><TR><TD CLASS="l">2733</TD><TD>                    }</TD></TR><TR><TD CLASS="l">2734</TD><TD>                }</TD></TR><TR><TD CLASS="l">2735</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2736</TD><TD>                if (!this.useNewIo) {</TD></TR><TR CLASS="c"><TD CLASS="l">2737</TD><TD>                    this.mysqlOutput.write(packetToSend.getByteBuffer(), 0,</TD></TR><TR><TD CLASS="l">2738</TD><TD>                        packetLen);</TD></TR><TR CLASS="c"><TD CLASS="l">2739</TD><TD>                    this.mysqlOutput.flush();</TD></TR><TR><TD CLASS="l">2740</TD><TD>                } else {</TD></TR><TR CLASS="c"><TD CLASS="l">2741</TD><TD>                    sendViaChannel(packetToSend, packetLen);</TD></TR><TR><TD CLASS="l">2742</TD><TD>                }</TD></TR><TR><TD CLASS="l">2743</TD><TD>            }</TD></TR><TR><TD CLASS="l">2744</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2745</TD><TD>            if (this.enablePacketDebug) {</TD></TR><TR CLASS="z"><TD CLASS="l">2746</TD><TD>                enqueuePacketForDebugging(true, false, packetLen + 5,</TD></TR><TR><TD CLASS="l">2747</TD><TD>                    this.packetHeaderBuf, packet);</TD></TR><TR><TD CLASS="l">2748</TD><TD>            }</TD></TR><TR><TD CLASS="l">2749</TD><TD> </TD></TR><TR><TD CLASS="l">2750</TD><TD>            // </TD></TR><TR><TD CLASS="l">2751</TD><TD>            // Don't hold on to large packets</TD></TR><TR><TD CLASS="l">2752</TD><TD>            //</TD></TR><TR CLASS="c"><TD CLASS="l">2753</TD><TD>            if (packet == this.sharedSendPacket) {</TD></TR><TR CLASS="c"><TD CLASS="l">2754</TD><TD>                reclaimLargeSharedSendPacket();</TD></TR><TR><TD CLASS="l">2755</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">2756</TD><TD>        } catch (IOException ioEx) {</TD></TR><TR CLASS="c"><TD CLASS="l">2757</TD><TD>            throw new CommunicationsException(this.connection,</TD></TR><TR><TD CLASS="l">2758</TD><TD>                this.lastPacketSentTimeMs, ioEx);</TD></TR><TR CLASS="c"><TD CLASS="l">2759</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">2760</TD><TD>    }</TD></TR><TR><TD CLASS="l">2761</TD><TD> </TD></TR><TR><TD CLASS="l">2762</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2763</TD><TD>     * Reads and sends a file to the server for LOAD DATA LOCAL INFILE</TD></TR><TR><TD CLASS="l">2764</TD><TD>     *</TD></TR><TR><TD CLASS="l">2765</TD><TD>     * @param callingStatement DOCUMENT ME!</TD></TR><TR><TD CLASS="l">2766</TD><TD>     * @param fileName the file name to send.</TD></TR><TR><TD CLASS="l">2767</TD><TD>     *</TD></TR><TR><TD CLASS="l">2768</TD><TD>     * @return DOCUMENT ME!</TD></TR><TR><TD CLASS="l">2769</TD><TD>     *</TD></TR><TR><TD CLASS="l">2770</TD><TD>     * @throws SQLException DOCUMENT ME!</TD></TR><TR><TD CLASS="l"><A NAME="27">2771</A></TD><TD>     */</TD></TR><TR><TD CLASS="l">2772</TD><TD>    private final ResultSet sendFileToServer(Statement callingStatement,</TD></TR><TR><TD CLASS="l">2773</TD><TD>        String fileName) throws SQLException {</TD></TR><TR><TD CLASS="l">2774</TD><TD>            </TD></TR><TR CLASS="c"><TD CLASS="l">2775</TD><TD>        Buffer filePacket = (this.loadFileBufRef == null) ? null</TD></TR><TR><TD CLASS="l">2776</TD><TD>                                                          : (Buffer) (this.loadFileBufRef.get());</TD></TR><TR><TD CLASS="l">2777</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2778</TD><TD>        int bigPacketLength = Math.min(this.connection.getMaxAllowedPacket() -</TD></TR><TR><TD CLASS="l">2779</TD><TD>                (HEADER_LENGTH * 3),</TD></TR><TR><TD CLASS="l">2780</TD><TD>                alignPacketSize(this.connection.getMaxAllowedPacket() - 16, 4096) -</TD></TR><TR><TD CLASS="l">2781</TD><TD>                (HEADER_LENGTH * 3));</TD></TR><TR><TD CLASS="l">2782</TD><TD>        </TD></TR><TR CLASS="c"><TD CLASS="l">2783</TD><TD>        int oneMeg = 1024 * 1024;</TD></TR><TR><TD CLASS="l">2784</TD><TD>        </TD></TR><TR CLASS="c"><TD CLASS="l">2785</TD><TD>        int smallerPacketSizeAligned = Math.min(oneMeg - (HEADER_LENGTH * 3), </TD></TR><TR><TD CLASS="l">2786</TD><TD>                        alignPacketSize(oneMeg - 16, 4096) - (HEADER_LENGTH * 3));</TD></TR><TR><TD CLASS="l">2787</TD><TD>        </TD></TR><TR CLASS="c"><TD CLASS="l">2788</TD><TD>        int packetLength = Math.min(smallerPacketSizeAligned, bigPacketLength);</TD></TR><TR><TD CLASS="l">2789</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2790</TD><TD>        if (filePacket == null) {</TD></TR><TR><TD CLASS="l">2791</TD><TD>                try {</TD></TR><TR CLASS="c"><TD CLASS="l">2792</TD><TD>                        filePacket = Buffer.allocateNew((packetLength + HEADER_LENGTH),</TD></TR><TR><TD CLASS="l">2793</TD><TD>                    this.useNewIo);</TD></TR><TR CLASS="c"><TD CLASS="l">2794</TD><TD>                        this.loadFileBufRef = new SoftReference(filePacket);</TD></TR><TR CLASS="z"><TD CLASS="l">2795</TD><TD>                } catch (OutOfMemoryError oom) {</TD></TR><TR CLASS="z"><TD CLASS="l">2796</TD><TD>                        throw new SQLException(&#34;Could not allocate packet of &#34; + packetLength </TD></TR><TR><TD CLASS="l">2797</TD><TD>                                        + &#34; bytes required for LOAD DATA LOCAL INFILE operation.&#34; </TD></TR><TR><TD CLASS="l">2798</TD><TD>                                                + &#34; Try increasing max heap allocation for JVM or decreasing server variable &#34;</TD></TR><TR><TD CLASS="l">2799</TD><TD>                                                + &#34;'max_allowed_packet'&#34;, SQLError.SQL_STATE_MEMORY_ALLOCATION_FAILURE);</TD></TR><TR><TD CLASS="l">2800</TD><TD>                                </TD></TR><TR CLASS="c"><TD CLASS="l">2801</TD><TD>                }</TD></TR><TR><TD CLASS="l">2802</TD><TD>        }</TD></TR><TR><TD CLASS="l">2803</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2804</TD><TD>        filePacket.clear();</TD></TR><TR CLASS="c"><TD CLASS="l">2805</TD><TD>        send(filePacket, 0);</TD></TR><TR><TD CLASS="l">2806</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2807</TD><TD>        byte[] fileBuf = new byte[packetLength];</TD></TR><TR><TD CLASS="l">2808</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2809</TD><TD>        BufferedInputStream fileIn = null;</TD></TR><TR><TD CLASS="l">2810</TD><TD> </TD></TR><TR><TD CLASS="l">2811</TD><TD>        try {</TD></TR><TR CLASS="c"><TD CLASS="l">2812</TD><TD>            if (!this.connection.getAllowUrlInLocalInfile()) {</TD></TR><TR CLASS="c"><TD CLASS="l">2813</TD><TD>                fileIn = new BufferedInputStream(new FileInputStream(fileName));</TD></TR><TR><TD CLASS="l">2814</TD><TD>            } else {</TD></TR><TR><TD CLASS="l">2815</TD><TD>                // First look for ':'</TD></TR><TR CLASS="c"><TD CLASS="l">2816</TD><TD>                if (fileName.indexOf(&#34;:&#34;) != -1) {</TD></TR><TR><TD CLASS="l">2817</TD><TD>                    try {</TD></TR><TR CLASS="c"><TD CLASS="l">2818</TD><TD>                        URL urlFromFileName = new URL(fileName);</TD></TR><TR CLASS="c"><TD CLASS="l">2819</TD><TD>                        fileIn = new BufferedInputStream(urlFromFileName.openStream());</TD></TR><TR CLASS="c"><TD CLASS="l">2820</TD><TD>                    } catch (MalformedURLException badUrlEx) {</TD></TR><TR><TD CLASS="l">2821</TD><TD>                        // we fall back to trying this as a file input stream</TD></TR><TR CLASS="c"><TD CLASS="l">2822</TD><TD>                        fileIn = new BufferedInputStream(new FileInputStream(</TD></TR><TR><TD CLASS="l">2823</TD><TD>                                    fileName));</TD></TR><TR CLASS="c"><TD CLASS="l">2824</TD><TD>                    }</TD></TR><TR><TD CLASS="l">2825</TD><TD>                } else {</TD></TR><TR CLASS="c"><TD CLASS="l">2826</TD><TD>                    fileIn = new BufferedInputStream(new FileInputStream(</TD></TR><TR><TD CLASS="l">2827</TD><TD>                                fileName));</TD></TR><TR><TD CLASS="l">2828</TD><TD>                }</TD></TR><TR><TD CLASS="l">2829</TD><TD>            }</TD></TR><TR><TD CLASS="l">2830</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2831</TD><TD>            int bytesRead = 0;</TD></TR><TR><TD CLASS="l">2832</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2833</TD><TD>            while ((bytesRead = fileIn.read(fileBuf)) != -1) {</TD></TR><TR CLASS="c"><TD CLASS="l">2834</TD><TD>                filePacket.clear();</TD></TR><TR CLASS="c"><TD CLASS="l">2835</TD><TD>                filePacket.writeBytesNoNull(fileBuf, 0, bytesRead);</TD></TR><TR CLASS="c"><TD CLASS="l">2836</TD><TD>                send(filePacket);</TD></TR><TR><TD CLASS="l">2837</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">2838</TD><TD>        } catch (IOException ioEx) {</TD></TR><TR CLASS="c"><TD CLASS="l">2839</TD><TD>            StringBuffer messageBuf = new StringBuffer(Messages.getString(</TD></TR><TR><TD CLASS="l">2840</TD><TD>                        &#34;MysqlIO.60&#34;)); //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">2841</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2842</TD><TD>            if (!this.connection.getParanoid()) {</TD></TR><TR CLASS="c"><TD CLASS="l">2843</TD><TD>                messageBuf.append(&#34;'&#34;); //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">2844</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2845</TD><TD>                if (fileName != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">2846</TD><TD>                    messageBuf.append(fileName);</TD></TR><TR><TD CLASS="l">2847</TD><TD>                }</TD></TR><TR><TD CLASS="l">2848</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2849</TD><TD>                messageBuf.append(&#34;'&#34;); //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">2850</TD><TD>            }</TD></TR><TR><TD CLASS="l">2851</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2852</TD><TD>            messageBuf.append(Messages.getString(&#34;MysqlIO.63&#34;)); //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">2853</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2854</TD><TD>            if (!this.connection.getParanoid()) {</TD></TR><TR CLASS="c"><TD CLASS="l">2855</TD><TD>                messageBuf.append(Messages.getString(&#34;MysqlIO.64&#34;)); //$NON-NLS-1$</TD></TR><TR CLASS="c"><TD CLASS="l">2856</TD><TD>                messageBuf.append(Util.stackTraceToString(ioEx));</TD></TR><TR><TD CLASS="l">2857</TD><TD>            }</TD></TR><TR><TD CLASS="l">2858</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2859</TD><TD>            throw new SQLException(messageBuf.toString(),</TD></TR><TR><TD CLASS="l">2860</TD><TD>                SQLError.SQL_STATE_ILLEGAL_ARGUMENT);</TD></TR><TR><TD CLASS="l">2861</TD><TD>        } finally {</TD></TR><TR CLASS="c"><TD CLASS="l">2862</TD><TD>            if (fileIn != null) {</TD></TR><TR><TD CLASS="l">2863</TD><TD>                try {</TD></TR><TR CLASS="c"><TD CLASS="l">2864</TD><TD>                    fileIn.close();</TD></TR><TR CLASS="z"><TD CLASS="l">2865</TD><TD>                } catch (Exception ex) {</TD></TR><TR CLASS="z"><TD CLASS="l">2866</TD><TD>                    throw new SQLException(Messages.getString(&#34;MysqlIO.65&#34;), //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">2867</TD><TD>                        SQLError.SQL_STATE_GENERAL_ERROR);</TD></TR><TR CLASS="c"><TD CLASS="l">2868</TD><TD>                }</TD></TR><TR><TD CLASS="l">2869</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2870</TD><TD>                fileIn = null;</TD></TR><TR><TD CLASS="l">2871</TD><TD>            } else {</TD></TR><TR><TD CLASS="l">2872</TD><TD>                // file open failed, but server needs one packet</TD></TR><TR CLASS="c"><TD CLASS="l">2873</TD><TD>                filePacket.clear();</TD></TR><TR CLASS="c"><TD CLASS="l">2874</TD><TD>                send(filePacket);</TD></TR><TR CLASS="c"><TD CLASS="l">2875</TD><TD>                checkErrorPacket(); // to clear response off of queue</TD></TR><TR><TD CLASS="l">2876</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">2877</TD><TD>        }</TD></TR><TR><TD CLASS="l">2878</TD><TD> </TD></TR><TR><TD CLASS="l">2879</TD><TD>        // send empty packet to mark EOF</TD></TR><TR CLASS="c"><TD CLASS="l">2880</TD><TD>        filePacket.clear();</TD></TR><TR CLASS="c"><TD CLASS="l">2881</TD><TD>        send(filePacket);</TD></TR><TR><TD CLASS="l">2882</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2883</TD><TD>        Buffer resultPacket = checkErrorPacket();</TD></TR><TR><TD CLASS="l">2884</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2885</TD><TD>        return buildResultSetWithUpdates(callingStatement, resultPacket);</TD></TR><TR><TD CLASS="l">2886</TD><TD>    }</TD></TR><TR><TD CLASS="l">2887</TD><TD> </TD></TR><TR><TD CLASS="l">2888</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2889</TD><TD>     * Checks for errors in the reply packet, and if none, returns the reply</TD></TR><TR><TD CLASS="l">2890</TD><TD>     * packet, ready for reading</TD></TR><TR><TD CLASS="l">2891</TD><TD>     *</TD></TR><TR><TD CLASS="l">2892</TD><TD>     * @param command the command being issued (if used)</TD></TR><TR><TD CLASS="l">2893</TD><TD>     *</TD></TR><TR><TD CLASS="l">2894</TD><TD>     * @return DOCUMENT ME!</TD></TR><TR><TD CLASS="l">2895</TD><TD>     *</TD></TR><TR><TD CLASS="l"><A NAME="15">2896</A></TD><TD>     * @throws SQLException if an error packet was received</TD></TR><TR><TD CLASS="l">2897</TD><TD>     * @throws CommunicationsException DOCUMENT ME!</TD></TR><TR><TD CLASS="l">2898</TD><TD>     */</TD></TR><TR><TD CLASS="l">2899</TD><TD>    private Buffer checkErrorPacket(int command) throws SQLException {</TD></TR><TR CLASS="c"><TD CLASS="l">2900</TD><TD>        int statusCode = 0;</TD></TR><TR CLASS="c"><TD CLASS="l">2901</TD><TD>        Buffer resultPacket = null;</TD></TR><TR CLASS="c"><TD CLASS="l">2902</TD><TD>        this.serverStatus = 0;</TD></TR><TR><TD CLASS="l">2903</TD><TD> </TD></TR><TR><TD CLASS="l">2904</TD><TD>        try {</TD></TR><TR><TD CLASS="l">2905</TD><TD>            // Check return value, if we get a java.io.EOFException,</TD></TR><TR><TD CLASS="l">2906</TD><TD>            // the server has gone away. We'll pass it on up the</TD></TR><TR><TD CLASS="l">2907</TD><TD>            // exception chain and let someone higher up decide</TD></TR><TR><TD CLASS="l">2908</TD><TD>            // what to do (barf, reconnect, etc).</TD></TR><TR CLASS="c"><TD CLASS="l">2909</TD><TD>            resultPacket = reuseAndReadPacket(this.reusablePacket);</TD></TR><TR CLASS="c"><TD CLASS="l">2910</TD><TD>            statusCode = resultPacket.readByte();</TD></TR><TR CLASS="c"><TD CLASS="l">2911</TD><TD>        } catch (SQLException sqlEx) {</TD></TR><TR><TD CLASS="l">2912</TD><TD>            // Don't wrap SQL Exceptions</TD></TR><TR CLASS="c"><TD CLASS="l">2913</TD><TD>            throw sqlEx;</TD></TR><TR CLASS="z"><TD CLASS="l">2914</TD><TD>        } catch (Exception fallThru) {</TD></TR><TR CLASS="z"><TD CLASS="l">2915</TD><TD>            throw new CommunicationsException(this.connection,</TD></TR><TR><TD CLASS="l">2916</TD><TD>                this.lastPacketSentTimeMs, fallThru);</TD></TR><TR CLASS="c"><TD CLASS="l">2917</TD><TD>        }</TD></TR><TR><TD CLASS="l">2918</TD><TD> </TD></TR><TR><TD CLASS="l">2919</TD><TD>        // Error handling</TD></TR><TR CLASS="c"><TD CLASS="l">2920</TD><TD>        if (statusCode == (byte) 0xff) {</TD></TR><TR><TD CLASS="l">2921</TD><TD>            String serverErrorMessage;</TD></TR><TR CLASS="c"><TD CLASS="l">2922</TD><TD>            int errno = 2000;</TD></TR><TR><TD CLASS="l">2923</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2924</TD><TD>            if (this.protocolVersion &gt; 9) {</TD></TR><TR CLASS="c"><TD CLASS="l">2925</TD><TD>                errno = resultPacket.readInt();</TD></TR><TR><TD CLASS="l">2926</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2927</TD><TD>                String xOpen = null;</TD></TR><TR><TD CLASS="l">2928</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2929</TD><TD>                serverErrorMessage = resultPacket.readString();</TD></TR><TR><TD CLASS="l">2930</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2931</TD><TD>                if (serverErrorMessage.startsWith(&#34;#&#34;)) { //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">2932</TD><TD> </TD></TR><TR><TD CLASS="l">2933</TD><TD>                    // we have an SQLState</TD></TR><TR CLASS="c"><TD CLASS="l">2934</TD><TD>                    if (serverErrorMessage.length() &gt; 6) {</TD></TR><TR CLASS="c"><TD CLASS="l">2935</TD><TD>                        xOpen = serverErrorMessage.substring(1, 6);</TD></TR><TR CLASS="c"><TD CLASS="l">2936</TD><TD>                        serverErrorMessage = serverErrorMessage.substring(6);</TD></TR><TR><TD CLASS="l">2937</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2938</TD><TD>                        if (xOpen.equals(&#34;HY000&#34;)) { //$NON-NLS-1$</TD></TR><TR CLASS="c"><TD CLASS="l">2939</TD><TD>                            xOpen = SQLError.mysqlToSqlState(errno,</TD></TR><TR><TD CLASS="l">2940</TD><TD>                                    this.connection.getUseSqlStateCodes());</TD></TR><TR><TD CLASS="l">2941</TD><TD>                        }</TD></TR><TR><TD CLASS="l">2942</TD><TD>                    } else {</TD></TR><TR CLASS="z"><TD CLASS="l">2943</TD><TD>                        xOpen = SQLError.mysqlToSqlState(errno,</TD></TR><TR><TD CLASS="l">2944</TD><TD>                                this.connection.getUseSqlStateCodes());</TD></TR><TR><TD CLASS="l">2945</TD><TD>                    }</TD></TR><TR><TD CLASS="l">2946</TD><TD>                } else {</TD></TR><TR CLASS="c"><TD CLASS="l">2947</TD><TD>                    xOpen = SQLError.mysqlToSqlState(errno,</TD></TR><TR><TD CLASS="l">2948</TD><TD>                            this.connection.getUseSqlStateCodes());</TD></TR><TR><TD CLASS="l">2949</TD><TD>                }</TD></TR><TR><TD CLASS="l">2950</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2951</TD><TD>                clearInputStream();</TD></TR><TR><TD CLASS="l">2952</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2953</TD><TD>                StringBuffer errorBuf = new StringBuffer();</TD></TR><TR><TD CLASS="l">2954</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2955</TD><TD>                String xOpenErrorMessage = SQLError.get(xOpen);</TD></TR><TR><TD CLASS="l">2956</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2957</TD><TD>                if (!this.connection.getUseOnlyServerErrorMessages()) {</TD></TR><TR CLASS="z"><TD CLASS="l">2958</TD><TD>                    if (xOpenErrorMessage != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">2959</TD><TD>                        errorBuf.append(xOpenErrorMessage);</TD></TR><TR CLASS="z"><TD CLASS="l">2960</TD><TD>                        errorBuf.append(Messages.getString(&#34;MysqlIO.68&#34;)); //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">2961</TD><TD>                    }</TD></TR><TR><TD CLASS="l">2962</TD><TD>                }</TD></TR><TR><TD CLASS="l">2963</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2964</TD><TD>                errorBuf.append(serverErrorMessage);</TD></TR><TR><TD CLASS="l">2965</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2966</TD><TD>                if (!this.connection.getUseOnlyServerErrorMessages()) {</TD></TR><TR CLASS="z"><TD CLASS="l">2967</TD><TD>                    if (xOpenErrorMessage != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">2968</TD><TD>                        errorBuf.append(&#34;\&#34;&#34;); //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">2969</TD><TD>                    }</TD></TR><TR><TD CLASS="l">2970</TD><TD>                }</TD></TR><TR><TD CLASS="l">2971</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">2972</TD><TD>                if (xOpen != null &amp;&amp; xOpen.startsWith(&#34;22&#34;)) {</TD></TR><TR CLASS="c"><TD CLASS="l">2973</TD><TD>                        throw new MysqlDataTruncation(errorBuf.toString(), 0, true, false, 0, 0); </TD></TR><TR><TD CLASS="l">2974</TD><TD>                } else {</TD></TR><TR CLASS="c"><TD CLASS="l">2975</TD><TD>                        throw new SQLException(errorBuf.toString(), xOpen, errno);</TD></TR><TR><TD CLASS="l">2976</TD><TD>                }</TD></TR><TR><TD CLASS="l">2977</TD><TD>            }</TD></TR><TR><TD CLASS="l">2978</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2979</TD><TD>            serverErrorMessage = resultPacket.readString();</TD></TR><TR CLASS="z"><TD CLASS="l">2980</TD><TD>            clearInputStream();</TD></TR><TR><TD CLASS="l">2981</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2982</TD><TD>            if (serverErrorMessage.indexOf(Messages.getString(&#34;MysqlIO.70&#34;)) != -1) { //$NON-NLS-1$</TD></TR><TR CLASS="z"><TD CLASS="l">2983</TD><TD>                throw new SQLException(SQLError.get(</TD></TR><TR><TD CLASS="l">2984</TD><TD>                        SQLError.SQL_STATE_COLUMN_NOT_FOUND) +</TD></TR><TR><TD CLASS="l">2985</TD><TD>                    &#34;, &#34; //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">2986</TD><TD>                     +serverErrorMessage, SQLError.SQL_STATE_COLUMN_NOT_FOUND,</TD></TR><TR><TD CLASS="l">2987</TD><TD>                    -1);</TD></TR><TR><TD CLASS="l">2988</TD><TD>            }</TD></TR><TR><TD CLASS="l">2989</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2990</TD><TD>            StringBuffer errorBuf = new StringBuffer(Messages.getString(</TD></TR><TR><TD CLASS="l">2991</TD><TD>                        &#34;MysqlIO.72&#34;)); //$NON-NLS-1$</TD></TR><TR CLASS="z"><TD CLASS="l">2992</TD><TD>            errorBuf.append(serverErrorMessage);</TD></TR><TR CLASS="z"><TD CLASS="l">2993</TD><TD>            errorBuf.append(&#34;\&#34;&#34;); //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">2994</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2995</TD><TD>            throw new SQLException(SQLError.get(</TD></TR><TR><TD CLASS="l">2996</TD><TD>                    SQLError.SQL_STATE_GENERAL_ERROR) + &#34;, &#34; //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">2997</TD><TD>                 +errorBuf.toString(), SQLError.SQL_STATE_GENERAL_ERROR, -1);</TD></TR><TR><TD CLASS="l">2998</TD><TD>        }</TD></TR><TR><TD CLASS="l">2999</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3000</TD><TD>        return resultPacket;</TD></TR><TR><TD CLASS="l">3001</TD><TD>    }</TD></TR><TR><TD CLASS="l">3002</TD><TD> </TD></TR><TR><TD CLASS="l">3003</TD><TD>    /**</TD></TR><TR><TD CLASS="l">3004</TD><TD>     * Sends a large packet to the server as a series of smaller packets</TD></TR><TR><TD CLASS="l">3005</TD><TD>     *</TD></TR><TR><TD CLASS="l">3006</TD><TD>     * @param packet DOCUMENT ME!</TD></TR><TR><TD CLASS="l">3007</TD><TD>     *</TD></TR><TR><TD CLASS="l">3008</TD><TD>     * @throws SQLException DOCUMENT ME!</TD></TR><TR><TD CLASS="l">3009</TD><TD>     * @throws CommunicationsException DOCUMENT ME!</TD></TR><TR><TD CLASS="l">3010</TD><TD>     */</TD></TR><TR><TD CLASS="l">3011</TD><TD>    private final void sendSplitPackets(Buffer packet)</TD></TR><TR><TD CLASS="l">3012</TD><TD>        throws SQLException {</TD></TR><TR><TD CLASS="l">3013</TD><TD>        try {</TD></TR><TR><TD CLASS="l">3014</TD><TD>            //</TD></TR><TR><TD CLASS="l">3015</TD><TD>            // Big packets are handled by splitting them in packets of MAX_THREE_BYTES</TD></TR><TR><TD CLASS="l">3016</TD><TD>            // length. The last packet is always a packet that is &lt; MAX_THREE_BYTES.</TD></TR><TR><TD CLASS="l">3017</TD><TD>            // (The last packet may even have a length of 0)</TD></TR><TR><TD CLASS="l">3018</TD><TD>            //</TD></TR><TR><TD CLASS="l"><A NAME="1a">3019</A></TD><TD>            //</TD></TR><TR><TD CLASS="l">3020</TD><TD>            // NB: Guarded by execSQL. If the driver changes architecture, this</TD></TR><TR><TD CLASS="l">3021</TD><TD>            // will need to be synchronized in some other way</TD></TR><TR><TD CLASS="l">3022</TD><TD>            //</TD></TR><TR CLASS="p"><TD TITLE="67% line coverage (8 out of 12 instructions)" CLASS="l">3023</TD><TD TITLE="67% line coverage (8 out of 12 instructions)">            Buffer headerPacket = (this.splitBufRef == null) ? null</TD></TR><TR><TD CLASS="l">3024</TD><TD>                                                             : (Buffer) (this.splitBufRef.get());</TD></TR><TR><TD CLASS="l">3025</TD><TD> </TD></TR><TR><TD CLASS="l">3026</TD><TD>            //</TD></TR><TR><TD CLASS="l">3027</TD><TD>            // Store this packet in a soft reference...It can be re-used if not GC'd (so clients</TD></TR><TR><TD CLASS="l">3028</TD><TD>            // that use it frequently won't have to re-alloc the 16M buffer), but we don't</TD></TR><TR><TD CLASS="l">3029</TD><TD>            // penalize infrequent users of large packets by keeping 16M allocated all of the time</TD></TR><TR><TD CLASS="l">3030</TD><TD>            //</TD></TR><TR CLASS="c"><TD CLASS="l">3031</TD><TD>            if (headerPacket == null) {</TD></TR><TR CLASS="c"><TD CLASS="l">3032</TD><TD>                headerPacket = Buffer.allocateNew((this.maxThreeBytes +</TD></TR><TR><TD CLASS="l">3033</TD><TD>                        HEADER_LENGTH), this.useNewIo);</TD></TR><TR CLASS="c"><TD CLASS="l">3034</TD><TD>                this.splitBufRef = new SoftReference(headerPacket);</TD></TR><TR><TD CLASS="l">3035</TD><TD>            }</TD></TR><TR><TD CLASS="l">3036</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3037</TD><TD>            int len = packet.getPosition();</TD></TR><TR CLASS="c"><TD CLASS="l">3038</TD><TD>            int splitSize = this.maxThreeBytes;</TD></TR><TR CLASS="c"><TD CLASS="l">3039</TD><TD>            int originalPacketPos = HEADER_LENGTH;</TD></TR><TR CLASS="c"><TD CLASS="l">3040</TD><TD>            byte[] origPacketBytes = packet.getByteBuffer();</TD></TR><TR CLASS="c"><TD CLASS="l">3041</TD><TD>            byte[] headerPacketBytes = headerPacket.getByteBuffer();</TD></TR><TR><TD CLASS="l">3042</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3043</TD><TD>            while (len &gt;= this.maxThreeBytes) {</TD></TR><TR CLASS="c"><TD CLASS="l">3044</TD><TD>                this.packetSequence++;</TD></TR><TR><TD CLASS="l">3045</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3046</TD><TD>                headerPacket.setPosition(0);</TD></TR><TR CLASS="c"><TD CLASS="l">3047</TD><TD>                headerPacket.writeLongInt(splitSize);</TD></TR><TR><TD CLASS="l">3048</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3049</TD><TD>                headerPacket.writeByte(this.packetSequence);</TD></TR><TR CLASS="c"><TD CLASS="l">3050</TD><TD>                System.arraycopy(origPacketBytes, originalPacketPos,</TD></TR><TR><TD CLASS="l">3051</TD><TD>                    headerPacketBytes, 4, splitSize);</TD></TR><TR><TD CLASS="l">3052</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3053</TD><TD>                int packetLen = splitSize + HEADER_LENGTH;</TD></TR><TR><TD CLASS="l">3054</TD><TD> </TD></TR><TR><TD CLASS="l">3055</TD><TD>                //</TD></TR><TR><TD CLASS="l">3056</TD><TD>                // Swap a compressed packet in, if we're using</TD></TR><TR><TD CLASS="l">3057</TD><TD>                // compression...</TD></TR><TR><TD CLASS="l">3058</TD><TD>                //</TD></TR><TR CLASS="c"><TD CLASS="l">3059</TD><TD>                if (!this.useCompression) {</TD></TR><TR CLASS="c"><TD CLASS="l">3060</TD><TD>                    this.mysqlOutput.write(headerPacketBytes, 0,</TD></TR><TR><TD CLASS="l">3061</TD><TD>                        splitSize + HEADER_LENGTH);</TD></TR><TR CLASS="c"><TD CLASS="l">3062</TD><TD>                    this.mysqlOutput.flush();</TD></TR><TR><TD CLASS="l">3063</TD><TD>                } else {</TD></TR><TR><TD CLASS="l">3064</TD><TD>                    Buffer packetToSend;</TD></TR><TR><TD CLASS="l">3065</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3066</TD><TD>                    headerPacket.setPosition(0);</TD></TR><TR CLASS="z"><TD CLASS="l">3067</TD><TD>                    packetToSend = compressPacket(headerPacket, HEADER_LENGTH,</TD></TR><TR><TD CLASS="l">3068</TD><TD>                            splitSize, HEADER_LENGTH);</TD></TR><TR CLASS="z"><TD CLASS="l">3069</TD><TD>                    packetLen = packetToSend.getPosition();</TD></TR><TR><TD CLASS="l">3070</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3071</TD><TD>                    this.mysqlOutput.write(packetToSend.getByteBuffer(), 0,</TD></TR><TR><TD CLASS="l">3072</TD><TD>                        packetLen);</TD></TR><TR CLASS="z"><TD CLASS="l">3073</TD><TD>                    this.mysqlOutput.flush();</TD></TR><TR><TD CLASS="l">3074</TD><TD>                }</TD></TR><TR><TD CLASS="l">3075</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3076</TD><TD>                originalPacketPos += splitSize;</TD></TR><TR CLASS="c"><TD CLASS="l">3077</TD><TD>                len -= splitSize;</TD></TR><TR><TD CLASS="l">3078</TD><TD>            }</TD></TR><TR><TD CLASS="l">3079</TD><TD> </TD></TR><TR><TD CLASS="l">3080</TD><TD>            //</TD></TR><TR><TD CLASS="l">3081</TD><TD>            // Write last packet</TD></TR><TR><TD CLASS="l">3082</TD><TD>            //</TD></TR><TR CLASS="c"><TD CLASS="l">3083</TD><TD>            headerPacket.clear();</TD></TR><TR CLASS="c"><TD CLASS="l">3084</TD><TD>            headerPacket.setPosition(0);</TD></TR><TR CLASS="c"><TD CLASS="l">3085</TD><TD>            headerPacket.writeLongInt(len - HEADER_LENGTH);</TD></TR><TR CLASS="c"><TD CLASS="l">3086</TD><TD>            this.packetSequence++;</TD></TR><TR CLASS="c"><TD CLASS="l">3087</TD><TD>            headerPacket.writeByte(this.packetSequence);</TD></TR><TR><TD CLASS="l">3088</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3089</TD><TD>            if (len != 0) {</TD></TR><TR CLASS="c"><TD CLASS="l">3090</TD><TD>                System.arraycopy(origPacketBytes, originalPacketPos,</TD></TR><TR><TD CLASS="l">3091</TD><TD>                    headerPacketBytes, 4, len - HEADER_LENGTH);</TD></TR><TR><TD CLASS="l">3092</TD><TD>            }</TD></TR><TR><TD CLASS="l">3093</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3094</TD><TD>            int packetLen = len - HEADER_LENGTH;</TD></TR><TR><TD CLASS="l">3095</TD><TD> </TD></TR><TR><TD CLASS="l">3096</TD><TD>            //</TD></TR><TR><TD CLASS="l">3097</TD><TD>            // Swap a compressed packet in, if we're using</TD></TR><TR><TD CLASS="l">3098</TD><TD>            // compression...</TD></TR><TR><TD CLASS="l">3099</TD><TD>            //</TD></TR><TR CLASS="c"><TD CLASS="l">3100</TD><TD>            if (!this.useCompression) {</TD></TR><TR CLASS="c"><TD CLASS="l">3101</TD><TD>                this.mysqlOutput.write(headerPacket.getByteBuffer(), 0, len);</TD></TR><TR CLASS="c"><TD CLASS="l">3102</TD><TD>                this.mysqlOutput.flush();</TD></TR><TR><TD CLASS="l">3103</TD><TD>            } else {</TD></TR><TR><TD CLASS="l">3104</TD><TD>                Buffer packetToSend;</TD></TR><TR><TD CLASS="l">3105</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3106</TD><TD>                headerPacket.setPosition(0);</TD></TR><TR CLASS="z"><TD CLASS="l">3107</TD><TD>                packetToSend = compressPacket(headerPacket, HEADER_LENGTH,</TD></TR><TR><TD CLASS="l">3108</TD><TD>                        packetLen, HEADER_LENGTH);</TD></TR><TR CLASS="z"><TD CLASS="l">3109</TD><TD>                packetLen = packetToSend.getPosition();</TD></TR><TR><TD CLASS="l">3110</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3111</TD><TD>                this.mysqlOutput.write(packetToSend.getByteBuffer(), 0,</TD></TR><TR><TD CLASS="l">3112</TD><TD>                    packetLen);</TD></TR><TR CLASS="z"><TD CLASS="l">3113</TD><TD>                this.mysqlOutput.flush();</TD></TR><TR><TD CLASS="l">3114</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">3115</TD><TD>        } catch (IOException ioEx) {</TD></TR><TR CLASS="z"><TD CLASS="l">3116</TD><TD>            throw new CommunicationsException(this.connection,</TD></TR><TR><TD CLASS="l">3117</TD><TD>                this.lastPacketSentTimeMs, ioEx);</TD></TR><TR CLASS="c"><TD CLASS="l">3118</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">3119</TD><TD>    }</TD></TR><TR><TD CLASS="l">3120</TD><TD> </TD></TR><TR><TD CLASS="l">3121</TD><TD>    /**</TD></TR><TR><TD CLASS="l">3122</TD><TD>     * Sends a large packet to the server as a series of smaller packets</TD></TR><TR><TD CLASS="l">3123</TD><TD>     *</TD></TR><TR><TD CLASS="l">3124</TD><TD>     * @param packet DOCUMENT ME!</TD></TR><TR><TD CLASS="l">3125</TD><TD>     *</TD></TR><TR><TD CLASS="l">3126</TD><TD>     * @throws SQLException DOCUMENT ME!</TD></TR><TR><TD CLASS="l">3127</TD><TD>     * @throws CommunicationsException DOCUMENT ME!</TD></TR><TR><TD CLASS="l">3128</TD><TD>     */</TD></TR><TR><TD CLASS="l">3129</TD><TD>    private final void sendSplitPacketsViaChannel(Buffer packet)</TD></TR><TR><TD CLASS="l">3130</TD><TD>        throws SQLException {</TD></TR><TR><TD CLASS="l">3131</TD><TD>        try {</TD></TR><TR><TD CLASS="l">3132</TD><TD>            //</TD></TR><TR><TD CLASS="l">3133</TD><TD>            // Big packets are handled by splitting them in packets of MAX_THREE_BYTES</TD></TR><TR><TD CLASS="l">3134</TD><TD>            // length. The last packet is always a packet that is &lt; MAX_THREE_BYTES.</TD></TR><TR><TD CLASS="l">3135</TD><TD>            // (The last packet may even have a length of 0)</TD></TR><TR><TD CLASS="l">3136</TD><TD>            //</TD></TR><TR><TD CLASS="l"><A NAME="18">3137</A></TD><TD>            //</TD></TR><TR><TD CLASS="l">3138</TD><TD>            // NB: Guarded by execSQL. If the driver changes architecture, this</TD></TR><TR><TD CLASS="l">3139</TD><TD>            // will need to be synchronized in some other way</TD></TR><TR><TD CLASS="l">3140</TD><TD>            //</TD></TR><TR CLASS="p"><TD TITLE="67% line coverage (8 out of 12 instructions)" CLASS="l">3141</TD><TD TITLE="67% line coverage (8 out of 12 instructions)">            Buffer headerPacket = (this.splitBufRef == null) ? null</TD></TR><TR><TD CLASS="l">3142</TD><TD>                                                             : (Buffer) (this.splitBufRef.get());</TD></TR><TR><TD CLASS="l">3143</TD><TD> </TD></TR><TR><TD CLASS="l">3144</TD><TD>            //</TD></TR><TR><TD CLASS="l">3145</TD><TD>            // Store this packet in a soft reference...It can be re-used if not GC'd (so clients</TD></TR><TR><TD CLASS="l">3146</TD><TD>            // that use it frequently won't have to re-alloc the 16M buffer), but we don't</TD></TR><TR><TD CLASS="l">3147</TD><TD>            // penalize infrequent users of large packets by keeping 16M allocated all of the time</TD></TR><TR><TD CLASS="l">3148</TD><TD>            //</TD></TR><TR CLASS="c"><TD CLASS="l">3149</TD><TD>            if (headerPacket == null) {</TD></TR><TR CLASS="c"><TD CLASS="l">3150</TD><TD>                headerPacket = Buffer.allocateNew((this.maxThreeBytes +</TD></TR><TR><TD CLASS="l">3151</TD><TD>                        HEADER_LENGTH), this.useNewIo);</TD></TR><TR CLASS="c"><TD CLASS="l">3152</TD><TD>                this.splitBufRef = new SoftReference(headerPacket);</TD></TR><TR><TD CLASS="l">3153</TD><TD>            }</TD></TR><TR><TD CLASS="l">3154</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3155</TD><TD>            int len = packet.getPosition();</TD></TR><TR CLASS="c"><TD CLASS="l">3156</TD><TD>            int splitSize = this.maxThreeBytes;</TD></TR><TR CLASS="c"><TD CLASS="l">3157</TD><TD>            int originalPacketPos = HEADER_LENGTH;</TD></TR><TR CLASS="c"><TD CLASS="l">3158</TD><TD>            byte[] origPacketBytes = packet.getByteBuffer();</TD></TR><TR><TD CLASS="l">3159</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3160</TD><TD>            while (len &gt;= this.maxThreeBytes) {</TD></TR><TR CLASS="c"><TD CLASS="l">3161</TD><TD>                this.packetSequence++;</TD></TR><TR><TD CLASS="l">3162</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3163</TD><TD>                headerPacket.setPosition(0);</TD></TR><TR CLASS="c"><TD CLASS="l">3164</TD><TD>                headerPacket.writeLongInt(splitSize);</TD></TR><TR><TD CLASS="l">3165</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3166</TD><TD>                headerPacket.writeByte(this.packetSequence);</TD></TR><TR><TD CLASS="l">3167</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3168</TD><TD>                headerPacket.setPosition(4);</TD></TR><TR CLASS="c"><TD CLASS="l">3169</TD><TD>                headerPacket.writeBytesNoNull(origPacketBytes,</TD></TR><TR><TD CLASS="l">3170</TD><TD>                    originalPacketPos, splitSize);</TD></TR><TR><TD CLASS="l">3171</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3172</TD><TD>                int packetLen = splitSize + HEADER_LENGTH;</TD></TR><TR><TD CLASS="l">3173</TD><TD> </TD></TR><TR><TD CLASS="l">3174</TD><TD>                //</TD></TR><TR><TD CLASS="l">3175</TD><TD>                // Swap a compressed packet in, if we're using</TD></TR><TR><TD CLASS="l">3176</TD><TD>                // compression...</TD></TR><TR><TD CLASS="l">3177</TD><TD>                //</TD></TR><TR CLASS="c"><TD CLASS="l">3178</TD><TD>                if (!this.useCompression) {</TD></TR><TR CLASS="c"><TD CLASS="l">3179</TD><TD>                    headerPacket.getNioBuffer().limit(splitSize +</TD></TR><TR><TD CLASS="l">3180</TD><TD>                        HEADER_LENGTH);</TD></TR><TR CLASS="c"><TD CLASS="l">3181</TD><TD>                    headerPacket.setPosition(0);</TD></TR><TR><TD CLASS="l">3182</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3183</TD><TD>                    this.socketChannel.write(headerPacket.getNioBuffer());</TD></TR><TR><TD CLASS="l">3184</TD><TD>                } else {</TD></TR><TR><TD CLASS="l">3185</TD><TD>                    Buffer packetToSend;</TD></TR><TR><TD CLASS="l">3186</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3187</TD><TD>                    headerPacket.setPosition(0);</TD></TR><TR CLASS="z"><TD CLASS="l">3188</TD><TD>                    packetToSend = compressPacket(headerPacket, HEADER_LENGTH,</TD></TR><TR><TD CLASS="l">3189</TD><TD>                            splitSize, HEADER_LENGTH);</TD></TR><TR CLASS="z"><TD CLASS="l">3190</TD><TD>                    packetLen = packetToSend.getPosition();</TD></TR><TR><TD CLASS="l">3191</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3192</TD><TD>                    packetToSend.setPosition(0);</TD></TR><TR CLASS="z"><TD CLASS="l">3193</TD><TD>                    packetToSend.getNioBuffer().limit(packetLen);</TD></TR><TR CLASS="z"><TD CLASS="l">3194</TD><TD>                    this.socketChannel.write(packetToSend.getNioBuffer());</TD></TR><TR><TD CLASS="l">3195</TD><TD>                }</TD></TR><TR><TD CLASS="l">3196</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3197</TD><TD>                originalPacketPos += splitSize;</TD></TR><TR CLASS="c"><TD CLASS="l">3198</TD><TD>                len -= splitSize;</TD></TR><TR><TD CLASS="l">3199</TD><TD>            }</TD></TR><TR><TD CLASS="l">3200</TD><TD> </TD></TR><TR><TD CLASS="l">3201</TD><TD>            //</TD></TR><TR><TD CLASS="l">3202</TD><TD>            // Write last packet</TD></TR><TR><TD CLASS="l">3203</TD><TD>            //</TD></TR><TR CLASS="c"><TD CLASS="l">3204</TD><TD>            headerPacket.clear();</TD></TR><TR CLASS="c"><TD CLASS="l">3205</TD><TD>            headerPacket.setPosition(0);</TD></TR><TR CLASS="c"><TD CLASS="l">3206</TD><TD>            headerPacket.writeLongInt(len - HEADER_LENGTH);</TD></TR><TR CLASS="c"><TD CLASS="l">3207</TD><TD>            this.packetSequence++;</TD></TR><TR CLASS="c"><TD CLASS="l">3208</TD><TD>            headerPacket.writeByte(this.packetSequence);</TD></TR><TR><TD CLASS="l">3209</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3210</TD><TD>            if (len != 0) {</TD></TR><TR CLASS="c"><TD CLASS="l">3211</TD><TD>                headerPacket.setPosition(4);</TD></TR><TR CLASS="c"><TD CLASS="l">3212</TD><TD>                headerPacket.writeBytesNoNull(origPacketBytes,</TD></TR><TR><TD CLASS="l">3213</TD><TD>                    originalPacketPos, len - HEADER_LENGTH);</TD></TR><TR><TD CLASS="l">3214</TD><TD>            }</TD></TR><TR><TD CLASS="l">3215</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3216</TD><TD>            int packetLen = len - HEADER_LENGTH;</TD></TR><TR><TD CLASS="l">3217</TD><TD> </TD></TR><TR><TD CLASS="l">3218</TD><TD>            //</TD></TR><TR><TD CLASS="l">3219</TD><TD>            // Swap a compressed packet in, if we're using</TD></TR><TR><TD CLASS="l">3220</TD><TD>            // compression...</TD></TR><TR><TD CLASS="l">3221</TD><TD>            //</TD></TR><TR CLASS="c"><TD CLASS="l">3222</TD><TD>            if (!this.useCompression) {</TD></TR><TR CLASS="c"><TD CLASS="l">3223</TD><TD>                headerPacket.getNioBuffer().limit(len);</TD></TR><TR CLASS="c"><TD CLASS="l">3224</TD><TD>                headerPacket.setPosition(0);</TD></TR><TR><TD CLASS="l">3225</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3226</TD><TD>                this.socketChannel.write(headerPacket.getNioBuffer());</TD></TR><TR><TD CLASS="l">3227</TD><TD>            } else {</TD></TR><TR><TD CLASS="l">3228</TD><TD>                Buffer packetToSend;</TD></TR><TR><TD CLASS="l">3229</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3230</TD><TD>                headerPacket.setPosition(0);</TD></TR><TR CLASS="z"><TD CLASS="l">3231</TD><TD>                packetToSend = compressPacket(headerPacket, HEADER_LENGTH,</TD></TR><TR><TD CLASS="l">3232</TD><TD>                        packetLen, HEADER_LENGTH);</TD></TR><TR CLASS="z"><TD CLASS="l">3233</TD><TD>                packetLen = packetToSend.getPosition();</TD></TR><TR><TD CLASS="l">3234</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3235</TD><TD>                packetToSend.setPosition(0);</TD></TR><TR CLASS="z"><TD CLASS="l">3236</TD><TD>                packetToSend.getNioBuffer().limit(packetLen);</TD></TR><TR><TD CLASS="l">3237</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3238</TD><TD>                this.socketChannel.write(packetToSend.getNioBuffer());</TD></TR><TR><TD CLASS="l">3239</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">3240</TD><TD>        } catch (IOException ioEx) {</TD></TR><TR CLASS="z"><TD CLASS="l">3241</TD><TD>            throw new CommunicationsException(this.connection,</TD></TR><TR><TD CLASS="l">3242</TD><TD>                this.lastPacketSentTimeMs, ioEx);</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="44">3243</A></TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">3244</TD><TD>    }</TD></TR><TR><TD CLASS="l">3245</TD><TD> </TD></TR><TR><TD CLASS="l">3246</TD><TD>    private void reclaimLargeSharedSendPacket() {</TD></TR><TR CLASS="c"><TD CLASS="l">3247</TD><TD>        if ((this.sharedSendPacket != null) &amp;&amp;</TD></TR><TR><TD CLASS="l">3248</TD><TD>                (this.sharedSendPacket.getCapacity() &gt; 1048576)) {</TD></TR><TR CLASS="c"><TD CLASS="l">3249</TD><TD>            this.sharedSendPacket = Buffer.allocateNew(this.connection.getNetBufferLength(),</TD></TR><TR><TD CLASS="l">3250</TD><TD>                    this.useNewIo);</TD></TR><TR><TD CLASS="l">3251</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">3252</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="10">3253</A></TD><TD> </TD></TR><TR><TD CLASS="l">3254</TD><TD>    private Buffer reuseAndReadViaChannel(Buffer reuse)</TD></TR><TR><TD CLASS="l">3255</TD><TD>        throws SQLException {</TD></TR><TR><TD CLASS="l">3256</TD><TD>        try {</TD></TR><TR CLASS="c"><TD CLASS="l">3257</TD><TD>            reuse.setWasMultiPacket(false);</TD></TR><TR><TD CLASS="l">3258</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3259</TD><TD>            reuse.setPosition(0);</TD></TR><TR CLASS="c"><TD CLASS="l">3260</TD><TD>            reuse.setBufLength(4);</TD></TR><TR><TD CLASS="l">3261</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3262</TD><TD>            ByteBuffer lenBuf = reuse.getNioBuffer();</TD></TR><TR><TD CLASS="l">3263</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3264</TD><TD>            readChannelFully(lenBuf, 4);</TD></TR><TR><TD CLASS="l">3265</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3266</TD><TD>            byte b1 = lenBuf.get(0);</TD></TR><TR CLASS="c"><TD CLASS="l">3267</TD><TD>            byte b2 = lenBuf.get(1);</TD></TR><TR CLASS="c"><TD CLASS="l">3268</TD><TD>            byte b3 = lenBuf.get(2);</TD></TR><TR><TD CLASS="l">3269</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3270</TD><TD>            int packetLength = (b1 &amp; 0xff) + ((b2 &amp; 0xff) &lt;&lt; 8) +</TD></TR><TR><TD CLASS="l">3271</TD><TD>                ((b3 &amp; 0xff) &lt;&lt; 16);</TD></TR><TR><TD CLASS="l">3272</TD><TD> </TD></TR><TR><TD CLASS="l">3273</TD><TD>            // -1 for all values through above assembly sequence</TD></TR><TR CLASS="c"><TD CLASS="l">3274</TD><TD>            if (packetLength == -65793) {</TD></TR><TR CLASS="z"><TD CLASS="l">3275</TD><TD>                forceClose();</TD></TR><TR CLASS="z"><TD CLASS="l">3276</TD><TD>                throw new IOException(Messages.getString(&#34;MysqlIO.80&#34;)); //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">3277</TD><TD>            }</TD></TR><TR><TD CLASS="l">3278</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3279</TD><TD>            byte multiPacketSeq = lenBuf.get(3);</TD></TR><TR><TD CLASS="l">3280</TD><TD> </TD></TR><TR><TD CLASS="l">3281</TD><TD>            // Set the Buffer to it's original state</TD></TR><TR CLASS="c"><TD CLASS="l">3282</TD><TD>            reuse.setPosition(0);</TD></TR><TR><TD CLASS="l">3283</TD><TD> </TD></TR><TR><TD CLASS="l">3284</TD><TD>            // Do we need to re-alloc the byte buffer?</TD></TR><TR><TD CLASS="l">3285</TD><TD>            //</TD></TR><TR><TD CLASS="l">3286</TD><TD>            // Note: We actually check the length of the buffer,</TD></TR><TR><TD CLASS="l">3287</TD><TD>            // rather than getBufLength(), because getBufLength() is not</TD></TR><TR><TD CLASS="l">3288</TD><TD>            // necesarily the actual length of the byte array</TD></TR><TR><TD CLASS="l">3289</TD><TD>            // used as the buffer</TD></TR><TR CLASS="c"><TD CLASS="l">3290</TD><TD>            reuse.ensureCapacity(packetLength + 1);</TD></TR><TR><TD CLASS="l">3291</TD><TD> </TD></TR><TR><TD CLASS="l">3292</TD><TD>            // Set the new length</TD></TR><TR CLASS="c"><TD CLASS="l">3293</TD><TD>            reuse.setBufLength(packetLength);</TD></TR><TR><TD CLASS="l">3294</TD><TD> </TD></TR><TR><TD CLASS="l">3295</TD><TD>            // Read the data from the server</TD></TR><TR CLASS="c"><TD CLASS="l">3296</TD><TD>            readChannelFully(reuse.getNioBuffer(), packetLength);</TD></TR><TR CLASS="c"><TD CLASS="l">3297</TD><TD>            reuse.setPosition(0);</TD></TR><TR><TD CLASS="l">3298</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3299</TD><TD>            boolean isMultiPacket = false;</TD></TR><TR><TD CLASS="l">3300</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3301</TD><TD>            if (packetLength == this.maxThreeBytes) {</TD></TR><TR CLASS="z"><TD CLASS="l">3302</TD><TD>                reuse.setPosition(this.maxThreeBytes);</TD></TR><TR><TD CLASS="l">3303</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3304</TD><TD>                int packetEndPoint = packetLength;</TD></TR><TR><TD CLASS="l">3305</TD><TD> </TD></TR><TR><TD CLASS="l">3306</TD><TD>                // it's multi-packet</TD></TR><TR CLASS="z"><TD CLASS="l">3307</TD><TD>                isMultiPacket = true;</TD></TR><TR><TD CLASS="l">3308</TD><TD> </TD></TR><TR><TD CLASS="l">3309</TD><TD>                // We can't use lenBuf from reuse any more</TD></TR><TR><TD CLASS="l">3310</TD><TD>                // because data is coming out of it...</TD></TR><TR CLASS="z"><TD CLASS="l">3311</TD><TD>                Buffer lenChannelBuf = Buffer.allocateNew(4, true);</TD></TR><TR><TD CLASS="l">3312</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3313</TD><TD>                lenBuf = lenChannelBuf.getNioBuffer();</TD></TR><TR><TD CLASS="l">3314</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3315</TD><TD>                lenBuf.position(0);</TD></TR><TR CLASS="z"><TD CLASS="l">3316</TD><TD>                readChannelFully(lenBuf, 4);</TD></TR><TR><TD CLASS="l">3317</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3318</TD><TD>                b1 = lenBuf.get(0);</TD></TR><TR CLASS="z"><TD CLASS="l">3319</TD><TD>                b2 = lenBuf.get(1);</TD></TR><TR CLASS="z"><TD CLASS="l">3320</TD><TD>                b3 = lenBuf.get(2);</TD></TR><TR><TD CLASS="l">3321</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3322</TD><TD>                packetLength = (b1 &amp; 0xff) + ((b2 &amp; 0xff) &lt;&lt; 8) +</TD></TR><TR><TD CLASS="l">3323</TD><TD>                    ((b3 &amp; 0xff) &lt;&lt; 16);</TD></TR><TR><TD CLASS="l">3324</TD><TD> </TD></TR><TR><TD CLASS="l">3325</TD><TD>                // -1 for all values through above assembly sequence</TD></TR><TR CLASS="z"><TD CLASS="l">3326</TD><TD>                if (packetLength == -65793) {</TD></TR><TR CLASS="z"><TD CLASS="l">3327</TD><TD>                    forceClose();</TD></TR><TR CLASS="z"><TD CLASS="l">3328</TD><TD>                    throw new IOException(Messages.getString(&#34;MysqlIO.81&#34;)); //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">3329</TD><TD>                }</TD></TR><TR><TD CLASS="l">3330</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3331</TD><TD>                Buffer multiPacket = Buffer.allocateNew(packetLength,</TD></TR><TR><TD CLASS="l">3332</TD><TD>                        this.useNewIo);</TD></TR><TR CLASS="z"><TD CLASS="l">3333</TD><TD>                boolean firstMultiPkt = true;</TD></TR><TR><TD CLASS="l">3334</TD><TD> </TD></TR><TR><TD CLASS="l">3335</TD><TD>                while (true) {</TD></TR><TR CLASS="z"><TD CLASS="l">3336</TD><TD>                    if (!firstMultiPkt) {</TD></TR><TR CLASS="z"><TD CLASS="l">3337</TD><TD>                        lenBuf.position(0);</TD></TR><TR CLASS="z"><TD CLASS="l">3338</TD><TD>                        readChannelFully(lenBuf, 4);</TD></TR><TR><TD CLASS="l">3339</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3340</TD><TD>                        b1 = lenBuf.get(0);</TD></TR><TR CLASS="z"><TD CLASS="l">3341</TD><TD>                        b2 = lenBuf.get(1);</TD></TR><TR CLASS="z"><TD CLASS="l">3342</TD><TD>                        b3 = lenBuf.get(2);</TD></TR><TR><TD CLASS="l">3343</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3344</TD><TD>                        packetLength = (b1 &amp; 0xff) + ((b2 &amp; 0xff) &lt;&lt; 8) +</TD></TR><TR><TD CLASS="l">3345</TD><TD>                            ((b3 &amp; 0xff) &lt;&lt; 16);</TD></TR><TR><TD CLASS="l">3346</TD><TD> </TD></TR><TR><TD CLASS="l">3347</TD><TD>                        // -1 for all values through above assembly sequence</TD></TR><TR CLASS="z"><TD CLASS="l">3348</TD><TD>                        if (packetLength == -65793) {</TD></TR><TR CLASS="z"><TD CLASS="l">3349</TD><TD>                            forceClose();</TD></TR><TR CLASS="z"><TD CLASS="l">3350</TD><TD>                            throw new IOException(Messages.getString(</TD></TR><TR><TD CLASS="l">3351</TD><TD>                                    &#34;MysqlIO.82&#34;)); //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">3352</TD><TD>                        }</TD></TR><TR><TD CLASS="l">3353</TD><TD>                    } else {</TD></TR><TR CLASS="z"><TD CLASS="l">3354</TD><TD>                        firstMultiPkt = false;</TD></TR><TR><TD CLASS="l">3355</TD><TD>                    }</TD></TR><TR><TD CLASS="l">3356</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3357</TD><TD>                    if (!this.useNewLargePackets &amp;&amp; (packetLength == 1)) {</TD></TR><TR CLASS="z"><TD CLASS="l">3358</TD><TD>                        clearInputStream();</TD></TR><TR><TD CLASS="l">3359</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3360</TD><TD>                        break;</TD></TR><TR CLASS="z"><TD CLASS="l">3361</TD><TD>                    } else if (packetLength &lt; this.maxThreeBytes) {</TD></TR><TR CLASS="z"><TD CLASS="l">3362</TD><TD>                        lenBuf.position(0);</TD></TR><TR CLASS="z"><TD CLASS="l">3363</TD><TD>                        readChannelFully(lenBuf, 1);</TD></TR><TR><TD CLASS="l">3364</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3365</TD><TD>                        byte newPacketSeq = lenBuf.get(0);</TD></TR><TR><TD CLASS="l">3366</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3367</TD><TD>                        if (newPacketSeq != (multiPacketSeq + 1)) {</TD></TR><TR CLASS="z"><TD CLASS="l">3368</TD><TD>                            throw new IOException(Messages.getString(</TD></TR><TR><TD CLASS="l">3369</TD><TD>                                    &#34;MysqlIO.83&#34;)); //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">3370</TD><TD>                        }</TD></TR><TR><TD CLASS="l">3371</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3372</TD><TD>                        multiPacketSeq = newPacketSeq;</TD></TR><TR><TD CLASS="l">3373</TD><TD> </TD></TR><TR><TD CLASS="l">3374</TD><TD>                        // Set the Buffer to it's original state</TD></TR><TR CLASS="z"><TD CLASS="l">3375</TD><TD>                        multiPacket.setPosition(0);</TD></TR><TR><TD CLASS="l">3376</TD><TD> </TD></TR><TR><TD CLASS="l">3377</TD><TD>                        // Set the new length</TD></TR><TR CLASS="z"><TD CLASS="l">3378</TD><TD>                        multiPacket.setBufLength(packetLength);</TD></TR><TR><TD CLASS="l">3379</TD><TD> </TD></TR><TR><TD CLASS="l">3380</TD><TD>                        // Read the data from the server</TD></TR><TR CLASS="z"><TD CLASS="l">3381</TD><TD>                        int lengthToWrite = packetLength;</TD></TR><TR><TD CLASS="l">3382</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3383</TD><TD>                        readChannelFully(multiPacket.getNioBuffer(),</TD></TR><TR><TD CLASS="l">3384</TD><TD>                            packetLength);</TD></TR><TR><TD CLASS="l">3385</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3386</TD><TD>                        byte[] byteBuf = multiPacket.getByteBuffer();</TD></TR><TR><TD CLASS="l">3387</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3388</TD><TD>                        reuse.writeBytesNoNull(byteBuf, 0, lengthToWrite);</TD></TR><TR><TD CLASS="l">3389</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3390</TD><TD>                        packetEndPoint += lengthToWrite;</TD></TR><TR><TD CLASS="l">3391</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3392</TD><TD>                        break; // end of multipacket sequence</TD></TR><TR><TD CLASS="l">3393</TD><TD>                    }</TD></TR><TR><TD CLASS="l">3394</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3395</TD><TD>                    lenBuf.position(0);</TD></TR><TR CLASS="z"><TD CLASS="l">3396</TD><TD>                    readChannelFully(lenBuf, 1);</TD></TR><TR><TD CLASS="l">3397</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3398</TD><TD>                    byte newPacketSeq = lenBuf.get(0);</TD></TR><TR><TD CLASS="l">3399</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3400</TD><TD>                    if (newPacketSeq != (multiPacketSeq + 1)) {</TD></TR><TR CLASS="z"><TD CLASS="l">3401</TD><TD>                        throw new IOException(Messages.getString(&#34;MysqlIO.84&#34;)); //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">3402</TD><TD>                    }</TD></TR><TR><TD CLASS="l">3403</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3404</TD><TD>                    multiPacketSeq = newPacketSeq;</TD></TR><TR><TD CLASS="l">3405</TD><TD> </TD></TR><TR><TD CLASS="l">3406</TD><TD>                    // Set the Buffer to it's original state</TD></TR><TR CLASS="z"><TD CLASS="l">3407</TD><TD>                    multiPacket.setPosition(0);</TD></TR><TR><TD CLASS="l">3408</TD><TD> </TD></TR><TR><TD CLASS="l">3409</TD><TD>                    // Set the new length</TD></TR><TR CLASS="z"><TD CLASS="l">3410</TD><TD>                    multiPacket.setBufLength(packetLength);</TD></TR><TR><TD CLASS="l">3411</TD><TD> </TD></TR><TR><TD CLASS="l">3412</TD><TD>                    // Read the data from the server</TD></TR><TR CLASS="z"><TD CLASS="l">3413</TD><TD>                    int lengthToWrite = packetLength;</TD></TR><TR><TD CLASS="l">3414</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3415</TD><TD>                    readChannelFully(multiPacket.getNioBuffer(), packetLength);</TD></TR><TR><TD CLASS="l">3416</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3417</TD><TD>                    byte[] byteBuf = multiPacket.getByteBuffer();</TD></TR><TR><TD CLASS="l">3418</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3419</TD><TD>                    reuse.writeBytesNoNull(byteBuf, 0, lengthToWrite);</TD></TR><TR><TD CLASS="l">3420</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3421</TD><TD>                    packetEndPoint += lengthToWrite;</TD></TR><TR><TD CLASS="l">3422</TD><TD>                }</TD></TR><TR><TD CLASS="l">3423</TD><TD> </TD></TR><TR><TD CLASS="l">3424</TD><TD>                //reuse.writeByte((byte) 0);</TD></TR><TR CLASS="z"><TD CLASS="l">3425</TD><TD>                reuse.setPosition(0);</TD></TR><TR CLASS="z"><TD CLASS="l">3426</TD><TD>                reuse.setWasMultiPacket(true);</TD></TR><TR><TD CLASS="l">3427</TD><TD>            }</TD></TR><TR><TD CLASS="l">3428</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3429</TD><TD>            if (!isMultiPacket) {</TD></TR><TR CLASS="c"><TD CLASS="l">3430</TD><TD>                reuse.setPosition(packetLength);</TD></TR><TR CLASS="c"><TD CLASS="l">3431</TD><TD>                reuse.writeByte((byte) 0); // Null-termination</TD></TR><TR><TD CLASS="l">3432</TD><TD>            }</TD></TR><TR><TD CLASS="l">3433</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3434</TD><TD>            reuse.setPosition(0);</TD></TR><TR><TD CLASS="l">3435</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3436</TD><TD>            return reuse;</TD></TR><TR CLASS="z"><TD CLASS="l">3437</TD><TD>        } catch (IOException ioEx) {</TD></TR><TR CLASS="z"><TD CLASS="l">3438</TD><TD>            throw new CommunicationsException(this.connection,</TD></TR><TR><TD CLASS="l">3439</TD><TD>                this.lastPacketSentTimeMs, ioEx);</TD></TR><TR CLASS="z"><TD CLASS="l">3440</TD><TD>        } catch (OutOfMemoryError oom) {</TD></TR><TR><TD CLASS="l">3441</TD><TD>                try {</TD></TR><TR><TD CLASS="l">3442</TD><TD>                        // _Try_ this</TD></TR><TR CLASS="z"><TD CLASS="l">3443</TD><TD>                        clearInputStream();</TD></TR><TR CLASS="z"><TD CLASS="l">3444</TD><TD>                } finally {</TD></TR><TR CLASS="z"><TD CLASS="l">3445</TD><TD>                        try {</TD></TR><TR CLASS="z"><TD CLASS="l">3446</TD><TD>                                this.connection.realClose(false, false, true, oom);</TD></TR><TR><TD CLASS="l">3447</TD><TD>                        } finally {</TD></TR><TR CLASS="z"><TD CLASS="l">3448</TD><TD>                                throw oom;</TD></TR><TR><TD CLASS="l">3449</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">3450</TD><TD>                }</TD></TR><TR><TD CLASS="l"><A NAME="3e">3451</A></TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3452</TD><TD>    }</TD></TR><TR><TD CLASS="l">3453</TD><TD> </TD></TR><TR><TD CLASS="l">3454</TD><TD>    boolean hadWarnings() {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="46">3455</A></TD><TD>            return this.hadWarnings;</TD></TR><TR><TD CLASS="l">3456</TD><TD>    }</TD></TR><TR><TD CLASS="l">3457</TD><TD>    </TD></TR><TR><TD CLASS="l">3458</TD><TD>    void scanForAndThrowDataTruncation() throws SQLException {</TD></TR><TR CLASS="c"><TD CLASS="l">3459</TD><TD>        if ((this.streamingData == null) &amp;&amp; versionMeetsMinimum(4, 1, 0) &amp;&amp;</TD></TR><TR><TD CLASS="l">3460</TD><TD>                this.connection.getJdbcCompliantTruncation()) {</TD></TR><TR CLASS="c"><TD CLASS="l">3461</TD><TD>            SQLError.convertShowWarningsToSQLWarnings(this.connection,</TD></TR><TR><TD CLASS="l">3462</TD><TD>                this.warningCount, true);</TD></TR><TR><TD CLASS="l">3463</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">3464</TD><TD>    }</TD></TR><TR><TD CLASS="l">3465</TD><TD> </TD></TR><TR><TD CLASS="l">3466</TD><TD>    /**</TD></TR><TR><TD CLASS="l">3467</TD><TD>     * Secure authentication for 4.1 and newer servers.</TD></TR><TR><TD CLASS="l">3468</TD><TD>     *</TD></TR><TR><TD CLASS="l">3469</TD><TD>     * @param packet DOCUMENT ME!</TD></TR><TR><TD CLASS="l">3470</TD><TD>     * @param packLength</TD></TR><TR><TD CLASS="l">3471</TD><TD>     * @param user</TD></TR><TR><TD CLASS="l">3472</TD><TD>     * @param password</TD></TR><TR><TD CLASS="l">3473</TD><TD>     * @param database DOCUMENT ME!</TD></TR><TR><TD CLASS="l">3474</TD><TD>     * @param writeClientParams</TD></TR><TR><TD CLASS="l">3475</TD><TD>     *</TD></TR><TR><TD CLASS="l">3476</TD><TD>     * @throws SQLException</TD></TR><TR><TD CLASS="l">3477</TD><TD>     */</TD></TR><TR><TD CLASS="l"><A NAME="b">3478</A></TD><TD>    private void secureAuth(Buffer packet, int packLength, String user,</TD></TR><TR><TD CLASS="l">3479</TD><TD>        String password, String database, boolean writeClientParams)</TD></TR><TR><TD CLASS="l">3480</TD><TD>        throws SQLException {</TD></TR><TR><TD CLASS="l">3481</TD><TD>        // Passwords can be 16 chars long</TD></TR><TR CLASS="z"><TD CLASS="l">3482</TD><TD>        if (packet == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">3483</TD><TD>            packet = Buffer.allocateNew(packLength, this.useNewIo);</TD></TR><TR><TD CLASS="l">3484</TD><TD>        }</TD></TR><TR><TD CLASS="l">3485</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3486</TD><TD>        if (writeClientParams) {</TD></TR><TR CLASS="z"><TD CLASS="l">3487</TD><TD>            if (this.use41Extensions) {</TD></TR><TR CLASS="z"><TD CLASS="l">3488</TD><TD>                if (versionMeetsMinimum(4, 1, 1)) {</TD></TR><TR CLASS="z"><TD CLASS="l">3489</TD><TD>                    packet.writeLong(this.clientParam);</TD></TR><TR CLASS="z"><TD CLASS="l">3490</TD><TD>                    packet.writeLong(this.maxThreeBytes);</TD></TR><TR><TD CLASS="l">3491</TD><TD> </TD></TR><TR><TD CLASS="l">3492</TD><TD>                    // charset, JDBC will connect as 'latin1',</TD></TR><TR><TD CLASS="l">3493</TD><TD>                    // and use 'SET NAMES' to change to the desired</TD></TR><TR><TD CLASS="l">3494</TD><TD>                    // charset after the connection is established.</TD></TR><TR CLASS="z"><TD CLASS="l">3495</TD><TD>                    packet.writeByte((byte) 8);</TD></TR><TR><TD CLASS="l">3496</TD><TD> </TD></TR><TR><TD CLASS="l">3497</TD><TD>                    // Set of bytes reserved for future use.</TD></TR><TR CLASS="z"><TD CLASS="l">3498</TD><TD>                    packet.writeBytesNoNull(new byte[23]);</TD></TR><TR><TD CLASS="l">3499</TD><TD>                } else {</TD></TR><TR CLASS="z"><TD CLASS="l">3500</TD><TD>                    packet.writeLong(this.clientParam);</TD></TR><TR CLASS="z"><TD CLASS="l">3501</TD><TD>                    packet.writeLong(this.maxThreeBytes);</TD></TR><TR><TD CLASS="l">3502</TD><TD>                }</TD></TR><TR><TD CLASS="l">3503</TD><TD>            } else {</TD></TR><TR CLASS="z"><TD CLASS="l">3504</TD><TD>                packet.writeInt((int) this.clientParam);</TD></TR><TR CLASS="z"><TD CLASS="l">3505</TD><TD>                packet.writeLongInt(this.maxThreeBytes);</TD></TR><TR><TD CLASS="l">3506</TD><TD>            }</TD></TR><TR><TD CLASS="l">3507</TD><TD>        }</TD></TR><TR><TD CLASS="l">3508</TD><TD> </TD></TR><TR><TD CLASS="l">3509</TD><TD>        // User/Password data</TD></TR><TR CLASS="z"><TD CLASS="l">3510</TD><TD>        packet.writeString(user);</TD></TR><TR><TD CLASS="l">3511</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3512</TD><TD>        if (password.length() != 0) {</TD></TR><TR><TD CLASS="l">3513</TD><TD>            /* Prepare false scramble  */</TD></TR><TR CLASS="z"><TD CLASS="l">3514</TD><TD>            packet.writeString(FALSE_SCRAMBLE);</TD></TR><TR><TD CLASS="l">3515</TD><TD>        } else {</TD></TR><TR><TD CLASS="l">3516</TD><TD>            /* For empty password*/</TD></TR><TR CLASS="z"><TD CLASS="l">3517</TD><TD>            packet.writeString(&#34;&#34;); //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">3518</TD><TD>        }</TD></TR><TR><TD CLASS="l">3519</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3520</TD><TD>        if (this.useConnectWithDb) {</TD></TR><TR CLASS="z"><TD CLASS="l">3521</TD><TD>            packet.writeString(database);</TD></TR><TR><TD CLASS="l">3522</TD><TD>        }</TD></TR><TR><TD CLASS="l">3523</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3524</TD><TD>        send(packet);</TD></TR><TR><TD CLASS="l">3525</TD><TD> </TD></TR><TR><TD CLASS="l">3526</TD><TD>        //</TD></TR><TR><TD CLASS="l">3527</TD><TD>        // Don't continue stages if password is empty</TD></TR><TR><TD CLASS="l">3528</TD><TD>        //</TD></TR><TR CLASS="z"><TD CLASS="l">3529</TD><TD>        if (password.length() &gt; 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">3530</TD><TD>            Buffer b = readPacket();</TD></TR><TR><TD CLASS="l">3531</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3532</TD><TD>            b.setPosition(0);</TD></TR><TR><TD CLASS="l">3533</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3534</TD><TD>            byte[] replyAsBytes = b.getByteBuffer();</TD></TR><TR><TD CLASS="l">3535</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3536</TD><TD>            if ((replyAsBytes.length == 25) &amp;&amp; (replyAsBytes[0] != 0)) {</TD></TR><TR><TD CLASS="l">3537</TD><TD>                // Old passwords will have '*' at the first byte of hash */</TD></TR><TR CLASS="z"><TD CLASS="l">3538</TD><TD>                if (replyAsBytes[0] != '*') {</TD></TR><TR><TD CLASS="l">3539</TD><TD>                    try {</TD></TR><TR><TD CLASS="l">3540</TD><TD>                        /* Build full password hash as it is required to decode scramble */</TD></TR><TR CLASS="z"><TD CLASS="l">3541</TD><TD>                        byte[] buff = Security.passwordHashStage1(password);</TD></TR><TR><TD CLASS="l">3542</TD><TD> </TD></TR><TR><TD CLASS="l">3543</TD><TD>                        /* Store copy as we'll need it later */</TD></TR><TR CLASS="z"><TD CLASS="l">3544</TD><TD>                        byte[] passwordHash = new byte[buff.length];</TD></TR><TR CLASS="z"><TD CLASS="l">3545</TD><TD>                        System.arraycopy(buff, 0, passwordHash, 0, buff.length);</TD></TR><TR><TD CLASS="l">3546</TD><TD> </TD></TR><TR><TD CLASS="l">3547</TD><TD>                        /* Finally hash complete password using hash we got from server */</TD></TR><TR CLASS="z"><TD CLASS="l">3548</TD><TD>                        passwordHash = Security.passwordHashStage2(passwordHash,</TD></TR><TR><TD CLASS="l">3549</TD><TD>                                replyAsBytes);</TD></TR><TR><TD CLASS="l">3550</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3551</TD><TD>                        byte[] packetDataAfterSalt = new byte[replyAsBytes.length -</TD></TR><TR><TD CLASS="l">3552</TD><TD>                            5];</TD></TR><TR><TD CLASS="l">3553</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3554</TD><TD>                        System.arraycopy(replyAsBytes, 4, packetDataAfterSalt,</TD></TR><TR><TD CLASS="l">3555</TD><TD>                            0, replyAsBytes.length - 5);</TD></TR><TR><TD CLASS="l">3556</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3557</TD><TD>                        byte[] mysqlScrambleBuff = new byte[20];</TD></TR><TR><TD CLASS="l">3558</TD><TD> </TD></TR><TR><TD CLASS="l">3559</TD><TD>                        /* Decypt and store scramble 4 = hash for stage2 */</TD></TR><TR CLASS="z"><TD CLASS="l">3560</TD><TD>                        Security.passwordCrypt(packetDataAfterSalt,</TD></TR><TR><TD CLASS="l">3561</TD><TD>                            mysqlScrambleBuff, passwordHash, 20);</TD></TR><TR><TD CLASS="l">3562</TD><TD> </TD></TR><TR><TD CLASS="l">3563</TD><TD>                        /* Encode scramble with password. Recycle buffer */</TD></TR><TR CLASS="z"><TD CLASS="l">3564</TD><TD>                        Security.passwordCrypt(mysqlScrambleBuff, buff, buff, 20);</TD></TR><TR><TD CLASS="l">3565</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3566</TD><TD>                        Buffer packet2 = Buffer.allocateNew(25, this.useNewIo);</TD></TR><TR CLASS="z"><TD CLASS="l">3567</TD><TD>                        packet2.writeBytesNoNull(buff);</TD></TR><TR><TD CLASS="l">3568</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3569</TD><TD>                        this.packetSequence++;</TD></TR><TR><TD CLASS="l">3570</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3571</TD><TD>                        send(packet2, 24);</TD></TR><TR CLASS="z"><TD CLASS="l">3572</TD><TD>                    } catch (NoSuchAlgorithmException nse) {</TD></TR><TR CLASS="z"><TD CLASS="l">3573</TD><TD>                        throw new SQLException(Messages.getString(&#34;MysqlIO.91&#34;) //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">3574</TD><TD>                             +Messages.getString(&#34;MysqlIO.92&#34;), //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">3575</TD><TD>                            SQLError.SQL_STATE_GENERAL_ERROR);</TD></TR><TR CLASS="z"><TD CLASS="l">3576</TD><TD>                    }</TD></TR><TR><TD CLASS="l">3577</TD><TD>                } else {</TD></TR><TR><TD CLASS="l">3578</TD><TD>                    try {</TD></TR><TR><TD CLASS="l">3579</TD><TD>                        /* Create password to decode scramble */</TD></TR><TR CLASS="z"><TD CLASS="l">3580</TD><TD>                        byte[] passwordHash = Security.createKeyFromOldPassword(password);</TD></TR><TR><TD CLASS="l">3581</TD><TD> </TD></TR><TR><TD CLASS="l">3582</TD><TD>                        /* Decypt and store scramble 4 = hash for stage2 */</TD></TR><TR CLASS="z"><TD CLASS="l">3583</TD><TD>                        byte[] netReadPos4 = new byte[replyAsBytes.length - 5];</TD></TR><TR><TD CLASS="l">3584</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3585</TD><TD>                        System.arraycopy(replyAsBytes, 4, netReadPos4, 0,</TD></TR><TR><TD CLASS="l">3586</TD><TD>                            replyAsBytes.length - 5);</TD></TR><TR><TD CLASS="l">3587</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3588</TD><TD>                        byte[] mysqlScrambleBuff = new byte[20];</TD></TR><TR><TD CLASS="l">3589</TD><TD> </TD></TR><TR><TD CLASS="l">3590</TD><TD>                        /* Decypt and store scramble 4 = hash for stage2 */</TD></TR><TR CLASS="z"><TD CLASS="l">3591</TD><TD>                        Security.passwordCrypt(netReadPos4, mysqlScrambleBuff,</TD></TR><TR><TD CLASS="l">3592</TD><TD>                            passwordHash, 20);</TD></TR><TR><TD CLASS="l">3593</TD><TD> </TD></TR><TR><TD CLASS="l">3594</TD><TD>                        /* Finally scramble decoded scramble with password */</TD></TR><TR CLASS="z"><TD CLASS="l">3595</TD><TD>                        String scrambledPassword = Util.scramble(new String(</TD></TR><TR><TD CLASS="l">3596</TD><TD>                                    mysqlScrambleBuff), password);</TD></TR><TR><TD CLASS="l">3597</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3598</TD><TD>                        Buffer packet2 = Buffer.allocateNew(packLength,</TD></TR><TR><TD CLASS="l">3599</TD><TD>                                this.useNewIo);</TD></TR><TR CLASS="z"><TD CLASS="l">3600</TD><TD>                        packet2.writeString(scrambledPassword);</TD></TR><TR CLASS="z"><TD CLASS="l">3601</TD><TD>                        this.packetSequence++;</TD></TR><TR><TD CLASS="l">3602</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3603</TD><TD>                        send(packet2, 24);</TD></TR><TR CLASS="z"><TD CLASS="l">3604</TD><TD>                    } catch (NoSuchAlgorithmException nse) {</TD></TR><TR CLASS="z"><TD CLASS="l">3605</TD><TD>                        throw new SQLException(Messages.getString(&#34;MysqlIO.93&#34;) //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">3606</TD><TD>                             +Messages.getString(&#34;MysqlIO.94&#34;), //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">3607</TD><TD>                            SQLError.SQL_STATE_GENERAL_ERROR);</TD></TR><TR CLASS="z"><TD CLASS="l">3608</TD><TD>                    }</TD></TR><TR><TD CLASS="l">3609</TD><TD>                }</TD></TR><TR><TD CLASS="l">3610</TD><TD>            }</TD></TR><TR><TD CLASS="l">3611</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3612</TD><TD>    }</TD></TR><TR><TD CLASS="l">3613</TD><TD> </TD></TR><TR><TD CLASS="l">3614</TD><TD>    /**</TD></TR><TR><TD CLASS="l">3615</TD><TD>     * Secure authentication for 4.1.1 and newer servers.</TD></TR><TR><TD CLASS="l">3616</TD><TD>     *</TD></TR><TR><TD CLASS="l">3617</TD><TD>     * @param packet DOCUMENT ME!</TD></TR><TR><TD CLASS="l">3618</TD><TD>     * @param packLength</TD></TR><TR><TD CLASS="l">3619</TD><TD>     * @param user</TD></TR><TR><TD CLASS="l">3620</TD><TD>     * @param password</TD></TR><TR><TD CLASS="l">3621</TD><TD>     * @param database DOCUMENT ME!</TD></TR><TR><TD CLASS="l">3622</TD><TD>     * @param writeClientParams</TD></TR><TR><TD CLASS="l">3623</TD><TD>     *</TD></TR><TR><TD CLASS="l">3624</TD><TD>     * @throws SQLException</TD></TR><TR><TD CLASS="l">3625</TD><TD>     */</TD></TR><TR><TD CLASS="l">3626</TD><TD>    void secureAuth411(Buffer packet, int packLength, String user,</TD></TR><TR><TD CLASS="l">3627</TD><TD>        String password, String database, boolean writeClientParams)</TD></TR><TR><TD CLASS="l">3628</TD><TD>        throws SQLException {</TD></TR><TR><TD CLASS="l">3629</TD><TD>        //        SERVER:  public_seed=create_random_string()</TD></TR><TR><TD CLASS="l">3630</TD><TD>        //                         send(public_seed)</TD></TR><TR><TD CLASS="l">3631</TD><TD>        //</TD></TR><TR><TD CLASS="l">3632</TD><TD>        //        CLIENT:  recv(public_seed)</TD></TR><TR><TD CLASS="l">3633</TD><TD>        //                         hash_stage1=sha1(&#34;password&#34;)</TD></TR><TR><TD CLASS="l">3634</TD><TD>        //                         hash_stage2=sha1(hash_stage1)</TD></TR><TR><TD CLASS="l">3635</TD><TD>        //                         reply=xor(hash_stage1, sha1(public_seed,hash_stage2)</TD></TR><TR><TD CLASS="l">3636</TD><TD>        //</TD></TR><TR><TD CLASS="l">3637</TD><TD>        //                         // this three steps are done in scramble()</TD></TR><TR><TD CLASS="l">3638</TD><TD>        //</TD></TR><TR><TD CLASS="l">3639</TD><TD>        //                         send(reply)</TD></TR><TR><TD CLASS="l">3640</TD><TD>        //</TD></TR><TR><TD CLASS="l">3641</TD><TD>        //</TD></TR><TR><TD CLASS="l">3642</TD><TD>        //        SERVER:  recv(reply)</TD></TR><TR><TD CLASS="l"><A NAME="13">3643</A></TD><TD>        //                         hash_stage1=xor(reply, sha1(public_seed,hash_stage2))</TD></TR><TR><TD CLASS="l">3644</TD><TD>        //                         candidate_hash2=sha1(hash_stage1)</TD></TR><TR><TD CLASS="l">3645</TD><TD>        //                         check(candidate_hash2==hash_stage2)</TD></TR><TR><TD CLASS="l">3646</TD><TD>        // Passwords can be 16 chars long</TD></TR><TR CLASS="c"><TD CLASS="l">3647</TD><TD>        if (packet == null) {</TD></TR><TR CLASS="c"><TD CLASS="l">3648</TD><TD>            packet = Buffer.allocateNew(packLength, this.useNewIo);</TD></TR><TR><TD CLASS="l">3649</TD><TD>        }</TD></TR><TR><TD CLASS="l">3650</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3651</TD><TD>        if (writeClientParams) {</TD></TR><TR CLASS="c"><TD CLASS="l">3652</TD><TD>            if (this.use41Extensions) {</TD></TR><TR CLASS="c"><TD CLASS="l">3653</TD><TD>                if (versionMeetsMinimum(4, 1, 1)) {</TD></TR><TR CLASS="c"><TD CLASS="l">3654</TD><TD>                    packet.writeLong(this.clientParam);</TD></TR><TR CLASS="c"><TD CLASS="l">3655</TD><TD>                    packet.writeLong(this.maxThreeBytes);</TD></TR><TR><TD CLASS="l">3656</TD><TD> </TD></TR><TR><TD CLASS="l">3657</TD><TD>                    // charset, JDBC will connect as 'latin1',</TD></TR><TR><TD CLASS="l">3658</TD><TD>                    // and use 'SET NAMES' to change to the desired</TD></TR><TR><TD CLASS="l">3659</TD><TD>                    // charset after the connection is established.</TD></TR><TR CLASS="c"><TD CLASS="l">3660</TD><TD>                    packet.writeByte((byte) 8);</TD></TR><TR><TD CLASS="l">3661</TD><TD> </TD></TR><TR><TD CLASS="l">3662</TD><TD>                    // Set of bytes reserved for future use.</TD></TR><TR CLASS="c"><TD CLASS="l">3663</TD><TD>                    packet.writeBytesNoNull(new byte[23]);</TD></TR><TR><TD CLASS="l">3664</TD><TD>                } else {</TD></TR><TR CLASS="z"><TD CLASS="l">3665</TD><TD>                    packet.writeLong(this.clientParam);</TD></TR><TR CLASS="z"><TD CLASS="l">3666</TD><TD>                    packet.writeLong(this.maxThreeBytes);</TD></TR><TR><TD CLASS="l">3667</TD><TD>                }</TD></TR><TR><TD CLASS="l">3668</TD><TD>            } else {</TD></TR><TR CLASS="z"><TD CLASS="l">3669</TD><TD>                packet.writeInt((int) this.clientParam);</TD></TR><TR CLASS="z"><TD CLASS="l">3670</TD><TD>                packet.writeLongInt(this.maxThreeBytes);</TD></TR><TR><TD CLASS="l">3671</TD><TD>            }</TD></TR><TR><TD CLASS="l">3672</TD><TD>        }</TD></TR><TR><TD CLASS="l">3673</TD><TD> </TD></TR><TR><TD CLASS="l">3674</TD><TD>        // User/Password data</TD></TR><TR CLASS="c"><TD CLASS="l">3675</TD><TD>        packet.writeString(user);</TD></TR><TR><TD CLASS="l">3676</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3677</TD><TD>        if (password.length() != 0) {</TD></TR><TR CLASS="c"><TD CLASS="l">3678</TD><TD>            packet.writeByte((byte) 0x14);</TD></TR><TR><TD CLASS="l">3679</TD><TD> </TD></TR><TR><TD CLASS="l">3680</TD><TD>            try {</TD></TR><TR CLASS="c"><TD CLASS="l">3681</TD><TD>                packet.writeBytesNoNull(Security.scramble411(password, this.seed));</TD></TR><TR CLASS="z"><TD CLASS="l">3682</TD><TD>            } catch (NoSuchAlgorithmException nse) {</TD></TR><TR CLASS="z"><TD CLASS="l">3683</TD><TD>                throw new SQLException(Messages.getString(&#34;MysqlIO.95&#34;) //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">3684</TD><TD>                     +Messages.getString(&#34;MysqlIO.96&#34;), //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">3685</TD><TD>                    SQLError.SQL_STATE_GENERAL_ERROR);</TD></TR><TR CLASS="c"><TD CLASS="l">3686</TD><TD>            }</TD></TR><TR><TD CLASS="l">3687</TD><TD>        } else {</TD></TR><TR><TD CLASS="l">3688</TD><TD>            /* For empty password*/</TD></TR><TR CLASS="z"><TD CLASS="l">3689</TD><TD>            packet.writeByte((byte) 0);</TD></TR><TR><TD CLASS="l">3690</TD><TD>        }</TD></TR><TR><TD CLASS="l">3691</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3692</TD><TD>        if (this.useConnectWithDb) {</TD></TR><TR CLASS="c"><TD CLASS="l">3693</TD><TD>            packet.writeString(database);</TD></TR><TR><TD CLASS="l">3694</TD><TD>        }</TD></TR><TR><TD CLASS="l">3695</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3696</TD><TD>        send(packet);</TD></TR><TR><TD CLASS="l">3697</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3698</TD><TD>        byte savePacketSequence = this.packetSequence++;</TD></TR><TR><TD CLASS="l">3699</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3700</TD><TD>        Buffer reply = checkErrorPacket();</TD></TR><TR><TD CLASS="l">3701</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3702</TD><TD>        if (reply.isLastDataPacket()) {</TD></TR><TR><TD CLASS="l">3703</TD><TD>            /*</TD></TR><TR><TD CLASS="l">3704</TD><TD>                  By sending this very specific reply server asks us to send scrambled</TD></TR><TR><TD CLASS="l">3705</TD><TD>                  password in old format. The reply contains scramble_323.</TD></TR><TR><TD CLASS="l">3706</TD><TD>            */</TD></TR><TR CLASS="z"><TD CLASS="l">3707</TD><TD>            this.packetSequence = ++savePacketSequence;</TD></TR><TR CLASS="z"><TD CLASS="l">3708</TD><TD>            packet.clear();</TD></TR><TR><TD CLASS="l">3709</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3710</TD><TD>            String seed323 = this.seed.substring(0, 8);</TD></TR><TR CLASS="z"><TD CLASS="l">3711</TD><TD>            packet.writeString(Util.newCrypt(password, seed323));</TD></TR><TR CLASS="z"><TD CLASS="l">3712</TD><TD>            send(packet);</TD></TR><TR><TD CLASS="l">3713</TD><TD> </TD></TR><TR><TD CLASS="l">3714</TD><TD>            /* Read what server thinks about out new auth message report */</TD></TR><TR CLASS="z"><TD CLASS="l">3715</TD><TD>            checkErrorPacket();</TD></TR><TR><TD CLASS="l">3716</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">3717</TD><TD>    }</TD></TR><TR><TD CLASS="l">3718</TD><TD> </TD></TR><TR><TD CLASS="l">3719</TD><TD>    /**</TD></TR><TR><TD CLASS="l">3720</TD><TD>     * Un-packs binary-encoded result set data for one row</TD></TR><TR><TD CLASS="l">3721</TD><TD>     *</TD></TR><TR><TD CLASS="l">3722</TD><TD>     * @param fields</TD></TR><TR><TD CLASS="l">3723</TD><TD>     * @param binaryData</TD></TR><TR><TD CLASS="l">3724</TD><TD>     * @param resultSetConcurrency DOCUMENT ME!</TD></TR><TR><TD CLASS="l">3725</TD><TD>     *</TD></TR><TR><TD CLASS="l">3726</TD><TD>     * @return byte[][]</TD></TR><TR><TD CLASS="l">3727</TD><TD>     *</TD></TR><TR><TD CLASS="l"><A NAME="49">3728</A></TD><TD>     * @throws SQLException DOCUMENT ME!</TD></TR><TR><TD CLASS="l">3729</TD><TD>     */</TD></TR><TR><TD CLASS="l">3730</TD><TD>    private final Object[] unpackBinaryResultSetRow(Field[] fields,</TD></TR><TR><TD CLASS="l">3731</TD><TD>        Buffer binaryData, int resultSetConcurrency) throws SQLException {</TD></TR><TR CLASS="c"><TD CLASS="l">3732</TD><TD>        int numFields = fields.length;</TD></TR><TR><TD CLASS="l">3733</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3734</TD><TD>        Object[] unpackedRowData = new Object[numFields];</TD></TR><TR><TD CLASS="l">3735</TD><TD> </TD></TR><TR><TD CLASS="l">3736</TD><TD>        //</TD></TR><TR><TD CLASS="l">3737</TD><TD>        // Unpack the null bitmask, first</TD></TR><TR><TD CLASS="l">3738</TD><TD>        //</TD></TR><TR><TD CLASS="l">3739</TD><TD> </TD></TR><TR><TD CLASS="l">3740</TD><TD>        /* Reserve place for null-marker bytes */</TD></TR><TR CLASS="c"><TD CLASS="l">3741</TD><TD>        int nullCount = (numFields + 9) / 8;</TD></TR><TR><TD CLASS="l">3742</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3743</TD><TD>        byte[] nullBitMask = new byte[nullCount];</TD></TR><TR><TD CLASS="l">3744</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3745</TD><TD>        for (int i = 0; i &lt; nullCount; i++) {</TD></TR><TR CLASS="c"><TD CLASS="l">3746</TD><TD>            nullBitMask[i] = binaryData.readByte();</TD></TR><TR><TD CLASS="l">3747</TD><TD>        }</TD></TR><TR><TD CLASS="l">3748</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3749</TD><TD>        int nullMaskPos = 0;</TD></TR><TR CLASS="c"><TD CLASS="l">3750</TD><TD>        int bit = 4; // first two bits are reserved for future use</TD></TR><TR><TD CLASS="l">3751</TD><TD>       </TD></TR><TR><TD CLASS="l">3752</TD><TD>        //</TD></TR><TR><TD CLASS="l">3753</TD><TD>        // TODO: Benchmark if moving check for updatable result</TD></TR><TR><TD CLASS="l">3754</TD><TD>        //       sets out of loop is worthwhile?</TD></TR><TR><TD CLASS="l">3755</TD><TD>        //</TD></TR><TR><TD CLASS="l">3756</TD><TD>        </TD></TR><TR CLASS="c"><TD CLASS="l">3757</TD><TD>        for (int i = 0; i &lt; numFields; i++) {</TD></TR><TR CLASS="c"><TD CLASS="l">3758</TD><TD>            if ((nullBitMask[nullMaskPos] &amp; bit) != 0) {</TD></TR><TR CLASS="c"><TD CLASS="l">3759</TD><TD>                unpackedRowData[i] = null;</TD></TR><TR><TD CLASS="l">3760</TD><TD>            } else {</TD></TR><TR CLASS="c"><TD CLASS="l">3761</TD><TD>                    if (resultSetConcurrency != ResultSet.CONCUR_UPDATABLE) {</TD></TR><TR CLASS="c"><TD CLASS="l">3762</TD><TD>                            extractNativeEncodedColumn(binaryData, fields, i, </TD></TR><TR><TD CLASS="l">3763</TD><TD>                                            unpackedRowData);</TD></TR><TR><TD CLASS="l">3764</TD><TD>                    } else {</TD></TR><TR CLASS="c"><TD CLASS="l">3765</TD><TD>                            unpackNativeEncodedColumn(binaryData, fields, i, </TD></TR><TR><TD CLASS="l">3766</TD><TD>                                            unpackedRowData);</TD></TR><TR><TD CLASS="l">3767</TD><TD>                    }   </TD></TR><TR><TD CLASS="l">3768</TD><TD>            }</TD></TR><TR><TD CLASS="l">3769</TD><TD>            </TD></TR><TR CLASS="c"><TD CLASS="l">3770</TD><TD>                if (((bit &lt;&lt;= 1) &amp; 255) == 0) {</TD></TR><TR CLASS="c"><TD CLASS="l">3771</TD><TD>                        bit = 1; /* To next byte */</TD></TR><TR><TD CLASS="l">3772</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3773</TD><TD>                        nullMaskPos++;</TD></TR><TR><TD CLASS="l">3774</TD><TD>                }</TD></TR><TR><TD CLASS="l">3775</TD><TD>        }</TD></TR><TR><TD CLASS="l">3776</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3777</TD><TD>        return unpackedRowData;</TD></TR><TR><TD CLASS="l">3778</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="21">3779</A></TD><TD> </TD></TR><TR><TD CLASS="l">3780</TD><TD>        </TD></TR><TR><TD CLASS="l">3781</TD><TD>    private final void extractNativeEncodedColumn(Buffer binaryData, </TD></TR><TR><TD CLASS="l">3782</TD><TD>                    Field[] fields, int columnIndex, Object[] unpackedRowData) throws SQLException {</TD></TR><TR CLASS="c"><TD CLASS="l">3783</TD><TD>            Field curField = fields[columnIndex];</TD></TR><TR><TD CLASS="l">3784</TD><TD>            </TD></TR><TR CLASS="c"><TD CLASS="l">3785</TD><TD>            switch (curField.getMysqlType()) {</TD></TR><TR><TD CLASS="l">3786</TD><TD>            case MysqlDefs.FIELD_TYPE_NULL:</TD></TR><TR CLASS="z"><TD CLASS="l">3787</TD><TD>                    break; // for dummy binds</TD></TR><TR><TD CLASS="l">3788</TD><TD>            </TD></TR><TR><TD CLASS="l">3789</TD><TD>            case MysqlDefs.FIELD_TYPE_TINY:</TD></TR><TR><TD CLASS="l">3790</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3791</TD><TD>                    unpackedRowData[columnIndex] = new byte[] {binaryData.readByte()};</TD></TR><TR CLASS="c"><TD CLASS="l">3792</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">3793</TD><TD>            </TD></TR><TR><TD CLASS="l">3794</TD><TD>            case MysqlDefs.FIELD_TYPE_SHORT:</TD></TR><TR><TD CLASS="l">3795</TD><TD>            case MysqlDefs.FIELD_TYPE_YEAR:</TD></TR><TR><TD CLASS="l">3796</TD><TD>                    </TD></TR><TR CLASS="c"><TD CLASS="l">3797</TD><TD>                    unpackedRowData[columnIndex] = binaryData.getBytes(2);</TD></TR><TR CLASS="c"><TD CLASS="l">3798</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">3799</TD><TD>            case MysqlDefs.FIELD_TYPE_LONG:</TD></TR><TR><TD CLASS="l">3800</TD><TD>            case MysqlDefs.FIELD_TYPE_INT24:</TD></TR><TR><TD CLASS="l">3801</TD><TD>                    </TD></TR><TR CLASS="c"><TD CLASS="l">3802</TD><TD>                    unpackedRowData[columnIndex] = binaryData.getBytes(4);</TD></TR><TR CLASS="c"><TD CLASS="l">3803</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">3804</TD><TD>            case MysqlDefs.FIELD_TYPE_LONGLONG:</TD></TR><TR><TD CLASS="l">3805</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3806</TD><TD>                    unpackedRowData[columnIndex] = binaryData.getBytes(8);</TD></TR><TR CLASS="c"><TD CLASS="l">3807</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">3808</TD><TD>            case MysqlDefs.FIELD_TYPE_FLOAT:</TD></TR><TR><TD CLASS="l">3809</TD><TD>                    </TD></TR><TR CLASS="c"><TD CLASS="l">3810</TD><TD>                    unpackedRowData[columnIndex] = binaryData.getBytes(4);</TD></TR><TR CLASS="c"><TD CLASS="l">3811</TD><TD>                    break;           </TD></TR><TR><TD CLASS="l">3812</TD><TD>            case MysqlDefs.FIELD_TYPE_DOUBLE:</TD></TR><TR><TD CLASS="l">3813</TD><TD>                    </TD></TR><TR CLASS="c"><TD CLASS="l">3814</TD><TD>                    unpackedRowData[columnIndex] = binaryData.getBytes(8);</TD></TR><TR CLASS="c"><TD CLASS="l">3815</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">3816</TD><TD>            case MysqlDefs.FIELD_TYPE_TIME:</TD></TR><TR><TD CLASS="l">3817</TD><TD>                    </TD></TR><TR CLASS="c"><TD CLASS="l">3818</TD><TD>                    int length = (int) binaryData.readFieldLength();</TD></TR><TR><TD CLASS="l">3819</TD><TD>            </TD></TR><TR CLASS="c"><TD CLASS="l">3820</TD><TD>                    unpackedRowData[columnIndex] = binaryData.getBytes(length);</TD></TR><TR><TD CLASS="l">3821</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3822</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">3823</TD><TD>            case MysqlDefs.FIELD_TYPE_DATE:</TD></TR><TR><TD CLASS="l">3824</TD><TD>                    </TD></TR><TR CLASS="c"><TD CLASS="l">3825</TD><TD>                    length = (int) binaryData.readFieldLength();</TD></TR><TR><TD CLASS="l">3826</TD><TD>            </TD></TR><TR CLASS="c"><TD CLASS="l">3827</TD><TD>                    unpackedRowData[columnIndex] = binaryData.getBytes(length);</TD></TR><TR><TD CLASS="l">3828</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3829</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">3830</TD><TD>            case MysqlDefs.FIELD_TYPE_DATETIME:</TD></TR><TR><TD CLASS="l">3831</TD><TD>            case MysqlDefs.FIELD_TYPE_TIMESTAMP:</TD></TR><TR CLASS="c"><TD CLASS="l">3832</TD><TD>                    length = (int) binaryData.readFieldLength();</TD></TR><TR><TD CLASS="l">3833</TD><TD>            </TD></TR><TR CLASS="c"><TD CLASS="l">3834</TD><TD>                    unpackedRowData[columnIndex] = binaryData.getBytes(length);</TD></TR><TR CLASS="c"><TD CLASS="l">3835</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">3836</TD><TD>            case MysqlDefs.FIELD_TYPE_GEOMETRY:</TD></TR><TR><TD CLASS="l">3837</TD><TD>            case MysqlDefs.FIELD_TYPE_TINY_BLOB:</TD></TR><TR><TD CLASS="l">3838</TD><TD>            case MysqlDefs.FIELD_TYPE_MEDIUM_BLOB:</TD></TR><TR><TD CLASS="l">3839</TD><TD>            case MysqlDefs.FIELD_TYPE_LONG_BLOB:</TD></TR><TR><TD CLASS="l">3840</TD><TD>            case MysqlDefs.FIELD_TYPE_BLOB:</TD></TR><TR><TD CLASS="l">3841</TD><TD>            case MysqlDefs.FIELD_TYPE_VAR_STRING:</TD></TR><TR><TD CLASS="l">3842</TD><TD>            case MysqlDefs.FIELD_TYPE_VARCHAR:</TD></TR><TR><TD CLASS="l">3843</TD><TD>            case MysqlDefs.FIELD_TYPE_STRING:</TD></TR><TR><TD CLASS="l">3844</TD><TD>            case MysqlDefs.FIELD_TYPE_DECIMAL:</TD></TR><TR><TD CLASS="l">3845</TD><TD>            case MysqlDefs.FIELD_TYPE_NEW_DECIMAL:</TD></TR><TR CLASS="c"><TD CLASS="l">3846</TD><TD>                    unpackedRowData[columnIndex] = binaryData.readLenByteArray(0);</TD></TR><TR><TD CLASS="l">3847</TD><TD>            </TD></TR><TR CLASS="c"><TD CLASS="l">3848</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">3849</TD><TD>            case MysqlDefs.FIELD_TYPE_BIT:</TD></TR><TR CLASS="c"><TD CLASS="l">3850</TD><TD>                    unpackedRowData[columnIndex] = binaryData.readLenByteArray(0);</TD></TR><TR><TD CLASS="l">3851</TD><TD>                    </TD></TR><TR CLASS="c"><TD CLASS="l">3852</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">3853</TD><TD>            default:</TD></TR><TR CLASS="z"><TD CLASS="l">3854</TD><TD>                    throw new SQLException(Messages.getString(&#34;MysqlIO.97&#34;) //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">3855</TD><TD>                                    +curField.getMysqlType() +</TD></TR><TR><TD CLASS="l">3856</TD><TD>                                        Messages.getString(&#34;MysqlIO.98&#34;) + columnIndex +</TD></TR><TR><TD CLASS="l">3857</TD><TD>                                        Messages.getString(&#34;MysqlIO.99&#34;) //$NON-NLS-1$ //$NON-NLS-2$</TD></TR><TR><TD CLASS="l">3858</TD><TD>                                        + fields.length + Messages.getString(&#34;MysqlIO.100&#34;), //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">3859</TD><TD>                                        SQLError.SQL_STATE_GENERAL_ERROR);</TD></TR><TR><TD CLASS="l">3860</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">3861</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="11">3862</A></TD><TD> </TD></TR><TR><TD CLASS="l">3863</TD><TD>    private final void unpackNativeEncodedColumn(Buffer binaryData, </TD></TR><TR><TD CLASS="l">3864</TD><TD>                    Field[] fields, int columnIndex, Object[] unpackedRowData) </TD></TR><TR><TD CLASS="l">3865</TD><TD>    throws SQLException {</TD></TR><TR CLASS="c"><TD CLASS="l">3866</TD><TD>            Field curField = fields[columnIndex];</TD></TR><TR><TD CLASS="l">3867</TD><TD>            </TD></TR><TR CLASS="c"><TD CLASS="l">3868</TD><TD>            switch (curField.getMysqlType()) {</TD></TR><TR><TD CLASS="l">3869</TD><TD>            case MysqlDefs.FIELD_TYPE_NULL:</TD></TR><TR CLASS="z"><TD CLASS="l">3870</TD><TD>                    break; // for dummy binds</TD></TR><TR><TD CLASS="l">3871</TD><TD>                    </TD></TR><TR><TD CLASS="l">3872</TD><TD>            case MysqlDefs.FIELD_TYPE_TINY:</TD></TR><TR><TD CLASS="l">3873</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">3874</TD><TD>                    byte tinyVal = binaryData.readByte();</TD></TR><TR><TD CLASS="l">3875</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">3876</TD><TD>                    if (!curField.isUnsigned()) {                        </TD></TR><TR CLASS="z"><TD CLASS="l">3877</TD><TD>                            unpackedRowData[columnIndex] = String.valueOf(tinyVal)</TD></TR><TR><TD CLASS="l">3878</TD><TD>                            .getBytes();                          </TD></TR><TR><TD CLASS="l">3879</TD><TD>                    } else {</TD></TR><TR CLASS="z"><TD CLASS="l">3880</TD><TD>                            short unsignedTinyVal = (short) (tinyVal &amp; 0xff);</TD></TR><TR><TD CLASS="l">3881</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3882</TD><TD>                            unpackedRowData[columnIndex] = String.valueOf(unsignedTinyVal)</TD></TR><TR><TD CLASS="l">3883</TD><TD>                            .getBytes();                           </TD></TR><TR><TD CLASS="l">3884</TD><TD>                    }</TD></TR><TR><TD CLASS="l">3885</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">3886</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">3887</TD><TD>                    </TD></TR><TR><TD CLASS="l">3888</TD><TD>            case MysqlDefs.FIELD_TYPE_SHORT:</TD></TR><TR><TD CLASS="l">3889</TD><TD>            case MysqlDefs.FIELD_TYPE_YEAR:</TD></TR><TR><TD CLASS="l">3890</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">3891</TD><TD>                    short shortVal = (short) binaryData.readInt();</TD></TR><TR><TD CLASS="l">3892</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">3893</TD><TD>                    if (!curField.isUnsigned()) {</TD></TR><TR CLASS="z"><TD CLASS="l">3894</TD><TD>                            unpackedRowData[columnIndex] = String.valueOf(shortVal)</TD></TR><TR><TD CLASS="l">3895</TD><TD>                            .getBytes();        </TD></TR><TR><TD CLASS="l">3896</TD><TD>                    } else {</TD></TR><TR CLASS="z"><TD CLASS="l">3897</TD><TD>                            int unsignedShortVal = shortVal &amp; 0xffff;</TD></TR><TR><TD CLASS="l">3898</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3899</TD><TD>                            unpackedRowData[columnIndex] = String.valueOf(unsignedShortVal)</TD></TR><TR><TD CLASS="l">3900</TD><TD>                            .getBytes();        </TD></TR><TR><TD CLASS="l">3901</TD><TD>                    }</TD></TR><TR><TD CLASS="l">3902</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">3903</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">3904</TD><TD>                    </TD></TR><TR><TD CLASS="l">3905</TD><TD>            case MysqlDefs.FIELD_TYPE_LONG:</TD></TR><TR><TD CLASS="l">3906</TD><TD>            case MysqlDefs.FIELD_TYPE_INT24:</TD></TR><TR><TD CLASS="l">3907</TD><TD>                    </TD></TR><TR CLASS="c"><TD CLASS="l">3908</TD><TD>                    int intVal = (int) binaryData.readLong();</TD></TR><TR><TD CLASS="l">3909</TD><TD>                    </TD></TR><TR CLASS="c"><TD CLASS="l">3910</TD><TD>                    if (!curField.isUnsigned()) {</TD></TR><TR CLASS="c"><TD CLASS="l">3911</TD><TD>                            unpackedRowData[columnIndex] = String.valueOf(intVal)</TD></TR><TR><TD CLASS="l">3912</TD><TD>                            .getBytes();</TD></TR><TR><TD CLASS="l">3913</TD><TD>                    } else {</TD></TR><TR CLASS="c"><TD CLASS="l">3914</TD><TD>                            long longVal = intVal &amp; 0xffffffffL;</TD></TR><TR><TD CLASS="l">3915</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3916</TD><TD>                            unpackedRowData[columnIndex] = String.valueOf(longVal)</TD></TR><TR><TD CLASS="l">3917</TD><TD>                            .getBytes();        </TD></TR><TR><TD CLASS="l">3918</TD><TD>                    }</TD></TR><TR><TD CLASS="l">3919</TD><TD>                    </TD></TR><TR CLASS="c"><TD CLASS="l">3920</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">3921</TD><TD>                    </TD></TR><TR><TD CLASS="l">3922</TD><TD>            case MysqlDefs.FIELD_TYPE_LONGLONG:</TD></TR><TR><TD CLASS="l">3923</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">3924</TD><TD>                    long longVal = binaryData.readLongLong();</TD></TR><TR><TD CLASS="l">3925</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">3926</TD><TD>                    if (!curField.isUnsigned()) {</TD></TR><TR CLASS="z"><TD CLASS="l">3927</TD><TD>                            unpackedRowData[columnIndex] = String.valueOf(longVal)</TD></TR><TR><TD CLASS="l">3928</TD><TD>                            .getBytes();</TD></TR><TR><TD CLASS="l">3929</TD><TD>                    } else {</TD></TR><TR CLASS="z"><TD CLASS="l">3930</TD><TD>                            BigInteger asBigInteger = ResultSet.convertLongToUlong(longVal);</TD></TR><TR><TD CLASS="l">3931</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3932</TD><TD>                            unpackedRowData[columnIndex] = asBigInteger.toString()</TD></TR><TR><TD CLASS="l">3933</TD><TD>                            .getBytes();        </TD></TR><TR><TD CLASS="l">3934</TD><TD>                    }</TD></TR><TR><TD CLASS="l">3935</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">3936</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">3937</TD><TD>                    </TD></TR><TR><TD CLASS="l">3938</TD><TD>            case MysqlDefs.FIELD_TYPE_FLOAT:</TD></TR><TR><TD CLASS="l">3939</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">3940</TD><TD>                    float floatVal = Float.intBitsToFloat(binaryData.readIntAsLong());</TD></TR><TR><TD CLASS="l">3941</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">3942</TD><TD>                    unpackedRowData[columnIndex] = String.valueOf(floatVal).getBytes();</TD></TR><TR><TD CLASS="l">3943</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3944</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">3945</TD><TD>                    </TD></TR><TR><TD CLASS="l">3946</TD><TD>            case MysqlDefs.FIELD_TYPE_DOUBLE:</TD></TR><TR><TD CLASS="l">3947</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">3948</TD><TD>                    double doubleVal = Double.longBitsToDouble(binaryData.readLongLong());</TD></TR><TR><TD CLASS="l">3949</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3950</TD><TD>                    unpackedRowData[columnIndex] = String.valueOf(doubleVal).getBytes();</TD></TR><TR><TD CLASS="l">3951</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3952</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">3953</TD><TD>                    </TD></TR><TR><TD CLASS="l">3954</TD><TD>            case MysqlDefs.FIELD_TYPE_TIME:</TD></TR><TR><TD CLASS="l">3955</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">3956</TD><TD>                    int length = (int) binaryData.readFieldLength();</TD></TR><TR><TD CLASS="l">3957</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">3958</TD><TD>                    int hour = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">3959</TD><TD>                    int minute = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">3960</TD><TD>                    int seconds = 0;</TD></TR><TR><TD CLASS="l">3961</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">3962</TD><TD>                    if (length != 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">3963</TD><TD>                            binaryData.readByte(); // skip tm-&gt;neg</TD></TR><TR CLASS="z"><TD CLASS="l">3964</TD><TD>                            binaryData.readLong(); // skip daysPart</TD></TR><TR CLASS="z"><TD CLASS="l">3965</TD><TD>                            hour = binaryData.readByte();</TD></TR><TR CLASS="z"><TD CLASS="l">3966</TD><TD>                            minute = binaryData.readByte();</TD></TR><TR CLASS="z"><TD CLASS="l">3967</TD><TD>                            seconds = binaryData.readByte();</TD></TR><TR><TD CLASS="l">3968</TD><TD>                            </TD></TR><TR CLASS="z"><TD CLASS="l">3969</TD><TD>                            if (length &gt; 8) {</TD></TR><TR CLASS="z"><TD CLASS="l">3970</TD><TD>                                    binaryData.readLong(); // ignore 'secondsPart'</TD></TR><TR><TD CLASS="l">3971</TD><TD>                            }</TD></TR><TR><TD CLASS="l">3972</TD><TD>                    }</TD></TR><TR><TD CLASS="l">3973</TD><TD>                    </TD></TR><TR><TD CLASS="l">3974</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">3975</TD><TD>                    byte[] timeAsBytes = new byte[8];</TD></TR><TR><TD CLASS="l">3976</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">3977</TD><TD>                    timeAsBytes[0] = (byte) Character.forDigit(hour / 10, 10);</TD></TR><TR CLASS="z"><TD CLASS="l">3978</TD><TD>                    timeAsBytes[1] = (byte) Character.forDigit(hour % 10, 10);</TD></TR><TR><TD CLASS="l">3979</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">3980</TD><TD>                    timeAsBytes[2] = (byte) ':';</TD></TR><TR><TD CLASS="l">3981</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">3982</TD><TD>                    timeAsBytes[3] = (byte) Character.forDigit(minute / 10,</TD></TR><TR><TD CLASS="l">3983</TD><TD>                                    10);</TD></TR><TR CLASS="z"><TD CLASS="l">3984</TD><TD>                    timeAsBytes[4] = (byte) Character.forDigit(minute % 10,</TD></TR><TR><TD CLASS="l">3985</TD><TD>                                    10);</TD></TR><TR><TD CLASS="l">3986</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">3987</TD><TD>                    timeAsBytes[5] = (byte) ':';</TD></TR><TR><TD CLASS="l">3988</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">3989</TD><TD>                    timeAsBytes[6] = (byte) Character.forDigit(seconds / 10,</TD></TR><TR><TD CLASS="l">3990</TD><TD>                                    10);</TD></TR><TR CLASS="z"><TD CLASS="l">3991</TD><TD>                    timeAsBytes[7] = (byte) Character.forDigit(seconds % 10,</TD></TR><TR><TD CLASS="l">3992</TD><TD>                                    10);</TD></TR><TR><TD CLASS="l">3993</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">3994</TD><TD>                    unpackedRowData[columnIndex] = timeAsBytes;</TD></TR><TR><TD CLASS="l">3995</TD><TD>                    </TD></TR><TR><TD CLASS="l">3996</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">3997</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">3998</TD><TD>                    </TD></TR><TR><TD CLASS="l">3999</TD><TD>            case MysqlDefs.FIELD_TYPE_DATE:</TD></TR><TR CLASS="z"><TD CLASS="l">4000</TD><TD>                    length = (int) binaryData.readFieldLength();</TD></TR><TR><TD CLASS="l">4001</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">4002</TD><TD>                    int year = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">4003</TD><TD>                    int month = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">4004</TD><TD>                    int day = 0;</TD></TR><TR><TD CLASS="l">4005</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">4006</TD><TD>                    hour = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">4007</TD><TD>                    minute = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">4008</TD><TD>                    seconds = 0;</TD></TR><TR><TD CLASS="l">4009</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">4010</TD><TD>                    if (length != 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">4011</TD><TD>                            year = binaryData.readInt();</TD></TR><TR CLASS="z"><TD CLASS="l">4012</TD><TD>                            month = binaryData.readByte();</TD></TR><TR CLASS="z"><TD CLASS="l">4013</TD><TD>                            day = binaryData.readByte();</TD></TR><TR><TD CLASS="l">4014</TD><TD>                    }</TD></TR><TR><TD CLASS="l">4015</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">4016</TD><TD>                    if ((year == 0) &amp;&amp; (month == 0) &amp;&amp; (day == 0)) {</TD></TR><TR CLASS="z"><TD CLASS="l">4017</TD><TD>                            if (ConnectionProperties.ZERO_DATETIME_BEHAVIOR_CONVERT_TO_NULL.equals(</TD></TR><TR><TD CLASS="l">4018</TD><TD>                                            this.connection.getZeroDateTimeBehavior())) {</TD></TR><TR CLASS="z"><TD CLASS="l">4019</TD><TD>                                    unpackedRowData[columnIndex] = null;</TD></TR><TR><TD CLASS="l">4020</TD><TD>                                    </TD></TR><TR CLASS="z"><TD CLASS="l">4021</TD><TD>                                    break;</TD></TR><TR CLASS="z"><TD CLASS="l">4022</TD><TD>                            } else if (ConnectionProperties.ZERO_DATETIME_BEHAVIOR_EXCEPTION.equals(</TD></TR><TR><TD CLASS="l">4023</TD><TD>                                            this.connection.getZeroDateTimeBehavior())) {</TD></TR><TR CLASS="z"><TD CLASS="l">4024</TD><TD>                                    throw new SQLException(&#34;Value '0000-00-00' can not be represented as java.sql.Date&#34;,</TD></TR><TR><TD CLASS="l">4025</TD><TD>                                                    SQLError.SQL_STATE_ILLEGAL_ARGUMENT);</TD></TR><TR><TD CLASS="l">4026</TD><TD>                            }</TD></TR><TR><TD CLASS="l">4027</TD><TD>                            </TD></TR><TR CLASS="z"><TD CLASS="l">4028</TD><TD>                            year = 1;</TD></TR><TR CLASS="z"><TD CLASS="l">4029</TD><TD>                            month = 1;</TD></TR><TR CLASS="z"><TD CLASS="l">4030</TD><TD>                            day = 1;</TD></TR><TR><TD CLASS="l">4031</TD><TD>                    }</TD></TR><TR><TD CLASS="l">4032</TD><TD>                    </TD></TR><TR><TD CLASS="l">4033</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">4034</TD><TD>                    byte[] dateAsBytes = new byte[10];</TD></TR><TR><TD CLASS="l">4035</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">4036</TD><TD>                    dateAsBytes[0] = (byte) Character.forDigit(year / 1000,</TD></TR><TR><TD CLASS="l">4037</TD><TD>                                    10);</TD></TR><TR><TD CLASS="l">4038</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">4039</TD><TD>                    int after1000 = year % 1000;</TD></TR><TR><TD CLASS="l">4040</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">4041</TD><TD>                    dateAsBytes[1] = (byte) Character.forDigit(after1000 / 100,</TD></TR><TR><TD CLASS="l">4042</TD><TD>                                    10);</TD></TR><TR><TD CLASS="l">4043</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">4044</TD><TD>                    int after100 = after1000 % 100;</TD></TR><TR><TD CLASS="l">4045</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">4046</TD><TD>                    dateAsBytes[2] = (byte) Character.forDigit(after100 / 10,</TD></TR><TR><TD CLASS="l">4047</TD><TD>                                    10);</TD></TR><TR CLASS="z"><TD CLASS="l">4048</TD><TD>                    dateAsBytes[3] = (byte) Character.forDigit(after100 % 10,</TD></TR><TR><TD CLASS="l">4049</TD><TD>                                    10);</TD></TR><TR><TD CLASS="l">4050</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">4051</TD><TD>                    dateAsBytes[4] = (byte) '-';</TD></TR><TR><TD CLASS="l">4052</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">4053</TD><TD>                    dateAsBytes[5] = (byte) Character.forDigit(month / 10,</TD></TR><TR><TD CLASS="l">4054</TD><TD>                                    10);</TD></TR><TR CLASS="z"><TD CLASS="l">4055</TD><TD>                    dateAsBytes[6] = (byte) Character.forDigit(month % 10,</TD></TR><TR><TD CLASS="l">4056</TD><TD>                                    10);</TD></TR><TR><TD CLASS="l">4057</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">4058</TD><TD>                    dateAsBytes[7] = (byte) '-';</TD></TR><TR><TD CLASS="l">4059</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">4060</TD><TD>                    dateAsBytes[8] = (byte) Character.forDigit(day / 10, 10);</TD></TR><TR CLASS="z"><TD CLASS="l">4061</TD><TD>                    dateAsBytes[9] = (byte) Character.forDigit(day % 10, 10);</TD></TR><TR><TD CLASS="l">4062</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">4063</TD><TD>                    unpackedRowData[columnIndex] = dateAsBytes;</TD></TR><TR><TD CLASS="l">4064</TD><TD>                    </TD></TR><TR><TD CLASS="l">4065</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">4066</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">4067</TD><TD>                    </TD></TR><TR><TD CLASS="l">4068</TD><TD>            case MysqlDefs.FIELD_TYPE_DATETIME:</TD></TR><TR><TD CLASS="l">4069</TD><TD>            case MysqlDefs.FIELD_TYPE_TIMESTAMP:</TD></TR><TR CLASS="c"><TD CLASS="l">4070</TD><TD>                    length = (int) binaryData.readFieldLength();</TD></TR><TR><TD CLASS="l">4071</TD><TD>                    </TD></TR><TR CLASS="c"><TD CLASS="l">4072</TD><TD>                    year = 0;</TD></TR><TR CLASS="c"><TD CLASS="l">4073</TD><TD>                    month = 0;</TD></TR><TR CLASS="c"><TD CLASS="l">4074</TD><TD>                    day = 0;</TD></TR><TR><TD CLASS="l">4075</TD><TD>                    </TD></TR><TR CLASS="c"><TD CLASS="l">4076</TD><TD>                    hour = 0;</TD></TR><TR CLASS="c"><TD CLASS="l">4077</TD><TD>                    minute = 0;</TD></TR><TR CLASS="c"><TD CLASS="l">4078</TD><TD>                    seconds = 0;</TD></TR><TR><TD CLASS="l">4079</TD><TD>                    </TD></TR><TR CLASS="c"><TD CLASS="l">4080</TD><TD>                    int nanos = 0;</TD></TR><TR><TD CLASS="l">4081</TD><TD>                    </TD></TR><TR CLASS="c"><TD CLASS="l">4082</TD><TD>                    if (length != 0) {</TD></TR><TR CLASS="c"><TD CLASS="l">4083</TD><TD>                            year = binaryData.readInt();</TD></TR><TR CLASS="c"><TD CLASS="l">4084</TD><TD>                            month = binaryData.readByte();</TD></TR><TR CLASS="c"><TD CLASS="l">4085</TD><TD>                            day = binaryData.readByte();</TD></TR><TR><TD CLASS="l">4086</TD><TD>                            </TD></TR><TR CLASS="c"><TD CLASS="l">4087</TD><TD>                            if (length &gt; 4) {</TD></TR><TR CLASS="c"><TD CLASS="l">4088</TD><TD>                                    hour = binaryData.readByte();</TD></TR><TR CLASS="c"><TD CLASS="l">4089</TD><TD>                                    minute = binaryData.readByte();</TD></TR><TR CLASS="c"><TD CLASS="l">4090</TD><TD>                                    seconds = binaryData.readByte();</TD></TR><TR><TD CLASS="l">4091</TD><TD>                            }</TD></TR><TR><TD CLASS="l">4092</TD><TD>                            </TD></TR><TR><TD CLASS="l">4093</TD><TD>                            //if (length &gt; 7) {</TD></TR><TR><TD CLASS="l">4094</TD><TD>                            //    nanos = (int)binaryData.readLong();</TD></TR><TR><TD CLASS="l">4095</TD><TD>                            //}</TD></TR><TR><TD CLASS="l">4096</TD><TD>                    }</TD></TR><TR><TD CLASS="l">4097</TD><TD>                    </TD></TR><TR CLASS="p"><TD TITLE="33% line coverage (2 out of 6 instructions)" CLASS="l">4098</TD><TD TITLE="33% line coverage (2 out of 6 instructions)">                    if ((year == 0) &amp;&amp; (month == 0) &amp;&amp; (day == 0)) {</TD></TR><TR CLASS="z"><TD CLASS="l">4099</TD><TD>                            if (ConnectionProperties.ZERO_DATETIME_BEHAVIOR_CONVERT_TO_NULL.equals(</TD></TR><TR><TD CLASS="l">4100</TD><TD>                                            this.connection.getZeroDateTimeBehavior())) {</TD></TR><TR CLASS="z"><TD CLASS="l">4101</TD><TD>                                    unpackedRowData[columnIndex] = null;</TD></TR><TR><TD CLASS="l">4102</TD><TD>                                    </TD></TR><TR CLASS="z"><TD CLASS="l">4103</TD><TD>                                    break;</TD></TR><TR CLASS="z"><TD CLASS="l">4104</TD><TD>                            } else if (ConnectionProperties.ZERO_DATETIME_BEHAVIOR_EXCEPTION.equals(</TD></TR><TR><TD CLASS="l">4105</TD><TD>                                            this.connection.getZeroDateTimeBehavior())) {</TD></TR><TR CLASS="z"><TD CLASS="l">4106</TD><TD>                                    throw new SQLException(&#34;Value '0000-00-00' can not be represented as java.sql.Timestamp&#34;,</TD></TR><TR><TD CLASS="l">4107</TD><TD>                                                    SQLError.SQL_STATE_ILLEGAL_ARGUMENT);</TD></TR><TR><TD CLASS="l">4108</TD><TD>                            }</TD></TR><TR><TD CLASS="l">4109</TD><TD>                            </TD></TR><TR CLASS="z"><TD CLASS="l">4110</TD><TD>                            year = 1;</TD></TR><TR CLASS="z"><TD CLASS="l">4111</TD><TD>                            month = 1;</TD></TR><TR CLASS="z"><TD CLASS="l">4112</TD><TD>                            day = 1;</TD></TR><TR><TD CLASS="l">4113</TD><TD>                    }</TD></TR><TR><TD CLASS="l">4114</TD><TD>                    </TD></TR><TR><TD CLASS="l">4115</TD><TD>                    </TD></TR><TR CLASS="c"><TD CLASS="l">4116</TD><TD>                    int stringLength = 19;</TD></TR><TR><TD CLASS="l">4117</TD><TD>                    </TD></TR><TR CLASS="c"><TD CLASS="l">4118</TD><TD>                    byte[] nanosAsBytes = Integer.toString(nanos).getBytes();</TD></TR><TR><TD CLASS="l">4119</TD><TD>                    </TD></TR><TR CLASS="c"><TD CLASS="l">4120</TD><TD>                    stringLength += (1 + nanosAsBytes.length); // '.' + # of digits</TD></TR><TR><TD CLASS="l">4121</TD><TD>                    </TD></TR><TR CLASS="c"><TD CLASS="l">4122</TD><TD>                    byte[] datetimeAsBytes = new byte[stringLength];</TD></TR><TR><TD CLASS="l">4123</TD><TD>                    </TD></TR><TR CLASS="c"><TD CLASS="l">4124</TD><TD>                    datetimeAsBytes[0] = (byte) Character.forDigit(year / 1000,</TD></TR><TR><TD CLASS="l">4125</TD><TD>                                    10);</TD></TR><TR><TD CLASS="l">4126</TD><TD>                    </TD></TR><TR CLASS="c"><TD CLASS="l">4127</TD><TD>                    after1000 = year % 1000;</TD></TR><TR><TD CLASS="l">4128</TD><TD>                    </TD></TR><TR CLASS="c"><TD CLASS="l">4129</TD><TD>                    datetimeAsBytes[1] = (byte) Character.forDigit(after1000 / 100,</TD></TR><TR><TD CLASS="l">4130</TD><TD>                                    10);</TD></TR><TR><TD CLASS="l">4131</TD><TD>                    </TD></TR><TR CLASS="c"><TD CLASS="l">4132</TD><TD>                    after100 = after1000 % 100;</TD></TR><TR><TD CLASS="l">4133</TD><TD>                    </TD></TR><TR CLASS="c"><TD CLASS="l">4134</TD><TD>                    datetimeAsBytes[2] = (byte) Character.forDigit(after100 / 10,</TD></TR><TR><TD CLASS="l">4135</TD><TD>                                    10);</TD></TR><TR CLASS="c"><TD CLASS="l">4136</TD><TD>                    datetimeAsBytes[3] = (byte) Character.forDigit(after100 % 10,</TD></TR><TR><TD CLASS="l">4137</TD><TD>                                    10);</TD></TR><TR><TD CLASS="l">4138</TD><TD>                    </TD></TR><TR CLASS="c"><TD CLASS="l">4139</TD><TD>                    datetimeAsBytes[4] = (byte) '-';</TD></TR><TR><TD CLASS="l">4140</TD><TD>                    </TD></TR><TR CLASS="c"><TD CLASS="l">4141</TD><TD>                    datetimeAsBytes[5] = (byte) Character.forDigit(month / 10,</TD></TR><TR><TD CLASS="l">4142</TD><TD>                                    10);</TD></TR><TR CLASS="c"><TD CLASS="l">4143</TD><TD>                    datetimeAsBytes[6] = (byte) Character.forDigit(month % 10,</TD></TR><TR><TD CLASS="l">4144</TD><TD>                                    10);</TD></TR><TR><TD CLASS="l">4145</TD><TD>                    </TD></TR><TR CLASS="c"><TD CLASS="l">4146</TD><TD>                    datetimeAsBytes[7] = (byte) '-';</TD></TR><TR><TD CLASS="l">4147</TD><TD>                    </TD></TR><TR CLASS="c"><TD CLASS="l">4148</TD><TD>                    datetimeAsBytes[8] = (byte) Character.forDigit(day / 10,</TD></TR><TR><TD CLASS="l">4149</TD><TD>                                    10);</TD></TR><TR CLASS="c"><TD CLASS="l">4150</TD><TD>                    datetimeAsBytes[9] = (byte) Character.forDigit(day % 10,</TD></TR><TR><TD CLASS="l">4151</TD><TD>                                    10);</TD></TR><TR><TD CLASS="l">4152</TD><TD>                    </TD></TR><TR CLASS="c"><TD CLASS="l">4153</TD><TD>                    datetimeAsBytes[10] = (byte) ' ';</TD></TR><TR><TD CLASS="l">4154</TD><TD>                    </TD></TR><TR CLASS="c"><TD CLASS="l">4155</TD><TD>                    datetimeAsBytes[11] = (byte) Character.forDigit(hour / 10,</TD></TR><TR><TD CLASS="l">4156</TD><TD>                                    10);</TD></TR><TR CLASS="c"><TD CLASS="l">4157</TD><TD>                    datetimeAsBytes[12] = (byte) Character.forDigit(hour % 10,</TD></TR><TR><TD CLASS="l">4158</TD><TD>                                    10);</TD></TR><TR><TD CLASS="l">4159</TD><TD>                    </TD></TR><TR CLASS="c"><TD CLASS="l">4160</TD><TD>                    datetimeAsBytes[13] = (byte) ':';</TD></TR><TR><TD CLASS="l">4161</TD><TD>                    </TD></TR><TR CLASS="c"><TD CLASS="l">4162</TD><TD>                    datetimeAsBytes[14] = (byte) Character.forDigit(minute / 10,</TD></TR><TR><TD CLASS="l">4163</TD><TD>                                    10);</TD></TR><TR CLASS="c"><TD CLASS="l">4164</TD><TD>                    datetimeAsBytes[15] = (byte) Character.forDigit(minute % 10,</TD></TR><TR><TD CLASS="l">4165</TD><TD>                                    10);</TD></TR><TR><TD CLASS="l">4166</TD><TD>                    </TD></TR><TR CLASS="c"><TD CLASS="l">4167</TD><TD>                    datetimeAsBytes[16] = (byte) ':';</TD></TR><TR><TD CLASS="l">4168</TD><TD>                    </TD></TR><TR CLASS="c"><TD CLASS="l">4169</TD><TD>                    datetimeAsBytes[17] = (byte) Character.forDigit(seconds / 10,</TD></TR><TR><TD CLASS="l">4170</TD><TD>                                    10);</TD></TR><TR CLASS="c"><TD CLASS="l">4171</TD><TD>                    datetimeAsBytes[18] = (byte) Character.forDigit(seconds % 10,</TD></TR><TR><TD CLASS="l">4172</TD><TD>                                    10);</TD></TR><TR><TD CLASS="l">4173</TD><TD>                    </TD></TR><TR CLASS="c"><TD CLASS="l">4174</TD><TD>                    datetimeAsBytes[19] = (byte) '.';</TD></TR><TR><TD CLASS="l">4175</TD><TD>                    </TD></TR><TR CLASS="c"><TD CLASS="l">4176</TD><TD>                    int nanosOffset = 20;</TD></TR><TR><TD CLASS="l">4177</TD><TD>                    </TD></TR><TR CLASS="c"><TD CLASS="l">4178</TD><TD>                    for (int j = 0; j &lt; nanosAsBytes.length; j++) {</TD></TR><TR CLASS="c"><TD CLASS="l">4179</TD><TD>                            datetimeAsBytes[nanosOffset + j] = nanosAsBytes[j];</TD></TR><TR><TD CLASS="l">4180</TD><TD>                    }</TD></TR><TR><TD CLASS="l">4181</TD><TD>                    </TD></TR><TR CLASS="c"><TD CLASS="l">4182</TD><TD>                    unpackedRowData[columnIndex] = datetimeAsBytes;</TD></TR><TR><TD CLASS="l">4183</TD><TD>                    </TD></TR><TR><TD CLASS="l">4184</TD><TD>                    </TD></TR><TR CLASS="c"><TD CLASS="l">4185</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">4186</TD><TD>                    </TD></TR><TR><TD CLASS="l">4187</TD><TD>            case MysqlDefs.FIELD_TYPE_TINY_BLOB:</TD></TR><TR><TD CLASS="l">4188</TD><TD>            case MysqlDefs.FIELD_TYPE_MEDIUM_BLOB:</TD></TR><TR><TD CLASS="l">4189</TD><TD>            case MysqlDefs.FIELD_TYPE_LONG_BLOB:</TD></TR><TR><TD CLASS="l">4190</TD><TD>            case MysqlDefs.FIELD_TYPE_BLOB:</TD></TR><TR><TD CLASS="l">4191</TD><TD>            case MysqlDefs.FIELD_TYPE_VAR_STRING:</TD></TR><TR><TD CLASS="l">4192</TD><TD>            case MysqlDefs.FIELD_TYPE_STRING:</TD></TR><TR><TD CLASS="l">4193</TD><TD>            case MysqlDefs.FIELD_TYPE_VARCHAR:</TD></TR><TR><TD CLASS="l">4194</TD><TD>            case MysqlDefs.FIELD_TYPE_DECIMAL:</TD></TR><TR><TD CLASS="l">4195</TD><TD>            case MysqlDefs.FIELD_TYPE_NEW_DECIMAL:</TD></TR><TR><TD CLASS="l">4196</TD><TD>            case MysqlDefs.FIELD_TYPE_GEOMETRY:</TD></TR><TR CLASS="c"><TD CLASS="l">4197</TD><TD>                    unpackedRowData[columnIndex] = binaryData.readLenByteArray(0);</TD></TR><TR><TD CLASS="l">4198</TD><TD>                    </TD></TR><TR CLASS="c"><TD CLASS="l">4199</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">4200</TD><TD>                    </TD></TR><TR><TD CLASS="l">4201</TD><TD>            default:</TD></TR><TR CLASS="z"><TD CLASS="l">4202</TD><TD>                    throw new SQLException(Messages.getString(&#34;MysqlIO.97&#34;) //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">4203</TD><TD>                                    +curField.getMysqlType() +</TD></TR><TR><TD CLASS="l">4204</TD><TD>                                    Messages.getString(&#34;MysqlIO.98&#34;) + columnIndex +</TD></TR><TR><TD CLASS="l">4205</TD><TD>                                    Messages.getString(&#34;MysqlIO.99&#34;) //$NON-NLS-1$ //$NON-NLS-2$</TD></TR><TR><TD CLASS="l">4206</TD><TD>                                    + fields.length + Messages.getString(&#34;MysqlIO.100&#34;), //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">4207</TD><TD>                                    SQLError.SQL_STATE_GENERAL_ERROR);</TD></TR><TR><TD CLASS="l">4208</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">4209</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="48">4210</A></TD><TD>    </TD></TR><TR><TD CLASS="l">4211</TD><TD>    private void sendViaChannel(Buffer packet, int packetLength)</TD></TR><TR><TD CLASS="l">4212</TD><TD>        throws SQLException {</TD></TR><TR><TD CLASS="l">4213</TD><TD>        try {</TD></TR><TR CLASS="c"><TD CLASS="l">4214</TD><TD>            int oldLength = packet.getBufLength();</TD></TR><TR><TD CLASS="l">4215</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">4216</TD><TD>            packet.getNioBuffer().limit(packetLength);</TD></TR><TR CLASS="c"><TD CLASS="l">4217</TD><TD>            packet.setPosition(0);</TD></TR><TR><TD CLASS="l">4218</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">4219</TD><TD>            this.socketChannel.write(packet.getNioBuffer());</TD></TR><TR><TD CLASS="l">4220</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">4221</TD><TD>            packet.setBufLength(oldLength);</TD></TR><TR CLASS="c"><TD CLASS="l">4222</TD><TD>        } catch (IOException ioEx) {</TD></TR><TR CLASS="c"><TD CLASS="l">4223</TD><TD>            StringBuffer message = new StringBuffer(SQLError.get(</TD></TR><TR><TD CLASS="l">4224</TD><TD>                        SQLError.SQL_STATE_COMMUNICATION_LINK_FAILURE));</TD></TR><TR CLASS="c"><TD CLASS="l">4225</TD><TD>            message.append(&#34;: &#34;); //$NON-NLS-1$</TD></TR><TR CLASS="c"><TD CLASS="l">4226</TD><TD>            message.append(ioEx.getClass().getName());</TD></TR><TR CLASS="c"><TD CLASS="l">4227</TD><TD>            message.append(Messages.getString(&#34;MysqlIO.102&#34;)); //$NON-NLS-1$</TD></TR><TR CLASS="c"><TD CLASS="l">4228</TD><TD>            message.append(ioEx.getMessage());</TD></TR><TR><TD CLASS="l">4229</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">4230</TD><TD>            if (!this.connection.getParanoid()) {</TD></TR><TR CLASS="c"><TD CLASS="l">4231</TD><TD>                message.append(Util.stackTraceToString(ioEx));</TD></TR><TR><TD CLASS="l">4232</TD><TD>            }</TD></TR><TR><TD CLASS="l">4233</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">4234</TD><TD>            throw new SQLException(message.toString(),</TD></TR><TR><TD CLASS="l">4235</TD><TD>                SQLError.SQL_STATE_COMMUNICATION_LINK_FAILURE, 0);</TD></TR><TR CLASS="c"><TD CLASS="l">4236</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">4237</TD><TD>    }</TD></TR><TR><TD CLASS="l">4238</TD><TD> </TD></TR><TR><TD CLASS="l">4239</TD><TD>    /**</TD></TR><TR><TD CLASS="l"><A NAME="6">4240</A></TD><TD>     * Optimization to only use one calendar per-session, or calculate it</TD></TR><TR><TD CLASS="l">4241</TD><TD>     * for each call, depending on user configuration</TD></TR><TR><TD CLASS="l">4242</TD><TD>     */</TD></TR><TR><TD CLASS="l">4243</TD><TD>    private Calendar getCalendarInstanceForSessionOrNew() {</TD></TR><TR CLASS="z"><TD CLASS="l">4244</TD><TD>            if (this.connection.getDynamicCalendars()) {</TD></TR><TR CLASS="z"><TD CLASS="l">4245</TD><TD>                    return Calendar.getInstance();</TD></TR><TR><TD CLASS="l">4246</TD><TD>            } else {</TD></TR><TR CLASS="z"><TD CLASS="l">4247</TD><TD>                    return this.sessionCalendar;</TD></TR><TR><TD CLASS="l">4248</TD><TD>            }</TD></TR><TR><TD CLASS="l">4249</TD><TD>    }</TD></TR><TR><TD CLASS="l">4250</TD><TD>    </TD></TR><TR><TD CLASS="l">4251</TD><TD>    /**</TD></TR><TR><TD CLASS="l">4252</TD><TD>     * Negotiates the SSL communications channel used when connecting</TD></TR><TR><TD CLASS="l">4253</TD><TD>     * to a MySQL server that understands SSL.</TD></TR><TR><TD CLASS="l">4254</TD><TD>     *</TD></TR><TR><TD CLASS="l">4255</TD><TD>     * @param user</TD></TR><TR><TD CLASS="l">4256</TD><TD>     * @param password</TD></TR><TR><TD CLASS="l">4257</TD><TD>     * @param database</TD></TR><TR><TD CLASS="l">4258</TD><TD>     * @param packLength</TD></TR><TR><TD CLASS="l">4259</TD><TD>     * @throws SQLException</TD></TR><TR><TD CLASS="l">4260</TD><TD>     * @throws CommunicationsException</TD></TR><TR><TD CLASS="l"><A NAME="9">4261</A></TD><TD>     */</TD></TR><TR><TD CLASS="l">4262</TD><TD>    private void negotiateSSLConnection(String user, String password,</TD></TR><TR><TD CLASS="l">4263</TD><TD>        String database, int packLength)</TD></TR><TR><TD CLASS="l">4264</TD><TD>        throws SQLException, CommunicationsException {</TD></TR><TR CLASS="z"><TD CLASS="l">4265</TD><TD>        if (!ExportControlled.enabled()) {</TD></TR><TR CLASS="z"><TD CLASS="l">4266</TD><TD>            throw new ConnectionFeatureNotAvailableException(this.connection,</TD></TR><TR><TD CLASS="l">4267</TD><TD>                this.lastPacketSentTimeMs, null);</TD></TR><TR><TD CLASS="l">4268</TD><TD>        }</TD></TR><TR><TD CLASS="l">4269</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">4270</TD><TD>        boolean doSecureAuth = false;</TD></TR><TR><TD CLASS="l">4271</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">4272</TD><TD>        if ((this.serverCapabilities &amp; CLIENT_SECURE_CONNECTION) != 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">4273</TD><TD>            this.clientParam |= CLIENT_SECURE_CONNECTION;</TD></TR><TR CLASS="z"><TD CLASS="l">4274</TD><TD>            doSecureAuth = true;</TD></TR><TR><TD CLASS="l">4275</TD><TD>        }</TD></TR><TR><TD CLASS="l">4276</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">4277</TD><TD>        this.clientParam |= CLIENT_SSL;</TD></TR><TR><TD CLASS="l">4278</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">4279</TD><TD>        Buffer packet = Buffer.allocateNew(packLength, this.useNewIo);</TD></TR><TR><TD CLASS="l">4280</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">4281</TD><TD>        if ((this.clientParam &amp; CLIENT_RESERVED) != 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">4282</TD><TD>            packet.writeLong(this.clientParam);</TD></TR><TR><TD CLASS="l">4283</TD><TD>        } else {</TD></TR><TR CLASS="z"><TD CLASS="l">4284</TD><TD>            packet.writeInt((int) this.clientParam);</TD></TR><TR><TD CLASS="l">4285</TD><TD>        }</TD></TR><TR><TD CLASS="l">4286</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">4287</TD><TD>        send(packet);</TD></TR><TR><TD CLASS="l">4288</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">4289</TD><TD>        ExportControlled.transformSocketToSSLSocket(this);</TD></TR><TR><TD CLASS="l">4290</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">4291</TD><TD>        packet.clear();</TD></TR><TR><TD CLASS="l">4292</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">4293</TD><TD>        if (doSecureAuth) {</TD></TR><TR CLASS="z"><TD CLASS="l">4294</TD><TD>            if (versionMeetsMinimum(4, 1, 1)) {</TD></TR><TR CLASS="z"><TD CLASS="l">4295</TD><TD>                secureAuth411(null, packLength, user, password, database, true);</TD></TR><TR><TD CLASS="l">4296</TD><TD>            } else {</TD></TR><TR CLASS="z"><TD CLASS="l">4297</TD><TD>                secureAuth(null, packLength, user, password, database, true);</TD></TR><TR><TD CLASS="l">4298</TD><TD>            }</TD></TR><TR><TD CLASS="l">4299</TD><TD>        } else {</TD></TR><TR CLASS="z"><TD CLASS="l">4300</TD><TD>            if ((this.clientParam &amp; CLIENT_RESERVED) != 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">4301</TD><TD>                packet.writeLong(this.clientParam);</TD></TR><TR CLASS="z"><TD CLASS="l">4302</TD><TD>                packet.writeLong(this.maxThreeBytes);</TD></TR><TR><TD CLASS="l">4303</TD><TD>            } else {</TD></TR><TR CLASS="z"><TD CLASS="l">4304</TD><TD>                packet.writeInt((int) this.clientParam);</TD></TR><TR CLASS="z"><TD CLASS="l">4305</TD><TD>                packet.writeLongInt(this.maxThreeBytes);</TD></TR><TR><TD CLASS="l">4306</TD><TD>            }</TD></TR><TR><TD CLASS="l">4307</TD><TD> </TD></TR><TR><TD CLASS="l">4308</TD><TD>            // User/Password data</TD></TR><TR CLASS="z"><TD CLASS="l">4309</TD><TD>            packet.writeString(user);</TD></TR><TR><TD CLASS="l">4310</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">4311</TD><TD>            if (this.protocolVersion &gt; 9) {</TD></TR><TR CLASS="z"><TD CLASS="l">4312</TD><TD>                packet.writeString(Util.newCrypt(password, this.seed));</TD></TR><TR><TD CLASS="l">4313</TD><TD>            } else {</TD></TR><TR CLASS="z"><TD CLASS="l">4314</TD><TD>                packet.writeString(Util.oldCrypt(password, this.seed));</TD></TR><TR><TD CLASS="l">4315</TD><TD>            }</TD></TR><TR><TD CLASS="l">4316</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">4317</TD><TD>            if (((this.serverCapabilities &amp; CLIENT_CONNECT_WITH_DB) != 0) &amp;&amp;</TD></TR><TR><TD CLASS="l">4318</TD><TD>                    (database != null) &amp;&amp; (database.length() &gt; 0)) {</TD></TR><TR CLASS="z"><TD CLASS="l">4319</TD><TD>                packet.writeString(database);</TD></TR><TR><TD CLASS="l">4320</TD><TD>            }</TD></TR><TR><TD CLASS="l">4321</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">4322</TD><TD>            send(packet);</TD></TR><TR><TD CLASS="l">4323</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">4324</TD><TD>    }</TD></TR><TR><TD CLASS="l">4325</TD><TD>}</TD></TR></TABLE><P></P><TABLE CLASS="hdft" WIDTH="100%" CELLSPACING="0"><TR><TD CLASS="nv">[<A HREF="../index.html">all classes</A>][<A HREF="6.html">com.mysql.jdbc</A>]</TD></TR><TR><TD CLASS="tl"><A HREF="http://sourceforge.net/projects/emma">EMMA 2.0.4217</A> (C) Vladimir Roubtsov</TD></TR></TABLE></BODY></HTML>